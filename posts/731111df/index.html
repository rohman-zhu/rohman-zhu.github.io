<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="需求说明一期需求最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码； 一期需求只能实现 服务器挂载镜像后，自动安装操作系统，安装完毕后仍需要使用初始化脚本对主机名、IP进行初始化，因此对镜像的管理由为重要，拟定命名应该包含OS版本信息、启动模式、适配机型、初始硬盘大小；  ubuntu-20.04.5-live-ser">
<meta property="og:type" content="article">
<meta property="og:title" content="Ubuntu2004无人值守安装实例【待完善】">
<meta property="og:url" content="http://github.com/rohman-zhu/posts/731111df/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:description" content="需求说明一期需求最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码； 一期需求只能实现 服务器挂载镜像后，自动安装操作系统，安装完毕后仍需要使用初始化脚本对主机名、IP进行初始化，因此对镜像的管理由为重要，拟定命名应该包含OS版本信息、启动模式、适配机型、初始硬盘大小；  ubuntu-20.04.5-live-ser">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-29T12:20:28.000Z">
<meta property="article:modified_time" content="2025-04-01T17:34:27.657Z">
<meta property="article:author" content="Rohman.Zhu">
<meta property="article:tag" content="default">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/posts/731111df/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh_cn","comments":true,"permalink":"http://github.com/rohman-zhu/posts/731111df/","path":"posts/731111df/","title":"Ubuntu2004无人值守安装实例【待完善】"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Ubuntu2004无人值守安装实例【待完善】 | 诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">诺曼实验室</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">需求说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E6%9C%9F%E9%9C%80%E6%B1%82"><span class="nav-number">1.1.</span> <span class="nav-text">一期需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E6%9C%9F%E9%9C%80%E6%B1%82"><span class="nav-number">1.2.</span> <span class="nav-text">二期需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E6%9C%9F%E9%9C%80%E6%B1%82"><span class="nav-number">1.3.</span> <span class="nav-text">三期需求</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">实现过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E6%9C%9F%E9%9C%80%E6%B1%82%E8%90%BD%E5%9C%B0"><span class="nav-number">2.1.</span> <span class="nav-text">一期需求落地</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%86%E5%A4%87"><span class="nav-number">2.1.1.</span> <span class="nav-text">虚拟机准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="nav-number">2.1.2.</span> <span class="nav-text">手动安装准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="nav-number">2.1.3.</span> <span class="nav-text">自动安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6-user-data"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">应答文件 user-data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%AF%BC%E6%96%87%E4%BB%B6-grub-cfg"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">引导文件 grub.cfg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">系统初始化脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E5%B0%81%E8%A3%85ISO%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.3.4.</span> <span class="nav-text">重新封装ISO文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="nav-number">2.1.3.5.</span> <span class="nav-text">虚拟机验证测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.3.6.</span> <span class="nav-text">遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%981%EF%BC%9A%E6%97%A0%E6%B3%95%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A1%AC%E7%9B%98%EF%BC%8C%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9B%B4%E6%8E%A5%E4%B8%AD%E6%96%AD%E6%9A%82%E5%81%9C%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95%E6%9C%89%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.3.6.1.</span> <span class="nav-text">问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">2.1.3.6.1.1.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">2.1.3.6.1.2.</span> <span class="nav-text">解决方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%982%EF%BC%9A%E6%97%A0%E6%B3%95%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A1%AC%E7%9B%98%EF%BC%8C%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9B%B4%E6%8E%A5%E4%B8%AD%E6%96%AD%E6%9A%82%E5%81%9C%EF%BC%8C%E5%8E%9F%E5%A7%8B%E7%A1%AC%E7%9B%98%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3"><span class="nav-number">2.1.3.6.2.</span> <span class="nav-text">问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-1"><span class="nav-number">2.1.3.6.2.1.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-1"><span class="nav-number">2.1.3.6.2.2.</span> <span class="nav-text">解决方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%983%EF%BC%9A%E5%8D%A1%E5%9C%A8downloading-and-installing-security-updates"><span class="nav-number">2.1.3.6.3.</span> <span class="nav-text">问题3：卡在downloading and installing security updates</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-2"><span class="nav-number">2.1.3.6.3.1.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-2"><span class="nav-number">2.1.3.6.3.2.</span> <span class="nav-text">解决方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%984%EF%BC%9A%E6%8F%90%E7%A4%BAnetplan-apply-returned-non-zero-exit-status-1"><span class="nav-number">2.1.3.6.4.</span> <span class="nav-text">问题4：提示netplan apply returned non-zero exit status 1</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-3"><span class="nav-number">2.1.3.6.4.1.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-3"><span class="nav-number">2.1.3.6.4.2.</span> <span class="nav-text">解决方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%985%EF%BC%9Auser-data%E6%96%87%E4%BB%B6%E5%BC%82%E5%B8%B8%EF%BC%8C%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E3%80%90%E5%BE%85%E5%A4%8D%E6%A0%B8%E7%A1%AE%E8%AE%A4%E3%80%91"><span class="nav-number">2.1.3.6.5.</span> <span class="nav-text">问题5：user-data文件异常，无法使用【待复核确认】</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90-4"><span class="nav-number">2.1.3.6.5.1.</span> <span class="nav-text">原因分析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-4"><span class="nav-number">2.1.3.6.5.2.</span> <span class="nav-text">解决方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%AE%E9%A2%985%EF%BC%9A%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%AD%EF%BC%8C%E6%A8%A1%E6%8B%9Fcurtin-%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C"><span class="nav-number">2.1.3.6.6.</span> <span class="nav-text">问题5：安装中断，模拟curtin 继续执行</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E6%9C%9F%E9%9C%80%E6%B1%82%E8%90%BD%E5%9C%B0%E3%80%90%E5%BE%85%E6%9B%B4%E6%96%B0%E3%80%91"><span class="nav-number">2.2.</span> <span class="nav-text">二期需求落地【待更新】</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E6%9C%9F%E9%9C%80%E6%B1%82%E8%90%BD%E5%9C%B0%E3%80%90%E5%BE%85%E6%9B%B4%E6%96%B0%E3%80%91"><span class="nav-number">2.3.</span> <span class="nav-text">三期需求落地【待更新】</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">3.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">437</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh_cn">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/731111df/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Ubuntu2004无人值守安装实例【待完善】 | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ubuntu2004无人值守安装实例【待完善】
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-29 12:20:28" itemprop="dateCreated datePublished" datetime="2025-03-29T12:20:28+00:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-01 17:34:27" itemprop="dateModified" datetime="2025-04-01T17:34:27+00:00">2025-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><h2 id="一期需求"><a href="#一期需求" class="headerlink" title="一期需求"></a>一期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码；</p>
<p>一期需求只能实现 服务器挂载镜像后，自动安装操作系统，安装完毕后仍需要使用初始化脚本对主机名、IP进行初始化，因此对镜像的管理由为重要，拟定命名应该包含OS版本信息、启动模式、适配机型、初始硬盘大小；</p>
<blockquote>
<p>ubuntu-20.04.5-live-server-amd64-uefi-pc-10G.iso</p>
</blockquote>
<h2 id="二期需求"><a href="#二期需求" class="headerlink" title="二期需求"></a>二期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，可以要求用户输入主机名、IP，输入完毕后就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码；</p>
<h2 id="三期需求"><a href="#三期需求" class="headerlink" title="三期需求"></a>三期需求</h2><p>通过PXE方式，实现远程挂载镜像自动安装；</p>
<h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h1><p>整体过程：</p>
<ol>
<li>使用虚拟机安装；</li>
<li>先手动安装一遍，并在&#x2F;var&#x2F;log&#x2F;installer&#x2F;autoinstall-user-data</li>
<li>将user-data文件封装进 ISO，并测试安装；</li>
</ol>
<h2 id="一期需求落地"><a href="#一期需求落地" class="headerlink" title="一期需求落地"></a>一期需求落地</h2><h3 id="虚拟机准备"><a href="#虚拟机准备" class="headerlink" title="虚拟机准备"></a>虚拟机准备</h3><p>虚拟化层：使用 VirtualBox 7.1.6 版本；<br>虚拟机配置：1C1G；（低于此配置，可能会在安装的时候触发中断）<br>镜像准备：ubuntu-20.04.5-live-server-amd64.iso (下载地址：<a target="_blank" rel="noopener" href="https://old-releases.ubuntu.com/releases/20.04.5/">https://old-releases.ubuntu.com/releases/20.04.5/</a>  ； 这里有一个坑，我在一个看起来像官网的地方，下载了一个镜像结果怎么样都无法使用)</p>
<h3 id="手动安装准备"><a href="#手动安装准备" class="headerlink" title="手动安装准备"></a>手动安装准备</h3><p>主机名 test001<br>用户名 testuser<br>密码 [自行设置]<br>磁盘 10G：0.5G为EFI分区，2G为boot分区，2G为swap分区，5G为根分区<br>网卡名称：enp0s3<br>IP：192.168.56.101<br>Netmask：255.255.255.0<br>Gateway：192.168.56.1<br>DNS：8.8.8.8,8.8.4.4<br>search domain：rohman.com<br>镜像源： <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/ubuntu/">https://mirrors.aliyun.com/ubuntu/</a><br>安装OpenSSH</p>
<h3 id="自动安装"><a href="#自动安装" class="headerlink" title="自动安装"></a>自动安装</h3><p>通过手动安装，我们获取到了user-data的应答文件，可以开始准备封装自动化安装的镜像。</p>
<h4 id="应答文件-user-data"><a href="#应答文件-user-data" class="headerlink" title="应答文件 user-data"></a>应答文件 user-data</h4><p>从服务器中获取 autoinstall-user-data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">#cloud-config</span><br><span class="line">autoinstall:</span><br><span class="line">  apt:</span><br><span class="line">    disable_components: []</span><br><span class="line">    geoip: true</span><br><span class="line">    preserve_sources_list: false</span><br><span class="line">    # apt 仓库</span><br><span class="line">    primary:</span><br><span class="line">    - arches:</span><br><span class="line">      - amd64</span><br><span class="line">      - i386</span><br><span class="line">      uri: http://mirrors.aliyun.com/ubuntu</span><br><span class="line">    - arches:</span><br><span class="line">      - default</span><br><span class="line">      uri: http://ports.ubuntu.com/ubuntu-ports</span><br><span class="line">  drivers:</span><br><span class="line">    install: false</span><br><span class="line">  # 配置主机与用户名信息</span><br><span class="line">  identity:</span><br><span class="line">    hostname: test001</span><br><span class="line">    password: $6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span><br><span class="line">    realname: testuser</span><br><span class="line">    username: testuser</span><br><span class="line">  kernel:</span><br><span class="line">    package: linux-generic</span><br><span class="line">  keyboard:</span><br><span class="line">    layout: us</span><br><span class="line">    toggle: null</span><br><span class="line">    variant: &#x27;&#x27;</span><br><span class="line">  locale: en_US.UTF-8</span><br><span class="line">  # 配置网络</span><br><span class="line">  network:</span><br><span class="line">    ethernets:</span><br><span class="line">      enp0s3:</span><br><span class="line">        addresses:</span><br><span class="line">        - 192.168.56.102/24</span><br><span class="line">        gateway4: 192.168.56.1</span><br><span class="line">        nameservers:</span><br><span class="line">          addresses:</span><br><span class="line">          - 8.8.8.8</span><br><span class="line">          - 8.8.4.4</span><br><span class="line">          search:</span><br><span class="line">          - rohman.com</span><br><span class="line">    version: 2</span><br><span class="line">  # 配置SSH</span><br><span class="line">  ssh:</span><br><span class="line">    allow-pw: true</span><br><span class="line">    authorized-keys: []</span><br><span class="line">    install-server: true</span><br><span class="line">  # 存储配置</span><br><span class="line">  storage:</span><br><span class="line">    config:</span><br><span class="line">    - ptable: gpt</span><br><span class="line">      serial: VBOX_HARDDISK_VB84cd466a-d1bb429d</span><br><span class="line">      path: /dev/sda</span><br><span class="line">      preserve: true</span><br><span class="line">      name: &#x27;&#x27;</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: disk</span><br><span class="line">      id: disk-sda</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 564133888</span><br><span class="line">      flag: boot</span><br><span class="line">      number: 1</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: true</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda1</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 1073741824</span><br><span class="line">      wipe: superblock</span><br><span class="line">      flag: linux</span><br><span class="line">      number: 2</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda2</span><br><span class="line">    - fstype: ext4</span><br><span class="line">      volume: partition-sda2</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-0</span><br><span class="line">    - fstype: vfat</span><br><span class="line">      volume: partition-sda1</span><br><span class="line">      preserve: true</span><br><span class="line">      type: format</span><br><span class="line">      id: format-partition-sda1</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 9097445376</span><br><span class="line">      flag: linux</span><br><span class="line">      number: 3</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda3</span><br><span class="line">    - name: vg-root</span><br><span class="line">      devices:</span><br><span class="line">      - partition-sda3</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_volgroup</span><br><span class="line">      id: lvm-volgroup-vg-root</span><br><span class="line">    - name: lv-swap</span><br><span class="line">      volgroup: lvm-volgroup-vg-root</span><br><span class="line">      size: 2147483648B</span><br><span class="line">      wipe: superblock</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_partition</span><br><span class="line">      id: lvm-partition-lv-swap</span><br><span class="line">    - fstype: swap</span><br><span class="line">      volume: lvm-partition-lv-swap</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-1</span><br><span class="line">    - path: &#x27;&#x27;</span><br><span class="line">      device: format-1</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-2</span><br><span class="line">    - name: lv-root</span><br><span class="line">      volgroup: lvm-volgroup-vg-root</span><br><span class="line">      size: 5368709120B</span><br><span class="line">      wipe: superblock</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_partition</span><br><span class="line">      id: lvm-partition-lv-root</span><br><span class="line">    - fstype: ext4</span><br><span class="line">      volume: lvm-partition-lv-root</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-2</span><br><span class="line">    - path: /</span><br><span class="line">      device: format-2</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-3</span><br><span class="line">    - path: /boot</span><br><span class="line">      device: format-0</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-1</span><br><span class="line">    - path: /boot/efi</span><br><span class="line">      device: format-partition-sda1</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-0</span><br><span class="line">    swap:</span><br><span class="line">      swap: 0</span><br><span class="line">  updates: security</span><br><span class="line">  # 安装完成后，需要执行的指令</span><br><span class="line">  late-commands:</span><br><span class="line">    # NTP服务修改</span><br><span class="line">    - </span><br><span class="line">  version: 1</span><br></pre></td></tr></table></figure>
<p>这份文件需要修改的地方是 “serial: VBOX_HARDDISK_VB84cd466a-d1bb429d”,这个值每一个机器都是独一份的，配置文件中不能复用，否则会报错。</p>
<p>最终的应答文件为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="comment"># 不自动更新OS版本</span></span><br><span class="line">  <span class="attr">refresh-installer:</span></span><br><span class="line">    <span class="attr">update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 必要格式，当前版本为1</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># 禁用security仓库</span></span><br><span class="line">    <span class="comment"># disable_suites: [security]</span></span><br><span class="line">    <span class="attr">geoip:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">preserve_sources_list:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 配置</span></span><br><span class="line">    <span class="attr">primary:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">amd64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">i386</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://ports.ubuntu.com/ubuntu-ports</span></span><br><span class="line">  <span class="attr">drivers:</span></span><br><span class="line">    <span class="attr">install:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 主机名与用户</span></span><br><span class="line">  <span class="attr">identity:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu-server-uefi-img</span></span><br><span class="line">    <span class="comment"># 基于 SHA-512 的密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span></span><br><span class="line">    <span class="attr">realname:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testuser</span></span><br><span class="line">  <span class="comment"># 时区设置</span></span><br><span class="line">  <span class="attr">timezone:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  <span class="attr">kernel:</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">linux-generic</span></span><br><span class="line">  <span class="attr">keyboard:</span></span><br><span class="line">    <span class="attr">layout:</span> <span class="string">us</span></span><br><span class="line">    <span class="attr">toggle:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">locale:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># 网络配置</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">ethernets:</span></span><br><span class="line">      <span class="attr">enp0s3:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">        <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">        <span class="attr">nameservers:</span></span><br><span class="line">          <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">          <span class="attr">search:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rohman.com</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># SSH配置</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">allow-pw:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorized-keys:</span> []</span><br><span class="line">    <span class="attr">install-server:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 存储配置</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ptable:</span> <span class="string">gpt</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/dev/sda</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock-recursive</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">disk</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">disk-sda</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">564133888</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">boot</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1073741824</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">vfat</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">9097445376</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vg-root</span></span><br><span class="line">      <span class="attr">devices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">partition-sda3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_volgroup</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-swap</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">2147483648B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">swap</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-root</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">5368709120B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot/efi</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-0</span></span><br><span class="line">    <span class="attr">swap:</span></span><br><span class="line">      <span class="attr">swap:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 安装完成后执行的指令</span></span><br><span class="line">  <span class="attr">late-commands:</span></span><br><span class="line">  <span class="comment"># 根目录在/target中</span></span><br><span class="line">    <span class="comment"># DNS恢复</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.3/8.8.8.8/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.4/8.8.4.4/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="comment"># NTP设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#NTP=/NTP=ntp.ntsc.ac.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#FallbackNTP=ntp.ubuntu.com/FallbackNTP=edu.ntp.org.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">timedatectl</span> <span class="string">set-ntp</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># sudo权限</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;testuser ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/sudoers</span></span><br><span class="line">    <span class="comment"># OpenFile设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* soft nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* hard nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#DefaultLimitNOFILE=/DefaultLimitNOFILE=819200/g&quot;</span> <span class="string">/target/etc/systemd/user.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;DefaultLimitNOFILE=819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/systemd/system.conf</span></span><br><span class="line">    <span class="comment"># 不更新内核</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-image-generic</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-headers-generic</span></span><br><span class="line">    <span class="comment"># 拷贝脚本</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cp</span> <span class="string">/cdrom/server-init.sh</span> <span class="string">/target/root/</span></span><br><span class="line">  <span class="comment"># 重启</span></span><br><span class="line">  <span class="attr">shutdown:</span> <span class="string">reboot</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="引导文件-grub-cfg"><a href="#引导文件-grub-cfg" class="headerlink" title="引导文件 grub.cfg"></a>引导文件 grub.cfg</h4><p>ISO的引导文件放置在 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ fsck.mode&#x3D;skip 字段；关键字段是 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ 这个是自动安装的关键。</p>
</blockquote>
<p>最终版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Automatic][UEFI]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Manual]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="系统初始化脚本"><a href="#系统初始化脚本" class="headerlink" title="系统初始化脚本"></a>系统初始化脚本</h4><p>完成安装后，我们还需要进入OS内执行初始化指令，比如修改主机名、IP之类的。<br>脚本为server-init.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line"><span class="comment"># Description: Init servername and IP.</span></span><br><span class="line"><span class="comment"># Date:2025-03-30</span></span><br><span class="line"><span class="comment"># Version:v1</span></span><br><span class="line"><span class="comment"># ScriptName:server-init.sh</span></span><br><span class="line"><span class="comment"># Args: servername ip</span></span><br><span class="line"><span class="comment"># Example: bash server-init.sh test001 1.2.3.4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Servername is <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerIP is <span class="variable">$2</span>&quot;</span></span><br><span class="line">hostname=<span class="variable">$1</span></span><br><span class="line">ip=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -n1 -p <span class="string">&quot;Is that information correct?(y/n)&quot;</span> KEY</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$KEY</span> <span class="keyword">in</span></span><br><span class="line">Y | y)</span><br><span class="line">    hostnamectl set-hostname <span class="variable">$hostname</span>;</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.1/<span class="variable">$ip</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    gateway4=$(<span class="built_in">echo</span> <span class="variable">$ip</span> | awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.254&quot;&#125;&#x27;</span>)</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.2/<span class="variable">$gateway4</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    netplan apply</span><br><span class="line">    apt-mark hold linux-headers-generic</span><br><span class="line">    apt-mark hold linux-image-generic</span><br><span class="line">    ;;</span><br><span class="line">N | n)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Cancel&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR VALUE!&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h4 id="重新封装ISO文件"><a href="#重新封装ISO文件" class="headerlink" title="重新封装ISO文件"></a>重新封装ISO文件</h4><p>这里使用的工具是 UltraISO 工具，用此工具打开原ISO文件，主要放入的四个文件：</p>
<ol>
<li>grub.cfg文件，要替换 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg ；</li>
<li>user-data应答文件，要放入  &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>meta-data应答文件的元数据文件，要放入 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>server-init.sh放入&#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
</ol>
<p>确认放入后，点击保存即可。</p>
<h4 id="虚拟机验证测试"><a href="#虚拟机验证测试" class="headerlink" title="虚拟机验证测试"></a>虚拟机验证测试</h4><p>VirtualBox创建虚拟机，挂载ISO文件。预期内应该能自动完成安装。</p>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><h5 id="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"><a href="#问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题" class="headerlink" title="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"></a>问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash ，搜索Error字段，发现明显的提示 RuntimeError: type:disk id&#x3D;disk-sda has both wipe and preserve</p>
<h6 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h6><p>应答文件中写得有冲突，在存储配置里面，有关于 磁盘是否要保留数据的参数 preserve 参数，填写了 true；<br>新硬盘正常不应该会存在分区，填写了包留分区，则会有冲突，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">preserve: true, false</span><br><span class="line"></span><br><span class="line">When the preserve key is present and set to true curtin will attempt reuse the existing storage device. Curtin will verify aspects of the device against the configuration provided. </span><br><span class="line">For example, when assessing whether curtin can use a preserved partition, curtin checks that the device exists, size of the partition matches the value in the config and checks if the same partition flag is set. </span><br><span class="line">The set of verification checks vary by device type. If curtin encounters a mismatch between config and what is found on the device a RuntimeError will be raised with the expected and found values and halt the installation. </span><br></pre></td></tr></table></figure>

<p>第二个关键参数，wipe;当wipe指定了内容，则是要格式化磁盘，所有内容均会被抹除；原配置文件中带有wipe参数，但是preserve又填为true，因此导致前后冲突。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wipe: superblock, superblock-recursive, pvremove, zero, random</span><br><span class="line"></span><br><span class="line">If wipe is specified, the disk contents will be destroyed. In the case that a disk is a part of virtual block device, like bcache, RAID array, or LVM, then curtin will attempt to tear down the virtual device to allow access to the disk for resetting the disk.</span><br><span class="line"></span><br><span class="line">The most common option for clearing a disk is wipe: superblock. In some cases use of wipe: superblock-recursive is useful to ensure that embedded superblocks on a disk aren’t rediscovered during probing. For example, LVM, bcache and RAID on a partition would have metadata outside of the range of a superblock wipe of the start and end sections of the disk.</span><br><span class="line"></span><br><span class="line">The wipe: zero option will write zeros to each sector of the disk. Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: random option will write pseudo-random data from /dev/urandom Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: pvremove option will execute the pvremove command to wipe the LVM metadata so that the device is no longer part of an LVM.</span><br></pre></td></tr></table></figure>

<h6 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h6><p>将 preserve: true 全部改成 preserve: false;</p>
<h5 id="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"><a href="#问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足" class="headerlink" title="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"></a>问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看日志，搜索ERROR字段，发现有FAIL:configuring storage;</p>
<h6 id="原因分析-1"><a href="#原因分析-1" class="headerlink" title="原因分析"></a>原因分析</h6><p>目标磁盘sda空间不足，导致无法继续分配空间；</p>
<h6 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1，修改应答文件，将空间缩小；<br>方法2，修改磁盘大小，将初始容量扩大；</p>
<h5 id="问题3：卡在downloading-and-installing-security-updates"><a href="#问题3：卡在downloading-and-installing-security-updates" class="headerlink" title="问题3：卡在downloading and installing security updates"></a>问题3：卡在downloading and installing security updates</h5><p>Log显示downloading and installing security updates</p>
<h6 id="原因分析-2"><a href="#原因分析-2" class="headerlink" title="原因分析"></a>原因分析</h6><p>安装过程中，服务器网络正常可以访问外网则会自动拉取安全更新。</p>
<h6 id="解决方法-2"><a href="#解决方法-2" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1：安装过程中使网络异常，安装完成后再解除；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp0s3:</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我个人更倾向使用此方法，安装完毕后，再到操作系统执行初始化脚本 server-init.sh</p>
</blockquote>
<p>方法2：禁用apt的security仓库；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line"> <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="attr">disable_suites:</span> [<span class="string">security</span>]</span><br></pre></td></tr></table></figure>

<p>但这个会导致默认的源文件会少 security 仓库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span><br><span class="line"># newer versions of the distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"></span><br><span class="line">## Major bug fix updates produced after the final release of the</span><br><span class="line">## distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team. Also, please note that software in universe WILL NOT receive any</span><br><span class="line">## review or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team, and may not be under a free licence. Please satisfy yourself as to</span><br><span class="line">## your rights to use the software. Also, please note that software in</span><br><span class="line">## multiverse WILL NOT receive any review or updates from the Ubuntu</span><br><span class="line">## security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository may not have been tested as</span><br><span class="line">## extensively as that contained in the main release, although it includes</span><br><span class="line">## newer versions of some applications which may provide useful features.</span><br><span class="line">## Also, please note that software in backports WILL NOT receive any review</span><br><span class="line">## or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">## Uncomment the following two lines to add software from Canonical&#x27;s</span><br><span class="line">## &#x27;partner&#x27; repository.</span><br><span class="line">## This software is not part of Ubuntu, but is offered by Canonical and the</span><br><span class="line">## respective vendors as a service to Ubuntu users.</span><br><span class="line"># deb http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"># deb-src http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"></span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br></pre></td></tr></table></figure>

<h5 id="问题4：提示netplan-apply-returned-non-zero-exit-status-1"><a href="#问题4：提示netplan-apply-returned-non-zero-exit-status-1" class="headerlink" title="问题4：提示netplan apply returned non-zero exit status 1"></a>问题4：提示netplan apply returned non-zero exit status 1</h5><p>自动安装过程中，网卡显示中断</p>
<h6 id="原因分析-3"><a href="#原因分析-3" class="headerlink" title="原因分析"></a>原因分析</h6><p>网卡配置写错了，需要复核一下每一个参数是否拼写有误，比如应该写interfaces的选项，写成interface；比如缩进有问题，空格键与tab键混用；</p>
<h6 id="解决方法-3"><a href="#解决方法-3" class="headerlink" title="解决方法"></a>解决方法</h6><p>可以切换至tty2,手动使用netplan apply看看具体报错。</p>
<h5 id="问题5：user-data文件异常，无法使用【待复核确认】"><a href="#问题5：user-data文件异常，无法使用【待复核确认】" class="headerlink" title="问题5：user-data文件异常，无法使用【待复核确认】"></a>问题5：user-data文件异常，无法使用【待复核确认】</h5><p>配置文件未正常生效，安装时仍然进入手动安装界面。</p>
<h6 id="原因分析-4"><a href="#原因分析-4" class="headerlink" title="原因分析"></a>原因分析</h6><p>为yaml文件的配置语法有异常，导致整片yaml配置无法使用。</p>
<h6 id="解决方法-4"><a href="#解决方法-4" class="headerlink" title="解决方法"></a>解决方法</h6><ol>
<li>缩进、空格不能混用；</li>
<li>参数与值之间要空格；如 item: value</li>
</ol>
<h5 id="问题5：安装中断，模拟curtin-继续执行"><a href="#问题5：安装中断，模拟curtin-继续执行" class="headerlink" title="问题5：安装中断，模拟curtin 继续执行"></a>问题5：安装中断，模拟curtin 继续执行</h5><p>指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在目标系统中执行安装任务</span></span><br><span class="line">curtin in-target --target=/target -- [指令内容]</span><br></pre></td></tr></table></figure>

<h2 id="二期需求落地【待更新】"><a href="#二期需求落地【待更新】" class="headerlink" title="二期需求落地【待更新】"></a>二期需求落地【待更新】</h2><h2 id="三期需求落地【待更新】"><a href="#三期需求落地【待更新】" class="headerlink" title="三期需求落地【待更新】"></a>三期需求落地【待更新】</h2><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《制作自动安装Ubuntu22.04-server的iso镜像以及安装过程详解》： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luokeli0755/p/17861638.html">https://www.cnblogs.com/luokeli0755/p/17861638.html</a><br>《grub2详解(翻译和整理官方手册)》：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7094693.html">https://www.cnblogs.com/f-ck-need-u/p/7094693.html</a><br>《如何使用 autoinstall 编写和执行 Ubuntu 无人值守安装》：<a target="_blank" rel="noopener" href="https://cn.linux-console.net/?p=33717">https://cn.linux-console.net/?p=33717</a><br>《Ubuntu&#x2F;Debian无人值守 Autoinstall》：<a target="_blank" rel="noopener" href="https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html">https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html</a><br>《配置界面存储的语法Storage》：<a target="_blank" rel="noopener" href="https://curtin.readthedocs.io/en/latest/topics/storage.html">https://curtin.readthedocs.io/en/latest/topics/storage.html</a><br>《Ubuntu的autoinstall自动安装配置》<a target="_blank" rel="noopener" href="https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html">https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html</a><br>《ubuntu20.04打包iso镜像自动安装》 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/super-age/p/14952469.html">https://www.cnblogs.com/super-age/p/14952469.html</a><br>《Ubuntu无人值守安装保姆级教程》 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/1886733079500007398">https://zhuanlan.zhihu.com/p/1886733079500007398</a><br>《NoCloud》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html">https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html</a><br>《User-data formats》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats">https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats</a><br>《Autoinstall configuration reference manual》<a target="_blank" rel="noopener" href="https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html">https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html</a><br>《how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config》<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config">https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/default/" rel="tag"># default</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/c58cc2d9/" rel="prev" title="vCenter报vapi-endpoint status告警">
                  <i class="fa fa-angle-left"></i> vCenter报vapi-endpoint status告警
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/ad068cdf/" rel="next" title="记一次Ubuntu因自动更新导致的业务故障[待更新]">
                  记一次Ubuntu因自动更新导致的业务故障[待更新] <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
