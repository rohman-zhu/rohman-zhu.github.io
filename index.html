<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">435</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/731111df/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/731111df/" class="post-title-link" itemprop="url">Ubuntu2004无人值守安装实例【待完善】</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-29 12:20:28" itemprop="dateCreated datePublished" datetime="2025-03-29T12:20:28+00:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-30 05:58:21" itemprop="dateModified" datetime="2025-03-30T05:58:21+00:00">2025-03-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><h2 id="一期需求"><a href="#一期需求" class="headerlink" title="一期需求"></a>一期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码；</p>
<h2 id="二期需求"><a href="#二期需求" class="headerlink" title="二期需求"></a>二期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，可以要求用户输入主机名、IP，输入完毕后就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码；</p>
<h2 id="三期需求"><a href="#三期需求" class="headerlink" title="三期需求"></a>三期需求</h2><p>通过PXE方式，实现远程挂载镜像自动安装；</p>
<h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h1><p>整体过程：</p>
<ol>
<li>使用虚拟机安装；</li>
<li>先手动安装一遍，并在&#x2F;var&#x2F;log&#x2F;installer&#x2F;autoinstall-user-data</li>
<li>将user-data文件封装进 ISO，并测试安装；</li>
</ol>
<h2 id="一期需求落地"><a href="#一期需求落地" class="headerlink" title="一期需求落地"></a>一期需求落地</h2><h3 id="虚拟机准备"><a href="#虚拟机准备" class="headerlink" title="虚拟机准备"></a>虚拟机准备</h3><p>虚拟化层：使用 VirtualBox 7.1.6 版本；<br>虚拟机配置：1C1G；（低于此配置，可能会在安装的时候触发中断）<br>镜像准备：ubuntu-20.04.5-live-server-amd64.iso (下载地址：<a target="_blank" rel="noopener" href="https://old-releases.ubuntu.com/releases/20.04.5/">https://old-releases.ubuntu.com/releases/20.04.5/</a>  ； 这里有一个坑，我在一个看起来像官网的地方，下载了一个镜像结果怎么样都无法使用)</p>
<h3 id="手动安装准备"><a href="#手动安装准备" class="headerlink" title="手动安装准备"></a>手动安装准备</h3><p>主机名 test001<br>用户名 testuser<br>密码 Abc321<br>磁盘 10G：0.5G为EFI分区，2G为boot分区，2G为swap分区，5G为根分区<br>网卡名称：enp0s3<br>IP：192.168.56.101<br>Netmask：255.255.255.0<br>Gateway：192.168.56.1<br>DNS：8.8.8.8,8.8.4.4<br>search domain：rohman.com<br>镜像源： <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/ubuntu/">https://mirrors.aliyun.com/ubuntu/</a><br>安装OpenSSH</p>
<h3 id="自动安装"><a href="#自动安装" class="headerlink" title="自动安装"></a>自动安装</h3><p>通过手动安装，我们获取到了user-data的应答文件，可以开始准备封装自动化安装的镜像。</p>
<h4 id="应答文件-user-data"><a href="#应答文件-user-data" class="headerlink" title="应答文件 user-data"></a>应答文件 user-data</h4><p>从服务器中获取 autoinstall-user-data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">#cloud-config</span><br><span class="line">autoinstall:</span><br><span class="line">  apt:</span><br><span class="line">    disable_components: []</span><br><span class="line">    geoip: true</span><br><span class="line">    preserve_sources_list: false</span><br><span class="line">    # apt 仓库</span><br><span class="line">    primary:</span><br><span class="line">    - arches:</span><br><span class="line">      - amd64</span><br><span class="line">      - i386</span><br><span class="line">      uri: http://mirrors.aliyun.com/ubuntu</span><br><span class="line">    - arches:</span><br><span class="line">      - default</span><br><span class="line">      uri: http://ports.ubuntu.com/ubuntu-ports</span><br><span class="line">  drivers:</span><br><span class="line">    install: false</span><br><span class="line">  # 配置主机与用户名信息</span><br><span class="line">  identity:</span><br><span class="line">    hostname: test001</span><br><span class="line">    password: $6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span><br><span class="line">    realname: testuser</span><br><span class="line">    username: testuser</span><br><span class="line">  kernel:</span><br><span class="line">    package: linux-generic</span><br><span class="line">  keyboard:</span><br><span class="line">    layout: us</span><br><span class="line">    toggle: null</span><br><span class="line">    variant: &#x27;&#x27;</span><br><span class="line">  locale: en_US.UTF-8</span><br><span class="line">  # 配置网络</span><br><span class="line">  network:</span><br><span class="line">    ethernets:</span><br><span class="line">      enp0s3:</span><br><span class="line">        addresses:</span><br><span class="line">        - 192.168.56.102/24</span><br><span class="line">        gateway4: 192.168.56.1</span><br><span class="line">        nameservers:</span><br><span class="line">          addresses:</span><br><span class="line">          - 8.8.8.8</span><br><span class="line">          - 8.8.4.4</span><br><span class="line">          search:</span><br><span class="line">          - rohman.com</span><br><span class="line">    version: 2</span><br><span class="line">  # 配置SSH</span><br><span class="line">  ssh:</span><br><span class="line">    allow-pw: true</span><br><span class="line">    authorized-keys: []</span><br><span class="line">    install-server: true</span><br><span class="line">  # 存储配置</span><br><span class="line">  storage:</span><br><span class="line">    config:</span><br><span class="line">    - ptable: gpt</span><br><span class="line">      serial: VBOX_HARDDISK_VB84cd466a-d1bb429d</span><br><span class="line">      path: /dev/sda</span><br><span class="line">      preserve: true</span><br><span class="line">      name: &#x27;&#x27;</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: disk</span><br><span class="line">      id: disk-sda</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 564133888</span><br><span class="line">      flag: boot</span><br><span class="line">      number: 1</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: true</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda1</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 1073741824</span><br><span class="line">      wipe: superblock</span><br><span class="line">      flag: linux</span><br><span class="line">      number: 2</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda2</span><br><span class="line">    - fstype: ext4</span><br><span class="line">      volume: partition-sda2</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-0</span><br><span class="line">    - fstype: vfat</span><br><span class="line">      volume: partition-sda1</span><br><span class="line">      preserve: true</span><br><span class="line">      type: format</span><br><span class="line">      id: format-partition-sda1</span><br><span class="line">    - device: disk-sda</span><br><span class="line">      size: 9097445376</span><br><span class="line">      flag: linux</span><br><span class="line">      number: 3</span><br><span class="line">      preserve: true</span><br><span class="line">      grub_device: false</span><br><span class="line">      type: partition</span><br><span class="line">      id: partition-sda3</span><br><span class="line">    - name: vg-root</span><br><span class="line">      devices:</span><br><span class="line">      - partition-sda3</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_volgroup</span><br><span class="line">      id: lvm-volgroup-vg-root</span><br><span class="line">    - name: lv-swap</span><br><span class="line">      volgroup: lvm-volgroup-vg-root</span><br><span class="line">      size: 2147483648B</span><br><span class="line">      wipe: superblock</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_partition</span><br><span class="line">      id: lvm-partition-lv-swap</span><br><span class="line">    - fstype: swap</span><br><span class="line">      volume: lvm-partition-lv-swap</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-1</span><br><span class="line">    - path: &#x27;&#x27;</span><br><span class="line">      device: format-1</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-2</span><br><span class="line">    - name: lv-root</span><br><span class="line">      volgroup: lvm-volgroup-vg-root</span><br><span class="line">      size: 5368709120B</span><br><span class="line">      wipe: superblock</span><br><span class="line">      preserve: true</span><br><span class="line">      type: lvm_partition</span><br><span class="line">      id: lvm-partition-lv-root</span><br><span class="line">    - fstype: ext4</span><br><span class="line">      volume: lvm-partition-lv-root</span><br><span class="line">      preserve: false</span><br><span class="line">      type: format</span><br><span class="line">      id: format-2</span><br><span class="line">    - path: /</span><br><span class="line">      device: format-2</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-3</span><br><span class="line">    - path: /boot</span><br><span class="line">      device: format-0</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-1</span><br><span class="line">    - path: /boot/efi</span><br><span class="line">      device: format-partition-sda1</span><br><span class="line">      type: mount</span><br><span class="line">      id: mount-0</span><br><span class="line">    swap:</span><br><span class="line">      swap: 0</span><br><span class="line">  updates: security</span><br><span class="line">  # 安装完成后，需要执行的指令</span><br><span class="line">  late-commands:</span><br><span class="line">    # NTP服务修改</span><br><span class="line">    - </span><br><span class="line">  version: 1</span><br></pre></td></tr></table></figure>
<p>这份文件需要修改的地方是 “serial: VBOX_HARDDISK_VB84cd466a-d1bb429d”,这个值每一个机器都是独一份的，配置文件中不能复用，否则会报错。</p>
<p>最终的应答文件为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="comment"># 不自动更新OS版本</span></span><br><span class="line">  <span class="attr">refresh-installer:</span></span><br><span class="line">    <span class="attr">update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 必要格式，当前版本为1</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># 禁用security仓库</span></span><br><span class="line">    <span class="comment"># disable_suites: [security]</span></span><br><span class="line">    <span class="attr">geoip:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">preserve_sources_list:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 配置</span></span><br><span class="line">    <span class="attr">primary:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">amd64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">i386</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://ports.ubuntu.com/ubuntu-ports</span></span><br><span class="line">  <span class="attr">drivers:</span></span><br><span class="line">    <span class="attr">install:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 主机名与用户</span></span><br><span class="line">  <span class="attr">identity:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu-server-uefi-img</span></span><br><span class="line">    <span class="comment"># 基于 SHA-512 的密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span></span><br><span class="line">    <span class="attr">realname:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testuser</span></span><br><span class="line">  <span class="comment"># 时区设置</span></span><br><span class="line">  <span class="attr">timezone:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  <span class="attr">kernel:</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">linux-generic</span></span><br><span class="line">  <span class="attr">keyboard:</span></span><br><span class="line">    <span class="attr">layout:</span> <span class="string">us</span></span><br><span class="line">    <span class="attr">toggle:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">locale:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># 网络配置</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">ethernets:</span></span><br><span class="line">      <span class="attr">enp0s3:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">        <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">        <span class="attr">nameservers:</span></span><br><span class="line">          <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">          <span class="attr">search:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rohman.com</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># SSH配置</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">allow-pw:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorized-keys:</span> []</span><br><span class="line">    <span class="attr">install-server:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 存储配置</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ptable:</span> <span class="string">gpt</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/dev/sda</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock-recursive</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">disk</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">disk-sda</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">564133888</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">boot</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1073741824</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">vfat</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">9097445376</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vg-root</span></span><br><span class="line">      <span class="attr">devices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">partition-sda3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_volgroup</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-swap</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">2147483648B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">swap</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-root</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">5368709120B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot/efi</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-0</span></span><br><span class="line">    <span class="attr">swap:</span></span><br><span class="line">      <span class="attr">swap:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 安装完成后执行的指令</span></span><br><span class="line">  <span class="attr">late-commands:</span></span><br><span class="line">  <span class="comment"># 根目录在/target中</span></span><br><span class="line">    <span class="comment"># DNS恢复</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.3/8.8.8.8/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.4/8.8.4.4/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="comment"># NTP设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#NTP=/NTP=ntp.ntsc.ac.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#FallbackNTP=ntp.ubuntu.com/FallbackNTP=edu.ntp.org.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">timedatectl</span> <span class="string">set-ntp</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># sudo权限</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;testuser ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/sudoers</span></span><br><span class="line">    <span class="comment"># OpenFile设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* soft nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* hard nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#DefaultLimitNOFILE=/DefaultLimitNOFILE=819200/g&quot;</span> <span class="string">/target/etc/systemd/user.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;DefaultLimitNOFILE=819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/systemd/system.conf</span></span><br><span class="line">    <span class="comment"># 不更新内核</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-image-generic</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-headers-generic</span></span><br><span class="line">    <span class="comment"># 拷贝脚本</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cp</span> <span class="string">/cdrom/server-init.sh</span> <span class="string">/target/root/</span></span><br><span class="line">  <span class="comment"># 重启</span></span><br><span class="line">  <span class="attr">shutdown:</span> <span class="string">reboot</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="引导文件-grub-cfg"><a href="#引导文件-grub-cfg" class="headerlink" title="引导文件 grub.cfg"></a>引导文件 grub.cfg</h4><p>ISO的引导文件放置在 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ fsck.mode&#x3D;skip 字段；关键字段是 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ 这个是自动安装的关键。</p>
</blockquote>
<p>最终版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Automatic][UEFI]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Manual]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="系统初始化脚本"><a href="#系统初始化脚本" class="headerlink" title="系统初始化脚本"></a>系统初始化脚本</h4><p>完成安装后，我们还需要进入OS内执行初始化指令，比如修改主机名、IP之类的。<br>脚本为server-init.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line"><span class="comment"># Description: Init servername and IP.</span></span><br><span class="line"><span class="comment"># Date:2025-03-30</span></span><br><span class="line"><span class="comment"># Version:v1</span></span><br><span class="line"><span class="comment"># ScriptName:server-init.sh</span></span><br><span class="line"><span class="comment"># Args: servername ip</span></span><br><span class="line"><span class="comment"># Example: bash server-init.sh test001 1.2.3.4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Servername is <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerIP is <span class="variable">$2</span>&quot;</span></span><br><span class="line">hostname=<span class="variable">$1</span></span><br><span class="line">ip=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -n1 -p <span class="string">&quot;Is that information correct?(y/n)&quot;</span> KEY</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$KEY</span> <span class="keyword">in</span></span><br><span class="line">Y | y)</span><br><span class="line">    hostnamectl set-hostname <span class="variable">$hostname</span>;</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.1/<span class="variable">$ip</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    gateway4=$(<span class="built_in">echo</span> <span class="variable">$ip</span> | awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.254&quot;&#125;&#x27;</span>)</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.2/<span class="variable">$gateway4</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    netplan apply</span><br><span class="line">    apt-mark hold linux-headers-generic</span><br><span class="line">    apt-mark hold linux-image-generic</span><br><span class="line">    ;;</span><br><span class="line">N | n)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Cancel&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR VALUE!&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h4 id="重新封装ISO文件"><a href="#重新封装ISO文件" class="headerlink" title="重新封装ISO文件"></a>重新封装ISO文件</h4><p>这里使用的工具是 UltraISO 工具，用此工具打开原ISO文件，主要放入的四个文件：</p>
<ol>
<li>grub.cfg文件，要替换 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg ；</li>
<li>user-data应答文件，要放入  &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>meta-data应答文件的元数据文件，要放入 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>server-init.sh放入&#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
</ol>
<p>确认放入后，点击保存即可。</p>
<h4 id="虚拟机验证测试"><a href="#虚拟机验证测试" class="headerlink" title="虚拟机验证测试"></a>虚拟机验证测试</h4><p>VirtualBox创建虚拟机，挂载ISO文件。预期内应该能自动完成安装。</p>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><h5 id="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"><a href="#问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题" class="headerlink" title="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"></a>问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash ，搜索Error字段，发现明显的提示 RuntimeError: type:disk id&#x3D;disk-sda has both wipe and preserve</p>
<h6 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h6><p>应答文件中写得有冲突，在存储配置里面，有关于 磁盘是否要保留数据的参数 preserve 参数，填写了 true；<br>新硬盘正常不应该会存在分区，填写了包留分区，则会有冲突，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">preserve: true, false</span><br><span class="line"></span><br><span class="line">When the preserve key is present and set to true curtin will attempt reuse the existing storage device. Curtin will verify aspects of the device against the configuration provided. </span><br><span class="line">For example, when assessing whether curtin can use a preserved partition, curtin checks that the device exists, size of the partition matches the value in the config and checks if the same partition flag is set. </span><br><span class="line">The set of verification checks vary by device type. If curtin encounters a mismatch between config and what is found on the device a RuntimeError will be raised with the expected and found values and halt the installation. </span><br></pre></td></tr></table></figure>

<p>第二个关键参数，wipe;当wipe指定了内容，则是要格式化磁盘，所有内容均会被抹除；原配置文件中带有wipe参数，但是preserve又填为true，因此导致前后冲突。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wipe: superblock, superblock-recursive, pvremove, zero, random</span><br><span class="line"></span><br><span class="line">If wipe is specified, the disk contents will be destroyed. In the case that a disk is a part of virtual block device, like bcache, RAID array, or LVM, then curtin will attempt to tear down the virtual device to allow access to the disk for resetting the disk.</span><br><span class="line"></span><br><span class="line">The most common option for clearing a disk is wipe: superblock. In some cases use of wipe: superblock-recursive is useful to ensure that embedded superblocks on a disk aren’t rediscovered during probing. For example, LVM, bcache and RAID on a partition would have metadata outside of the range of a superblock wipe of the start and end sections of the disk.</span><br><span class="line"></span><br><span class="line">The wipe: zero option will write zeros to each sector of the disk. Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: random option will write pseudo-random data from /dev/urandom Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: pvremove option will execute the pvremove command to wipe the LVM metadata so that the device is no longer part of an LVM.</span><br></pre></td></tr></table></figure>

<h6 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h6><p>将 preserve: true 全部改成 preserve: false;</p>
<h5 id="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"><a href="#问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足" class="headerlink" title="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"></a>问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看日志，搜索ERROR字段，发现有FAIL:configuring storage;</p>
<h6 id="原因分析-1"><a href="#原因分析-1" class="headerlink" title="原因分析"></a>原因分析</h6><p>目标磁盘sda空间不足，导致无法继续分配空间；</p>
<h6 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1，修改应答文件，将空间缩小；<br>方法2，修改磁盘大小，将初始容量扩大；</p>
<h5 id="问题3：卡在downloading-and-installing-security-updates"><a href="#问题3：卡在downloading-and-installing-security-updates" class="headerlink" title="问题3：卡在downloading and installing security updates"></a>问题3：卡在downloading and installing security updates</h5><p>Log显示downloading and installing security updates</p>
<h6 id="原因分析-2"><a href="#原因分析-2" class="headerlink" title="原因分析"></a>原因分析</h6><p>安装过程中，服务器网络正常可以访问外网则会自动拉取安全更新。</p>
<h6 id="解决方法-2"><a href="#解决方法-2" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1：安装过程中使网络异常，安装完成后再解除；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp0s3:</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我个人更倾向使用此方法，安装完毕后，再到操作系统执行初始化脚本 server-init.sh</p>
</blockquote>
<p>方法2：禁用apt的security仓库；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line"> <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="attr">disable_suites:</span> [<span class="string">security</span>]</span><br></pre></td></tr></table></figure>

<p>但这个会导致默认的源文件会少 security 仓库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span><br><span class="line"># newer versions of the distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"></span><br><span class="line">## Major bug fix updates produced after the final release of the</span><br><span class="line">## distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team. Also, please note that software in universe WILL NOT receive any</span><br><span class="line">## review or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team, and may not be under a free licence. Please satisfy yourself as to</span><br><span class="line">## your rights to use the software. Also, please note that software in</span><br><span class="line">## multiverse WILL NOT receive any review or updates from the Ubuntu</span><br><span class="line">## security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository may not have been tested as</span><br><span class="line">## extensively as that contained in the main release, although it includes</span><br><span class="line">## newer versions of some applications which may provide useful features.</span><br><span class="line">## Also, please note that software in backports WILL NOT receive any review</span><br><span class="line">## or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">## Uncomment the following two lines to add software from Canonical&#x27;s</span><br><span class="line">## &#x27;partner&#x27; repository.</span><br><span class="line">## This software is not part of Ubuntu, but is offered by Canonical and the</span><br><span class="line">## respective vendors as a service to Ubuntu users.</span><br><span class="line"># deb http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"># deb-src http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"></span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《制作自动安装Ubuntu22.04-server的iso镜像以及安装过程详解》： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luokeli0755/p/17861638.html">https://www.cnblogs.com/luokeli0755/p/17861638.html</a><br>《grub2详解(翻译和整理官方手册)》：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7094693.html">https://www.cnblogs.com/f-ck-need-u/p/7094693.html</a><br>《如何使用 autoinstall 编写和执行 Ubuntu 无人值守安装》：<a target="_blank" rel="noopener" href="https://cn.linux-console.net/?p=33717">https://cn.linux-console.net/?p=33717</a><br>《Ubuntu&#x2F;Debian无人值守 Autoinstall》：<a target="_blank" rel="noopener" href="https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html">https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html</a><br>《配置界面存储的语法Storage》：<a target="_blank" rel="noopener" href="https://curtin.readthedocs.io/en/latest/topics/storage.html">https://curtin.readthedocs.io/en/latest/topics/storage.html</a><br>《Ubuntu的autoinstall自动安装配置》<a target="_blank" rel="noopener" href="https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html">https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html</a><br>《ubuntu20.04打包iso镜像自动安装》 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/super-age/p/14952469.html">https://www.cnblogs.com/super-age/p/14952469.html</a><br>《Ubuntu无人值守安装保姆级教程》 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/1886733079500007398">https://zhuanlan.zhihu.com/p/1886733079500007398</a><br>《NoCloud》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html">https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html</a><br>《User-data formats》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats">https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats</a><br>《Autoinstall configuration reference manual》<a target="_blank" rel="noopener" href="https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html">https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html</a><br>《how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config》<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config">https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/c58cc2d9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/c58cc2d9/" class="post-title-link" itemprop="url">vCenter报vapi-endpoint status告警</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-26 11:43:54 / Modified: 15:09:43" itemprop="dateCreated datePublished" datetime="2025-03-26T11:43:54+00:00">2025-03-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><h2 id="vCenter有告警"><a href="#vCenter有告警" class="headerlink" title="vCenter有告警"></a>vCenter有告警</h2><p>在vCenter中，选中事件页面，会出现VMware vAPI Endpoint 服务运行状况报警：xxxxx</p>
<h2 id="5480管理后台有告警"><a href="#5480管理后台有告警" class="headerlink" title="5480管理后台有告警"></a>5480管理后台有告警</h2><p>在 vCenter IP:5480 页面，会出现VMware vAPId Endpoint 服务异常；<br>访问 https:&#x2F;&#x2F;[vCenter IP]&#x2F;vapiendpoint&#x2F;health，看到有Yellow提示；</p>
<h2 id="PowerCLI无法创建标签"><a href="#PowerCLI无法创建标签" class="headerlink" title="PowerCLI无法创建标签"></a>PowerCLI无法创建标签</h2><p>使用 New-TagCategory 指令创建标签目录，会出现“com.vmware.vapi.std.errors.operation_not_found”提示，但执行完后，可以在vCenter中看到Tag目录；<br>使用 New-Tag 指定刚才创建的Tag目录，则会创建失败，提示值不能为null；</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><ol>
<li>日志目录 &#x2F;var&#x2F;log&#x2F;vmware&#x2F;vapi&#x2F;endpoint&#x2F; 查找有无可靠信息;</li>
<li>查看证书是否过期;</li>
</ol>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><h2 id="日志排查【待补充】"><a href="#日志排查【待补充】" class="headerlink" title="日志排查【待补充】"></a>日志排查【待补充】</h2><h2 id="更新证书"><a href="#更新证书" class="headerlink" title="更新证书"></a>更新证书</h2><p>我实际在排查的时候，发现有证书过期，因此做了证书更新：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新证书参照此前写过的文章：《VCSA-503故障-证书到期》 https://rohman-zhu.github.io/posts/aae56061/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查：</span></span><br><span class="line"><span class="keyword">for</span> store <span class="keyword">in</span> $(/usr/lib/vmware-vmafd/bin/vecs-cli store list | grep -v TRUSTED_ROOT_CRLS); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;[*] Store :&quot;</span> <span class="variable">$store</span>; /usr/lib/vmware-vmafd/bin/vecs-cli entry list --store <span class="variable">$store</span> --text | grep -ie <span class="string">&quot;Alias&quot;</span> -ie <span class="string">&quot;Not After&quot;</span>;<span class="keyword">done</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换：</span></span><br><span class="line">/usr/lib/vmware-vmca/bin/certificate-manager</span><br><span class="line"><span class="comment"># 选择4,Regenerate a new VMCA Root Certificate and replace all certificates。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>附：check-trust-anchors 脚本内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本来自 https://web.vmware-labs.com/scripts/check-trust-anchors</span></span><br><span class="line"><span class="comment"># 执行方式：检查 ./脚本.sh -cml</span></span><br><span class="line"><span class="comment"># 执行方式：修复 ./脚本.sh -cmlf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---脚本内容--- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#------------------------------</span></span><br><span class="line"><span class="comment"># Script to check and fix SSL trust achors</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: Vincent Santa Maria [vsantamaria@vmware.com]</span></span><br><span class="line"><span class="comment"># Version: 2.1</span></span><br><span class="line"><span class="comment">#------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setOptionColorize</span></span>() &#123;</span><br><span class="line">   RED=$(tput setaf 1)</span><br><span class="line">   GREEN=$(tput setaf 2)</span><br><span class="line">   YELLOW=$(tput setaf 3)</span><br><span class="line">   CYAN=$(tput setaf 6)</span><br><span class="line">   NORMAL=$(tput sgr0)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">unknownOption</span></span>() &#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Unknown option &#x27;<span class="variable">$2</span>&#x27;. Please see &#x27;<span class="variable">$1</span> --help&#x27; for usage and available options&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CURRENT_SERVICE_ID=<span class="string">&#x27;&#x27;</span></span><br><span class="line">SHOW_SERVICE_IDS=0</span><br><span class="line">SHOW_ENDPOINTS=0</span><br><span class="line">SHOW_DUPLICATE_ENDPOINTS=0</span><br><span class="line">LIVE_CHECK=0</span><br><span class="line">VIEW_MACHINE_SSL=0</span><br><span class="line">DEBUG=0</span><br><span class="line">FIX=0</span><br><span class="line">TP_ALGORITHM=<span class="string">&quot;sha1&quot;</span></span><br><span class="line">TP_REGEX_ITER=<span class="string">&quot;19&quot;</span></span><br><span class="line">CERT_TEXT=0</span><br><span class="line">CERT_COUNT=1</span><br><span class="line">RED=<span class="string">&#x27;&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;&#x27;</span></span><br><span class="line">CYAN=<span class="string">&#x27;&#x27;</span></span><br><span class="line">NORMAL=<span class="string">&#x27;&#x27;</span></span><br><span class="line">LSTOOL_FILE=<span class="string">&#x27;lstool.txt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;LIVE_CHECK&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">   VC_VERSION=$(grep <span class="string">&#x27;CLOUDVM_VERSION:&#x27;</span> /etc/vmware/.buildInfo | awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | awk -F<span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   VC_VERSION=$(grep <span class="string">&#x27;CLOUDVM_VERSION:&#x27;</span> ../etc/vmware/.buildInfo | awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | awk -F<span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;VC_VERSION&#125;</span> -eq 7 ]]; <span class="keyword">then</span></span><br><span class="line">   LS_PORT=<span class="string">&#x27;7090&#x27;</span></span><br><span class="line">   LSTOOL_SCRIPT=<span class="string">&#x27;/usr/lib/vmware-lookupsvc/tools/lstool.py&#x27;</span></span><br><span class="line">   LSUPDATE_SCRIPT=<span class="string">&#x27;/usr/lib/vmware-lookupsvc/tools/ls_update_certs.py&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   LS_PORT=<span class="string">&#x27;7080&#x27;</span></span><br><span class="line">   LSTOOL_SCRIPT=<span class="string">&#x27;/usr/lib/vmidentity/tools/scripts/lstool.py&#x27;</span></span><br><span class="line">   LSUPDATE_SCRIPT=<span class="string">&#x27;/usr/lib/vmidentity/tools/scripts/ls_update_certs.py&#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f /usr/bin/ldapsearch ]; <span class="keyword">then</span></span><br><span class="line">   LDAPSEARCH=<span class="string">&#x27;/usr/bin/ldapsearch&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   LDAPSEARCH=<span class="string">&#x27;/opt/likewise/bin/ldapsearch&#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -ge 1 ]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">case</span> <span class="variable">$&#123;arg&#125;</span> <span class="keyword">in</span></span><br><span class="line">         -h|--<span class="built_in">help</span>)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;SSL Trust Anchor Verification and Remediation Script&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> [options]&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Options:&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -s | --show-service-ids   Shows the Service IDs that are using a particular SSL certificate.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -e | --show-endpoints     Shows the Endpoing URIs that are using a particular SSL certificate.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -c | --colorize           Colorizes text for quick identification of Subject field, SHA1/SHA256 Fingerprint, or&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             expired certificates. Do not use if passing output to a paginator or file.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -l | --live-check         Used when running the script on a live system, which will automatically dump the&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             Lookup Service registrations to /tmp. Must be used with the fix (-f|--fix) option.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -m | --machine-ssl        Will display information on the current Machine SSL ceritifcate. Cannot be run on&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             a support bundle from an external Platform Services Controller.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -t | --cert-text          Will provide full output of each certificate similar to &#x27;openssl x509 -text&#x27;&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -f | --fix                Will prompt for SSO credentials, thumbprint of a trust anchor cert to update, and the IP/FQDN&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             of a node to update.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -d | --debug              Will include the raw certificate hash to see if there are any extra characters&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             (sometimes the lstool.py script has connection issues and STDERR gets randomly&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;                             inserted in the output).&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -h | --help               Prints this help menu.&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;   -2 | --sha256             Outputs the SHA256 thumbprint of the certificates instead of the SHA1 thumbprint&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Parses the output of the following command from the Platform Services Controller:&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;LSTOOL_SCRIPT&#125;</span> list --url http://localhost:<span class="variable">$&#123;LS_PORT&#125;</span>/lookupservice/sdk 2&gt;/dev/null&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Can be run from the &#x27;commands/&#x27; directory of a support bundle, or live on a PSC node.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span></span><br><span class="line">            ;;</span><br><span class="line"></span><br><span class="line">         --show-service-ids)</span><br><span class="line">            SHOW_SERVICE_IDS=1</span><br><span class="line">            ;;</span><br><span class="line"></span><br><span class="line">         --show-endpoints)</span><br><span class="line">            SHOW_ENDPOINTS=1</span><br><span class="line">            ;;</span><br><span class="line">         --colorize)</span><br><span class="line">            setOptionColorize</span><br><span class="line">            ;;</span><br><span class="line">         --live-check)</span><br><span class="line">            LIVE_CHECK=1</span><br><span class="line">            ;;</span><br><span class="line">         --machine-ssl)</span><br><span class="line">            VIEW_MACHINE_SSL=1</span><br><span class="line">            ;;</span><br><span class="line">         --debug)</span><br><span class="line">            DEBUG=1</span><br><span class="line">            ;;</span><br><span class="line">         --cert-text)</span><br><span class="line">            CERT_TEXT=1</span><br><span class="line">            ;;</span><br><span class="line">         --fix)</span><br><span class="line">            FIX=1</span><br><span class="line">            ;;</span><br><span class="line">         --sha256)</span><br><span class="line">            TP_ALGORITHM=<span class="string">&quot;sha256&quot;</span></span><br><span class="line">            TP_REGEX_ITER=<span class="string">&quot;31&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">         -[seclmfdt2]*)</span><br><span class="line">            OPT=$(<span class="built_in">echo</span> <span class="string">&quot;z<span class="variable">$&#123;arg&#125;</span>&quot;</span> | sed <span class="string">&#x27;s/z-//&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> (( i=<span class="number">0</span>; i&lt;<span class="variable">$&#123;#OPT&#125;</span>; i++ )); <span class="keyword">do</span></span><br><span class="line">               <span class="keyword">case</span> <span class="variable">$&#123;OPT:$i:1&#125;</span> <span class="keyword">in</span></span><br><span class="line">                  s)</span><br><span class="line">                     SHOW_SERVICE_IDS=1</span><br><span class="line">                     ;;</span><br><span class="line">                  e)</span><br><span class="line">                     SHOW_ENDPOINTS=1</span><br><span class="line">                     ;;</span><br><span class="line">                  c)</span><br><span class="line">                     setOptionColorize</span><br><span class="line">                     ;;</span><br><span class="line">                  d)</span><br><span class="line">                     DEBUG=1</span><br><span class="line">                     ;;</span><br><span class="line">                  l)</span><br><span class="line">                     LIVE_CHECK=1</span><br><span class="line">                     ;;</span><br><span class="line">                  m)</span><br><span class="line">                     VIEW_MACHINE_SSL=1</span><br><span class="line">                     ;;</span><br><span class="line">                  t)</span><br><span class="line">                     CERT_TEXT=1</span><br><span class="line">                     ;;              </span><br><span class="line">                  f)</span><br><span class="line">                     FIX=1</span><br><span class="line">                     ;;</span><br><span class="line">                  2)</span><br><span class="line">                     TP_ALGORITHM=<span class="string">&quot;sha256&quot;</span></span><br><span class="line">                     TP_REGEX_ITER=<span class="string">&quot;31&quot;</span></span><br><span class="line">                     ;;</span><br><span class="line">                  *)</span><br><span class="line">                     unknownOption <span class="variable">$0</span> <span class="string">&#x27;-$&#123;OPT:$i:1&#125;&#x27;</span></span><br><span class="line">                     <span class="built_in">exit</span></span><br><span class="line">                     ;;</span><br><span class="line">               <span class="keyword">esac</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">            ;;</span><br><span class="line">         *)</span><br><span class="line">            unknownOption <span class="variable">$0</span> <span class="variable">$&#123;arg&#125;</span></span><br><span class="line">            <span class="built_in">exit</span></span><br><span class="line">            ;;</span><br><span class="line">      <span class="keyword">esac</span></span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;LIVE_CHECK&#125;</span> -eq 0 ]]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">if</span> [ ! -f <span class="variable">$&#123;LSTOOL_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ ! -f <span class="string">&quot;python.exe_VMWARE_CIS_HOMEVMwareIdentityServiceslstoolscriptslstoolpy-list---url-httplocalhost7080lo[...].txt&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>No output from &#x27;lstool.py list&#x27; found in this bundle.&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         LSTOOL_FILE=<span class="string">&#x27;python.exe_VMWARE_CIS_HOMEVMwareIdentityServiceslstoolscriptslstoolpy-list---url-httplocalhost7080lo[...].txt&#x27;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">if</span> [ -f ../etc/vmware/deployment.node.type ]; <span class="keyword">then</span></span><br><span class="line">      NODE_TYPE=$(<span class="built_in">cat</span> ../etc/vmware/deployment.node.type)</span><br><span class="line">   <span class="keyword">elif</span> [ -f ../ProgramData/VMware/vCenterServer/cfg/deployment.node.type ]; <span class="keyword">then</span></span><br><span class="line">      NODE_TYPE=$(<span class="built_in">cat</span> ../ProgramData/VMware/vCenterServer/cfg/deployment.node.type)</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   NODE_TYPE=$(<span class="built_in">cat</span> /etc/vmware/deployment.node.type)</span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$&#123;NODE_TYPE&#125;</span> == <span class="string">&#x27;management&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Operation not supported on a Management Node. Please run this live on a PSC node. Exiting...<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">exit</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> [ ! -f <span class="variable">$&#123;LSTOOL_FILE&#125;</span> ]; <span class="keyword">then</span> LSTOOL_FILE=<span class="string">&#x27;/tmp/lstool.txt&#x27;</span>; <span class="keyword">fi</span></span><br><span class="line">      </span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>No &#x27;lstool.txt&#x27; file found in this directory. Dumping service registrations to <span class="variable">$&#123;LSTOOL_FILE&#125;</span>...<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">   <span class="variable">$&#123;LSTOOL_SCRIPT&#125;</span> list --url http://localhost:<span class="variable">$&#123;LS_PORT&#125;</span>/lookupservice/sdk 2&gt;/tmp/lstool_stderr &gt; <span class="variable">$&#123;LSTOOL_FILE&#125;</span>      </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">DATA=$(<span class="built_in">cat</span> <span class="variable">$&#123;LSTOOL_FILE&#125;</span> | grep -vE <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span> | grep -E <span class="string">&#x27;Service ID:|URL:|SSL trust:|^[0-9A-Za-z/\+]&#x27;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\t&#x27;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\r\n&#x27;</span> | sed -e <span class="string">&#x27;s/ServiceID:/\nServiceID:/g&#x27;</span> -e <span class="string">&#x27;s/URL:/\nURL:/g&#x27;</span> -e <span class="string">&#x27;s/SSLtrust:/\nSSLtrust:/g&#x27;</span>)</span><br><span class="line">TRUST_ANCHORS=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;DATA&#125;</span>&quot;</span> | grep <span class="string">&#x27;SSLtrust&#x27;</span> | sed -e <span class="string">&#x27;s/SSLtrust://g&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> RAW_HASH <span class="keyword">in</span> <span class="variable">$&#123;TRUST_ANCHORS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>-----Endpoint Certificate <span class="variable">$&#123;CERT_COUNT&#125;</span>-----<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$&#123;RAW_HASH&#125;</span> =~ [0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125; ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>Malformed hash detected<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      BAD=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;RAW_HASH&#125;</span>&quot;</span> | grep -oE <span class="string">&#x27;[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;(.)+&#x27;</span>)</span><br><span class="line">      HASH=<span class="string">&quot;<span class="subst">$(echo <span class="string">&quot;<span class="variable">$&#123;RAW_HASH&#125;</span>&quot;</span> | sed -e &#x27;s/$&#123;BAD&#125;//&#x27;)</span>&quot;</span></span><br><span class="line">      CHARS=<span class="variable">$&#123;#HASH&#125;</span></span><br><span class="line">      MOD=$((<span class="variable">$&#123;CHARS&#125;</span> % <span class="number">4</span>))</span><br><span class="line">      <span class="keyword">case</span> <span class="variable">$&#123;MOD&#125;</span> <span class="keyword">in</span></span><br><span class="line">         3)</span><br><span class="line">            HASH=<span class="string">&quot;<span class="variable">$&#123;HASH&#125;</span>=&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">         2)</span><br><span class="line">            HASH=<span class="string">&quot;<span class="variable">$&#123;HASH&#125;</span>==&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">      <span class="keyword">esac</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      HASH=<span class="variable">$&#123;RAW_HASH&#125;</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">   CURRENT_CERT=<span class="string">&quot;-----BEGIN CERTIFICATE-----&quot;</span>$<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">   CURRENT_CERT+=$(<span class="built_in">echo</span> <span class="variable">$&#123;HASH&#125;</span> | <span class="built_in">fold</span> -c64)</span><br><span class="line">   CURRENT_CERT+=$<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;-----END CERTIFICATE-----&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT&#125;</span>&quot;</span> | openssl x509 -text &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [[ <span class="variable">$&#123;CERT_TEXT&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">         CURRENT_CERT_INFO=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT&#125;</span>&quot;</span> | openssl x509 -text -noout -fingerprint -<span class="variable">$&#123;TP_ALGORITHM&#125;</span> | sed -e <span class="string">&#x27;s/SHA[0-9]* Fingerprint/\t&amp;/g&#x27;</span> -e <span class="string">&quot;s/Subject:/<span class="variable">$&#123;GREEN&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span> -e <span class="string">&quot;s/[[:xdigit:]]\&#123;2\&#125;\(:[[:xdigit:]]\&#123;2\&#125;\)\&#123;<span class="variable">$&#123;TP_REGEX_ITER&#125;</span>\&#125;/<span class="variable">$&#123;YELLOW&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span> -e <span class="string">&quot;s/X509v3 Subject Alternative Name/<span class="variable">$&#123;GREEN&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span>)</span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT_INFO&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         CURRENT_CERT_INFO=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT&#125;</span>&quot;</span> | openssl x509 -text -noout -fingerprint -<span class="variable">$&#123;TP_ALGORITHM&#125;</span> | grep -E <span class="string">&#x27;Issuer:|Subject:|Validity|Not Before:|Not After :|Fingerprint&#x27;</span> | sed -e <span class="string">&#x27;s/SHA[0-9]* Fingerprint/\t&amp;/g&#x27;</span> -e <span class="string">&quot;s/Subject:/<span class="variable">$&#123;GREEN&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span> -e <span class="string">&quot;s/[[:xdigit:]]\&#123;2\&#125;\(:[[:xdigit:]]\&#123;2\&#125;\)\&#123;<span class="variable">$&#123;TP_REGEX_ITER&#125;</span>\&#125;/<span class="variable">$&#123;YELLOW&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span>)</span><br><span class="line"></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;Certificate Info:&quot;</span></span><br><span class="line">         <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT&#125;</span>&quot;</span> | openssl x509 -noout -checkend 0; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT_INFO&#125;</span>&quot;</span></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_CERT_INFO&#125;</span>&quot;</span> | sed -e <span class="string">&quot;s/Not Before/<span class="variable">$&#123;RED&#125;</span>&amp;/&quot;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">         <span class="keyword">if</span> [[ <span class="variable">$&#123;DEBUG&#125;</span> -gt 0 ]]; <span class="keyword">then</span> <span class="built_in">echo</span> $<span class="string">&#x27;\t&#x27;</span><span class="string">&quot;Certificate Hash: <span class="variable">$&#123;HASH&#125;</span>&quot;</span>; <span class="keyword">fi</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>Unable to parse certificate hash<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">if</span> [[ <span class="variable">$&#123;DEBUG&#125;</span> -gt 0 ]]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;HASH&#125;</span>&quot;</span>; <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$&#123;SHOW_SERVICE_IDS&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">      REGEX_HASH=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;RAW_HASH&#125;</span>&quot;</span> | sed -e <span class="string">&#x27;s/\+/\\+/g&#x27;</span> -e <span class="string">&#x27;s/\$/\\$/g&#x27;</span>)</span><br><span class="line">      FOUND_SERVICE_IDS=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> line <span class="keyword">in</span> $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;DATA&#125;</span>&quot;</span> | grep -vE <span class="string">&#x27;^URL:&#x27;</span> | <span class="built_in">uniq</span> | grep -E <span class="string">&quot;ServiceID|<span class="variable">$&#123;REGEX_HASH&#125;</span>&quot;</span> | grep -B1 <span class="variable">$&#123;RAW_HASH&#125;</span>); <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> =~ ^ServiceID ]]; <span class="keyword">then</span></span><br><span class="line">            CURRENT_SERVICE_ID=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | sed -e <span class="string">&#x27;s/ServiceID://g&#x27;</span>)</span><br><span class="line">         <span class="keyword">elif</span> $(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="variable">$&#123;RAW_HASH&#125;</span> &gt; /dev/null); <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;FOUND_SERVICE_IDS&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">               FOUND_SERVICE_IDS=$<span class="string">&#x27;\t&#x27;</span><span class="string">&quot;<span class="variable">$&#123;CURRENT_SERVICE_ID&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">               FOUND_SERVICE_IDS+=$<span class="string">&#x27;\n\t&#x27;</span><span class="string">&quot;<span class="variable">$&#123;CURRENT_SERVICE_ID&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">      NUM_FOUND_SERVICE_IDS=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;FOUND_SERVICE_IDS&#125;</span>&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Service IDs (<span class="variable">$&#123;NUM_FOUND_SERVICE_IDS&#125;</span>):&quot;</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;FOUND_SERVICE_IDS&#125;</span>&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$&#123;SHOW_ENDPOINTS&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">      ENDPOINTS=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;DATA&#125;</span>&quot;</span> | grep -vE <span class="string">&#x27;^ServiceID&#x27;</span> | grep -B1 <span class="variable">$&#123;RAW_HASH&#125;</span> | grep -E <span class="string">&#x27;^URL:&#x27;</span> | sed -e <span class="string">&#x27;s/URL:/\t/g&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span>)</span><br><span class="line">      NUM_ENDPOINTS=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;ENDPOINTS&#125;</span>&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line"></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Endpoints (<span class="variable">$&#123;NUM_ENDPOINTS&#125;</span>):&quot;</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;ENDPOINTS&#125;</span>&quot;</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>--------------------------------<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">   ((++CERT_COUNT))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;VIEW_MACHINE_SSL&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$&#123;LIVE_CHECK&#125;</span> -eq 0 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;NODE_TYPE&#125;</span>&quot;</span> = <span class="string">&#x27;infrastructure&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>The Machine SSL certificate is not included in an external PSC support bundle.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         <span class="keyword">if</span> [ -f ../etc/vmware-vpx/ssl/rui.crt ]; <span class="keyword">then</span></span><br><span class="line">            MACHINE_SSL_FILE=<span class="string">&#x27;../etc/vmware-vpx/ssl/rui.crt&#x27;</span></span><br><span class="line">         <span class="keyword">elif</span> [ -f ../ProgramData/VMware/vCenterServer/cfg/vmware-vpx/ssl/rui.crt ]; <span class="keyword">then</span></span><br><span class="line">            MACHINE_SSL_FILE=<span class="string">&#x27;../ProgramData/VMware/vCenterServer/cfg/vmware-vpx/ssl/rui.crt&#x27;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> [ ! -z <span class="variable">$&#123;MACHINE_SSL_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>-----Machine SSL Certificate-----<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">            CURRENT_MACHINE_SSL_CERT_INFO=$(<span class="built_in">cat</span> <span class="variable">$&#123;MACHINE_SSL_FILE&#125;</span> | openssl x509 -text -noout -fingerprint -<span class="variable">$&#123;TP_ALGORITHM&#125;</span> | grep -E <span class="string">&#x27;Issuer:|Subject:|Validity|Not Before:|Not After :|Fingerprint&#x27;</span> | sed -e <span class="string">&#x27;s/SHA[0-9]* Fingerprint/\t&amp;/g&#x27;</span> -e <span class="string">&quot;s/Subject:/<span class="variable">$&#123;GREEN&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span> -e <span class="string">&quot;s/[[:xdigit:]]\&#123;2\&#125;\(:[[:xdigit:]]\&#123;2\&#125;\)\&#123;<span class="variable">$&#123;TP_REGEX_ITER&#125;</span>\&#125;/<span class="variable">$&#123;YELLOW&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Certificate Info:&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$&#123;MACHINE_SSL_FILE&#125;</span>&quot;</span> | openssl x509 -noout -checkend 0; <span class="keyword">then</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_MACHINE_SSL_CERT_INFO&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_MACHINE_SSL_CERT_INFO&#125;</span>&quot;</span> | sed -e <span class="string">&quot;s/Not Before/<span class="variable">$&#123;RED&#125;</span>&amp;/&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>---------------------------------<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Unable to locate the Machine SSL certificate file in the support bundle.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      SSO_DOMAIN=$(/usr/lib/vmware-vmafd/bin/vmafd-cli get-domain-name --server-name localhost)</span><br><span class="line">      SSO_SITE=$(/usr/lib/vmware-vmafd/bin/vmafd-cli get-site-name --server-name localhost)</span><br><span class="line">      VMDIR_DC_BRANCH=<span class="string">&quot;dc=<span class="subst">$(echo $&#123;SSO_DOMAIN&#125; | sed &#x27;s/\./,dc=/g&#x27;)</span>&quot;</span></span><br><span class="line">      VMDIR_MACHINE_PASSWORD=$(/opt/likewise/bin/lwregshell list_values <span class="string">&#x27;[HKEY_THIS_MACHINE\services\vmdir]&#x27;</span> | grep dcAccountPassword | awk -F<span class="string">&quot;  &quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | awk <span class="string">&#x27;&#123;print substr($0,2,length($0)-2)&#125;&#x27;</span> | sed -e <span class="string">&#x27;s/\\&quot;/&quot;/g&#x27;</span> -e <span class="string">&#x27;s/\\\\/\\/g&#x27;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span> &gt; /tmp/.vmdir_machine_account_password; <span class="built_in">chmod</span> go-r /tmp/.vmdir_machine_account_password)</span><br><span class="line">      VMDIR_MACHINE_ACCOUNT_DN=$(/opt/likewise/bin/lwregshell list_values <span class="string">&#x27;[HKEY_THIS_MACHINE\services\vmdir]&#x27;</span> | grep <span class="string">&#x27;&quot;dcAccountDN&quot;&#x27;</span> | awk -F<span class="string">&quot;  &quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | awk <span class="string">&#x27;&#123;print substr($0,2,length($0)-2)&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      SSO_NODES=()</span><br><span class="line">      PSC_NODES=$(<span class="variable">$LDAPSEARCH</span> -LLL -h localhost -p 389 -b <span class="string">&quot;ou=Domain Controllers,<span class="variable">$VMDIR_DC_BRANCH</span>&quot;</span> -D <span class="string">&quot;<span class="variable">$VMDIR_MACHINE_ACCOUNT_DN</span>&quot;</span> -y /tmp/.vmdir_machine_account_password <span class="string">&quot;(objectclass=computer)&quot;</span> cn | grep <span class="string">&#x27;^cn:&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">      PSC_COUNT=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;PSC_NODES&#125;</span>&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">      VCENTER_NODES=$(<span class="variable">$LDAPSEARCH</span> -LLL -h localhost -p 389 -b <span class="string">&quot;ou=Computers,<span class="variable">$VMDIR_DC_BRANCH</span>&quot;</span> -D <span class="string">&quot;<span class="variable">$VMDIR_MACHINE_ACCOUNT_DN</span>&quot;</span> -y /tmp/.vmdir_machine_account_password <span class="string">&quot;(objectclass=computer)&quot;</span> cn | grep <span class="string">&#x27;^cn:&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">      VCENTER_COUNT=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;VCENTER_NODES&#125;</span>&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">   </span><br><span class="line">      <span class="keyword">for</span> psc_node <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$PSC_NODES</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;SSO_NODES[@]&#125;</span>&quot;</span> =~ <span class="string">&quot;<span class="variable">$psc_node</span>&quot;</span> ]]; <span class="keyword">then</span> SSO_NODES+=(<span class="variable">$psc_node</span>); <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> vc_node <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$VCENTER_NODES</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;SSO_NODES[@]&#125;</span>&quot;</span> =~ <span class="string">&quot;<span class="variable">$vc_node</span>&quot;</span> ]]; <span class="keyword">then</span> SSO_NODES+=(<span class="variable">$vc_node</span>); <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">rm</span> /tmp/.vmdir_machine_account_password</span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> node <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;SSO_NODES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>-----Machine SSL Certificate-----<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span><span class="variable">$&#123;node&#125;</span><span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         CURRENT_MACHINE_SSL_CERT_INFO=$(<span class="built_in">echo</span> | openssl s_client -connect <span class="variable">$&#123;node&#125;</span>:443 2&gt;/dev/null | openssl x509 -text -noout -fingerprint -<span class="variable">$&#123;TP_ALGORITHM&#125;</span> 2&gt;/dev/null | grep -E <span class="string">&#x27;Issuer:|Subject:|Validity|Not Before:|Not After :|Fingerprint&#x27;</span> | sed -e <span class="string">&#x27;s/SHA[0-9]* Fingerprint/\t&amp;/g&#x27;</span> -e <span class="string">&quot;s/Subject:/<span class="variable">$&#123;GREEN&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span> -e <span class="string">&quot;s/[[:xdigit:]]\&#123;2\&#125;\(:[[:xdigit:]]\&#123;2\&#125;\)\&#123;<span class="variable">$&#123;TP_REGEX_ITER&#125;</span>\&#125;/<span class="variable">$&#123;YELLOW&#125;</span>&amp;<span class="variable">$&#123;NORMAL&#125;</span>/g&quot;</span>)</span><br><span class="line"></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;Certificate Info:&quot;</span></span><br><span class="line">         <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$CURRENT_MACHINE_SSL_CERT_INFO</span>&quot;</span> != <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">echo</span> | openssl s_client -connect <span class="variable">$&#123;node&#125;</span>:443 2&gt;/dev/null | openssl x509 -noout -checkend 0; <span class="keyword">then</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_MACHINE_SSL_CERT_INFO&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CURRENT_MACHINE_SSL_CERT_INFO&#125;</span>&quot;</span> | sed -e <span class="string">&quot;s/Not Before/<span class="variable">$&#123;RED&#125;</span>&amp;/&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\t&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Unable to retrieve certificate information from <span class="variable">$&#123;node&#125;</span><span class="variable">$&#123;NORMLA&#125;</span>&quot;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>---------------------------------<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;FIX&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">   <span class="keyword">if</span> [[ <span class="variable">$&#123;LIVE_CHECK&#125;</span> -gt 0 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ ! -f <span class="variable">$&#123;LSUPDATE_SCRIPT&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>The <span class="variable">$&#123;LSUPDATE_SCRIPT&#125;</span> script could not be found. Please ensure you are running this from a PSC.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">else</span>    </span><br><span class="line">         <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>SSL Trust Anchor Repair<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>---------------------------------<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;This process will attempt to update the SSL trust anchors for Lookup Service registrations using native Lookup Service libraries. These changes should propagate to all PSCs in the SSO domain.&quot;</span></span><br><span class="line">         <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>It is strongly recommended that you take offline snapshots of all PSCs in the SSO domain before proceeding.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">         <span class="built_in">read</span> -p $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Proceed with updating trust anchors? [Y/N]: &quot;</span> PROCEED</span><br><span class="line">         <span class="keyword">if</span> [ -z <span class="variable">$&#123;PROCEED&#125;</span> ]; <span class="keyword">then</span> PROCEED_FIX=<span class="string">&quot;n&quot;</span>; <span class="keyword">else</span> PROCEED_FIX=$(<span class="built_in">echo</span> <span class="variable">$&#123;PROCEED&#125;</span> | awk <span class="string">&#x27;&#123;print tolower(substr($0,0,1))&#125;&#x27;</span>); <span class="keyword">fi</span></span><br><span class="line">         <span class="keyword">if</span> [ <span class="variable">$&#123;PROCEED_FIX&#125;</span> == <span class="string">&quot;y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            SSO_DOMAIN=$(/usr/lib/vmware-vmafd/bin/vmafd-cli get-domain-name --server-name localhost)</span><br><span class="line">            <span class="built_in">read</span> -p $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Enter SSO admin [administrator@<span class="variable">$&#123;SSO_DOMAIN&#125;</span>]: &quot;</span> LOGIN</span><br><span class="line">            <span class="keyword">if</span> [ -z <span class="variable">$&#123;LOGIN&#125;</span> ]; <span class="keyword">then</span> LOGIN=<span class="string">&quot;administrator@<span class="variable">$&#123;SSO_DOMAIN&#125;</span>&quot;</span>; <span class="keyword">fi</span></span><br><span class="line">            <span class="built_in">read</span> -s -p <span class="string">&quot;Enter password for <span class="variable">$&#123;LOGIN&#125;</span>: &quot;</span> PASSWORD_INPUT</span><br><span class="line">            PASSWORD=$(<span class="built_in">echo</span> <span class="variable">$&#123;PASSWORD_INPUT&#125;</span> | sed <span class="string">&quot;s/&#x27;/&#x27;\\\&#x27;&#x27;/g&quot;</span>)</span><br><span class="line">            <span class="built_in">read</span> -p $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Enter fingerprint of trust anchor(s) to update: &quot;</span> FINGERPRINT</span><br><span class="line">            <span class="built_in">read</span> -p <span class="string">&quot;Enter the FQDN of the node to update: &quot;</span> NODE_FQDN</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&#x27;y&#x27;</span> | openssl s_client -connect <span class="variable">$&#123;NODE_FQDN&#125;</span>:443 2&gt;/dev/null | openssl x509 &gt; /tmp/machine-ssl.crt; <span class="keyword">then</span></span><br><span class="line">               <span class="keyword">if</span> ! <span class="variable">$&#123;LSUPDATE_SCRIPT&#125;</span> --url http://localhost:<span class="variable">$&#123;LS_PORT&#125;</span>/lookupservice/sdk 2&gt;/tmp/ls_update_certs.stderr --fingerprint <span class="variable">$&#123;FINGERPRINT&#125;</span> --certfile /tmp/machine-ssl.crt --user <span class="variable">$&#123;LOGIN&#125;</span>  --password $(<span class="built_in">eval</span> <span class="built_in">echo</span> <span class="string">&quot;&#x27;<span class="variable">$&#123;PASSWORD&#125;</span>&#x27;&quot;</span>); <span class="keyword">then</span></span><br><span class="line">                  <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>The ls_update_certs.py script encountered an error.&quot;</span></span><br><span class="line">                  <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Please refer to /tmp/ls_update_certs.stderr for more information.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">               <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Unable to obtain SSL certificate from <span class="variable">$&#123;NODE_FQDN&#125;</span>. Exiting...&quot;</span></span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;Operation aborted. Exiting...&quot;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> $<span class="string">&#x27;\n&#x27;</span><span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>Fixing trust anchors can only be done on a live system.<span class="variable">$&#123;NORMAL&#125;</span>&quot;</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>vCenter报vapi-endpoint status异常告警：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ximenjianxue/article/details/107629496">https://blog.csdn.net/ximenjianxue/article/details/107629496</a><br>“VMware vAPI Endpoint Service Health Alarm” due to the duplicate service registrations after upgrading vCenter to 7.0: <a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/313797/vmware-vapi-endpoint-service-health-alar.html">https://knowledge.broadcom.com/external/article/313797/vmware-vapi-endpoint-service-health-alar.html</a><br>vCenter cloud account datacollection fails in Aria Automation with “The connection with vAPI endpoint can not be established failedToLoginMaxUserSessionCountReached”: <a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/312158/vcenter-cloud-account-datacollection-fai.html">https://knowledge.broadcom.com/external/article/312158/vcenter-cloud-account-datacollection-fai.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/46120746/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/46120746/" class="post-title-link" itemprop="url">Horizon删除桌面池卡在-删除中</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-19 12:13:47 / Modified: 12:19:58" itemprop="dateCreated datePublished" datetime="2025-03-19T12:13:47+00:00">2025-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>进入Horizon管理后台（<a target="_blank" rel="noopener" href="https://horizon/">https://horizon</a> connection server ip&#x2F;admin），在桌面池中会有提示某一个桌面池在删除中，无法顺利正常删除。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>需要修改ADAM数据库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 打开 ADSI 编辑器，ADSI Edit;</span><br><span class="line">2. 选中“ADSI Edit”，右键，点击 Connect to...；</span><br><span class="line">3. 输入以下信息后，点击OK：</span><br><span class="line">- Name:View ADAM Database;</span><br><span class="line">- Select or <span class="built_in">type</span> a Distinguished Name or Naming Contest: dc=vdi,dc=vmware,dc=int;</span><br><span class="line">- Select or <span class="built_in">type</span> a domain or server:localhost</span><br><span class="line"></span><br><span class="line">删除一：在左边导航栏中，选中 OU=Server Groups：</span><br><span class="line">找到异常的桌面池，右键，点击删除。</span><br><span class="line"></span><br><span class="line">删除二：在左边导航栏中，选中 OU=Applications：</span><br><span class="line">找到异常的桌面池，右键，点击删除。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://nolabnoparty.com/en/vmware-horizon-remove-desktop-pool-stuck-in-deleting-state/">https://nolabnoparty.com/en/vmware-horizon-remove-desktop-pool-stuck-in-deleting-state/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/93636b9d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/93636b9d/" class="post-title-link" itemprop="url">重置Unified Access Gateway (UAG) 管理员密码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-19 12:10:06 / Modified: 12:12:19" itemprop="dateCreated datePublished" datetime="2025-03-19T12:10:06+00:00">2025-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Photon-Linux/" itemprop="url" rel="index"><span itemprop="name">Photon Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>UAG的管理员账户admin密码忘记，需要重置。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>使用root账户登录UAG；</li>
<li>输入adminpwd，重置admin密码；</li>
<li>进入WEB管理页面，<a target="_blank" rel="noopener" href="https://uag-ip:9443/">https://UAG-IP:9443</a>, 输入admin与新密码登录后，会提示密码过期，这个时候重新修改一下密码就好；</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.dinghui.org/reset-uag-admin-password.html">https://www.dinghui.org/reset-uag-admin-password.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/e8e9b2d3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/e8e9b2d3/" class="post-title-link" itemprop="url">Photon Linux进入单用户模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-19 12:04:22 / Modified: 12:08:45" itemprop="dateCreated datePublished" datetime="2025-03-19T12:04:22+00:00">2025-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Photon-Linux/" itemprop="url" rel="index"><span itemprop="name">Photon Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>场景1：忘记 Photon Linux 的root密码 ， （VMware的UAG就是用Photon Linux搭建的）。需要进入单用户模式重置root密码。</p>
<p>场景2：Photon Linux的登界面中，提示root账户被锁定了，需要进入单用户模式解锁root账户。</p>
<h1 id="操作步骤："><a href="#操作步骤：" class="headerlink" title="操作步骤："></a>操作步骤：</h1><ol>
<li>重启操作系统；</li>
<li>在启动引导界面，按 “e” ；</li>
<li>在linux行中，删除 rootpartition 与 if 之间的内容；</li>
<li>在 rootpartition 后面补充 rw init&#x3D;&#x2F;bin&#x2F;bash ；</li>
<li>按 Ctrl + x 启动；</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ximenjianxue/article/details/108408506">https://blog.csdn.net/ximenjianxue/article/details/108408506</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/62381b2c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/62381b2c/" class="post-title-link" itemprop="url">Linux多VLAN多网卡配置实例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-13 12:56:43 / Modified: 15:31:25" itemprop="dateCreated datePublished" datetime="2025-03-13T12:56:43+00:00">2025-03-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Ubuntu 20.04上面只有一张网卡，需要配置多个IP，且每一个IP都是不同VLAN ID，仅只有一个默认网关。</p>
<h1 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h1><ol>
<li>vSphere虚拟机的交换机端口组的VLAN要全放通。VLAN ID应该设置为 4095；（VGT 模式）</li>
<li>虚拟机的网卡配置文件需要写好，格式对齐yaml；</li>
<li>默认网关需写在对应vlan 配置里面；</li>
<li>物理交换机端口要放通所有vlan tag；</li>
</ol>
<h1 id="实操记录"><a href="#实操记录" class="headerlink" title="实操记录"></a>实操记录</h1><p>出口IP 192.168.1.1；<br>默认网关 192.168.1.254；</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">默认网关</th>
<th align="center">VLAN ID</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.1.1</td>
<td align="center">192.168.1.254</td>
<td align="center">192</td>
</tr>
<tr>
<td align="center">172.168.1.1</td>
<td align="center">无</td>
<td align="center">172</td>
</tr>
<tr>
<td align="center">173.168.1.3</td>
<td align="center">无</td>
<td align="center">173</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  ethernets:</span><br><span class="line">    eno160:</span><br><span class="line">      dhcp4: <span class="literal">false</span></span><br><span class="line">  vlans:</span><br><span class="line">    vlan.192:</span><br><span class="line">      <span class="built_in">id</span>: 192 <span class="comment"># 关键参数，对应vlan ID</span></span><br><span class="line">      <span class="built_in">link</span>: eno160 <span class="comment"># 关键参数，对应哪一个网卡</span></span><br><span class="line">      addresses: <span class="comment"># 关键参数，配置哪一个IP</span></span><br><span class="line">      - 192.168.1.1/24</span><br><span class="line">      gateway4: 192.168.1.254</span><br><span class="line">  vlans:</span><br><span class="line">    vlan.172:</span><br><span class="line">      <span class="built_in">id</span>: 172 <span class="comment"># 关键参数，对应vlan ID</span></span><br><span class="line">      <span class="built_in">link</span>: eno160 <span class="comment"># 关键参数，对应哪一个网卡</span></span><br><span class="line">      addresses: <span class="comment"># 关键参数，配置哪一个IP</span></span><br><span class="line">      - 172.168.1.1/24</span><br><span class="line">  vlans:</span><br><span class="line">    vlan.173:</span><br><span class="line">      <span class="built_in">id</span>: 2 <span class="comment"># 关键参数，对应vlan ID</span></span><br><span class="line">      <span class="built_in">link</span>: eno160 <span class="comment"># 关键参数，对应哪一个网卡</span></span><br><span class="line">      addresses: <span class="comment"># 关键参数，配置哪一个IP</span></span><br><span class="line">      - 173.168.1.3/24     </span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45027467/article/details/123928744">https://blog.csdn.net/weixin_45027467/article/details/123928744</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/ask/sof/116487215">https://cloud.tencent.com/developer/ask/sof/116487215</a><br><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/311540/sample-configuration-of-virtual-switch-v.html">https://knowledge.broadcom.com/external/article/311540/sample-configuration-of-virtual-switch-v.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/8b301521/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/8b301521/" class="post-title-link" itemprop="url">Linux-History设置时间戳</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-13 12:24:21 / Modified: 12:48:31" itemprop="dateCreated datePublished" datetime="2025-03-13T12:24:21+00:00">2025-03-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>Linux的 history 指令下，虽然可以查看到历史操作记录，但是无法看到操作时间；需要设置一下环境变量，使 history 指令可以看到时间戳。</p>
<h1 id="操作思路"><a href="#操作思路" class="headerlink" title="操作思路"></a>操作思路</h1><ol>
<li>变更 HISTTIMEFORMAT 环境变量；[词组：hist-time-format]</li>
</ol>
<h1 id="操作记录"><a href="#操作记录" class="headerlink" title="操作记录"></a>操作记录</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑环境变量文件 /etc/bashrc 或者 /etc/profile 文件；</span></span><br><span class="line"><span class="comment"># /etc/profile:此文件为系统的每个用户设置环境信息,当第一个用户登录时,该文件被执行.并从/etc/profile.d目录的配置文件中搜集shell的设置.</span></span><br><span class="line"><span class="comment"># /etc/bashrc:为每一个运行bash shell的用户执行此文件.当bash shell被打开时,该文件被读取。有些linux版本中的/etc目录下已经没有了bashrc文件。</span></span><br><span class="line"></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HISTFILESIZE 定义在 .bash_history 中保存的记录总数；</span></span><br><span class="line"><span class="comment"># HISTSIZE 定义 history 命令输出的记录数；</span></span><br><span class="line"><span class="comment"># 默认只有1000条；</span></span><br><span class="line">HISTFILESIZE=10000</span><br><span class="line">HISTSZIE=4000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义USER_IP参数</span></span><br><span class="line"><span class="comment"># 2&gt;/dev/null 是将错误信息重定向至空设备文件；</span></span><br><span class="line"><span class="comment"># awk &#x27;&#123;print $NF&#125;&#x27; 表示用awk切割，输出最后一个域；输出第一个域则是1F；</span></span><br><span class="line"><span class="comment"># sed -e &#x27;s/[()]//g&#x27;,表示将[]替换为空；有[]表示任意括号中任意一个字符均做替换；</span></span><br><span class="line">USER_IP=`<span class="built_in">who</span> -u am i 2&gt;/dev/null | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | sed -e <span class="string">&#x27;s/[()]//g&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$USER_IP</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    USER_IP=`hostname`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示格式</span></span><br><span class="line">HISTTIMEFORMAT=<span class="string">&quot;%F %T <span class="variable">$USER_IP</span>:`whoami` :&quot;</span></span><br><span class="line"><span class="built_in">export</span> HISTTIMEFORMAT</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/A___LEi/article/details/127661481">https://blog.csdn.net/A___LEi/article/details/127661481</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37886429/article/details/78520434">https://blog.csdn.net/m0_37886429/article/details/78520434</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/1e8f9c78/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/1e8f9c78/" class="post-title-link" itemprop="url">Docker实例-Wallabag部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-12-30 09:55:08 / Modified: 11:03:54" itemprop="dateCreated datePublished" datetime="2024-12-30T09:55:08+00:00">2024-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>使用 Docker 部署 Wallabag 。</p>
<h1 id="Docker-Compose-编写"><a href="#Docker-Compose-编写" class="headerlink" title="Docker-Compose 编写"></a>Docker-Compose 编写</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">blog:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wallabag/wallabag:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wallabag-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;[映射端口]:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/data:/var/www/wallabag/data</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/images:/var/www/wallabag/web/assets/images</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">SYMFONY__ENV__DOMAIN_NAME=&quot;http://[IP]:[映射端口]&quot;</span></span><br></pre></td></tr></table></figure>

<p>编写完毕后，执行docker-compose up -d</p>
<h2 id="细节说明"><a href="#细节说明" class="headerlink" title="细节说明"></a>细节说明</h2><h3 id="参数-SYMFONY-ENV-DOMAIN-NAME-说明，需要写明此URL，否则Wallabag无法显示对应信息，图片或者一些设置无法正常显示；"><a href="#参数-SYMFONY-ENV-DOMAIN-NAME-说明，需要写明此URL，否则Wallabag无法显示对应信息，图片或者一些设置无法正常显示；" class="headerlink" title="参数 SYMFONY__ENV__DOMAIN_NAME 说明，需要写明此URL，否则Wallabag无法显示对应信息，图片或者一些设置无法正常显示；"></a>参数 SYMFONY__ENV__DOMAIN_NAME 说明，需要写明此URL，否则Wallabag无法显示对应信息，图片或者一些设置无法正常显示；</h3><p>可以通过浏览器的F12看到，如果没有写URL，则会出现很多404；</p>
<h3 id="如何备份？"><a href="#如何备份？" class="headerlink" title="如何备份？"></a>如何备份？</h3><p>将data、images目录拷贝出来，并且设置权限为 65534 ， Docker才能正常读取；</p>
<h3 id="如何保存缓存图片"><a href="#如何保存缓存图片" class="headerlink" title="如何保存缓存图片"></a>如何保存缓存图片</h3><ol>
<li>选择内部设置</li>
<li>进入杂项；</li>
<li>本地缓存图片选择1</li>
</ol>
<p>参照：<a target="_blank" rel="noopener" href="https://www.bilibili.com/opus/1003990631705477145">https://www.bilibili.com/opus/1003990631705477145</a></p>
<h3 id="部署反向代理"><a href="#部署反向代理" class="headerlink" title="部署反向代理"></a>部署反向代理</h3><ol>
<li>Nginx里面指向 本地Docker的IP；并配置一个域名；</li>
<li>在wallabag的域名写上反向代理域名；</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/bc9f4eee/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/bc9f4eee/" class="post-title-link" itemprop="url">Docker-Hexo_Blog实例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-12-08 22:23:15" itemprop="dateCreated datePublished" datetime="2024-12-08T22:23:15+00:00">2024-12-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:41:53" itemprop="dateModified" datetime="2024-12-22T05:41:53+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>之前是使用一台CentOS 部署 node.js 与 hexo ， 这种形态还是有点重，想改成Docker形态看看。</p>
<h1 id="开始操作"><a href="#开始操作" class="headerlink" title="开始操作"></a>开始操作</h1><p>思路是先 拉取一个 node 镜像，然后再基于 node 镜像 封装一个 hexo 镜像；</p>
<p>参照：<a target="_blank" rel="noopener" href="https://chunchengwei.github.io/ruan-jian/ji-yu-docker-de-hexo-bo-ke-da-jian/">https://chunchengwei.github.io/ruan-jian/ji-yu-docker-de-hexo-bo-ke-da-jian/</a></p>
<h2 id="拉取-node-镜像"><a href="#拉取-node-镜像" class="headerlink" title="拉取 node 镜像"></a>拉取 node 镜像</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取最新的 node.js 镜像</span></span><br><span class="line">docker pull node:latest</span><br></pre></td></tr></table></figure>

<h2 id="封装镜像"><a href="#封装镜像" class="headerlink" title="封装镜像"></a>封装镜像</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 hexo 工作目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/Hexo &amp;&amp; <span class="built_in">cd</span> ~/Hexo</span><br><span class="line"><span class="built_in">mkdir</span> hexo_docker &amp;&amp; <span class="built_in">cd</span> hexo_docker</span><br><span class="line"><span class="comment"># 创建 Docker 封装的编译文件</span></span><br><span class="line"><span class="built_in">touch</span> Dockerfile</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> your_name &lt;your_mail&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /hexo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Hexo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install hexo-cli -g</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> hexo init .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.name <span class="string">&quot;your_name&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.email <span class="string">&quot;your_mail&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 映射端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>执行编译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;hexo:latest&quot;</span></span><br></pre></td></tr></table></figure>

<p>封装结束后，可以看到有这个镜像：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h2 id="测试镜像是否可用"><a href="#测试镜像是否可用" class="headerlink" title="测试镜像是否可用"></a>测试镜像是否可用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 6000 映射 4000 的容器</span></span><br><span class="line">docker run -it --name=<span class="string">&quot;temp&quot;</span> -p 6000:4000 hexo:latest /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入docker后</span></span><br><span class="line"><span class="comment"># 执行指令 hexo s，开启hexo服务</span></span><br><span class="line">hexo s</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>确认可以访问 ： 在外部访问 <a target="_blank" rel="noopener" href="http://docker/">http://docker</a> 宿主机IP:6000</p>
</blockquote>
<h2 id="二次封装镜像"><a href="#二次封装镜像" class="headerlink" title="二次封装镜像"></a>二次封装镜像</h2><p>确认完上述方案是可以成功运行后，我们需要进一步去封装docker镜像，使镜像可以直接使用。</p>
<p>我期望有一些初始化动作就直接封装完毕，比如一些安装插件的动作即可在镜像中就完成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># 基础镜像</span><br><span class="line">FROM hexo:latest</span><br><span class="line"></span><br><span class="line"># 维护者</span><br><span class="line">MAINTAINER [维护者信息]</span><br><span class="line"></span><br><span class="line"># 工作目录</span><br><span class="line">WORKDIR /hexo</span><br><span class="line"></span><br><span class="line"># 修改npm 源，增加npm安装速率</span><br><span class="line">RUN npm config set registry https://registry.npmmirror.com</span><br><span class="line">RUN npm get registry</span><br><span class="line"></span><br><span class="line"># 安装 hexo 插件</span><br><span class="line">RUN npm i hexo-prism-plugin --save</span><br><span class="line"># 搜索插件</span><br><span class="line">RUN npm i hexo-generator-searchdb --save</span><br><span class="line"># 汉字转拼音插件</span><br><span class="line">RUN npm i hexo-permalink-pinyin --save</span><br><span class="line"></span><br><span class="line"># node 14 报错问题</span><br><span class="line">RUN yarn add hexo-renderer-stylus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对外映射端口</span><br><span class="line">EXPOSE 4000</span><br><span class="line"></span><br><span class="line"># 运行命令</span><br><span class="line"># CMD [&quot;/bin/bash&quot;]</span><br><span class="line">CMD [&quot;/usr/bin/env&quot;, &quot;hexo&quot;, &quot;server&quot;]</span><br></pre></td></tr></table></figure>

<p>构建镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;nextblog:24&quot;</span> -f dockerfile ./</span><br></pre></td></tr></table></figure>

<h2 id="创建docker-compose文件"><a href="#创建docker-compose文件" class="headerlink" title="创建docker compose文件"></a>创建docker compose文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">blog:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">hexo_docker</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextblog:24</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">temp_simple_test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4000:4000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD:/hexo</span></span><br></pre></td></tr></table></figure>

<p>执行指令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动整个应用</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止整个应用</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>

<h2 id="其他一些补充"><a href="#其他一些补充" class="headerlink" title="其他一些补充"></a>其他一些补充</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 npm 当前安装了哪一些部件以及版本号</span></span><br><span class="line">npm <span class="built_in">ls</span> --depth 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line">npm i hexo@4.2.0 -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看compose过程中的一些报错</span></span><br><span class="line">docker-compose logs -f --<span class="built_in">tail</span>=50</span><br></pre></td></tr></table></figure>


<h2 id="2024年实例记录"><a href="#2024年实例记录" class="headerlink" title="2024年实例记录"></a>2024年实例记录</h2><p>基础镜像 node.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 获取最新node </span><br><span class="line">docker pull node:latest</span><br></pre></td></tr></table></figure>

<p>创建 dockerfile 文件，用于编译专用镜像:</p>
<ul>
<li>docker相关：<ul>
<li>docker-compose.yml 服务配置文件</li>
<li>hexo_docker&#x2F; 用于存放Dockerfile文件</li>
</ul>
</li>
<li>hexo相关：<ul>
<li>scaffolds&#x2F; 存放模版文件</li>
<li>source&#x2F; 存放用户资源文件，post，draft</li>
<li>themes&#x2F; 存放主题</li>
</ul>
</li>
<li>git相关：<ul>
<li>.deploy_git&#x2F; hexo-deployer-git插件用于存放commit历史记录。</li>
</ul>
</li>
</ul>
<blockquote>
<p>编译时，需要有root权限，否则会影响npm安装动作；</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dockerfile如下</span></span><br><span class="line">FROM node:latest</span><br><span class="line"></span><br><span class="line">MAINTAINER rohman.zhu</span><br><span class="line"></span><br><span class="line">WORKDIR /hexo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用国内源</span></span><br><span class="line">RUN npm config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br><span class="line">RUN npm install hexo-cli -g --save</span><br><span class="line">RUN hexo init .</span><br><span class="line">RUN npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化主题</span></span><br><span class="line"><span class="comment"># [TODO] 主题可能会变</span></span><br><span class="line"><span class="comment"># Git 可能获取会超时，需要调整</span></span><br><span class="line"><span class="comment"># RUN git config --global http.version HTTP/1.1</span></span><br><span class="line"><span class="comment"># RUN git clone https://github.com/iissnan/hexo-theme-next themes/next</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新版本的next需要安装这个插件</span></span><br><span class="line">RUN npm i hexo-renderer-swig --no-fund --save</span><br><span class="line">RUN npm i hexo-prism-plugin --save</span><br><span class="line">RUN npm i hexo-permalink-pinyin --save</span><br><span class="line">RUN npm i hexo-deployer-git --save</span><br><span class="line">RUN npm i hexo-abbrlink --save</span><br><span class="line">RUN git init ./.deploy_git/</span><br><span class="line">RUN git config --global user.name <span class="string">&quot;your_name&quot;</span></span><br><span class="line">RUN git config --global user.email <span class="string">&quot;your_mail&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HEXO 相关的</span></span><br><span class="line"><span class="comment"># 生成 categories 页面</span></span><br><span class="line">RUN hexo new page <span class="string">&quot;categories&quot;</span></span><br><span class="line"><span class="comment"># 生成 about 页面</span></span><br><span class="line">RUN hexo new page <span class="string">&quot;about&quot;</span></span><br><span class="line"><span class="comment"># 生成 tag 页面</span></span><br><span class="line">RUN hexo new page <span class="string">&quot;tags&quot;</span></span><br><span class="line"><span class="comment"># 生成页面</span></span><br><span class="line">RUN hexo g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建挂载点</span></span><br><span class="line">VOLUME [<span class="string">&quot;/hexo/.deploy_git&quot;</span>, <span class="string">&quot;/hexo/scaffolds&quot;</span>, <span class="string">&quot;/hexo/source&quot;</span>, <span class="string">&quot;/hexo/themes&quot;</span>, <span class="string">&quot;/root/.ssh&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对外暴露 4000 端口</span></span><br><span class="line">EXPOSE 4000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line"><span class="comment"># CMD [&quot;/bin/bash&quot;]</span></span><br><span class="line"><span class="comment"># 容器启动后，会默认执行的指令；</span></span><br><span class="line">CMD [<span class="string">&quot;/usr/bin/env&quot;</span>, <span class="string">&quot;hexo&quot;</span>, <span class="string">&quot;server&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>可以临时编译测试看看；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于 node:latest 创建一个hexo镜像</span></span><br><span class="line">docker build -t <span class="string">&quot;hexo:1&quot;</span> .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不使用缓存,重新编译</span></span><br><span class="line">docker build -t <span class="string">&quot;hexo:1&quot;</span> . --no-cache</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 对创建出来的镜像试运行</span><br><span class="line">docker run -it --name=&quot;hexo-temptest&quot; -p [映射的端口]:4000  -v $PWD:/hexo/org hexo:1 /bin/bash</span><br></pre></td></tr></table></figure>

<p>编写docker compose文件，用于自动生成；</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">blog:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">./</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hexo:1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">temp_simple_test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;[映射的端口]:4000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/.ssh:/root/.ssh</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/.deploy_git:/hexo/.deploy_git</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/scaffolds:/hexo/scaffolds</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/source:/hexo/source</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/themes:/hexo/themes</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD/_config.yml:/hexo/_config.yml</span></span><br></pre></td></tr></table></figure>

<p>服务创建完成后，常用指令为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="comment"># 进入compose文件所在的目录</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新文章</span></span><br><span class="line">docker <span class="built_in">exec</span> [blog_docker 名称] hexo new <span class="string">&quot;文章名&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文章静态页面</span></span><br><span class="line">docker <span class="built_in">exec</span> [blog_docker 名称] hexo g </span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布文章至github</span></span><br><span class="line">docker <span class="built_in">exec</span> [blog_docker 名称] hexo d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line">docker-compose down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建指令别名</span></span><br><span class="line"><span class="built_in">alias</span> hexo=<span class="string">&quot;docker exec [blog_docker 名称] hexo&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="操作过程中的报错"><a href="#操作过程中的报错" class="headerlink" title="操作过程中的报错"></a>操作过程中的报错</h3><ol>
<li>github 仓库无法使用</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fatal: not a git repository (or any parent up to mount point /hexo)</span><br><span class="line">Stopping at filesystem boundary (GIT_DISCOVERY_ACROSS_FILESYSTEM not set).</span><br><span class="line">FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">Error: Spawn failed</span><br><span class="line">    at ChildProcess.&lt;anonymous&gt; (/hexo/node_modules/hexo-deployer-git/node_modules/hexo-util/lib/spawn.js:51:21)</span><br><span class="line">    at ChildProcess.emit (node:events:513:28)</span><br><span class="line">    at ChildProcess._handle.onexit (node:internal/child_process:294:12)</span><br></pre></td></tr></table></figure>

<p>原因：.deploy_git 文件下没有初始化.git仓库</p>
<p>解决方法： git init .&#x2F;.deploy_git&#x2F;</p>
<ol start="2">
<li>SSL 配置</li>
</ol>
<p>有两个地方：</p>
<ol>
<li>个人账户的SSL key配置，这个是全局的；入口：Settings –&gt; SSH and GPG Keys</li>
<li>对应仓库的 SSL key配置，这个是针对特定仓库的；入口：repo –&gt; Settings –&gt; Deploy Keys</li>
</ol>
<h2 id="其他参考资料"><a href="#其他参考资料" class="headerlink" title="其他参考资料"></a>其他参考资料</h2><p>next主题：<a target="_blank" rel="noopener" href="https://zxblog.eu.org/posts/488a">https://zxblog.eu.org/posts/488a</a><br>hexo博客设置：<a target="_blank" rel="noopener" href="https://zxblog.eu.org/posts/5a75/">https://zxblog.eu.org/posts/5a75/</a><br>docker 编译过程中，指定用户：<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175463/9129345#:~:text=%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Docker%20build%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%201%201.%20%E7%AE%80%E4%BB%8B%20%E5%9C%A8Docker%E4%B8%AD%E4%BD%BF%E7%94%A8%20docker%20build,4.%20%E7%BB%93%E8%AE%BA%20%E9%80%9A%E8%BF%87%E4%BB%A5%E4%B8%8A%E6%AD%A5%E9%AA%A4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8Docker%E4%B8%AD%E4%BD%BF%E7%94%A8%20docker%20build%20%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%E6%9D%A5%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E3%80%82%20%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%A2%9E%E5%8A%A0%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E3%80%82%20%E5%B8%8C%E6%9C%9B%E6%9C%AC%E6%96%87%E5%AF%B9%E4%BD%A0%E6%9C%89%E6%89%80%E5%B8%AE%E5%8A%A9%EF%BC%8C%E7%A5%9D%E4%BD%A0%E5%9C%A8%E4%BD%BF%E7%94%A8Docker%E6%97%B6%E5%8F%96%E5%BE%97%E6%88%90%E5%8A%9F%EF%BC%81">https://blog.51cto.com/u_16175463/9129345#:~:text=%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Docker%20build%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%201%201.%20%E7%AE%80%E4%BB%8B%20%E5%9C%A8Docker%E4%B8%AD%E4%BD%BF%E7%94%A8%20docker%20build,4.%20%E7%BB%93%E8%AE%BA%20%E9%80%9A%E8%BF%87%E4%BB%A5%E4%B8%8A%E6%AD%A5%E9%AA%A4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8Docker%E4%B8%AD%E4%BD%BF%E7%94%A8%20docker%20build%20%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%E6%9D%A5%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E3%80%82%20%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%A2%9E%E5%8A%A0%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E3%80%82%20%E5%B8%8C%E6%9C%9B%E6%9C%AC%E6%96%87%E5%AF%B9%E4%BD%A0%E6%9C%89%E6%89%80%E5%B8%AE%E5%8A%A9%EF%BC%8C%E7%A5%9D%E4%BD%A0%E5%9C%A8%E4%BD%BF%E7%94%A8Docker%E6%97%B6%E5%8F%96%E5%BE%97%E6%88%90%E5%8A%9F%EF%BC%81</a><br>目录结构插件 abbrLink ： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsuh/articles/17231388.html">https://www.cnblogs.com/zsuh/articles/17231388.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/9102e9f1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/9102e9f1/" class="post-title-link" itemprop="url">弱网测试工具--clumsy</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-10-20 19:20:08" itemprop="dateCreated datePublished" datetime="2024-10-20T19:20:08+00:00">2024-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h1><p>需要模拟时延、丢包等网络条件问题对业务的影响，最近看到有一款软件可以满足这个需求 clumsy。故做一下使用记录。</p>
<h2 id="开始模拟"><a href="#开始模拟" class="headerlink" title="开始模拟"></a>开始模拟</h2><p>使用的版本一定要为 0.4 版本，测试过程会较老版本稳定</p>
<h3 id="时延-LAG"><a href="#时延-LAG" class="headerlink" title="时延 LAG"></a>时延 LAG</h3><ol>
<li>presets &#x3D; outbound ;</li>
<li>Lag 勾选</li>
<li>Delay(ms): 输入需要的时延；</li>
</ol>
<p>参考参数：</p>
<ul>
<li>0ms ， 用于记录软件自身的时延，以及波动偏差；</li>
<li>+10ms、+15ms为梯度去测试；（根据实际业务环境去实测）</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://gulut.github.io/gulut-blog/post1/2020/09/20/2020-09-20-clumsy-a-bad-net-test-tool/">https://gulut.github.io/gulut-blog/post1/2020/09/20/2020-09-20-clumsy-a-bad-net-test-tool/</a><br><a target="_blank" rel="noopener" href="http://jagt.github.io/clumsy/manual.html">http://jagt.github.io/clumsy/manual.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/44/">44</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
