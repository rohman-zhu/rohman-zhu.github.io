<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/5/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/5/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">457</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">151</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/48929e2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/48929e2/" class="post-title-link" itemprop="url">esxcli catch patch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-08 23:26:51" itemprop="dateCreated datePublished" datetime="2024-09-08T23:26:51+00:00">2024-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-08-19 04:17:45" itemprop="dateModified" datetime="2025-08-19T04:17:45+00:00">2025-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="抓包过程"><a href="#抓包过程" class="headerlink" title="抓包过程"></a>抓包过程</h1><ol>
<li>登录ESXi Shell</li>
<li>使用 pktcap-uw 抓包</li>
<li>使用 tcpdump-uw 解包</li>
</ol>
<h2 id="基于vmk抓包"><a href="#基于vmk抓包" class="headerlink" title="基于vmk抓包"></a>基于vmk抓包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓取 vmk0 的数据包，并保存在 test.zip</span></span><br><span class="line">pktcap-uw --vmk vmk0 -o test.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解包</span></span><br><span class="line">tcpdump-uw -enr test.zip</span><br></pre></td></tr></table></figure>

<h2 id="基于虚拟机端口抓包"><a href="#基于虚拟机端口抓包" class="headerlink" title="基于虚拟机端口抓包"></a>基于虚拟机端口抓包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到虚拟机端口 ，虚拟机名为 testdemo,输出的包为 test.zip</span></span><br><span class="line">net-stats -l | grep testdemo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓虚拟机所需的端口</span></span><br><span class="line">pktcap-uw --switchport [testdemo nic port] --ip [需要过滤的IP] -o test.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解包</span></span><br><span class="line">tcpdump-uw -enr test.zip</span><br></pre></td></tr></table></figure>

<h3 id="持续抓包"><a href="#持续抓包" class="headerlink" title="持续抓包"></a>持续抓包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pktcap-uw --switchport [vm nic port] -o - | tcpdump-uw -r - [过滤条件]</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/72f8ddd7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/72f8ddd7/" class="post-title-link" itemprop="url">Linux_Bond</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-08 22:58:47" itemprop="dateCreated datePublished" datetime="2024-09-08T22:58:47+00:00">2024-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Linux-bond-模式"><a href="#Linux-bond-模式" class="headerlink" title="Linux bond 模式"></a>Linux bond 模式</h1><p>Bonding驱动一共提供了7种负载均衡模式，它们分别是：balance-rr、active-backup、balance-xor、broadcast、802.3ad、balance-tlb、balance-alb，其中最常用的是balance-xor和balance-alb。</p>
<ol start="0">
<li>balance-rr or 0：轮询模式，提供负载平衡和容错。该模式下两个网口都工作。</li>
<li>active-backup or 1：主备倒换模式，提供冗余功能，该模式下只有一个网口工作，另一个做备份。本模式可以和任何二层（Layer-II）交换机一起工作。</li>
<li>balance-xor or 2：基于HASH算法的负载均衡模式，网卡的分流按照xmit_hash_policy的TCP协议层设置来进行HASH计算分流，使各种不同处理来源的访问都尽量在同一个网卡上进行处理。</li>
<li>broadcast or 3：广播模式，所有被绑定的网卡都将得到相同的数据，一般用于十分特殊的网络需求。</li>
<li>802.3ad or 4：802.3ad模式，要求交换机也支持802.3ad模式，理论上服务器及交换机都支持此模式时，网卡带宽最高可以翻倍（如从1Gbps翻到2Gbps）。在本模式中，bonding可以和支持IEEE 802.3ad动态连接聚合（Dynamic Link Aggregation）的系统一起工作，大多数可管理交换机和很多不可管理交换机都支持802.3ad。</li>
<li>balance-tlb or 5：适配器输出负载均衡模式，输出的数据会通过所有被绑定的网卡输出，接收数据时则只选定其中一块网卡。如果正在用于接收数据的网卡发生故障，则由其他网卡接管，要求所用的网卡及网卡驱动可通过ethtool命令得到speed信息。</li>
<li>balance-alb or 6：适配器输入&#x2F;输出负载均衡模式，在”模式5”的基础上，在接收数据的同时实现负载均衡，除要求ethtool命令可得到speed信息外，还要求支持对网卡MAC地址的动态修改功能。</li>
</ol>
<h2 id="需要交换机配置的策略"><a href="#需要交换机配置的策略" class="headerlink" title="需要交换机配置的策略"></a>需要交换机配置的策略</h2><h3 id="mode-0-balance-rr"><a href="#mode-0-balance-rr" class="headerlink" title="mode&#x3D;0,balance-rr"></a>mode&#x3D;0,balance-rr</h3><p>轮询的方式将数据包流转，第一个包走eth0，第二个包走eth1，知道数据包发送完毕。</p>
<p>优点：流量提高一倍；<br>缺点：需要接入交换机做端口聚合，否则可能无法使用；</p>
<h3 id="mode-2-balance-xor"><a href="#mode-2-balance-xor" class="headerlink" title="mode&#x3D;2,balance-xor"></a>mode&#x3D;2,balance-xor</h3><p>表示 XOR Hash负载分担，和交换机的聚合强制不协商方式配合。（序号xmit_hash_policy,需要交换机配置port channel）</p>
<p>特点：基于指定的传输HASH策略传输数据包。缺省的策略是：（源MAC地址 XOR 目标MAX地址）% Slave数量 。 其他的传输策略可通过xmit_hash_policy选项指定，此模式提供负载均衡和容错能力</p>
<h3 id="mode-3-broadcast"><a href="#mode-3-broadcast" class="headerlink" title="mode&#x3D;3,broadcast"></a>mode&#x3D;3,broadcast</h3><p>表示所有包从所有网络口发出，不均衡，只有冗余。</p>
<p>特点：每一个slave接口都在传输每一个数据包。</p>
<h3 id="mode-4-802-3ad"><a href="#mode-4-802-3ad" class="headerlink" title="mode&#x3D;4,802.3ad"></a>mode&#x3D;4,802.3ad</h3><p>表示使用802.3ad协议，需要和交换机聚合LACP方式配合，标准要求所有设备在聚合操作时，要在同样的速率和双工模式，每一个连接只能用一个网络接口。</p>
<p>前置条件：</p>
<ol>
<li>ethtool 支持获取每一个slave的速率和双工设定；</li>
<li>交换机支持 IEEE802.3ad Dynamic link aggregation;</li>
</ol>
<h2 id="不需要交换机配置的策略"><a href="#不需要交换机配置的策略" class="headerlink" title="不需要交换机配置的策略"></a>不需要交换机配置的策略</h2><h3 id="mode-1-active-backup"><a href="#mode-1-active-backup" class="headerlink" title="mode&#x3D;1,active-backup"></a>mode&#x3D;1,active-backup</h3><p>为主备模式</p>
<p>优点：冗余性高；<br>缺点：链路利用率低，只有一块网卡在使用；</p>
<h3 id="mode-5-balance-tlb"><a href="#mode-5-balance-tlb" class="headerlink" title="mode&#x3D;5,balance-tlb"></a>mode&#x3D;5,balance-tlb</h3><p>根据slave负载情况选择slave进行发送，接收时使用当前轮到的slave。该模式要求slave接口的网络设备驱动有某种ethtool支持，而且ARP监控不可用。</p>
<p>特点：不需要任何特定的交换机支持，在每一个slave上根据当前的负载分配外出流量。如果正在接受数据的slave出现故障，另一个slave接管失败的slave的MAC地址。</p>
<p>前置条件：</p>
<ol>
<li>ethtool支持获取每一个slave的速率</li>
</ol>
<h3 id="mode-6-balance-alb"><a href="#mode-6-balance-alb" class="headerlink" title="mode&#x3D;6,balance-alb"></a>mode&#x3D;6,balance-alb</h3><p>在mode&#x3D;5基础上加上了 “接收负载均衡（receiveload balance）”,不需要交换机支持，接收负载均衡是通过ARP协商实现的。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>netplan yaml：<a target="_blank" rel="noopener" href="https://netplan.readthedocs.io/en/latest/netplan-yaml/">https://netplan.readthedocs.io/en/latest/netplan-yaml/</a><br>fail_over_mac: <a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/linux-on-systems?topic=mode-option-fail-over-mac">https://www.ibm.com/docs/en/linux-on-systems?topic=mode-option-fail-over-mac</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/bc991194/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/bc991194/" class="post-title-link" itemprop="url">ESXi_Large-Scale workloads with intensive IO patterns might require queue depths significantly greater than paravirtual SCSI default values</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-04 00:26:21" itemprop="dateCreated datePublished" datetime="2024-09-04T00:26:21+00:00">2024-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h1><p>部分虚拟机业务对存储的IO有着极高的需求，在硬件条件有限的情况下，可以优化一下虚拟化层的配置。</p>
<h1 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h1><h2 id="虚拟化层的修改"><a href="#虚拟化层的修改" class="headerlink" title="虚拟化层的修改"></a>虚拟化层的修改</h2><p>核心就是修改 HBA 设备的队列深度</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先确认当前使用的哪种类型的HBA</span></span><br><span class="line"><span class="comment">## Qlogic HBA卡 类查询</span></span><br><span class="line">esxcli system module list | grep qla</span><br><span class="line"><span class="comment">##  Emulex HBA卡 类查询</span></span><br><span class="line">esxcli system module list | grep lpfc</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt; 看上述指令哪一个指令有结果显示</span></span><br><span class="line"><span class="comment"># 修改 Qlogic 类HBA卡</span></span><br><span class="line">esxcli system module parameters <span class="built_in">set</span> -p ql2xmaxqdepth=128 -m [根据上述指令查询的设备]</span><br><span class="line"><span class="comment"># 修改 Emulex 类HBA卡</span></span><br><span class="line">esxcli system module parameters <span class="built_in">set</span> -p lpfc0_lun_queue_depth=128 -m [根据上述指令查询的设备]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整完毕后，需要重启 ESXi</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启后使用指令查询</span></span><br><span class="line">esxcli system module parameters list -m [根据上述指令查询的设备]</span><br></pre></td></tr></table></figure>

<h2 id="虚拟机设置修改"><a href="#虚拟机设置修改" class="headerlink" title="虚拟机设置修改"></a>虚拟机设置修改</h2><p>将磁盘改为 PVSCSI 类型。</p>
<h2 id="虚拟机OS修改"><a href="#虚拟机OS修改" class="headerlink" title="虚拟机OS修改"></a>虚拟机OS修改</h2><h3 id="Linux-类修改"><a href="#Linux-类修改" class="headerlink" title="Linux 类修改"></a>Linux 类修改</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内核加载</span></span><br><span class="line">vim /etc/modprobe.d/pvscsi</span><br><span class="line"><span class="comment"># 添加以下内容，并保存</span></span><br><span class="line">options vmw_pvscsi cmd_per_lun=254 ring_pages=32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改启动文件 /etc/grub.conf 或 /boot/grub/grub.cfg</span></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">vmw_pvscsi.cmd_per_lun=254</span><br><span class="line">vmw_pvscsi.ring_pages=32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务器</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启后确认信息</span></span><br><span class="line"><span class="built_in">cat</span> /sys/module/vmw_pvscsi/parameters/cmd_per_lun</span><br><span class="line"><span class="built_in">cat</span> /sys/module/vmw_pvscsi/parameters/ring_pages</span><br></pre></td></tr></table></figure>

<h3 id="Windows-类修改"><a href="#Windows-类修改" class="headerlink" title="Windows 类修改"></a>Windows 类修改</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 添加注册表项</span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\services\pvscsi\Parameters\Device /v DriverParameter /t REG_SZ /d &quot;RequestRingPages=<span class="number">32</span>,MaxQueueDepth=<span class="number">254</span>&quot;</span><br><span class="line"></span><br><span class="line"># 修改完毕后，重启服务器</span><br><span class="line">shutdown /r /t <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 确认是否生成注册表</span><br><span class="line"># HKLM\ SYSTEM\CurrentControlSet\services\pvscsi\Parameters\Device.</span><br><span class="line"># 确认两个值是否为RequestRingPages=<span class="number">32</span>, MaxQueueDepth=<span class="number">254</span>.</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/343323/largescale-workloads-with-intensive-io-p.html">https://knowledge.broadcom.com/external/article/343323/largescale-workloads-with-intensive-io-p.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/fd61e70a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/fd61e70a/" class="post-title-link" itemprop="url">Virtualbox error with linux Kernal upgrade </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-01 00:26:17" itemprop="dateCreated datePublished" datetime="2024-09-01T00:26:17+00:00">2024-09-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 14:15:57" itemprop="dateModified" datetime="2025-06-22T14:15:57+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>VirtualBox 在Linux 内核升级后，虚拟机无法启动，会提示报错；忽略错误，则会导致虚拟机进入 Guru Mediation 状态。在log文件中可以看到 “VCPU0: Guru Meditation -2708(VERR_VMM_SET_JMP_ABORTED_RESUME)”</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>在非 root 账户下 ，执行指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage setextradata <span class="string">&quot;[虚拟机名]&quot;</span> <span class="string">&quot;VBoxInternal/RamPreAlloc&quot;</span> 1</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://forums.virtualbox.org/viewtopic.php?t=103333">https://forums.virtualbox.org/viewtopic.php?t=103333</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/9b88ac8a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/9b88ac8a/" class="post-title-link" itemprop="url">Simple performance testing on hard disk with different RAID level record</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-08-28 00:20:26" itemprop="dateCreated datePublished" datetime="2024-08-28T00:20:26+00:00">2024-08-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>| Index | TEST ENV | Type | Read Speed (MBps) | Write Speed (MBps)| Read IOPS | Write IOPS | Read latency(us) | Write latency(us) |<br>| 1 | 10 * 18TB SATA HDD , RAID 6 | SEQ 1M,Q8T1 | 1294 | 1421 | 1234 | 1355 | 6471 | 5864 |<br>| 2 | 10 * 18TB SATA HDD , RAID 6 | RND 1M,Q1T1 | 355 | 1385 | 339 | 1321 | 2907 | 756 |<br>| 3 | 10 * 18TB SATA HDD , RAID 6 | RND 4K,Q32T1 | 10 | 64 | 2480 | 15829 | 12842 | 1863|<br>| 4 | 10 * 18TB SATA HDD , RAID 6 | RND 4K,Q1T1 | 1 | 18 | 352 | 4551 |2827 | 195 |<br>| 5 | 2 * 960GB SATA SSD , RAID 1 | SEQ 1M,Q8T1 | 1294 | 1421 | 1234 | 1355 | 6471 | 5864 |<br>| 6 | 2 * 960GB SATA SSD , RAID 1 | RND 1M,Q1T1 | 355 | 1385 | 339 | 1321 | 2907 | 756 |<br>| 7 | 2 * 960GB SATA SSD , RAID 1 | RND 4K,Q32T1 | 10 | 64 | 2480 | 15829 | 12842 | 1863|<br>| 8 | 2 * 960GB SATA SSD , RAID 1 | RND 4K,Q1T1 | 1 | 18 | 352 | 4551 |2827 | 195 |</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/d8d1bc6f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/d8d1bc6f/" class="post-title-link" itemprop="url">Powershell-设置终端颜色</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-28 16:27:25" itemprop="dateCreated datePublished" datetime="2024-07-28T16:27:25+00:00">2024-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>Powershell默认背景是黑色的，需要调整</p>
<h1 id="设置过程"><a href="#设置过程" class="headerlink" title="设置过程"></a>设置过程</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 查看当前配色方案</span></span><br><span class="line"><span class="built_in">Get-PSReadLineOption</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置具体</span></span><br><span class="line"><span class="built_in">Set-PSReadLineOption</span> <span class="literal">-Colors</span> <span class="selector-tag">@</span>&#123;<span class="string">&quot;String&quot;</span>=<span class="string">&quot;yellow&quot;</span>&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/powershell/module/PSReadline/Set-PSReadlineOption?view=powershell-7.4">https://learn.microsoft.com/zh-cn/powershell/module/PSReadline/Set-PSReadlineOption?view=powershell-7.4</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/b82821a8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/b82821a8/" class="post-title-link" itemprop="url">Powershell-NTFS文件系统下设置文件夹ACL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-28 16:22:05" itemprop="dateCreated datePublished" datetime="2024-07-28T16:22:05+00:00">2024-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>通过脚本，设置C盘根目录下除了用户文件，其他文件夹禁止用户写入数据；</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><p>对C盘根目录设置 ACL，主要有以下三点：</p>
<ol>
<li>仅对 C 盘 此目录；</li>
<li>设置用户范围为 BUILTIN\Users；</li>
<li>设置 拒绝写入；</li>
</ol>
<h1 id="目录权限拟定方案"><a href="#目录权限拟定方案" class="headerlink" title="目录权限拟定方案"></a>目录权限拟定方案</h1><table>
<thead>
<tr>
<th align="left">目录</th>
<th align="left">范围</th>
<th align="center">权限</th>
<th align="left">动作</th>
</tr>
</thead>
<tbody><tr>
<td align="left">C:</td>
<td align="left">folder</td>
<td align="center">Write</td>
<td align="left">Deny</td>
</tr>
<tr>
<td align="left">Custom Folder</td>
<td align="left">folder,sub folder,file</td>
<td align="center">FullControl</td>
<td align="left">Deny</td>
</tr>
<tr>
<td align="left">PerfLogs</td>
<td align="left">DEFAULT</td>
<td align="center">DEFAULT</td>
<td align="left">DEFAULT</td>
</tr>
<tr>
<td align="left">Program Files</td>
<td align="left">DEFAULT</td>
<td align="center">DEFAULT</td>
<td align="left">DEFAULT</td>
</tr>
<tr>
<td align="left">Program Files(x86)</td>
<td align="left">DEFAULT</td>
<td align="center">DEFAULT</td>
<td align="left">DEFAULT</td>
</tr>
<tr>
<td align="left">Users</td>
<td align="left">DEFAULT</td>
<td align="center">DEFAULT</td>
<td align="left">DEFAULT</td>
</tr>
<tr>
<td align="left">Windows</td>
<td align="left">DEFAULT</td>
<td align="center">DEFAULT</td>
<td align="left">DEFAULT</td>
</tr>
</tbody></table>
<blockquote>
<p>获取隐藏目录，Get-ChildItem [path] -Force</p>
</blockquote>
<h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h1><h2 id="v1"><a href="#v1" class="headerlink" title="v1"></a>v1</h2><p>对指定目录设置禁止写入</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;#Golbal Constant #&gt;</span></span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>=<span class="string">&quot;FullControl&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_WRITE</span>=<span class="string">&quot;Write&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_READ</span>=<span class="string">&quot;Read&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_ALLOW</span>=<span class="string">&quot;Allow&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>=<span class="string">&quot;Deny&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：可以让C盘拒绝写入</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyWrite</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_WRITE</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_WRITE</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：非系统目录，则可以设置完全拒绝</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyFC</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Remote Desktop Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：上述动作仅对路径中的绝对目录生效，子目录是不生效的；</p>
</blockquote>
<h2 id="v2"><a href="#v2" class="headerlink" title="v2"></a>v2</h2><p>对指定目录设置禁止写入，并启用继承；</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;#Golbal Constant #&gt;</span></span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>=<span class="string">&quot;FullControl&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_WRITE</span>=<span class="string">&quot;Write&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_READ</span>=<span class="string">&quot;Read&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_ALLOW</span>=<span class="string">&quot;Allow&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>=<span class="string">&quot;Deny&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：可以让C盘拒绝写入</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyWrite</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_WRITE</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_WRITE</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：非系统目录，则可以设置完全拒绝</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyFC</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Remote Desktop Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">#$NewAcl.SetAccessRuleProtection($isProtected, $preserveInheritance)</span></span><br><span class="line">    <span class="comment"># $isProtected = $TRUE,表示禁用继承；</span></span><br><span class="line">    <span class="comment"># $preserveInheritance = $TRUE,表示继承的权限保存；</span></span><br><span class="line">    <span class="comment"># 第一个参数负责阻止从父文件夹继承，$FALSE为继承父目录权限;</span></span><br><span class="line">    <span class="comment"># 第二个参数用于删除当前继承的权限，$TRUE为不删除当前继承的权限;    </span></span><br><span class="line">    <span class="comment">#$CURRENT_ACL.SetAccessRuleProtection($FALSE,$TRUE);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第一个参数负责阻止从父文件夹继承，$TRUE为不继承父目录全新；</span></span><br><span class="line">    <span class="comment"># 第二个参数用于删除当前继承的权限，$FALSE为删除当前继承的权限;</span></span><br><span class="line">    <span class="comment">#$CURRENT_ACL.SetAccessRuleProtection($TRUE,$FALSE);</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个版本仅设置的是目标目录，作用范围仅是“此目录”；</p>
</blockquote>
<h2 id="v3"><a href="#v3" class="headerlink" title="v3"></a>v3</h2><p>要对 “此文件夹、子文件夹、文件”设置权限。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;#Golbal Constant #&gt;</span></span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>=<span class="string">&quot;FullControl&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_WRITE</span>=<span class="string">&quot;Write&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_BASE_PERMISSION_READ</span>=<span class="string">&quot;Read&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_ALLOW</span>=<span class="string">&quot;Allow&quot;</span>;</span><br><span class="line"><span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>=<span class="string">&quot;Deny&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：可以让C盘拒绝写入</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyWrite</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_WRITE</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_WRITE</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：非系统目录，则可以设置完全拒绝</span></span><br><span class="line"><span class="comment"># 范围：目标目录，“此目录”</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderToDenyFC</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Remote Desktop Users&quot;</span>;</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：非系统目录，则可以设置完全拒绝</span></span><br><span class="line"><span class="comment"># 范围：此目录，子目录，文件</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Set-TargetFolderALLToDenyFC</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_FOLDER</span>);</span><br><span class="line">    <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$TARGET_USER</span>=<span class="string">&quot;Remote Desktop Users&quot;</span>;</span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ContainerInherit <span class="operator">-bor</span> [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ObjectInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::None</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>.SetAccessRule(<span class="variable">$ACCESS_RULE</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span> | <span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CURRENT_ACL</span>=<span class="built_in">Get-ACL</span> <span class="literal">-Path</span> <span class="variable">$TARGET_FOLDER</span>;</span><br><span class="line">    <span class="variable">$CHECK_STATUS</span>=<span class="variable">$CURRENT_ACL</span>.Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.FileSystemRights <span class="operator">-eq</span> <span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span> <span class="operator">-and</span> <span class="variable">$_</span>.AccessControlType <span class="operator">-eq</span> <span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span> <span class="operator">-and</span> <span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;BUILTIN\\<span class="variable">$TARGET_USER</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$CHECK_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$IS_DENY_USER_ACL</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_DENY_USER_ACL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/ganzy/6926601">https://blog.51cto.com/ganzy/6926601</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl?view=powershell-7.4">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-acl?view=powershell-7.4</a></p>
<h2 id="来自-https-www-codenong-com-3282656"><a href="#来自-https-www-codenong-com-3282656" class="headerlink" title="来自 https://www.codenong.com/3282656/"></a>来自 <a target="_blank" rel="noopener" href="https://www.codenong.com/3282656/">https://www.codenong.com/3282656/</a></h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关于NTFS各个目录范围设置列举：</span></span><br><span class="line"></span><br><span class="line">    ╔═════════════╦═════════════╦═══════════════════════════════╦════════════════════════╦══════════════════╦═══════════════════════╦═════════════╦═════════════╗</span><br><span class="line">    ║             ║ folder only ║ folder, sub<span class="literal">-folders</span> and files ║ folder and sub<span class="literal">-folders</span> ║ folder and files ║ sub<span class="literal">-folders</span> and files ║ sub<span class="literal">-folders</span> ║    files    ║</span><br><span class="line">    ╠═════════════╬═════════════╬═══════════════════════════════╬════════════════════════╬══════════════════╬═══════════════════════╬═════════════╬═════════════╣</span><br><span class="line">    ║ Propagation ║ none        ║ none                          ║ none                   ║ none             ║ InheritOnly           ║ InheritOnly ║ InheritOnly ║</span><br><span class="line">    ║ Inheritance ║ none        ║ Container|Object              ║ Container              ║ Object           ║ Container|Object      ║ Container   ║ Object      ║</span><br><span class="line">    ╚═════════════╩═════════════╩═══════════════════════════════╩════════════════════════╩══════════════════╩═══════════════════════╩═════════════╩═════════════╝</span><br><span class="line"></span><br><span class="line"><span class="comment"># folder only</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::None</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::None</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># folder, sub-folders and files</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ContainerInherit <span class="operator">-bor</span> [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ObjectInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::None</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># folder and sub-folders </span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ContainerInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::None</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># folder and files</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ObjectInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::None</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># sub-folders and files</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ContainerInherit <span class="operator">-bor</span> [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ObjectInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::InheritOnly</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># sub-folders</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ContainerInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::InheritOnly</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># files</span></span><br><span class="line">    <span class="variable">$INHERITANCE_FLAG</span> = [<span class="type">System.Security.AccessControl.InheritanceFlags</span>]::ObjectInherit</span><br><span class="line">    <span class="variable">$PROPAGATION_FLAG</span> = [<span class="type">System.Security.AccessControl.PropagationFlags</span>]::InheritOnly</span><br><span class="line">    <span class="variable">$ACCESS_RULE</span>=<span class="built_in">New-Object</span> System.Security.AccessControl.FileSystemAccessRule(<span class="variable">$TARGET_USER</span>,<span class="variable">$ACL_BASE_PERMISSION_FULLCONTROL</span>,<span class="variable">$INHERITANCE_FLAG</span>,<span class="variable">$PROPAGATION_FLAG</span>,<span class="variable">$ACL_ACCESS_CONTROL_TYPE_DENY</span>);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/25c47bd6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/25c47bd6/" class="post-title-link" itemprop="url">VCSA中虚拟机迁移按钮是灰色的</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-21 22:31:59" itemprop="dateCreated datePublished" datetime="2024-07-21T22:31:59+00:00">2024-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>在VCSA中，选中目标虚拟机做迁移动作时，虚拟机的Migrate选项是灰色的，不可点击的。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>虚拟机处于备份状态中，无法进行vMotion。或者备份已经结束了，但虚拟机的状态未自动恢复正常。<br>在虚拟机备份完成后，没有移除 vCenter Server 数据库 vpx_disabled_methods 表中的条目时，可能会出现此问题。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>确定目标虚拟机的ID，vm-xxxxx;</li>
<li>WEB 浏览器打开这个地址:<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;ExamplevCenterFQDNorIP&gt; 替换 为 VCSA 地址；</span></span><br><span class="line">https://&lt;ExamplevCenterFQDNorIP&gt;/mob/?moid=AuthorizationManager&amp;method=enableMethods</span><br></pre></td></tr></table></figure></li>
<li>使用 SSO 账户登录；</li>
<li>在 entity 的 VALUE 框中，将 MOID 替换为 虚拟机的ID；</li>
<li>在 method 的 VALUE框中；<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">填入 &lt;method&gt; RelocateVM_Task &lt;/method&gt; ；</span><br></pre></td></tr></table></figure></li>
<li>点击调用方法 Invoke Method;</li>
<li>刷新浏览器，重新执行虚拟机vMotion；</li>
</ol>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=1029926">https://knowledge.broadcom.com/external/article?legacyId=1029926</a><br><a target="_blank" rel="noopener" href="https://www.cnuu.net/server/os/vmware/vmware-vsphere-%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%81%e7%a7%bb%e6%8c%89%e9%92%ae%e7%81%b0%e8%89%b2%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88.html">https://www.cnuu.net/server/os/vmware/vmware-vsphere-%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%81%e7%a7%bb%e6%8c%89%e9%92%ae%e7%81%b0%e8%89%b2%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/avenjan/article/details/135113397">https://blog.csdn.net/avenjan/article/details/135113397</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/cce1e06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/cce1e06/" class="post-title-link" itemprop="url">记录一次vMotion异常-多个故障叠加</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-21 21:59:16" itemprop="dateCreated datePublished" datetime="2024-07-21T21:59:16+00:00">2024-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>一台虚拟机要做存储迁移，该虚拟机规格是一台高负载、高配置的复杂虚拟机，虚拟机有40多个vmdk，OS内通过LVM做了条带卷。</p>
<p>第一次迁移，选择一次性同时迁移6块盘，该任务耗时 3 个小时左右，最终提示”Operation timed out”；</p>
<p>第二次迁移，选择单次仅迁移1块盘，任务均会提示失败，提示”The operation is not allowed in the cureent state.The operation cannot be performed because VM migration is in progress.”;</p>
<p>第三次迁移，选择仅迁移计算资源，任务均会提示失败，提示”The operation is not allowed in the cureent state.The operation cannot be performed because VM migration is in progress.”;</p>
<p>第四次迁移，选择仅迁移1块盘，这次任务正常了，任务耗时较久，为54分钟；</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>第一次迁移失败，可能是因为该虚拟机负载过高，vMotion过程需要拷贝原始数据，但数据变化量远远超过vMotion所能承受的极限，在第一次vMotion任务至第四次vMotion任务期间，可以观测到虚拟机整体的IOPS在 10K-17K 之间。</p>
<p>第二次迁移失败，因为在此时发现VCSA有异常，LOG目录的空间被写满，导致vpxd服务异常，因此对VCSA做了扩容修复，并重启了VCSA；这个过程导致VCSA的任务管理异常，迁移任务处于未释放的状态；且重启完VCSA后，选择VCSA的时候，会提示还在同步中；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在VCSA中，可以查到有很多 TASK ID</span></span><br><span class="line"><span class="comment"># 参考：https://blogs.vmware.com/vsphere/2019/09/troubleshooting-vmotion.html</span></span><br><span class="line">grep <span class="string">&quot;relocate&quot;</span> /var/log/vmware/vpxd/vpxd-*.<span class="built_in">log</span> | grep BEGIN</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分析ESXi的hostd日志</span></span><br><span class="line"><span class="comment"># 会有提示</span></span><br><span class="line">Hostlog_ExecuteCleanup:Failed to start disk /vmfs/xxxxxxx.vmdk - not cleaning up.xxxxx</span><br><span class="line"><span class="comment">#  磁盘任务失败；</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务状态也会异常</span></span><br><span class="line">Invlid transition requested (VM_STATE_EMIGRATING -&gt; VM_STATE_CREATE_SCREENSHOT):Invalid state;</span><br></pre></td></tr></table></figure>

<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>VCSA要确保正常，各项服务需要是正常运行的；</li>
<li>ESXi可以尝试重启管理程序，或者在VCSA中试试断开连接后重连；</li>
<li>针对这种类型的虚拟机，迁移时尽可能选择较少的磁盘迁移，每次仅迁移一块磁盘；</li>
</ol>
<blockquote>
<p>留一个方案： 假如我调整了ESXi的 Stream Helper是否会有帮助呢？</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3ec2a553/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3ec2a553/" class="post-title-link" itemprop="url">Windows_Server_内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-07 16:35:33" itemprop="dateCreated datePublished" datetime="2024-07-07T16:35:33+00:00">2024-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="任务管理器"><a href="#任务管理器" class="headerlink" title="任务管理器"></a>任务管理器</h1><h2 id="工作集（内存）"><a href="#工作集（内存）" class="headerlink" title="工作集（内存）"></a>工作集（内存）</h2><p>一个程序能够直接使用的所有物理内存大小。</p>
<h2 id="专用工作集"><a href="#专用工作集" class="headerlink" title="专用工作集"></a>专用工作集</h2><p>这个程序独享的物理内存大小。</p>
<h2 id="共享工作集"><a href="#共享工作集" class="headerlink" title="共享工作集"></a>共享工作集</h2><p>和其他程序共享的内存大小。</p>
<h2 id="提交大小"><a href="#提交大小" class="headerlink" title="提交大小"></a>提交大小</h2><p>程序申请的内存大小。</p>
<h2 id="页面错误"><a href="#页面错误" class="headerlink" title="页面错误"></a>页面错误</h2><p>使用虚拟内存读取失败。读取自 pagefile.sys 。 此错误越多，表示虚拟内存读取越频繁，内存运行效率越低。</p>
<blockquote>
<p>参考： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ii421e7Wd/?spm_id_from=333.1007.tianma.12-3-45.click&vd_source=a011e39eb7bf1b3a9f6ca7ec0db87ccf">https://www.bilibili.com/video/BV1ii421e7Wd/?spm_id_from=333.1007.tianma.12-3-45.click&amp;vd_source=a011e39eb7bf1b3a9f6ca7ec0db87ccf</a></p>
</blockquote>
<h1 id="博文：32MiB-Working-Sets-on-a-64-GiB-machine"><a href="#博文：32MiB-Working-Sets-on-a-64-GiB-machine" class="headerlink" title="博文：32MiB Working Sets on a 64 GiB machine"></a>博文：32MiB Working Sets on a 64 GiB machine</h1><p>大佬博客：<a target="_blank" rel="noopener" href="https://randomascii.wordpress.com/2023/10/01/32-mib-working-sets-on-a-64-gib-machine/#more-4032">https://randomascii.wordpress.com/2023/10/01/32-mib-working-sets-on-a-64-gib-machine/#more-4032</a></p>
<p>Memory is a relatively scarce resource on many consumer computers, so a feature to limit how much memory a process uses seems like a good idea, and Microsoft did indeed implement such a feature. However:</p>
<ul>
<li>They didn’t document this (!)</li>
<li>Their implementation doesn’t actually save memory</li>
<li>The implementation can have a prohibitively high CPU cost</li>
</ul>
<p>This feature works by limiting the working set of a process – the amount of memory mapped into the address-space of the process – to 32 MiB. Before reading any further take a moment to guess what the maximum slowdown might be from this feature. That is, if a process repeatedly touched more than 32 MiB of memory – let’s say 64 MiB of memory – then how much longer could these memory operations take compared to if the working set was not limited? Take a moment and write down your guess. The answer is later in this post.</p>
<p>This exploration started when a Chrome user tweeted at me that they kept seeing Chrome’s setup.exe hogging the CPU. Investigating weird Chrome performance problems is literally my job so we started chatting. Eventually they used UIforETW’s circular-buffer recording mode (leave tracing running, save the buffers when the problem happens) to capture an ETW trace. They filed a Chromium bug and shared the trace and I took a look.</p>
<p>The trace did indeed show lots of CPU time being spent in setup.exe (the sampling rate is 1 kHz so each sample represents approximately 1 ms of CPU time), but there was nothing obviously out of order:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb.png?w=601&h=464"></p>
<p>That is, at a first glance there was nothing obviously out of order, however as soon as I drilled down into the hottest call stack I saw something peculiar:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-1.png?w=601&h=548"></p>
<p>A few hundred samples spent in KiPageFault seemed maybe plausible, but more than 20,000 samples is definitely weird.</p>
<p>KiPageFault is triggered whenever a process touches memory that is not currently in the working set of the process. The memory faulted in might be a zeroed page (first use of an allocated page), a page from the standby list (pages in memory that contain data), a compressed page, or a page that is backed by a file (a memory mapped file or the page file). Whatever the source, this function adjusts the page tables to make the page visible inside the process, and then restarts the faulting instruction.</p>
<p>Since KiPageFault is showing up on multiple call stacks (memory can get paged in from almost anywhere, after all) I needed to use a butterfly view to find out the total cost, and get some hints as to why so much time was being spent there. So, I right-clicked on KiPageFault and selected View Callees, By Function. This showed me two very interesting details:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-2.png?w=602&h=253"></p>
<p>The first detail is that of the 46,912 CPU samples taken from this process fully 46,444 of them (99%!) were inside KiPageFault. That is remarkable. In a steady-state process (not allocating excessively) on a system with sufficient memory (this system had 64 GiB of RAM and roughly 47 GiB of that was available) the number of page faults should be close to zero, and this was a long way from that.</p>
<p>The other detail is that most of the time inside of KiPageFault was spent in MiTrimWorkingSet. This makes sense. But at the same time it is, actually, pretty weird. It looks like every time a page is faulted in to the process the system immediately trims the working set, presumably removing another page from the working set. Doing this is expensive, and increases the odds of future page faults. So, it makes sense in that it explains why the process is spending so much time in KiPageFault, but it is weird because I don’t know why Windows would be doing this.</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-3.png?w=293&h=70"></p>
<p>ETW traces contain a wealth of information so I looked at the “Total Commit” table and found that setup.exe only had 47.418 MiB of commit. This measures the total amount of allocated memory in this process, plus a few other types of memory such as stack, and modified global variables. 47.418 MB is a pretty tiny amount and should take less than 10 ms to fault in (see Hidden Costs of Memory Allocation for details), and there were no new allocations during the trace, so the KiPageFault overhead was definitely excessive.</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-4.png?w=296&h=229"></p>
<h2 id="Procrastination"><a href="#Procrastination" class="headerlink" title="Procrastination"></a>Procrastination</h2><p>I thought that SetProcessWorkingSetSize might be involved in triggering this behavior, and a coworker suggested SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN could be a factor, so I thought about doing some experimentation with these functions. But, the issue was reported on Windows 11 and I assumed that there must be some odd-ball configuration triggering this edge case behavior so I didn’t think my tests would be fruitful so I did nothing for three weeks.</p>
<p>I finally got back to the bug and decided to start by doing the simplest possible test. I wrote code that allocated 64 MiB of RAM, touched all of it, then used EmptyWorkingSet, SetProcessWorkingSetSize, and SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN, then touched the memory again. I used some Sleep(5000) calls and Task Manager to monitor the working set. I was not expecting the simplest possible test to reveal the problem.</p>
<p>My tests showed that EmptyWorkingSet and SetProcessWorkingSetSize both emptied the working set almost to nothing, but the working set “refilled” when the memory was touched again. So, the documentation for these functions (as crazy and archaic as it sounds) seems to be mostly accurate. And, unless they were called extremely frequently these functions could not cause the problem.</p>
<p>On the other hand, my tests showed that SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN caused the working set to be trimmed to 32 MiB, and kept it there when I touched all the memory again. That is, while touching 64 MiB of memory would normally fault those pages in and push the working set to 64 MiB or higher, instead the working set stayed capped.</p>
<p>Whoa. That’s crazy. It wasn’t supposed to be that simple. I refined the test code more but it’s still fairly simple. In its final form the code allocates 64 MiB of memory and then repeatedly walks over that memory (writing once to each page) to see how many times it can walk over the memory in a second. Then it does the same thing with the process set to background mode. The difference is dramatic:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-5.png?w=685&h=116"></p>
<p>The performance of scanning the memory in the normal mode is quite consistent, taking about 0.2 ms per scan. Scanning in background mode normally takes about 250 times as long per scan (two hundred and fifty times as long!!!). Sometimes the background-mode scanning goes dramatically slower – up to about 800 times as long per scan, 160 ms for 64 MiB.</p>
<p>This dramatic increase in CPU time is not a great way to reduce the impact of background processes.</p>
<h2 id="Limiting-the-Working-Set-Doesn’t-Save-Memory"><a href="#Limiting-the-Working-Set-Doesn’t-Save-Memory" class="headerlink" title="Limiting the Working Set Doesn’t Save Memory!"></a>Limiting the Working Set Doesn’t Save Memory!</h2><p>Okay, so PROCESS_MODE_BACKGROUND_BEGIN makes some operations take more than 250 times as long to run, but at least it saves memory. Right? Right?</p>
<p>Well, no. Not really. Not in any situation I can imagine.</p>
<p>Trimming the working set of a process doesn’t actually save memory. It just moves the memory from the working set of the process to the standby list. Then, if the system is under memory pressure the pages in the standby list are eligible to be compressed, or discarded (if unmodified and backed by a file), or written to the page file. But “eligible” is doing a lot of heavy lifting in that sentence. The OS doesn’t immediately do anything with the page, generally speaking. And, if the system has gobs of free and available memory then it may never do anything with the page, making the trimming pointless. The memory isn’t “saved”, it’s just moved from one list to another. It’s the digital equivalent of paper shuffling.</p>
<p>Another reason this trimming is pointless is because the system already has a (much more efficient) mechanism for managing working sets. Every second the system process wakes up and runs KeBalanceSetManager. Among other things this function calls MiProcessWorkingSets which calls MiTrimOrAgeWorkingSet:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-6.png?w=597&h=349"></p>
<p>All I know about this system is the names of the functions and the frequency of its operation, but I feel pretty confident in speculating about roughly what it’s doing, and it seems like a strictly better solution to the problem. Here’s why MiTrimOrAgeWorkingSet is better than PROCESS_MODE_BACKGROUND_BEGIN:</p>
<ul>
<li>Trimming the working set once per second is far more efficient (uses less CPU time) than trimming it after every page fault, and it greatly reduces the odds of trimming a page just before it is needed</li>
<li>Trimming the working set once per second is just as memory efficient as trimming after every page fault because trimming doesn’t immediately save memory anyway</li>
<li>Trimming the working set every second can more easily respond to changes in memory pressure, doing nothing when there is lots of free memory, and then aggressively trimming rarely-touched pages from idle processes when conditions change.</li>
</ul>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><p>As far as Chrome is concerned the solution to this problem was simple – don’t call this function, and therefore don’t put Chrome’s setup process into this mode. We still run in low-priority mode, but not the problematic “background” mode.</p>
<p>But this function remains, waiting to snare some future developer. The easiest thing that Microsoft could do would be to change the documentation to acknowledge this behavior. I have in mind a large, red, bold-faced label saying “if your process uses more than 32 MiB of memory then this may make your program run 250 times slower and it won’t really save memory so maybe use THREAD_MODE_BACKGROUND_BEGIN instead.” But fixing the documentation would not be as valuable as fixing the background mode. I have trouble imagining any scenario where capping the working set would be better than the working-set trimming implemented in the system process, so removing this functionality seems like a pure win.</p>
<p>And fixing the background mode would avoid the need for the ugly large, red, bold-faced warning label.</p>
<p>Ironically the impetus for using PROCESS_MODE_BACKGROUND_BEGIN in Chrome was a 2012 Chrome bug (predating my time on the team, and I’ve been there a while) complaining that the updater was using too much CPU time.</p>
<p>This recent issue was reported on Windows 11, but I found a Mozilla bug discussing this flag that linked to a Stack Overflow answer from 2015 that pointed out that PROCESS_MODE_BACKGROUND_BEGIN limited the working set to 32 MiB on Windows 7. This issue has been known for eight years, on many versions of Windows, and it still hasn’t been corrected or even documented. I hope that changes now.</p>
<h2 id="Addendums"><a href="#Addendums" class="headerlink" title="Addendums"></a>Addendums</h2><p>To clarify, it is the working-set that is trimmed to 32 MiB, not the private working set. So, the 32 MiB number includes code as well as data, for what it’s worth.</p>
<p>Also, after posting this I was playing around and found that when I reset the process with PROCESS_MODE_BACKGROUND_END this causes the working set to be trimmed. That’s harmless, but weird. Why would taking the process out of background mode cause the working set to be trimmed as if the process had called EmptyWorkingSet?</p>
<p>A twitter user posted a bit of history and a tool (untested!) to list working-set state for processes on the system.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/46/">46</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"light","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
