<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/14/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/14/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/14/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">428</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/ee047264/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/ee047264/" class="post-title-link" itemprop="url">OS内使用ipmitools指令修改服务器BMC的IP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-22 16:46:35" itemprop="dateCreated datePublished" datetime="2022-05-22T16:46:35+00:00">2022-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">服务器</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>不能重启服务器的前提下，需要修改BMC的IP。</p>
<h1 id="设置方法"><a href="#设置方法" class="headerlink" title="设置方法"></a>设置方法</h1><p>带外IP，可以在操作系统内更改；带外都是基于ipmi的，所以都可以用ipmitools去修改。主要流程为：</p>
<ol>
<li>设置IP</li>
<li>设置网关</li>
<li>重启bmc生效</li>
</ol>
<h1 id="Windows-操作系统下的操作"><a href="#Windows-操作系统下的操作" class="headerlink" title="Windows 操作系统下的操作"></a>Windows 操作系统下的操作</h1><p>Windows用ipmiutil指令</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示当前BMC的网络设置</span></span><br><span class="line">ipmiutil lan</span><br><span class="line"><span class="comment"># 设置 IP</span></span><br><span class="line">ipmiutil lan <span class="literal">-e</span> <span class="literal">-I</span> x.x.x.x</span><br><span class="line"><span class="comment"># 设置 子网掩码</span></span><br><span class="line">ipmiutil lan <span class="literal">-e</span> <span class="literal">-S</span> x.x.x.x</span><br><span class="line"><span class="comment"># 设置 默认网关</span></span><br><span class="line">ipmiutil lan <span class="literal">-e</span> <span class="literal">-G</span> x.x.x.x </span><br><span class="line"><span class="comment"># 重启BMC</span></span><br><span class="line">ipmiutil reset <span class="literal">-k</span></span><br></pre></td></tr></table></figure>
<h1 id="Linux-操作系统下的操作"><a href="#Linux-操作系统下的操作" class="headerlink" title="Linux 操作系统下的操作"></a>Linux 操作系统下的操作</h1><p>Linux用ipmitools指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示当前BMC的网络设置</span></span><br><span class="line">ipmitool lan <span class="built_in">print</span> 1</span><br><span class="line"><span class="comment"># 设置 IP</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 ipaddr x.x.x.x</span><br><span class="line"><span class="comment"># 设置 子网掩码</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 netmask x.x.x.x</span><br><span class="line"><span class="comment"># 设置 默认网关</span></span><br><span class="line">ipmitool lan <span class="built_in">set</span> 1 defgw ipaddr x.x.x.x</span><br><span class="line"><span class="comment"># 重启BMC</span></span><br><span class="line">ipmitool bmc reset cold</span><br></pre></td></tr></table></figure>

<p>如果出现异常“Could not open device at &#x2F;dev&#x2F;ipmi0 or &#x2F;dev&#x2F;ipmi&#x2F;0 or &#x2F;dev&#x2F;ipmidev&#x2F;0: No such file or directory”,可以执行以下指令:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载以下模块</span></span><br><span class="line">modprobe ipmi_watchdog</span><br><span class="line">modprobe ipmi_poweroff</span><br><span class="line">modprobe ipmi_devintf</span><br><span class="line">modprobe ipmi_si  加载该模块如果没有不影响ipmi的使用（与系统版本有关）</span><br><span class="line">modprobe ipmi_msghandler  加载该模块如果没有不影响ipmi的使用</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>包下载地址：<a target="_blank" rel="noopener" href="http://ipmiutil.sourceforge.net/">http://ipmiutil.sourceforge.net/</a></li>
<li>Linux与Windows指令参考：<a target="_blank" rel="noopener" href="https://portal.nutanix.com/page/documents/kbs/details?targetId=kA0600000008T3jCAE">https://portal.nutanix.com/page/documents/kbs/details?targetId=kA0600000008T3jCAE</a></li>
<li>Linux下IPMI指令异常： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/samuel610/p/10868804.html">https://www.cnblogs.com/samuel610/p/10868804.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/9ba040fd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/9ba040fd/" class="post-title-link" itemprop="url">记录一个Windows远程桌面错误--由于安全设置错误，客户端无法连接到远程计算机</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-22 16:25:19" itemprop="dateCreated datePublished" datetime="2022-05-22T16:25:19+00:00">2022-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>远程桌面提示“由于安全设置错误，客户端无法连接到远程计算机” 。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>需要将“系统加密：将FIPS兼容算法用于加密、哈希和签名”设置为禁用 。</p>
<ol>
<li>打开 secpol.msc</li>
<li>依从进入 安全设置–&gt; 本地策略 –&gt; 安全选项</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Braveliu/p/6759810.html">https://www.cnblogs.com/Braveliu/p/6759810.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/78abb069/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/78abb069/" class="post-title-link" itemprop="url">esxcli 常用指令记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-22 16:24:15" itemprop="dateCreated datePublished" datetime="2022-05-22T16:24:15+00:00">2022-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网络测试"><a href="#网络测试" class="headerlink" title="网络测试"></a>网络测试</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示所有网卡 </span></span><br><span class="line">esxcli network nic list</span><br><span class="line"><span class="comment"># 关闭网卡 </span></span><br><span class="line">esxcli network nic down -n vmnic[X]</span><br><span class="line"><span class="comment"># 开启网卡 </span></span><br><span class="line">esxcli network nic up -n vmnic[X]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考 https://kb.vmware.com/s/article/2006074</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用vmkernel网卡去ping </span></span><br><span class="line">vmkping -I  vmk0 [Target IP]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用巨帧</span></span><br><span class="line">vmkping -d -s 8972 x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考 ： https://kb.vmware.com/s/article/1003728?lang=zh_cn</span></span><br></pre></td></tr></table></figure>

<h1 id="负载查看"><a href="#负载查看" class="headerlink" title="负载查看"></a>负载查看</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">esxtop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用视图</span></span><br><span class="line">u=Disk Device</span><br><span class="line">d=Disk Adapter</span><br><span class="line">x=vSAN</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他视图</span></span><br><span class="line">c=CPU</span><br><span class="line">m=Memory</span><br><span class="line">n=Network</span><br><span class="line">p=Power Management</span><br></pre></td></tr></table></figure>

<h1 id="安装补丁"><a href="#安装补丁" class="headerlink" title="安装补丁"></a>安装补丁</h1><p>esxcli software vib update -d &#x2F;vmfs&#x2F;xxxxxxxx.zip<br>esxcli software vib install -d &#x2F;vmfs&#x2F;xxxxxxxx.zip</p>
<h1 id="设置标准交换机模式"><a href="#设置标准交换机模式" class="headerlink" title="设置标准交换机模式"></a>设置标准交换机模式</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">esxcli network vswitch standard policy failover <span class="built_in">set</span> -l [Policy] -v [vSwitch] -a vmnic[X],vmnic[X]</span><br><span class="line">esxcli network vswitch standard portgroup policy failover -<span class="built_in">set</span> -p <span class="string">&quot;Management Network&quot;</span> -l [Policy] -a vmnic[X],vmnic[X]</span><br></pre></td></tr></table></figure>

<p>[Policy]有以下4种：</p>
<p>explicit – according to the list<br>portid – based on the originating virtual port<br>mac – on source MAC-hash<br>iphash – based on IP-hash</p>
<h1 id="版本查看"><a href="#版本查看" class="headerlink" title="版本查看"></a>版本查看</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmware -v</span><br></pre></td></tr></table></figure>

<h1 id="存储连接状态"><a href="#存储连接状态" class="headerlink" title="存储连接状态"></a>存储连接状态</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">esxcli storage core device list -d=device_ID 命令。</span><br><span class="line"></span><br><span class="line">on- 设备已连接。</span><br><span class="line">dead- 设备已进入 APD 状态。APD 定时器已启动。</span><br><span class="line">dead <span class="built_in">timeout</span>- APD 超时已过期。</span><br><span class="line">not connected- 设备处于 PDL 状态。</span><br></pre></td></tr></table></figure>

<h1 id="回收精简制备vmdk的空间"><a href="#回收精简制备vmdk的空间" class="headerlink" title="回收精简制备vmdk的空间"></a>回收精简制备vmdk的空间</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmkfstools -K /vmfs/volume/xxxx/xxxx.vmdk</span><br><span class="line"><span class="comment"># -K|--punchzero  该选项会对所有清零块取消分配，只留下那些先前分配且包含有效数据的块。生成的虚拟磁盘为精简格式的虚拟磁盘。</span></span><br></pre></td></tr></table></figure>

<h1 id="虚拟机相关操作"><a href="#虚拟机相关操作" class="headerlink" title="虚拟机相关操作"></a>虚拟机相关操作</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚拟机信息 </span></span><br><span class="line">esxcli vm process list</span><br><span class="line">vim-cmd vmsvc/getallvms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结束虚拟机进程</span></span><br><span class="line">esxcli vm process <span class="built_in">kill</span> --<span class="built_in">type</span>[soft,hard,force] --world-id=[WorldNumber]</span><br><span class="line"><span class="comment"># 关闭虚拟机操作系统=soft</span></span><br><span class="line">vim-cmd vmsvc/power.shudown [WorldNumber]</span><br><span class="line"><span class="comment"># 强制关闭虚拟机=hard</span></span><br><span class="line">vim-cmd vmsvc/power.off [WorldNumber]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测是否有相关任务</span></span><br><span class="line">vim-cmd vmsvc/get.tasklist [WorldNumber]</span><br></pre></td></tr></table></figure>

<h1 id="检查目标文件系统Inode情况"><a href="#检查目标文件系统Inode情况" class="headerlink" title="检查目标文件系统Inode情况"></a>检查目标文件系统Inode情况</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stat</span> -f /</span><br></pre></td></tr></table></figure>

<h1 id="进入维护模式"><a href="#进入维护模式" class="headerlink" title="进入维护模式"></a>进入维护模式</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esxcli system maintenanceMode Set --enabled [<span class="built_in">yes</span>/no]</span><br></pre></td></tr></table></figure>
<h1 id="esxcfg命令列表"><a href="#esxcfg命令列表" class="headerlink" title="esxcfg命令列表"></a>esxcfg命令列表</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 防火墙</span></span><br><span class="line">esxcfg-firewall</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由表</span></span><br><span class="line">esxcfg-route</span><br><span class="line"></span><br><span class="line"><span class="comment"># vmkernel网卡</span></span><br><span class="line">esxcfg-vmknic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前网卡信息</span></span><br><span class="line">esxcfg-vswif</span><br><span class="line"></span><br><span class="line"><span class="comment"># 虚拟机交换机</span></span><br><span class="line">esxcfg-vswitch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 物理网卡信息</span></span><br><span class="line">esxcfg-nics</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示HBA设备</span></span><br><span class="line">esxcfg-vmhbadevs</span><br></pre></td></tr></table></figure>

<h1 id="VSAN磁盘组操作"><a href="#VSAN磁盘组操作" class="headerlink" title="VSAN磁盘组操作"></a>VSAN磁盘组操作</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除</span></span><br><span class="line">esxcli vsan storage remove -u [磁盘组UUID]</span><br><span class="line">esxcli vsan storage remove -s [缓存层 SSD NAAID]</span><br><span class="line">esxcli vsan storage remove -d [容量层 NNID]</span><br></pre></td></tr></table></figure>

<h1 id="退出VSAN集群"><a href="#退出VSAN集群" class="headerlink" title="退出VSAN集群"></a>退出VSAN集群</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">esxcli vsan cluster get</span><br><span class="line">esxcli vsan cluster leave</span><br></pre></td></tr></table></figure>

<p>VSAN相关指令：<a target="_blank" rel="noopener" href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.vsan-monitoring.doc/GUID-7799D2D7-2513-4372-92EA-4A1FB510E012.html">https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.vsan-monitoring.doc/GUID-7799D2D7-2513-4372-92EA-4A1FB510E012.html</a></p>
<h1 id="输出日志"><a href="#输出日志" class="headerlink" title="输出日志"></a>输出日志</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm-support -w [指定路径]</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/1010705?lang=zh_CN">https://kb.vmware.com/s/article/1010705?lang=zh_CN</a></p>
<h1 id="重启管理程序"><a href="#重启管理程序" class="headerlink" title="重启管理程序"></a>重启管理程序</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/hostd restart</span><br><span class="line">/etc/init.d/vpxa restart</span><br></pre></td></tr></table></figure>
<p>Restarting the Management agents in ESXi (1003490):<a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/1003490">https://kb.vmware.com/s/article/1003490</a></p>
<h1 id="扩容空间"><a href="#扩容空间" class="headerlink" title="扩容空间"></a>扩容空间</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vpxd_servicecfg storage lvm autogrow</span><br></pre></td></tr></table></figure>

<h1 id="获取Dump日志"><a href="#获取Dump日志" class="headerlink" title="获取Dump日志"></a>获取Dump日志</h1><p>一般情况下，ESXi紫屏后会产生DUMP日志，一般放置在 &#x2F;var&#x2F;core 目录下，</p>
<p>获取dump日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一般在/root/ , /var/core/目录中都能找到zdump文件</span></span><br><span class="line"><span class="comment"># 将zdump文件转为日志文件</span></span><br><span class="line">esxcfg-dumppart -L [vmkernel-zdump-filename]</span><br></pre></td></tr></table></figure>

<p>参考： <a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/1006796?lang=zh_CN">https://kb.vmware.com/s/article/1006796?lang=zh_CN</a></p>
<h1 id="配置-zdump-文件"><a href="#配置-zdump-文件" class="headerlink" title="配置 zdump 文件"></a>配置 zdump 文件</h1><p>参考：<a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/2081902">https://kb.vmware.com/s/article/2081902</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取当前配置</span></span><br><span class="line">esxcli system coredump file get</span><br></pre></td></tr></table></figure>
<h1 id="查询文件锁定"><a href="#查询文件锁定" class="headerlink" title="查询文件锁定"></a>查询文件锁定</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmfsfilelockinfo -p [路径]</span><br></pre></td></tr></table></figure>

<h1 id="VCSA指令-查看证书"><a href="#VCSA指令-查看证书" class="headerlink" title="VCSA指令-查看证书"></a>VCSA指令-查看证书</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> store <span class="keyword">in</span> $(/usr/lib/vmware-vmafd/bin/vecs-cli store list | grep -v TRUSTED_ROOT_CRLS); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;[*] Store :&quot;</span> <span class="variable">$store</span>; /usr/lib/vmware-vmafd/bin/vecs-cli entry list --store <span class="variable">$store</span> --text | grep -ie <span class="string">&quot;Alias&quot;</span> -ie <span class="string">&quot;Not After&quot;</span>;<span class="keyword">done</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参考： <a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/82332">https://kb.vmware.com/s/article/82332</a></p>
<h1 id="获取USB设备"><a href="#获取USB设备" class="headerlink" title="获取USB设备"></a>获取USB设备</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsusb</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>存储相关：<a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.storage.doc/GUID-A5D85C33-A510-4A3E-8FC7-93E6BA0A048F.html">https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.storage.doc/GUID-A5D85C33-A510-4A3E-8FC7-93E6BA0A048F.html</a></li>
<li>关闭虚拟机电源： <a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/1004340?lang=zh_CN">https://kb.vmware.com/s/article/1004340?lang=zh_CN</a></li>
<li>esxcfg命令：<a target="_blank" rel="noopener" href="https://blog.csdn.net/rrs123/article/details/77587702">https://blog.csdn.net/rrs123/article/details/77587702</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/afb69a33/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/afb69a33/" class="post-title-link" itemprop="url">记录一次Ubuntu2004下的kdump配置与测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-22 16:17:42" itemprop="dateCreated datePublished" datetime="2022-05-22T16:17:42+00:00">2022-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/Ubuntu/" itemprop="url" rel="index"><span itemprop="name">Ubuntu</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>有一台服务器经常死机，配置了kdump后并无生成dump日志，手动触发系统Crash后依旧无法重启记录Dump日志。<br>重装操作系统后依旧无生成dump日志。</p>
<ul>
<li>OS：Ubuntu 20.04</li>
<li>Kernel ： 5.4.0-42-generic</li>
<li>CPU：6252 * 4</li>
<li>Memory：512GB</li>
</ul>
<h1 id="分析原因"><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h1><p>经过长期实测，主要原因还是在于需要增加dumpcrash的内存大小，否则kdump进程没有足够多的内存写入日志。</p>
<h1 id="Ubuntu-20-04配置-Kdump-过程"><a href="#Ubuntu-20-04配置-Kdump-过程" class="headerlink" title="Ubuntu 20.04配置 Kdump 过程"></a>Ubuntu 20.04配置 Kdump 过程</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装主要工具</span></span><br><span class="line"><span class="comment"># 这里会安装 crash 、 kexec-tools 、 makedumpfile</span></span><br><span class="line">apt-get install linux-crashdump -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整crashkernel分配的内存空间</span></span><br><span class="line">vim /etc/default/grub.d/kexec-tools.cfg</span><br><span class="line"><span class="comment"># 末尾字段增加</span></span><br><span class="line"><span class="comment"># 需要根据实际内存大小来预分配</span></span><br><span class="line">crashkernel=128G-:4096M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整kdump配置文件</span></span><br><span class="line">vim /etc/default/kdump-tools</span><br><span class="line"><span class="comment">#配置项为 </span></span><br><span class="line">USE_KDUMP=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置触发条件</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 配置项为</span></span><br><span class="line"><span class="comment"># 相应sysrq来触发</span></span><br><span class="line">kernel.sysrq=1</span><br><span class="line"><span class="comment"># 硬件NMI按钮被按下时触发</span></span><br><span class="line">kernel.unknown_nmi_panic=1</span><br><span class="line">kernel.panic_on_unrecovered_nmi=1</span><br><span class="line"><span class="comment"># 触发内存OOM收集kdump</span></span><br><span class="line">vm.panic_on_oom=1</span><br><span class="line"><span class="comment"># 内核在OOPS错误（非法内存访问或非法指令）后触发</span></span><br><span class="line">kernel.panic_on_oops=1</span><br><span class="line"><span class="comment"># 内核在死锁或者死循环（soft-lockup）触发</span></span><br><span class="line">kernel.panic_on_io_nmi=1</span><br><span class="line"><span class="comment"># 内核在进程hung住时触发</span></span><br><span class="line">kernel.hung_task_panic=1</span><br><span class="line"><span class="comment"># 进程hung住多少时间触发</span></span><br><span class="line">kernel.hung_task_timeout_secs=120</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置完成后，需要重启服务器才能生效</span></span><br><span class="line">init 6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否配置成功，可以在重启后执行指令;查看是否有为kdump分配内存</span></span><br><span class="line">dmesg | grep -i crash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启完成后，通过指令查询</span></span><br><span class="line">kdump-config show</span><br><span class="line"><span class="built_in">cat</span> /proc/cmdline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志会默认保存在 /var/crash目录</span></span><br></pre></td></tr></table></figure>

<h1 id="触发测试"><a href="#触发测试" class="headerlink" title="触发测试"></a>触发测试</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/sysrq</span><br><span class="line"><span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br></pre></td></tr></table></figure>

<p>正常情况下，服务器会卡死，并开始记录crash信息，屏幕会输出 makedumpfile 信息。最终将重启服务器，并在&#x2F;var&#x2F;crash目录中生存相关信息。</p>
<h1 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h1><h2 id="分析日志的前置工作–安装-dbgsym"><a href="#分析日志的前置工作–安装-dbgsym" class="headerlink" title="分析日志的前置工作–安装 dbgsym"></a>分析日志的前置工作–安装 dbgsym</h2><p>分析日志需要用到 dbgsym ，也就是debug info包。需要增加 ddebs 源才能安装，联网安装方式为</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb http://ddebs.ubuntu.com <span class="subst">$(lsb_release -cs)</span> main restricted universe multiverse &quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/apt/sources.list.d/ddebs.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/apt/sources.list.d/ddebs.list 应该有以下内容</span></span><br><span class="line">deb http://ddebs.ubuntu.com [Ubuntu 发行版本] main restricted universe multiverse</span><br><span class="line">deb http://ddebs.ubuntu.com [Ubuntu 发行版本]-updates main restricted universe multiverse</span><br><span class="line">deb http://ddebs.ubuntu.com [Ubuntu 发行版本]-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始安装</span></span><br><span class="line">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys ECDCAD72428D7C01</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install systemtap</span><br><span class="line">apt-get install linux-image-$(<span class="built_in">uname</span> -r)-dbgsym</span><br><span class="line">apt-get <span class="built_in">source</span> linux-image-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<p>离线安装方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载地址 http://ddebs.ubuntu.com/pool/main/l/linux</span></span><br><span class="line"><span class="comment"># 因系统为 5.4.0-42-generic 的内核，因此需要使用这个版本</span></span><br><span class="line"><span class="comment"># 下载64位专用版本 linux-image-unsigned-5.4.0-42-generic-dbgsym_5.4.0-42.46_amd64.ddeb </span></span><br><span class="line"><span class="comment"># 服务器内安装 </span></span><br><span class="line">dpkg -i linux-image-unsigned-5.4.0-42-generic-dbgsym_5.4.0-42.46_amd64.ddeb</span><br></pre></td></tr></table></figure>

<h2 id="开始分析"><a href="#开始分析" class="headerlink" title="开始分析"></a>开始分析</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指令  crash [vmcore] [dumpfile]</span></span><br><span class="line"></span><br><span class="line">crash /usr/lib/debug/boot/vmlinux.......   /var/crash/20xxxxx/dump.xxxxxx </span><br><span class="line"></span><br><span class="line"><span class="comment"># 看到因为我们手动触发系统 Crash 的那一部分显示</span></span><br><span class="line">PANIC：“Kernel panic - not syncing： sysrq triggered crash”</span><br></pre></td></tr></table></figure>



<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>CentOS下的配置 <a target="_blank" rel="noopener" href="https://blog.51cto.com/kk876435928/2054256">https://blog.51cto.com/kk876435928/2054256</a><br>Ubuntu 20.04 下配置 <a target="_blank" rel="noopener" href="https://www.ebpf.top/post/ubuntu_kdump_crash/">https://www.ebpf.top/post/ubuntu_kdump_crash/</a><br>Kdump技术了解 <a target="_blank" rel="noopener" href="https://linux.cn/article-8737-1.html">https://linux.cn/article-8737-1.html</a><br>dbgsym: <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1637887">https://cloud.tencent.com/developer/article/1637887</a><br>ubuntu 中 的hwe ： <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/248914/what-is-hardware-enablement-hwe">https://askubuntu.com/questions/248914/what-is-hardware-enablement-hwe</a><br>dbgsym 库 ： <a target="_blank" rel="noopener" href="http://ddebs.ubuntu.com/pool/main/l/linux-hwe-5.4/">http://ddebs.ubuntu.com/pool/main/l/linux-hwe-5.4/</a><br>x86 “ <a target="_blank" rel="noopener" href="https://blog.csdn.net/xiao_yi_xiao/article/details/120223255?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-120223255-blog-86352725.pc_relevant_default&spm=1001.2101.3001.4242.1&utm_relevant_index=3">https://blog.csdn.net/xiao_yi_xiao/article/details/120223255?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-120223255-blog-86352725.pc_relevant_default&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=3</a><br>Ubuntu 中的内存大小 小于 实际内存大小： <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/923371/why-does-ubuntu-show-slightly-less-ram-than-my-computer-has-built-in">https://askubuntu.com/questions/923371/why-does-ubuntu-show-slightly-less-ram-than-my-computer-has-built-in</a><br>kdump ： <a target="_blank" rel="noopener" href="https://wiki.ubuntu.com/Kernel/CrashdumpRecipe">https://wiki.ubuntu.com/Kernel/CrashdumpRecipe</a><br>其他：<a target="_blank" rel="noopener" href="https://blog.csdn.net/quqi99/article/details/38069657">https://blog.csdn.net/quqi99/article/details/38069657</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/75a0989a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/75a0989a/" class="post-title-link" itemprop="url">Powershell常用脚本汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-10 00:15:36" itemprop="dateCreated datePublished" datetime="2022-05-10T00:15:36+00:00">2022-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常用脚本与指令合集"><a href="#常用脚本与指令合集" class="headerlink" title="常用脚本与指令合集"></a>常用脚本与指令合集</h1><h2 id="导出csv"><a href="#导出csv" class="headerlink" title="导出csv"></a>导出csv</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Export-Csv</span> [目标文件名] </span><br><span class="line"><span class="built_in">Export-Csv</span> [目标文件名] <span class="literal">-Delimiter</span> <span class="string">&quot;分隔符&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="特殊字符转意"><a href="#特殊字符转意" class="headerlink" title="特殊字符转意"></a>特殊字符转意</h2><p>需要使用单引号转意 &#96;</p>
<h2 id="获取系统启动时间"><a href="#获取系统启动时间" class="headerlink" title="获取系统启动时间"></a>获取系统启动时间</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Process</span> wininit).StartTime</span><br></pre></td></tr></table></figure>

<h2 id="Invoke-Command-传递参数"><a href="#Invoke-Command-传递参数" class="headerlink" title="Invoke-Command 传递参数"></a>Invoke-Command 传递参数</h2><p>Invoke-Command指令，需要带上-ArgumentList 传递参数<br>代码块使用Param()捕获参数</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> xxxxxxx <span class="literal">-ArgumentList</span> 参数<span class="number">1</span> <span class="literal">-ScriptBlock</span> &#123;<span class="keyword">Param</span>(<span class="variable">$</span>捕获参数<span class="number">1</span>) ; xxx使用 <span class="variable">$</span>捕获参数<span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>

<p>传递多个参数</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ArgumentList</span> [<span class="variable">$</span>参数<span class="number">1</span>],[<span class="variable">$</span>参数<span class="number">2</span>],[<span class="variable">$</span>参数<span class="number">3</span>] <span class="literal">-ScriptBlock</span> &#123;<span class="keyword">Param</span>(<span class="variable">$</span>参数<span class="number">1</span>,<span class="variable">$</span>参数<span class="number">2</span>,<span class="variable">$</span>参数<span class="number">3</span>)&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="获取当前时间"><a href="#获取当前时间" class="headerlink" title="获取当前时间"></a>获取当前时间</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;[yyyy-MM-dd][hh:mm]&quot;</span></span><br></pre></td></tr></table></figure>

<p>常用于打印Log</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetLog</span><span class="params">(<span class="variable">$logLevel</span>,<span class="variable">$logInfo</span>)</span></span>&#123;</span><br><span class="line">  <span class="string">&quot;<span class="variable">$</span>(Get-Date -Format &quot;</span>[<span class="type">yyyy</span>-<span class="type">MM</span>-<span class="type">dd</span>][<span class="type">hh</span>:<span class="type">mm</span>]<span class="string">&quot;)[<span class="variable">$logLevel</span>],[<span class="variable">$logInfo</span>]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="While-语句"><a href="#While-语句" class="headerlink" title="While 语句"></a>While 语句</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (&lt;condition&gt;)&#123;&lt;statement list&gt;&#125;</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$val</span> <span class="operator">-ne</span> <span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$val</span>++</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="variable">$val</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Switch-语句"><a href="#Switch-语句" class="headerlink" title="Switch 语句"></a>Switch 语句</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Switch</span> (&lt;<span class="built_in">test-expression</span>&gt;)</span><br><span class="line">&#123;</span><br><span class="line">    &lt;result1<span class="literal">-to-be-matched</span>&gt; &#123;&lt;action&gt;&#125;;</span><br><span class="line">    &lt;result2<span class="literal">-to-be-matched</span>&gt; &#123;&lt;action&gt;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Examples:</span></span><br><span class="line"><span class="keyword">switch</span> (<span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">1</span> &#123;<span class="string">&quot;It is one.&quot;</span>&#125;</span><br><span class="line">    <span class="number">2</span> &#123;<span class="string">&quot;It is two.&quot;</span>&#125;</span><br><span class="line">    <span class="number">3</span> &#123;<span class="string">&quot;It is three.&quot;</span>&#125;</span><br><span class="line">    <span class="number">4</span> &#123;<span class="string">&quot;It is four.&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="字符转十进制数字"><a href="#字符转十进制数字" class="headerlink" title="字符转十进制数字"></a>字符转十进制数字</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetNumber</span>=[<span class="type">convert</span>]::ToInt32(<span class="variable">$targetString</span>,<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h2 id="切割字符串"><a href="#切割字符串" class="headerlink" title="切割字符串"></a>切割字符串</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$stringArray</span>=<span class="variable">$targetString</span> <span class="operator">-Split</span> <span class="string">&quot;[切割字符]&quot;</span> </span><br></pre></td></tr></table></figure>

<p>一般配合.Trim()方法，来去除空格。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$noSpaceKey</span>=<span class="variable">$targetString</span>.Trim()</span><br></pre></td></tr></table></figure>

<h2 id="获取变量的类型"><a href="#获取变量的类型" class="headerlink" title="获取变量的类型"></a>获取变量的类型</h2><p>一般用于识别当前参数的类型；</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetArgs</span>.GetType()</span><br></pre></td></tr></table></figure>

<h2 id="拷贝文件到远端的方法"><a href="#拷贝文件到远端的方法" class="headerlink" title="拷贝文件到远端的方法"></a>拷贝文件到远端的方法</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remoteSession</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$targetServerHostName</span></span><br><span class="line"><span class="built_in">Copy-Item</span> [<span class="type">Local</span> <span class="type">Target</span> <span class="type">File</span>] <span class="literal">-Destination</span> [<span class="type">Remote</span> <span class="type">Target</span> <span class="type">File</span> <span class="type">Path</span>] <span class="literal">-ToSession</span> <span class="variable">$remoteSession</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ToSession参数需要PS 5.1以上版本才可以使用。</p>
</blockquote>
<h2 id="拷贝文件夹"><a href="#拷贝文件夹" class="headerlink" title="拷贝文件夹"></a>拷贝文件夹</h2><p>需要加参数-Recurse</p>
<blockquote>
<p>最简单的复制一个文件到另一个文件夹内，如果目标文件夹不存在会自动创建。</p>
</blockquote>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Copy-Item</span> <span class="string">&quot;E:\PowerShell\form\*&quot;</span> <span class="literal">-Destination</span> <span class="string">&quot;E:\PowerShell\to\&quot;</span> <span class="literal">-Recurse</span></span><br></pre></td></tr></table></figure>

<h2 id="查看Powershell版本"><a href="#查看Powershell版本" class="headerlink" title="查看Powershell版本"></a>查看Powershell版本</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PSVersionTable</span> | Findstr PSVersion</span><br></pre></td></tr></table></figure>

<h2 id="获取当前登录的用户数"><a href="#获取当前登录的用户数" class="headerlink" title="获取当前登录的用户数"></a>获取当前登录的用户数</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$userTempInfo1</span>=query user | <span class="built_in">Measure-Object</span> | Findstr Count;</span><br><span class="line"><span class="variable">$userTempInfo2</span>=<span class="variable">$userTempInfo1</span> <span class="operator">-Split</span> <span class="string">&quot;:&quot;</span>;</span><br><span class="line"><span class="variable">$userTempInfo3</span>=<span class="variable">$userTempInfo2</span>[<span class="number">1</span>].Trim();</span><br><span class="line"><span class="variable">$userTempAmount</span>=[<span class="type">Convert</span>]::ToInt32(<span class="variable">$userTempInfo3</span>,<span class="number">10</span>);</span><br><span class="line"><span class="variable">$userAmount</span>=<span class="variable">$userTempAmount</span><span class="literal">-1</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当服务器未有用户会话时，query user指令会返回“无用户登录”。</p>
</blockquote>
<h2 id="条件语句比较"><a href="#条件语句比较" class="headerlink" title="条件语句比较"></a>条件语句比较</h2><p>数字比较</p>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-gt</td>
<td align="center">大于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-ge</td>
<td align="center">大于等于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-lt</td>
<td align="center">小于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-le</td>
<td align="center">小于等于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-eq</td>
<td align="center">等于</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-ne</td>
<td align="center">不等于</td>
<td align="center"></td>
</tr>
</tbody></table>
<p>字符串比较</p>
<table>
<thead>
<tr>
<th align="center">字符</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-like</td>
<td align="center">字符串匹配通配符模式</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">-match</td>
<td align="center">字符串匹配正则表达式模式</td>
<td align="center"></td>
</tr>
</tbody></table>
<blockquote>
<p>注意，所有字符串都能 match 空值 $null</p>
</blockquote>
<h2 id="检查目标补丁是否安装"><a href="#检查目标补丁是否安装" class="headerlink" title="检查目标补丁是否安装"></a>检查目标补丁是否安装</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目标补丁KB号</span></span><br><span class="line">TargetHotFixIDArray=<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span>=<span class="number">0</span> ; <span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TargetHotFixIDArray</span>.length ; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">  <span class="variable">$isInstalled</span>=<span class="built_in">Get-HotFix</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.HotFixID=<span class="variable">$TargetHotFixIDArray</span>[<span class="variable">$i</span>]&#125; ;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$isInstalled</span> <span class="operator">-eq</span> <span class="variable">$null</span>)&#123;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$TargetHotFixIDArray</span>[<span class="variable">$i</span>] don&#x27;t installed.&quot;</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="设置注册表"><a href="#设置注册表" class="headerlink" title="设置注册表"></a>设置注册表</h2><p>注意：如果设置本地组策略或者有域策略的覆盖策略情况下，注册表写入的值会被覆盖。可以使用 rsop.msc 查看。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主要使用的指令</span></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKCU:\xxx\&#x27;</span> <span class="literal">-Name</span> [<span class="type">xxx</span>] <span class="literal">-Value</span> [<span class="type">xxx</span>]</span><br><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:\xxx\&#x27;</span> <span class="literal">-Name</span> [<span class="type">xxx</span>] <span class="literal">-Value</span> [<span class="type">xxx</span>]</span><br><span class="line"><span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKCU:\xxx\&#x27;</span> <span class="literal">-Name</span> [<span class="type">xxxx</span>]</span><br><span class="line"><span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:\xxx\&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 隐藏所有盘符</span></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer&#x27;</span> <span class="literal">-Name</span> NoDrives <span class="literal">-Value</span> <span class="number">61708863</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 除了设置常规的注册表项 （admx.help 获取） ，还可以关注WOW6432node注册表项</span><br><span class="line"># 参照</span><br><span class="line">When the 32-bit app performs a registry query on HKEY_LOCAL_MACHINE\SOFTWARE\&lt;company&gt;\&lt;product&gt;, Windows automatically redirects the query to HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\&lt;company&gt;\&lt;product&gt;</span><br><span class="line"></span><br><span class="line">There’s no need to take into account Wow6432 during the development of a 32-bit application. The management of Wow6432 is totally transparent for the developer. Kombustor, for example, modifies Afterburner registry entry:</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\MSI\Afterburner. During the dev of Kombustor, I never made a reference to Wow6432.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看对应的注册表项 <a target="_blank" rel="noopener" href="https://admx.help/">https://admx.help</a></p>
</blockquote>
<h2 id="设置网卡"><a href="#设置网卡" class="headerlink" title="设置网卡"></a>设置网卡</h2><p>静态IP设置</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改IP</span></span><br><span class="line">netsh interface ipv4 address [网卡名] <span class="keyword">static</span> [<span class="type">IP</span>] [<span class="type">NETMASK</span>] [<span class="type">Gateway</span>]</span><br><span class="line"><span class="comment"># 修改DNS</span></span><br><span class="line"><span class="comment"># 主DNS</span></span><br><span class="line">netsh interface ipv4 dns [网卡名] <span class="keyword">static</span> [<span class="type">DNS</span>] primary</span><br><span class="line"><span class="comment"># 副DNS</span></span><br><span class="line">netsh interface ipv4 add dns [网卡名] [<span class="type">DNS</span>]</span><br></pre></td></tr></table></figure>

<p>DHCP设置</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh interface ipv4 <span class="built_in">set</span> address [网卡名] dhcp</span><br><span class="line">netsh interface ipv4 <span class="built_in">set</span> dns [网卡名] dhcp</span><br></pre></td></tr></table></figure>

<h3 id="设置DNS"><a href="#设置DNS" class="headerlink" title="设置DNS"></a>设置DNS</h3><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$NICNAMESET</span>=<span class="built_in">Get-NetAdapter</span> <span class="literal">-Physical</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$NICNAMESET</span>=<span class="built_in">Get-NetAdapter</span> <span class="literal">-Physical</span>;</span><br><span class="line"><span class="variable">$PRIMARYDNS</span>=<span class="string">&quot;8.8.8.8&quot;</span>;</span><br><span class="line"><span class="variable">$SECONDDNS</span>=<span class="string">&quot;8.8.4.4&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$NICNAMESET</span>.Name.GetType().BaseType.Name <span class="operator">-match</span> <span class="string">&quot;Object&quot;</span>)&#123;</span><br><span class="line">    <span class="comment"># 单网卡设置DNS；</span></span><br><span class="line">    <span class="variable">$NICNAME</span>=<span class="variable">$NICNAMESET</span>.Name;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Set-DnsClientServerAddress</span> <span class="literal">-InterfaceAlias</span> <span class="variable">$NICNAME</span> <span class="literal">-ServerAddresses</span> <span class="variable">$PRIMARYDNS</span>,<span class="variable">$SECONDDNS</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">elseif</span> (<span class="variable">$NICNAMESET</span>.Name.GetType().BaseType.Name <span class="operator">-match</span> <span class="string">&quot;Array&quot;</span>) &#123;</span><br><span class="line">    <span class="comment"># 多网卡设置DNS</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$NICNAMESET</span>.Length;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$NICNAME</span>=<span class="variable">$NICNAMESET</span>.Name[<span class="variable">$i</span>];</span><br><span class="line">        <span class="built_in">Set-DnsClientServerAddress</span> <span class="literal">-InterfaceAlias</span> <span class="variable">$NICNAME</span> <span class="literal">-ServerAddresses</span> <span class="variable">$PRIMARYDNS</span>,<span class="variable">$SECONDDNS</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="切割IP信息"><a href="#切割IP信息" class="headerlink" title="切割IP信息"></a>切割IP信息</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取IP信息</span></span><br><span class="line"><span class="variable">$IPInfo</span>=<span class="variable">$</span>(<span class="variable">$</span>(ipconfig | findstr <span class="string">&quot;IPv4&quot;</span>) <span class="operator">-Split</span> <span class="string">&quot;[:]&quot;</span>)[<span class="number">1</span>].Trim();</span><br></pre></td></tr></table></figure>

<h3 id="切割IP信息-基于IP做主机名修改"><a href="#切割IP信息-基于IP做主机名修改" class="headerlink" title="切割IP信息-基于IP做主机名修改"></a>切割IP信息-基于IP做主机名修改</h3><p>格式为：主机名[IP第四位的序号]</p>
<p>如：</p>
<ul>
<li>主机名001</li>
<li>主机名010</li>
<li>主机名111</li>
</ul>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$baseHostname</span>=<span class="string">&quot;【设置的主机名基本格式】&quot;</span>;</span><br><span class="line"><span class="variable">$IPInfo</span>=<span class="variable">$</span>(<span class="variable">$</span>(ipconfig | findstr <span class="string">&quot;IPv4&quot;</span>) <span class="operator">-Split</span> <span class="string">&quot;[:]&quot;</span>)[<span class="number">1</span>].Trim();</span><br><span class="line"><span class="variable">$index</span>=<span class="variable">$</span>(<span class="variable">$IPInfo</span> <span class="operator">-Split</span> <span class="string">&quot;[.]&quot;</span>)[<span class="number">3</span>].Trim();</span><br><span class="line"></span><br><span class="line"><span class="comment">#将字符型转为整型 </span></span><br><span class="line"><span class="variable">$flag</span>=[<span class="type">convert</span>]::ToInt32(<span class="variable">$index</span>,<span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-ge</span> <span class="number">1</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-le</span> <span class="number">9</span>) )&#123;</span><br><span class="line">  <span class="comment"># 在 001 与 009 区间</span></span><br><span class="line">  <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="string">&quot;00&quot;</span> + <span class="variable">$index</span>;</span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-ge</span> <span class="number">10</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-le</span> <span class="number">99</span>))&#123;</span><br><span class="line">  <span class="comment"># 在 100 与 99 区间</span></span><br><span class="line">  <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="string">&quot;0&quot;</span> + <span class="variable">$index</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="comment"># 大于100</span></span><br><span class="line">  <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="variable">$index</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 两种改名方式</span></span><br><span class="line"><span class="comment"># 方式1：非加域</span></span><br><span class="line"><span class="built_in">Rename-Computer</span> <span class="literal">-NewName</span> <span class="variable">$newHostname</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：加域</span></span><br><span class="line"><span class="built_in">Add-Computer</span> <span class="literal">-DomainName</span> <span class="string">&quot;【目标域名】&quot;</span> <span class="literal">-Credential</span> <span class="string">&quot;加域用的账户&quot;</span> <span class="literal">-NewName</span> <span class="variable">$newHostname</span>;</span><br></pre></td></tr></table></figure>
<h2 id="检查端口占用进程"><a href="#检查端口占用进程" class="headerlink" title="检查端口占用进程"></a>检查端口占用进程</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat <span class="literal">-ab</span></span><br></pre></td></tr></table></figure>

<h2 id="服务器安装角色"><a href="#服务器安装角色" class="headerlink" title="服务器安装角色"></a>服务器安装角色</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取安装的功能</span></span><br><span class="line"><span class="built_in">Get-WindowsFeature</span> <span class="literal">-ComputerName</span> [主机名]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装功能</span></span><br><span class="line"><span class="built_in">Install-WindowsFeature</span> <span class="literal">-Name</span> [功能名]</span><br></pre></td></tr></table></figure>

<h3 id="安装Remote-Desktop-Host-Session"><a href="#安装Remote-Desktop-Host-Session" class="headerlink" title="安装Remote Desktop Host Session"></a>安装Remote Desktop Host Session</h3><p>远程桌面会话主机： RDS-RD-Server</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动重启需要加参数 -Restart</span></span><br><span class="line"><span class="built_in">Install-WindowsFeature</span> <span class="literal">-Name</span> <span class="string">&quot;RDS-RD-Server&quot;</span> <span class="literal">-Restart</span></span><br></pre></td></tr></table></figure>

<h2 id="加域"><a href="#加域" class="headerlink" title="加域"></a>加域</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Cred</span>=<span class="built_in">Get-Credential</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Add-Computer</span> <span class="literal">-DomainName</span> <span class="variable">$Domain</span> <span class="literal">-Credential</span> <span class="variable">$Cred</span> <span class="literal">-NewName</span> <span class="variable">$NewComputerName</span></span><br></pre></td></tr></table></figure>

<h2 id="在文本后面追加内容"><a href="#在文本后面追加内容" class="headerlink" title="在文本后面追加内容"></a>在文本后面追加内容</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-Content</span> [<span class="type">FilePath</span>] [<span class="type">Content</span>]</span><br></pre></td></tr></table></figure>

<h2 id="禁用本地账户"><a href="#禁用本地账户" class="headerlink" title="禁用本地账户"></a>禁用本地账户</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Disable-LocalUser</span> <span class="literal">-Name</span> [<span class="type">UserName</span>]</span><br></pre></td></tr></table></figure>

<h2 id="为本地用户组增加用户"><a href="#为本地用户组增加用户" class="headerlink" title="为本地用户组增加用户"></a>为本地用户组增加用户</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-LocalGroupMember</span> <span class="literal">-Name</span> <span class="string">&quot;组名&quot;</span>  <span class="literal">-Member</span> <span class="string">&quot;用户&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\脚本.ps1  [参数1文件]</span><br><span class="line"><span class="variable">$FILE</span>=<span class="variable">$args</span>[0];</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数1文件名获取 </span></span><br><span class="line"><span class="variable">$FILE</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="启动服务与设置服务"><a href="#启动服务与设置服务" class="headerlink" title="启动服务与设置服务"></a>启动服务与设置服务</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-Service</span> <span class="string">&quot;Zabbix Agent&quot;</span></span><br><span class="line"><span class="built_in">Set-Service</span> <span class="string">&quot;Zabbix Agent&quot;</span> <span class="literal">-StartupType</span> Automatic</span><br></pre></td></tr></table></figure>

<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ; <span class="variable">$i</span> <span class="operator">-le</span> <span class="number">10</span> ; <span class="variable">$i</span>++ )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$i</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试端口是否连通"><a href="#测试端口是否连通" class="headerlink" title="测试端口是否连通"></a>测试端口是否连通</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$TCP</span>=<span class="built_in">New-Object</span> Net.Sockets.TcpClient</span><br><span class="line"><span class="variable">$TCP</span>.Connect(<span class="string">&quot;192.168.1.1&quot;</span>,<span class="number">80</span>)</span><br><span class="line"><span class="variable">$TCP</span>.Close();</span><br></pre></td></tr></table></figure>

<h2 id="删除用户配置文件"><a href="#删除用户配置文件" class="headerlink" title="删除用户配置文件"></a>删除用户配置文件</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#requires -RunAsAdministrator</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$domain</span> = <span class="string">&#x27;ccie&#x27;</span></span><br><span class="line"><span class="variable">$username</span> = <span class="string">&#x27;user01&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get user SID</span></span><br><span class="line"><span class="variable">$sid</span> = (<span class="built_in">New-Object</span> Security.Principal.NTAccount(<span class="variable">$domain</span>, <span class="variable">$username</span>)).Translate([<span class="type">Security.Principal.SecurityIdentifier</span>]).Value</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-WmiObject</span> <span class="literal">-ClassName</span> Win32_UserProfile <span class="literal">-Filter</span> <span class="string">&quot;SID=&#x27;<span class="variable">$sid</span>&#x27;&quot;</span> |</span><br><span class="line">  <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="variable">$_</span>.Delete()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除用户配置文件改进版本"><a href="#删除用户配置文件改进版本" class="headerlink" title="删除用户配置文件改进版本"></a>删除用户配置文件改进版本</h3><p>场景：读取本地RDSH内的所有已登录的用户AD，并识别出已经停用的AD，对状态为“已停用”的AD账户配置删除。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#requires -RunAsAdministrator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始信息，需要输入AD域名</span></span><br><span class="line"><span class="variable">$domain</span> = <span class="string">&#x27;ccie&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户目录位置</span></span><br><span class="line"><span class="variable">$fpath</span>=<span class="string">&quot;C:\Users&quot;</span></span><br><span class="line"><span class="variable">$childPath</span>=<span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="variable">$fpath</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$tempPath</span> <span class="keyword">in</span> <span class="variable">$childPath</span> )&#123;</span><br><span class="line">  <span class="variable">$userName</span>=<span class="variable">$tempPath</span>.Name.Trim()</span><br><span class="line">  <span class="variable">$userInfo</span>=net user <span class="variable">$userName</span> /domain</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$userInfo</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;Yes&quot;</span>)&#123;</span><br><span class="line">    <span class="comment">#&quot;$userName is ACTIVE.&quot;</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="string">&quot;<span class="variable">$userName</span> is INACTIVE.Deleting...&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get user SID</span></span><br><span class="line">    <span class="variable">$sid</span> = (<span class="built_in">New-Object</span> Security.Principal.NTAccount(<span class="variable">$domain</span>, <span class="variable">$username</span>)).Translate([<span class="type">Security.Principal.SecurityIdentifier</span>]).Value</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-WmiObject</span> <span class="literal">-ClassName</span> Win32_UserProfile <span class="literal">-Filter</span> <span class="string">&quot;SID=&#x27;<span class="variable">$sid</span>&#x27;&quot;</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">      <span class="variable">$_</span>.Delete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="查看WINRM监听端口"><a href="#查看WINRM监听端口" class="headerlink" title="查看WINRM监听端口"></a>查看WINRM监听端口</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrm enumerate winrm/config/listener</span><br></pre></td></tr></table></figure>

<h2 id="更改WINRM监听端口"><a href="#更改WINRM监听端口" class="headerlink" title="更改WINRM监听端口"></a>更改WINRM监听端口</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set-item</span> wsman:\localhost\listener\listener*\port <span class="number">5895</span></span><br></pre></td></tr></table></figure>

<h2 id="逐行读取"><a href="#逐行读取" class="headerlink" title="逐行读取"></a>逐行读取</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Content</span> [<span class="type">FILEPATH</span>] | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">  <span class="comment">#line = $_</span></span><br><span class="line">  <span class="variable">$_</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-Timespan</span> [更早的时间]  [更晚的时间]</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-Timespan</span> <span class="variable">$</span>(<span class="built_in">Get-Date</span>) <span class="variable">$</span>(<span class="built_in">Get-Date</span> <span class="string">&quot;target date&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="获取注册表值"><a href="#获取注册表值" class="headerlink" title="获取注册表值"></a>获取注册表值</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ItemPropertyValue</span> <span class="literal">-Path</span> HKLM:\xxxxx\xxxx <span class="literal">-Name</span> [<span class="type">ItemName</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如果注册表路径带有空格，则需要将整个路径用” “</p>
</blockquote>
<h2 id="设置注册表值"><a href="#设置注册表值" class="headerlink" title="设置注册表值"></a>设置注册表值</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> HKLM:\路径 <span class="literal">-Name</span> [<span class="type">ItemName</span>] <span class="literal">-value</span> [具体的值]</span><br></pre></td></tr></table></figure>

<h2 id="非Powershell–Chrome忽略证书"><a href="#非Powershell–Chrome忽略证书" class="headerlink" title="非Powershell–Chrome忽略证书"></a>非Powershell–Chrome忽略证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 增加参数</span><br><span class="line">–ignore-certificate-errors</span><br></pre></td></tr></table></figure>

<h2 id="清除剪贴板"><a href="#清除剪贴板" class="headerlink" title="清除剪贴板"></a>清除剪贴板</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cmd</span>.exe /c &quot;<span class="built_in">echo</span> off | clip&quot;</span><br></pre></td></tr></table></figure>

<h2 id="检查Windows是否需要因为补丁重启"><a href="#检查Windows是否需要因为补丁重启" class="headerlink" title="检查Windows是否需要因为补丁重启"></a>检查Windows是否需要因为补丁重启</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#The RebootPending value at</span><br><span class="line">#HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing</span><br><span class="line">#The RebootRequired value at</span><br><span class="line">#HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update</span><br><span class="line">#The PendingFileRenameOperations value at</span><br><span class="line">#HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager</span><br></pre></td></tr></table></figure>

<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">isRebootRequired=<span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$isRebootRequired</span> <span class="operator">-eq</span> <span class="variable">$null</span>)&#123;</span><br><span class="line">  <span class="string">&quot;Current server don&#x27;t need Reboot.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="string">&quot;Current server need Reboot.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="静默安装Chrome"><a href="#静默安装Chrome" class="headerlink" title="静默安装Chrome"></a>静默安装Chrome</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 会话需要保持几分钟，用于Chrome完成安装；</span></span><br><span class="line">Chrome<span class="literal">-xxxxx</span>.msi  /passive /norestart; <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<p>Chrome 下载地址</p>
<p>x64位下载地址</p>
<p><a target="_blank" rel="noopener" href="http://www.google.com/intl/zh-CN/chrome/business/browser/admin/thankyou.html?platform=win64&msi=true&installdataindex=defaultbrowser&standalone=1">http://www.google.com/intl/zh-CN/chrome/business/browser/admin/thankyou.html?platform=win64&amp;msi=true&amp;installdataindex=defaultbrowser&amp;standalone=1</a></p>
<p>x86位下载地址<br><a target="_blank" rel="noopener" href="http://www.google.com/intl/zh-CN/chrome/business/browser/admin/thankyou.html?platform=win&msi=true&installdataindex=defaultbrowser&standalone=1">http://www.google.com/intl/zh-CN/chrome/business/browser/admin/thankyou.html?platform=win&amp;msi=true&amp;installdataindex=defaultbrowser&amp;standalone=1</a></p>
<h2 id="静默安装火狐浏览器"><a href="#静默安装火狐浏览器" class="headerlink" title="静默安装火狐浏览器"></a>静默安装火狐浏览器</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Firefox<span class="literal">-xxxxx</span>.msi  /passive /norestart; <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Chrome浏览器制定用户数据目录"><a href="#Chrome浏览器制定用户数据目录" class="headerlink" title="Chrome浏览器制定用户数据目录"></a>Chrome浏览器制定用户数据目录</h2><p>增加参数–user-data-dir&#x3D;”xxxx%username%\ChromeData”</p>
<h2 id="离线安装cab文件"><a href="#离线安装cab文件" class="headerlink" title="离线安装cab文件"></a>离线安装cab文件</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe  /online /<span class="built_in">add-package</span> /packagepath:<span class="string">&quot;路径&quot;</span>  /Quiet</span><br></pre></td></tr></table></figure>

<ul>
<li>会自动重启 &#x2F;Quiet</li>
<li>不用自动重启 &#x2F;Norestart</li>
</ul>
<h1 id="设置防火墙策略"><a href="#设置防火墙策略" class="headerlink" title="设置防火墙策略"></a>设置防火墙策略</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用策略</span></span><br><span class="line"><span class="built_in">Get-NetFirewallRule</span> <span class="literal">-Name</span> [防火墙策略名] | <span class="built_in">Set-NetFirewallRule</span> <span class="literal">-Enabled</span>;</span><br><span class="line"><span class="comment"># 设置目标策略的作用域,&#123;IP1&#125;,&#123;IP2&#125;,&#123;IP3&#125;</span></span><br><span class="line"><span class="built_in">Get-NetfirewallRule</span> <span class="literal">-Name</span> [防火墙策略名] | <span class="built_in">Get-NetFirewallAddressFilter</span> | <span class="built_in">Set-NetFirewallAddressFilter</span> <span class="literal">-RemoteAddress</span> &#123;IP1&#125;,&#123;IP2&#125;,&#123;IP3&#125;</span><br></pre></td></tr></table></figure>
<h1 id="关闭本地防火墙"><a href="#关闭本地防火墙" class="headerlink" title="关闭本地防火墙"></a>关闭本地防火墙</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state off</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state on</span><br></pre></td></tr></table></figure>

<h1 id="常用防火墙策略名称"><a href="#常用防火墙策略名称" class="headerlink" title="常用防火墙策略名称"></a>常用防火墙策略名称</h1><table>
<thead>
<tr>
<th align="center">策略显示名(Display)</th>
<th align="center">策略名(Name)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Windows 远程管理(HTTP-In)</td>
<td align="center">WINRM-HTTP-IN-TCP</td>
</tr>
<tr>
<td align="center">Windows 远程管理(HTTP-In)</td>
<td align="center">WINRM-HTTP-IN-TCP-PUBLIC</td>
</tr>
<tr>
<td align="center">远程计划任务管理(RPC)</td>
<td align="center">RemoteTask-In-TCP</td>
</tr>
<tr>
<td align="center">远程计划任务管理(RPC-EPMAP)</td>
<td align="center">RemoteTask-RPCSS-In-TCP</td>
</tr>
</tbody></table>
<h1 id="系统延迟"><a href="#系统延迟" class="headerlink" title="系统延迟"></a>系统延迟</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> [单位为秒];</span><br></pre></td></tr></table></figure>

<h1 id="发送邮件通知"><a href="#发送邮件通知" class="headerlink" title="发送邮件通知"></a>发送邮件通知</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Send-MailMessage</span> <span class="literal">-From</span> [发件人] <span class="literal">-To</span> [收件人] <span class="literal">-Cc</span> [抄送人] <span class="literal">-Subject</span> [邮件主题] <span class="literal">-Body</span> [邮件内容] <span class="literal">-Credential</span> [邮箱服务器认证账户] <span class="literal">-SmtpServer</span> [目标邮箱服务器地址]</span><br><span class="line"></span><br><span class="line"><span class="variable">$mailbody</span>=<span class="string">@&quot;</span></span><br><span class="line"><span class="string">......邮件内容</span></span><br><span class="line"><span class="string">&quot;@</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>中文邮件要注意编码，指令末尾需要加上 -Encoding ([System.Text.Encoding]::UTF8)</p>
</blockquote>
<h1 id="模板–逐行读取文件"><a href="#模板–逐行读取文件" class="headerlink" title="模板–逐行读取文件"></a>模板–逐行读取文件</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment"># Version:</span></span><br><span class="line"><span class="comment"># Date:</span></span><br><span class="line"><span class="comment"># Author:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入文件</span></span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$index</span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$file</span> <span class="operator">-match</span> <span class="string">&quot;.\\&quot;</span>)&#123;</span><br><span class="line">  <span class="comment"># 如果输入的参数是文件，则逐行读取</span></span><br><span class="line">  <span class="built_in">Get-Content</span> <span class="variable">$file</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">  <span class="variable">$target</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">  <span class="string">&quot;[<span class="variable">$index</span>][<span class="variable">$target</span>]&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># TODO HERE：</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$index</span>++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="comment"># 如果是单独一行字符串；</span></span><br><span class="line">  <span class="variable">$target</span>=<span class="variable">$file</span>.Trim();</span><br><span class="line">  <span class="string">&quot;[<span class="variable">$index</span>][<span class="variable">$target</span>]&quot;</span></span><br><span class="line">  <span class="comment"># TODO HERE;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="设置WSUS下载服务器的地址–注册表项"><a href="#设置WSUS下载服务器的地址–注册表项" class="headerlink" title="设置WSUS下载服务器的地址–注册表项"></a>设置WSUS下载服务器的地址–注册表项</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetWSUS</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> HKLM:Software\Policies\Microsoft\Windows\WindowsUpdate <span class="literal">-Name</span> WUServer <span class="literal">-Value</span> <span class="variable">$targetWSUS</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> HKLM:Software\Policies\Microsoft\Windows\WindowsUpdate <span class="literal">-Name</span> WUStatusServer <span class="literal">-Value</span> <span class="variable">$targetWSUS</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="定义函数与参数"><a href="#定义函数与参数" class="headerlink" title="定义函数与参数"></a>定义函数与参数</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TEST</span></span>&#123;</span><br><span class="line">  <span class="comment"># 参数写法,这里传入的是形参；</span></span><br><span class="line">  <span class="keyword">param</span>(<span class="variable">$</span>参数<span class="number">1</span>,<span class="variable">$</span>参数<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 函数内调用的参数与变更，仅在函数内有效；</span></span><br><span class="line">  <span class="variable">$</span>参数<span class="number">1</span>=[<span class="type">New</span> <span class="type">Value</span>];</span><br><span class="line">  <span class="variable">$</span>参数<span class="number">2</span>=[<span class="type">New</span> <span class="type">Value</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [返回值];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数</span></span><br><span class="line"><span class="comment"># 参数对应关系 $参数1=$传入参数1,$参数2=$传入参数2;</span></span><br><span class="line"><span class="comment"># 不抓取返回值的写法</span></span><br><span class="line">TEST <span class="variable">$</span>传入参数<span class="number">1</span> <span class="variable">$</span>传入参数<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取返回值的写法</span></span><br><span class="line"><span class="variable">$GETRETURN</span>=TEST <span class="variable">$</span>传入参数<span class="number">1</span> <span class="variable">$</span>传入参数<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="删除软件包"><a href="#删除软件包" class="headerlink" title="删除软件包"></a>删除软件包</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Package</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.Name <span class="operator">-like</span> <span class="string">&quot;包名&quot;</span>&#125; | <span class="built_in">Uninstall-Package</span></span><br></pre></td></tr></table></figure>

<h2 id="设置受信任主机列表"><a href="#设置受信任主机列表" class="headerlink" title="设置受信任主机列表"></a>设置受信任主机列表</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Item</span> WSman:\localhost\Client\TrustedHosts <span class="literal">-value</span> [列表]</span><br></pre></td></tr></table></figure>

<h2 id="输出控制台指令日志记录"><a href="#输出控制台指令日志记录" class="headerlink" title="输出控制台指令日志记录"></a>输出控制台指令日志记录</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-Transcript</span> <span class="literal">-Path</span> [<span class="type">Log</span> <span class="type">file</span> <span class="type">path</span>];</span><br><span class="line"><span class="built_in">Stop-Transcript</span>;</span><br></pre></td></tr></table></figure>
<h2 id="遍历文件夹并传输文件"><a href="#遍历文件夹并传输文件" class="headerlink" title="遍历文件夹并传输文件"></a>遍历文件夹并传输文件</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps1</span></span><br><span class="line"><span class="comment"># Description: 迁移文件至执行脚本所在的目录</span></span><br><span class="line"><span class="comment"># Version:v1</span></span><br><span class="line"><span class="comment"># Date:2024-10-04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本的第一个参数为0 ， 这个跟Shell脚本有差异，Bash Shell脚本是 $1;Windows Shell 脚本是$args[0];</span></span><br><span class="line"><span class="variable">$target_directoryName</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Move-FileToParentDir</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$target_DirName</span>,<span class="variable">$dir_depth</span>,<span class="variable">$is_move</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Current parent folder is <span class="variable">$target_DirName</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Current depth is <span class="variable">$dir_depth</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;Current is_move flag is <span class="variable">$is_move</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_dirtoryItem</span>=<span class="built_in">get-Item</span> <span class="variable">$target_DirName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-ChildItem</span> <span class="variable">$target_dirtoryItem</span> | <span class="built_in">Foreach-Object</span> &#123;</span><br><span class="line">        <span class="variable">$item_object</span>=<span class="variable">$_</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$item_object</span> | <span class="built_in">where-object</span> &#123;<span class="variable">$_</span>.mode <span class="operator">-match</span> <span class="string">&quot;d&quot;</span>&#125;)&#123;</span><br><span class="line">            <span class="comment"># Is directory</span></span><br><span class="line">            <span class="comment"># Powershell允许参数自加，LinuxShell没有此规则，需要$(($目标参数+1))</span></span><br><span class="line">            <span class="built_in">Move-FileToParentDir</span> <span class="string">&quot;<span class="variable">$target_dirtoryItem</span>\<span class="variable">$item_object</span>&quot;</span> <span class="variable">$</span>(<span class="variable">$dir_depth</span>+<span class="number">1</span>) <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$target_DirName</span>\<span class="variable">$</span>(<span class="variable">$item_object</span>.Name) is a file&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$is_move</span> <span class="operator">-eq</span> <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment"># 这个是执行脚本所在的目录，.\等价于脚本所在的目录，而不是递归到所到的文件层级；</span></span><br><span class="line">                <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$item_object</span>.Name) is a file which under a directory , need to move to parent directory.&quot;</span></span><br><span class="line">                <span class="built_in">Write-Host</span> <span class="variable">$target_DirName</span>;</span><br><span class="line">                <span class="variable">$parent_path</span>=<span class="built_in">Split-Path</span> <span class="literal">-Parent</span> <span class="variable">$target_DirName</span>;</span><br><span class="line">                <span class="built_in">move-item</span> <span class="string">&quot;<span class="variable">$target_DirName</span>\<span class="variable">$</span>(<span class="variable">$item_object</span>.Name)&quot;</span> <span class="variable">$parent_path</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$dir_depth</span>=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Move-FileToParentDir</span> <span class="variable">$target_directoryName</span> <span class="number">0</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>注意点：</p>
<ol>
<li>父目录，需要用Split-Path获取；</li>
</ol>
<h2 id="Write-Host-与-Write-Output-区别"><a href="#Write-Host-与-Write-Output-区别" class="headerlink" title="Write-Host 与 Write-Output 区别"></a>Write-Host 与 Write-Output 区别</h2><table>
<thead>
<tr>
<th align="center">指令</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Write-Host</td>
<td align="center">Write-Host 是直接将信息输出到控制台，而不管信息是什么类型，都会将其转换成字符串，并且不会将输出发送到管道。</td>
<td align="center">Write-Host “Hello world”</td>
</tr>
<tr>
<td align="center">Write-Output</td>
<td align="center">Write-Output 则会将输出发送到管道，以便在管道中的其他命令或过程中使用。它可以输出对象或文本，并且它不会将输出直接发送到控制台，除非您将输出发送到控制台。</td>
<td align="center">Get-ChildItem| Write-Output</td>
</tr>
</tbody></table>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>获取系统启动时间：<a target="_blank" rel="noopener" href="https://www.pstips.net/system-running-time.html">https://www.pstips.net/system-running-time.html</a></li>
<li>PS中的比较：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_comparison_operators?view=powershell-7.2">https://docs.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_comparison_operators?view=powershell-7.2</a></li>
<li>测试端口是否连通： <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33737134/article/details/85544432">https://blog.csdn.net/weixin_33737134/article/details/85544432</a></li>
<li>删除用户配置文件： <a target="_blank" rel="noopener" href="https://blog.vichamp.com/2017/12/27/deleting-user-profiles/">https://blog.vichamp.com/2017/12/27/deleting-user-profiles/</a></li>
<li>更改WINRM监听端口： <a target="_blank" rel="noopener" href="https://blog.51cto.com/281816327/1394801">https://blog.51cto.com/281816327/1394801</a></li>
<li>Chrome 修改用户数据目录：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40364421/article/details/82769021">https://blog.csdn.net/weixin_40364421/article/details/82769021</a></li>
<li>获取已安装的补丁： <a target="_blank" rel="noopener" href="https://www.winhelponline.com/blog/how-to-check-if-a-windows-update-kb-is-installed/">https://www.winhelponline.com/blog/how-to-check-if-a-windows-update-kb-is-installed/</a></li>
<li>检查Windows是否需要因为安装补丁重启：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/answers/questions/675843/from-the-command-line-how-can-i-tell-if-a-reboot-i.html">https://docs.microsoft.com/en-us/answers/questions/675843/from-the-command-line-how-can-i-tell-if-a-reboot-i.html</a></li>
<li>Copy-Item 复制文件和文件夹：<a target="_blank" rel="noopener" href="https://0x400.net/post/powershell-copy-item.html">https://0x400.net/post/powershell-copy-item.html</a></li>
<li>组策略与注册表项查询：<a target="_blank" rel="noopener" href="https://admx.help/?Category=Windows_8.1_2012R2&Policy=Microsoft.Policies.WindowsUpdate::CorpWuURL">https://admx.help/?Category=Windows_8.1_2012R2&amp;Policy=Microsoft.Policies.WindowsUpdate::CorpWuURL</a></li>
<li>Start-Transcript: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.host/start-transcript?view=powershell-7.4">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.host/start-transcript?view=powershell-7.4</a></li>
<li>Write-Host与Write-Output区别： <a target="_blank" rel="noopener" href="https://juejin.cn/s/powershell%20write-host%20write-output">https://juejin.cn/s/powershell%20write-host%20write-output</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/403570ec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/403570ec/" class="post-title-link" itemprop="url">基于Invoke-Command远程更新VMware Horizon View Agent</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-08 17:04:29" itemprop="dateCreated datePublished" datetime="2022-05-08T17:04:29+00:00">2022-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>需要更新RDSH的Horizon View Agent 至最新版本。</p>
<blockquote>
<p>Target VMware Horizon View Agent： 7.13.1</p>
</blockquote>
<h2 id="条件准备"><a href="#条件准备" class="headerlink" title="条件准备"></a>条件准备</h2><ul>
<li>OS ： Windows Server 2012R2；</li>
<li>网络：到客户端的TCP-5985防火墙需要开通；</li>
<li>客户端：需要开启WinRM功能，指令 Enable-PSRemoting；</li>
<li>安装包准备：将Horizon View Agent安装包放置到客户端的C盘目录下，例如C:\1-InstallPackage；</li>
</ul>
<h2 id="脚本实现"><a href="#脚本实现" class="headerlink" title="脚本实现"></a>脚本实现</h2><ol>
<li>将所需的文件拷贝至客户端；</li>
<li>删除旧的Horizon View Agent客户端，客户端安装完成后重启；</li>
<li>安装新的Horizon View Agent客户端，客户端安装完成后重启；</li>
</ol>
<table>
<thead>
<tr>
<th align="center">文件名</th>
<th align="center">说明</th>
<th align="center">使用方式</th>
</tr>
</thead>
<tbody><tr>
<td align="center">hosts.list</td>
<td align="center">客户端的文件列表</td>
<td align="center">逐行记录客户端的Hostname</td>
</tr>
<tr>
<td align="center">CopyFiles.ps1</td>
<td align="center">用于拷贝文件至远端服务器</td>
<td align="center">.\CopyFiles.ps1 .\hosts.list</td>
</tr>
<tr>
<td align="center">SendCommand.ps1</td>
<td align="center">下发指令至客户端</td>
<td align="center">.\SendCommand.ps1 .\hosts.list .[脚本]</td>
</tr>
<tr>
<td align="center">UninstallHorizonViewAgent.ps1</td>
<td align="center">卸载Horizon View Agent</td>
<td align="center">.\SendCommand.ps1 .\hosts.list .\UninstallHorizonViewAgent.ps1</td>
</tr>
<tr>
<td align="center">InstallHorizonViewAgent.ps1</td>
<td align="center">安装Horizon View Agent</td>
<td align="center">.\InstallHorizonViewAgent.ps1 .\hosts.list</td>
</tr>
</tbody></table>
<h3 id="拷贝文件脚本–CopyFiles-ps1"><a href="#拷贝文件脚本–CopyFiles-ps1" class="headerlink" title="拷贝文件脚本–CopyFiles.ps1"></a>拷贝文件脚本–CopyFiles.ps1</h3><p>可以用 Copy-Item 指令</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入客户端</span></span><br><span class="line"><span class="variable">$targetHostsFile</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Content</span> <span class="variable">$targetHostsFile</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line"><span class="variable">$targetSession</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$_</span> ;</span><br><span class="line">  <span class="built_in">Copy-Item</span> [源文件路径] <span class="literal">-Destination</span> [目标文件路径] <span class="literal">-ToSession</span> <span class="variable">$targetSession</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送指令脚本–SendCommand-ps1"><a href="#发送指令脚本–SendCommand-ps1" class="headerlink" title="发送指令脚本–SendCommand.ps1"></a>发送指令脚本–SendCommand.ps1</h3><p>原本指令为 Invoke-Command -ComputerName [Hostname] -Filepath [脚本路径]</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetHostsFile</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$scriptFile</span>=<span class="variable">$args</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Content</span> <span class="variable">$targetHostsFile</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">  <span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> <span class="variable">$_</span> <span class="literal">-Filepath</span> <span class="variable">$scriptFile</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除VMware-Horizon-View-Agent脚本–UninstallHorizonViewAgent-ps1"><a href="#删除VMware-Horizon-View-Agent脚本–UninstallHorizonViewAgent-ps1" class="headerlink" title="删除VMware Horizon View Agent脚本–UninstallHorizonViewAgent.ps1"></a>删除VMware Horizon View Agent脚本–UninstallHorizonViewAgent.ps1</h3><p>卸载完成后，会自动重启服务器；</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Package</span> <span class="literal">-Name</span> <span class="string">&quot;VMware Horizon Agent&quot;</span> | <span class="built_in">Uninstall-Package</span>;</span><br><span class="line">Shutdown <span class="literal">-r</span> <span class="literal">-t</span> <span class="number">300</span>;</span><br></pre></td></tr></table></figure>

<h3 id="安装VMwareHorizon-View-Agent脚本–InstallHorizonViewAgent-ps1"><a href="#安装VMwareHorizon-View-Agent脚本–InstallHorizonViewAgent-ps1" class="headerlink" title="安装VMwareHorizon View Agent脚本–InstallHorizonViewAgent.ps1"></a>安装VMwareHorizon View Agent脚本–InstallHorizonViewAgent.ps1</h3><p>利用的是安装包可以用msi静默安装的指令；<br>这里的安装包放在客户端的C:\1-InstallPackage\agent.exe;<br>安装结束后，可以自动触发服务器重启；</p>
<blockquote>
<p>本次脚本是触发agent.exe去后台安装，如果PS会话被注销，则会导致安装失败；因此需要建立一个会话供Horizon View Agent去安装。</p>
</blockquote>
<p>本脚本需要输入客户端列表 hosts.list；</p>
<p>脚本内部需要修改：</p>
<ul>
<li>Connect Server IP；</li>
<li>密码</li>
</ul>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$targetHostsFile</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$i</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$sessionArray</span>=<span class="selector-tag">@</span>(<span class="variable">$a</span>,<span class="variable">$b</span>,<span class="variable">$c</span>,<span class="variable">$d</span>,<span class="variable">$e</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Content</span> <span class="variable">$targetHostsFile</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line"><span class="comment">#设置5个并发为一组</span></span><br><span class="line"><span class="variable">$index</span>=<span class="variable">$</span>(<span class="variable">$i</span>%<span class="number">5</span>)</span><br><span class="line"><span class="variable">$sessionArray</span>[<span class="variable">$index</span>]=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$_</span> ;</span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sessionArray</span>[<span class="variable">$index</span>] <span class="literal">-ScriptBlock</span> &#123;</span><br><span class="line">  C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\agent.exe /s /v <span class="string">&#x27;/qn RDP_CHOICE=0 VDM_VC_MANAGED_AGENT=0 VDM_SERVER_NAME=[Connect Server IP] VDM_SERVER_USERNAME=[domain\administratorUsername] VDM_SERVER_PASSWORD=&quot;[密码，需要用双引号]&quot; ADDLOCAL=Core REBOOT=Force&#x27;</span> /l C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\installAgent.log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$index</span> <span class="operator">-eq</span> <span class="number">4</span>)&#123;</span><br><span class="line">  <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">300</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$i</span>++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>TCP-5985：<a target="_blank" rel="noopener" href="https://www.speedguide.net/port.php?port=5985">https://www.speedguide.net/port.php?port=5985</a></li>
<li>VMware Horizon View Agent 静默安装：<a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-Horizon-7/7.13/horizon-virtual-desktops/GUID-0B32D33F-152F-45EC-AC2C-F523D9432426.html">https://docs.vmware.com/cn/VMware-Horizon-7/7.13/horizon-virtual-desktops/GUID-0B32D33F-152F-45EC-AC2C-F523D9432426.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/c73dfe26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/c73dfe26/" class="post-title-link" itemprop="url">基于PSWindowsUpdate远程更新Windows补丁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-05 23:00:53" itemprop="dateCreated datePublished" datetime="2022-05-05T23:00:53+00:00">2022-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h1><p>可以通过指令下发指令去安装补丁，类似于Linux的Ansible。（当然也有用Ansible去控制Windows Server）</p>
<h1 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h1><p>网络层</p>
<ul>
<li>TCP-5985 （WINRM的HTTP监听端口）</li>
<li>TCP-135 (Invoke-WUJob使用)</li>
<li>TCP-RPC动态端口(Invoke-WUJob使用)</li>
<li>TCP-RPC终结点映射器(Invoke-WUJob使用)</li>
</ul>
<p>应用层</p>
<ul>
<li>安装 PSWindowsUpdate Module</li>
</ul>
<blockquote>
<p>离线安装：1. 安装nugetprovider ，这个文件不能为锁定的状态。2. 安装PSWindowsUpdate Module。</p>
</blockquote>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 离线安装 NugetProvider</span></span><br><span class="line"><span class="comment"># 下载安装包</span></span><br><span class="line"><span class="comment"># 进入地址 https://onegetcdn.azureedge.net/providers/providers.masterList.feed.swidtag</span></span><br><span class="line"><span class="comment"># 找到nuget有关的url，进入 https://onegetcdn.azureedge.net/providers/nuget-2.8.5.208.package.swidtag</span></span><br><span class="line"><span class="comment"># 找到nuget.dll 的URl，下载 https://onegetcdn.azureedge.net/providers/Microsoft.PackageManagement.NuGetProvider-2.8.5.208.dll</span></span><br><span class="line"><span class="comment"># 得到 NugetProvider.dll 库文件  Microsoft.PackageManagement.NuGetProvider-2.8.5.208.dll</span></span><br><span class="line"><span class="comment"># 注意，这里要注意文件不要锁定。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将目标文件放置到  C:\Program Files\PackageManagement\ProviderAssemblies\nuget\2.8.5.208\</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询是否能识别到</span></span><br><span class="line"><span class="built_in">Get-PackageProvider</span> <span class="literal">-ListAvailable</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载PSWindowsUpdate 的nupkg文件</span></span><br><span class="line"><span class="comment"># 下载地址：https://www.powershellgallery.com/packages/PSWindowsUpdate/</span></span><br><span class="line"><span class="comment"># 下载文件放置到任意目录，例如C:\1-InstallPackage</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册目标目录为本地安装仓库</span></span><br><span class="line"><span class="built_in">Register-PSRepository</span> <span class="literal">-Name</span> Local <span class="literal">-SourceLocation</span> C:\<span class="number">1</span><span class="literal">-InstallPackage</span> <span class="literal">-InstallationPolicy</span> Trusted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装模块</span></span><br><span class="line"><span class="built_in">Install-Module</span> <span class="literal">-Name</span> PSWindowsUpdate</span><br></pre></td></tr></table></figure>

<p>系统层</p>
<ul>
<li>开启 WinRM 服务</li>
<li>客户端与服务端同处一个域内</li>
</ul>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><p>Server端、Client端均安装PSWindowsUpdate模块与开启WinRM，并确保防火墙之间的防火墙端口通讯是开通的。</p>
<h2 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WUJob</span> <span class="literal">-ComputerName</span> [客户端主机名] <span class="literal">-Scripts</span> &#123; <span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-Install</span> <span class="literal">-AutoReboot</span> |<span class="built_in">Out-File</span> C:\PSWindowsUpdate.log&#125; <span class="literal">-Confirm</span>:<span class="variable">$false</span> <span class="literal">-RunNow</span></span><br></pre></td></tr></table></figure>

<p>注：远程调用不能用Invoke-Command + Install-WindowsUpdate 的方式。例如：</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下方法不可行,会提示访问拒绝</span></span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> [客户端主机名] <span class="literal">-ScriptBlock</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-Install</span> <span class="literal">-AutoReboot</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h2><p>如果到WSUS服务器的通讯是正常的话，则可以自动安装补丁，并且安装完成后会重启Server。<br>安装进度可以看在C:\WindowsUpdate.log,补丁的状态会有这样的变化：Accept –&gt; Download –&gt; Installed .</p>
<h1 id="其他已验证过，且不可行的方法汇总"><a href="#其他已验证过，且不可行的方法汇总" class="headerlink" title="其他已验证过，且不可行的方法汇总"></a>其他已验证过，且不可行的方法汇总</h1><p>以下记录已经验证过的方法，均来自互联网…</p>
<h2 id="通过注册表方式，让服务器重启后自动执行脚本安装"><a href="#通过注册表方式，让服务器重启后自动执行脚本安装" class="headerlink" title="通过注册表方式，让服务器重启后自动执行脚本安装"></a>通过注册表方式，让服务器重启后自动执行脚本安装</h2><p>在LKM的RunOnce中添加注册表项，调用 Powershell去执行Windows更新脚本。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Item</span> <span class="string">&quot;...\RunOnce\&quot;</span> xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本内容</span></span><br><span class="line"><span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-Install</span> <span class="literal">-AutoReboot</span></span><br></pre></td></tr></table></figure>

<p>在添加完注册表后，重启服务器后并不会自动执行脚本，需要用户再一次登录进Windows时才会触发，等安装结束后，RunOnce中的注册表项会被自动删除。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查是否安装目标补丁</span></span><br><span class="line"><span class="built_in">Get-HotFix</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.HotFixID=<span class="string">&quot;&quot;</span> &#125; | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> HotFixID;</span><br></pre></td></tr></table></figure>

<h2 id="Invoke-Command-与-Install-WindowsUpdate-指令结合"><a href="#Invoke-Command-与-Install-WindowsUpdate-指令结合" class="headerlink" title="Invoke-Command 与 Install-WindowsUpdate 指令结合"></a>Invoke-Command 与 Install-WindowsUpdate 指令结合</h2><p>Server端发起指令。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> [客户端主机名] <span class="literal">-ScriptBlock</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-Acceptall</span> <span class="literal">-Install</span> <span class="literal">-AutoReboot</span>&#125;</span><br></pre></td></tr></table></figure>

<p>以上执行完毕后，会扫描到补丁，并且状态为Accept，但后面就会提示访问拒绝。</p>
<p>远程调用补丁安装，应该使用Invoke-WUJob指令，如下：</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WUJob</span> <span class="literal">-ComputerName</span> <span class="variable">$serverName</span> <span class="literal">-Script</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-Acceptall</span> <span class="literal">-Install</span> <span class="literal">-AutoReboot</span>|<span class="built_in">Out-File</span> C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\PSWindowsUpdate.log&#125; <span class="literal">-RunNow</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>参考资料： <a target="_blank" rel="noopener" href="https://www.winhelponline.com/blog/how-to-check-if-a-windows-update-kb-is-installed/">https://www.winhelponline.com/blog/how-to-check-if-a-windows-update-kb-is-installed/</a><br>离线安装Nuget库文件：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58349992/how-do-i-install-the-nuget-provider-for-powershell-on-a-offline-machine">https://stackoverflow.com/questions/58349992/how-do-i-install-the-nuget-provider-for-powershell-on-a-offline-machine</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/31dd3f1c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/31dd3f1c/" class="post-title-link" itemprop="url">基于Python+Selenium+Chrome做的自动点击网页程序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-20 23:14:36" itemprop="dateCreated datePublished" datetime="2022-03-20T23:14:36+00:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E7%BC%96%E7%A8%8B/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>工作场景中，存在大量需要在网页中点击的场景。因此想做一个自动点击网页的脚本程序，而点击依据来源于本地的Excel文件。基于这样的思路，选用Python+Selenium+Chrome来实现这个功能。</p>
<h1 id="工具说明"><a href="#工具说明" class="headerlink" title="工具说明"></a>工具说明</h1><ol>
<li>Python3</li>
<li>Selenium</li>
<li>Chrome</li>
<li>Excel（xls文件）</li>
</ol>
<h1 id="代码部分【TODO】"><a href="#代码部分【TODO】" class="headerlink" title="代码部分【TODO】"></a>代码部分【TODO】</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/c4e4d78a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/c4e4d78a/" class="post-title-link" itemprop="url">疫情期间VDI小结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-20 22:53:04" itemprop="dateCreated datePublished" datetime="2022-03-20T22:53:04+00:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9D%82%E8%B0%88/" itemprop="url" rel="index"><span itemprop="name">杂谈</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>略</p>
<h1 id="分类小结"><a href="#分类小结" class="headerlink" title="分类小结"></a>分类小结</h1><h2 id="场景分配"><a href="#场景分配" class="headerlink" title="场景分配"></a>场景分配</h2><table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">配置</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">常规用户</td>
<td align="center">4C8G</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">轻度编译用户</td>
<td align="center">4C16G</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">重度编译用户</td>
<td align="center">8C16G</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">超重度编译用户</td>
<td align="center">16C32G</td>
<td align="center"></td>
</tr>
</tbody></table>
<p>以上4中用户类型中，若资源条件允许，应让“轻度编译用户”类型作为常规用户，当下的个人PC配置环境基本是16G内存起步。如果内存分配过小，用户在实际使用的时候很容易出现“Out of memory”的错误。</p>
<p>以上环境的单核基础频率是2.1GHz，也就是说一个重度用户对CPU的需求为16.8GHz左右。同一个任务下，4C要比8C多耗时40分钟左右。</p>
<h2 id="业务总结"><a href="#业务总结" class="headerlink" title="业务总结"></a>业务总结</h2><h3 id="使用场景评估"><a href="#使用场景评估" class="headerlink" title="使用场景评估"></a>使用场景评估</h3><p>需要清楚用户的访问链路，思考几个问题：</p>
<ol>
<li>用户的访问链路应该是怎么样的？</li>
<li>是否会与其他的远程工具冲突，如原本在外网就有解析的入口，是否会与VPN冲突？</li>
<li>私有云的出口网络带宽是否能支撑用户的访问需求？带宽需求大概是多少？</li>
<li>是否可以清楚监控到对应节点的负载情况？</li>
<li>用户的核心需求是什么？是远程桌面？还是VDI？</li>
</ol>
<blockquote>
<p>No.5非常重要，避免资源浪费，用户也许不清楚自己需要什么，更多情况下就是什么资源都会申请，这无疑会增加运维人员与支持人员的工作量。</p>
</blockquote>
<h3 id="信息安全侧评估"><a href="#信息安全侧评估" class="headerlink" title="信息安全侧评估"></a>信息安全侧评估</h3><p>需要明确信息安全红线，确保数据进出方向，对于敏感策略一定要设置有监控。所有的部署方案、防火墙策略申请应有审批报备。</p>
<h2 id="效率总结"><a href="#效率总结" class="headerlink" title="效率总结"></a>效率总结</h2><h3 id="管理侧"><a href="#管理侧" class="headerlink" title="管理侧"></a>管理侧</h3><p>对于 VMware Horizon View 中的 RDS 桌面部署，基本上都是在Chrome浏览器中用鼠标点击授权，这个重复性的操作可以用Python3+Selenuim+Chrome来做自动化点击部署。</p>
<h3 id="资源侧"><a href="#资源侧" class="headerlink" title="资源侧"></a>资源侧</h3><p>对于初始化RDSH服务器，可以使用 Windows + Openssh + Ansible 来批量部署。</p>
<p>RDSH服务器均为Windows服务器，在上面安装Openssh，并配置允许Ansible账户来部署。</p>
<p>Ansible侧则是需要写好相应的脚本批量下发即可，这里要注意Ansible服务器的配置，避免跑的任务太多导致CPU爆满。</p>
<h3 id="基础架构侧"><a href="#基础架构侧" class="headerlink" title="基础架构侧"></a>基础架构侧</h3><p>底层资源要充足，在紧急时候能够提供所需资源，这个需要与业务方商谈，让其做相关预算。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/d93c5529/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/d93c5529/" class="post-title-link" itemprop="url">Windows虚拟机扩容后CPU使用现象记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-07 10:52:50" itemprop="dateCreated datePublished" datetime="2022-03-07T10:52:50+00:00">2022-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>ESXi中的Windows虚拟机已经开启CPU热添加，因虚拟机CPU使用率过高，执行一下CPU扩容。</p>
<p>当CPU从4C扩容至8C时，虚拟机内看到的CPU使用率确实由原来的100%降至50%。但当将任务管理器中的CPU性能监控视图切换至“逻辑处理器使用率”时，发现有4颗逻辑CPU的负载还是100%，相当于负载没有均摊到其他CPU。</p>
<p>此时应做的操作有：</p>
<ol>
<li>重启服务器；</li>
<li>重新执行应用程序；【未验证过】</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
