<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/6/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/6/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">451</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/cf3a31ba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/cf3a31ba/" class="post-title-link" itemprop="url">VMware-vMotion相关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-19 00:36:59" itemprop="dateCreated datePublished" datetime="2024-05-19T00:36:59+00:00">2024-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="vMotion-相关文章"><a href="#vMotion-相关文章" class="headerlink" title="vMotion 相关文章"></a>vMotion 相关文章</h1><h2 id="Powered-off-vMotion-relocate-of-a-large-virtual-machine-across-datastores-may-timeout-in-vCenter"><a href="#Powered-off-vMotion-relocate-of-a-large-virtual-machine-across-datastores-may-timeout-in-vCenter" class="headerlink" title="Powered-off vMotion (relocate) of a large virtual machine across datastores may timeout in vCenter"></a>Powered-off vMotion (relocate) of a large virtual machine across datastores may timeout in vCenter</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/318734/poweredoff-vmotion-relocate-of-a-large-v.html">https://knowledge.broadcom.com/external/article/318734/poweredoff-vmotion-relocate-of-a-large-v.html</a></p>
<h2 id="vMotion-同时迁移的限制"><a href="#vMotion-同时迁移的限制" class="headerlink" title="vMotion 同时迁移的限制"></a>vMotion 同时迁移的限制</h2><p><a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.vcenterhost.doc/GUID-25EA5833-03B5-4EDD-A167-87578B8009B3.html#GUID-25EA5833-03B5-4EDD-A167-87578B8009B3">https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.vcenterhost.doc/GUID-25EA5833-03B5-4EDD-A167-87578B8009B3.html#GUID-25EA5833-03B5-4EDD-A167-87578B8009B3</a></p>
<h2 id="Multiple-NIC-vMotion-in-vSphere"><a href="#Multiple-NIC-vMotion-in-vSphere" class="headerlink" title="Multiple-NIC vMotion in vSphere"></a>Multiple-NIC vMotion in vSphere</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2007467">https://knowledge.broadcom.com/external/article?legacyId=2007467</a></p>
<h2 id="Troubleshooting-vMotion"><a href="#Troubleshooting-vMotion" class="headerlink" title="Troubleshooting vMotion"></a>Troubleshooting vMotion</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/09/troubleshooting-vmotion.html">https://blogs.vmware.com/vsphere/2019/09/troubleshooting-vmotion.html</a></p>
<h2 id="How-to-Tune-vMotion-for-Lower-Migration-Times"><a href="#How-to-Tune-vMotion-for-Lower-Migration-Times" class="headerlink" title="How to Tune vMotion for Lower Migration Times?"></a>How to Tune vMotion for Lower Migration Times?</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/09/how-to-tune-vmotion-for-lower-migration-times.html">https://blogs.vmware.com/vsphere/2019/09/how-to-tune-vmotion-for-lower-migration-times.html</a></p>
<h2 id="How-is-Virtual-Memory-Translated-to-Physical-Memory"><a href="#How-is-Virtual-Memory-Translated-to-Physical-Memory" class="headerlink" title="How is Virtual Memory Translated to Physical Memory?"></a>How is Virtual Memory Translated to Physical Memory?</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/03/how-is-virtual-memory-translated-to-physical-memory.html">https://blogs.vmware.com/vsphere/2020/03/how-is-virtual-memory-translated-to-physical-memory.html</a></p>
<h2 id="The-vMotion-Process-Under-the-Hood"><a href="#The-vMotion-Process-Under-the-Hood" class="headerlink" title="The vMotion Process Under the Hood"></a>The vMotion Process Under the Hood</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/07/the-vmotion-process-under-the-hood.html">https://blogs.vmware.com/vsphere/2019/07/the-vmotion-process-under-the-hood.html</a></p>
<h2 id="vSphere-7-vMotion-Enhancements"><a href="#vSphere-7-vMotion-Enhancements" class="headerlink" title="vSphere 7 - vMotion Enhancements"></a>vSphere 7 - vMotion Enhancements</h2><p>The vSphere vMotion feature enables customers to live-migrate workloads from source to destination ESXi hosts. Over time, we have developed vMotion to support new technologies. The vSphere 7 release is no exception to that, as we greatly improved the vMotion feature. The vMotion enhancements in vSphere 7 include a reduced performance impact during the live-migration and a reduced stun time. This blog post will go into details on how the vMotion improvements help customers to be comfortable using vMotion for large workloads.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vmotion-history-2048x463.png" alt="vMotion发展"></p>
<p>To understand what we improved for vMotion in vSphere 7, it is imperative to understand the vMotion internals. Read the vMotion Process Under the Hood to learn more about the vMotion process itself.</p>
<h3 id="Large-VM-vMotion-Challenges"><a href="#Large-VM-vMotion-Challenges" class="headerlink" title="Large VM vMotion Challenges"></a>Large VM vMotion Challenges</h3><p>vSphere is the perfect platform to host large virtual machines (VMs) — also referred to as “Monster” VMs — with the current per VM resource maximums set to 256 vCPU’s and 6 TB of memory. However, we noticed that customers running workloads in large VMs were not always comfortable live-migrating these VMs. That was due to a potential impact on workload performance during the vMotion process, and a switch-over (stun) time that took too long.</p>
<p>For example, large transactional database platforms that are dealing with a substantial number of I&#x2F;Os could experience performance degradation during a vMotion, although the precise impact strongly depends on the workload’s characteristics &amp; sizing. The enhanced logic for vMotion in vSphere 7 overcomes all these challenges and allows us to live-migrate large workloads without significant impact on performance or availability.</p>
<h3 id="Memory-Pre-copy-Optimizations"><a href="#Memory-Pre-copy-Optimizations" class="headerlink" title="Memory Pre-copy Optimizations"></a>Memory Pre-copy Optimizations</h3><p>As explained in this video, we need to keep track of all the changed memory pages for a VM during its vMotion operation. Because it is a live-migration, the guest OS inside the VM will keep writing data to memory during the vMotion. We need to track and resend memory pages that are overwritten during a vMotion.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vMotion-page-trace-v2-old.png" alt="vMotion "></p>
<p>The vMotion process installs a page tracer on all the vCPUs that are configured for the VM. By doing so, vMotion understands what memory pages are being overwritten. This is referred to as a ‘page fire’ during page tracing. We are distributing the tracing work to all the vCPU’s for the VM that is live-migrated.</p>
<p>To install the page tracer and to process a page fire, the vCPUs are briefly stopped. It’s only microseconds, but stopping all vCPUs disrupts the workload. Scaling up the compute resources of a VM increases the impact of a vMotion operation. After stopping the vCPUs for the tracing work, all memory Page Table Entries (PTE) are set to read-only, and the Translation Lookaside Buffers (TLB) are flushed to avoid TLB hits and force a page table walk so the vMotion process fully understands what memory pages have been overwritten. Learn more on these memory constructs in this blog</p>
<h3 id="How-we-do-it-in-vSphere-7"><a href="#How-we-do-it-in-vSphere-7" class="headerlink" title="How we do it in vSphere 7"></a>How we do it in vSphere 7</h3><p>The biggest impact comes from having to stop all the vCPUs for page tracing. What if we can install the page tracers without the need to stop all vCPUs? With vSphere 7, we are introducing the “Loose Page Trace Install.” The method for page tracing mostly remains the same but instead of using all vCPUs, we now only claim one vCPU to perform all the tracing work. All the other vCPUs that are entitled to the VM just continue to run the workload without interruption.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vMotion-page-trace-v2-new.png" alt="vSphere 7 vmotion"></p>
<h3 id="Page-Table-Granularity"><a href="#Page-Table-Granularity" class="headerlink" title="Page Table Granularity"></a>Page Table Granularity</h3><p>So we reduced the cost of tracing, but what if we can make it even more efficient? We optimized the way we set memory to read-only, meaning there’s less work to be done on this part. Less work means increased efficiency. The way memory is set to read-only prior to vSphere 7 is on a 4KB page granularity. All the individual 4KB pages needed to be set to read-only access.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/pagetableoverviewv2.png" alt="Page"></p>
<p>As of vSphere 7, the Virtual Machine Monitor (VMM) process will set the read-only flag at a much larger granularity, on 1GB pages. If a page fire (a memory page is overwritten) occurs, the 1GB PTE is broken down into 2MB and 4KB pages. VMware engineers have seen that a VM is typically not touching all of its memory during a vMotion process. The memory working set size during a vMotion is typically only 10-30%. If more memory is used during the vMotion time, the cost efficiency will be less.</p>
<h3 id="Switch-over-Phase-Enhancements"><a href="#Switch-over-Phase-Enhancements" class="headerlink" title="Switch-over Phase Enhancements"></a>Switch-over Phase Enhancements</h3><p>All the enhancements we have discussed so far are done in the memory pre-copy phase, where the tracing happens. Once we reach memory convergence, meaning almost all memory is copied to the destination host, vMotion is ready to switch-over to the destination ESXi host. In this last phase, the VM on the source ESXi host is suspended and the checkpoint data is sent to the destination host. Remember that we want the switch-over time (stun time) to be 1 second or less. For large VMs, this has become a challenge because of workload sizes that have increased over time.</p>
<p>In the switch-over phase, we send over the checkpoint data and the memory bitmap. The memory bitmap is used to track all the memory of a VM. It know what pages are overwritten and still need to be transmitted the destination ESXi host. As vMotion transfers the last memory pages, the VM on the destination host begins to power on. But it might still need the last pages left for transmission. To identity these pages on the destination, we use the bitmap that is transferred from the source. If customers overcommit memory, the swapped-out pages are tracked in the optional swap bitmap.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/fullbitmapv2.png" alt="full bitmap"></p>
<h3 id="How-vSphere-7-does-it"><a href="#How-vSphere-7-does-it" class="headerlink" title="How vSphere 7 does it"></a>How vSphere 7 does it</h3><p>With VMs running 6TB of memory (or potentially even more in the future), the bitmap is already 192MB. To stay under 1 sec of switch-over time, we need the bitmap to be smaller as sending over 192MB could take up to a second or more. What if we could compact the bitmap, and only send over the information that you really need?</p>
<p><img src="http://blogs.vmware.com/vsphere/files/2020/03/compactedbitmapv2.png" alt="vSphere 7 compacted bitmap"></p>
<p>At this stage we have already copied most of the memory pages, so only the last remaining memory pages need to be sent. Using a compacted memory bitmap, vMotion is able to send bitmaps for large VMs over in milliseconds, drastically lowering the stun time.</p>
<h3 id="Performance-Improvements"><a href="#Performance-Improvements" class="headerlink" title="Performance Improvements"></a>Performance Improvements</h3><p>These enhancements to vMotion in vSphere 7 allow workloads to be live-migrated with almost no performance degradation during a vMotion. The following diagram is an example of a test to show you the potential performance gains in vSphere 7. The testbed is a large VM (72 vCPU &#x2F; 512GB) running a HammerDB workload. We monitor the commits&#x2F;sec over a timeline with a 1 second granularity.</p>
<p>A couple of key takeaways that we noticed during this test in vSphere 7, compared to vSphere 6.7, are:</p>
<ul>
<li>We no longer experience the performance impact during the page trace phase.</li>
<li>The stun time remains within 1 second instead of taking multiple seconds.</li>
<li>The overall live-migration time is almost 20 seconds shorter.</li>
</ul>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vmotion7-improvements.png" alt="vSphere6.7 vSphere7 "></p>
<p>Your mileage may vary depending on vMotion network configurations and VM sizing, but this is an exemplary test to show the potential benefits of these vMotion improvements.</p>
<h3 id="To-Conclude"><a href="#To-Conclude" class="headerlink" title="To Conclude"></a>To Conclude</h3><p>The improvements made in vMotion with vSphere 7 are enormous and greatly reduce the cost paid for a vMotion. You don’t need to anything to enjoy the new and improved vMotion logic, other than to upgrade your systems to vSphere 7.</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/03/vsphere-7-vmotion-enhancements.html">https://blogs.vmware.com/vsphere/2020/03/vsphere-7-vmotion-enhancements.html</a></p>
<h2 id="vSphere-7-Storage-vMotion-Improvements"><a href="#vSphere-7-Storage-vMotion-Improvements" class="headerlink" title="vSphere-7-Storage vMotion Improvements"></a>vSphere-7-Storage vMotion Improvements</h2><p>参考： </p>
<p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/06/vsphere-7-storage-vmotion-improvements.html">https://blogs.vmware.com/vsphere/2020/06/vsphere-7-storage-vmotion-improvements.html</a></p>
<h2 id="ESXi提升vMotion速率-，-vMotion的属性设置"><a href="#ESXi提升vMotion速率-，-vMotion的属性设置" class="headerlink" title="ESXi提升vMotion速率 ， vMotion的属性设置"></a>ESXi提升vMotion速率 ， vMotion的属性设置</h2><p>Here’s the situation I was facing. Two Vmware vCenter 7.0.3. clusters on opposite sides of the country, connected via a a 10gig point to point ethernet circuit, and that circuit tends to have a bit of packet loss (0.5%-1%) under heavy utilization. Being cross country, it of course also has latency, typically in 55ms RTT range.</p>
<p>Vmware supports long distance vMotion. They claim you can do it with latency as high as 150ms. I found that to be the case, but whether a zero-loss site to site VPN across the internet, or across this high speed point to point link, I was never able to get vMotion to average more than a few hundred megabits. That is of course complete garbage if you’re trying to move terabytes of VM’s without downtime. If they’re frequently changing, and the rate of change exceeds the speed at which you can move data, you may even find vMotion impossible to use.</p>
<p>I found the above was due to the packet loss. I’ve done the same tests across a proper 10gig wave between locations, with the same latency but without the lossiness. On those I’d see a gigabit or two, but still far from full utilization. I suspect I could get that up to several gigabits after what I’ve learned and will share here, I just didn’t go back to test.</p>
<p>The cause of the problem is the vMotion (hot migrations) and provisioning (cold migrations) network stacks are based on decades out-of-date TCP configurations. They use a choice of two ancient congestion control algorithms, New Reno or Cubic, and both of those treat loss as congestion. When they see loss, they overreact and greatly reduce the TCP window size, causing your throughput to nosedive, then they take an excruciatingly long time to open it back up, and chances are another bit of loss will occur, compounding the issue.</p>
<p>Across this same lossy link, I did testing between two linux nodes set to use the BBR congestion control algorithm, and some other minor tuning I found at <a target="_blank" rel="noopener" href="https://fasterdata.es.net/host-tuning/linux/test-measurement-host-tuning/">https://fasterdata.es.net/host-tuning/linux/test-measurement-host-tuning/</a>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.core.rmem_max = 134217728</span><br><span class="line">net.core.wmem_max = 134217728</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br></pre></td></tr></table></figure>

<p>With that config in place, I can frequently push 7+ Gbps with a single TCP session, where with the default linux congestion control of cubic, and default settings, I’d be lucky to average more than a gigabit.</p>
<p>Vmware doesn’t allow you to tinker with congestion control or windowing &#x2F; buffer settings. So my workarounds for this were focused mostly on multi-stream vmotion, after reading pages like these:</p>
<p><a target="_blank" rel="noopener" href="https://core.vmware.com/resource/how-tune-vmotion-lower-migration-times#section1">https://core.vmware.com/resource/how-tune-vmotion-lower-migration-times#section1</a><br><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/2007467">https://kb.vmware.com/s/article/2007467</a><br>I tinkered extensively with the number of vmotion vmkernel ports defined, and custom values in the following settings:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Migrate.NetExpectedLineRateMBps</span><br><span class="line">Migrate.VMotionStreamHelpers</span><br><span class="line">Net.TcpipRxDispatchQueues</span><br><span class="line">Migrate.BindToVmknic</span><br></pre></td></tr></table></figure>

<p>I probably went through about 30 permutations of settings, and the one that I finally arrived at was:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Two target vmkernel ports</span><br><span class="line">Five <span class="built_in">source</span> vmkernel ports</span><br><span class="line"></span><br><span class="line">Migrate.NetExpectedLineRateMBps = 2000</span><br><span class="line">Net.TcpipRxDispatchQueues = 5</span><br><span class="line">Migrate.BindToVmknic = 2</span><br><span class="line">Migrate.VMotionStreamHelpers = 48</span><br></pre></td></tr></table></figure>

<p>I know that sounds kind of insane to have 48 stream helpers, but I went all the way to 64 in +8 jumps and 48 had the highest throughput for my 16 pCore source vMotion server. With the above config, 55ms 10gig circuit with ~1% loss, I was able to do cross country live vmotions of both VM state and storage at upwards of 2.4 Gbps. I did start out with more vmkernel ports on the target, but for whatever reason, while this config allows for 48 TCP sessions spread evenly across the five source vmkernel ports, they’d still only target two unique IP addresses, so the other three served no purpose.</p>
<p>This above config is also particularly useful if you have a Cogent point to point &#x2F; metroE circuit between locations, because those are often rate limited to around 2 gbps per TCP session even if you’re paying for a full 10gig circuit. Since vMotion spreads the flows evenly across all the TCP sessions, this will let you better utilize the link with no one session hitting the rate limit and being throttled.</p>
<p>Next up, I found a second way to get around this issue which could be of interest to those who want more of a bandaid fix to evacuate one cluster for another; i.e. not permanent. I happened across this reddit thread where u&#x2F;LatinSuD reported having similar issues solved by the use of socat to proxy the TCP session to the remote host. This was intriguing for me because I know my lossy link, in the hands of a modern TCP tuning, is capable of nearly wire speed. I tested it out and it worked. With only crude tuning, I was able to achieve 4 Gbps of vMotion between the same hosts and across the same link, where I could only get 2.4 Gbps with native tuning options. There’s probably more to go too if socat were running on a more modern system, but I have it on an old four core Xeon E3-1225 dating to 2011, so truly ancient hardware. The system has a Mellanox Connect-X 3 10gig NIC.</p>
<p>Here was my config:</p>
<p>Source ESXi host vmotion vmkernel interface: 10.88.0.9&#x2F;24<br>Source ESXi host vmotion network default gateway override: 10.88.0.1<br>Target ESXi host vmotion vmkernel interface: 10.99.0.9&#x2F;24<br>socat proxy linux system vmotion interface: 10.88.0.1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">One target vmkernel port</span><br><span class="line">One <span class="built_in">source</span> vmkernel port</span><br><span class="line"></span><br><span class="line">Migrate.NetExpectedLineRateMBps = 2000</span><br><span class="line">Net.TcpipRxDispatchQueues = 5</span><br><span class="line">Migrate.BindToVmknic = 2</span><br><span class="line">Migrate.VMotionStreamHelpers = 5</span><br></pre></td></tr></table></figure>

<p>The above config results in the source vmotion server wanting to talk to port 8000 on the target 10.99.0.9. However, since it’s been given a default gateway (you could also add a custom static route if needed) of the socat server, it’s going to send its packets to that system regardless.</p>
<p>On the socat server, I alter the packets with a destination NAT rule so it delivers those packets to itself instead of discarding or attempting to route them (if forwarding were enabled):</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -p tcp -d 10.99.0.9 --dport 8000 -j DNAT --to-destination 10.88.0.1:8000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>I also have the earlier sysctl settings in place, and most importantly, BBR congestion control:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.core.rmem_max = 134217728</span><br><span class="line">net.core.wmem_max = 134217728</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br></pre></td></tr></table></figure>

<p>Make sure no CPU throttling as socat is cpu-bound:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpupower frequency-set -g performance</span><br></pre></td></tr></table></figure>

<p>Now start socat up to forward the received packets to the vmotion target:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:8000,fork,reuseaddr,<span class="built_in">bind</span>=10.88.0.1 TCP4:10.99.0.9:8000</span><br></pre></td></tr></table></figure>

<p>With the above config, the source vmotion server will use five TCP sessions. Its packets are intercepted by the socat server, rewritten to have a target of the local interface IP, socat is listening and accepts them, five socat children are spawned and connected to the target vmotion interface. It then forwards them as part of a new proxied TCP session to the target vmotion interface. Because of the proxying, the TCP conversation between source and socat occur on the local fast and non-lossy network, and the TCP conversation between the socat server and the target vmotion uses the BBR algorithm and a tuned TCP stack to achieve massively improved throughput. Like I said, old server with a 12 year old CPU and many years old NIC, still saw 4+ Gbps on this lossy link.<br><a target="_blank" rel="noopener" href="https://www.ispcolohost.com/2023/10/02/speeding-up-long-distance-vmotion/">https://www.ispcolohost.com/2023/10/02/speeding-up-long-distance-vmotion/</a></p>
<h3 id="ESXi-属性信息"><a href="#ESXi-属性信息" class="headerlink" title="ESXi 属性信息"></a>ESXi 属性信息</h3><p><a href="https://github.com/lamw/esxi-advanced-and-kernel-settings/blob/master/esxi-80a-advanced-settings.md">https://github.com/lamw/esxi-advanced-and-kernel-settings/blob/master/esxi-80a-advanced-settings.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/cf950940/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/cf950940/" class="post-title-link" itemprop="url">油猴JavaScript脚本-B站牧场物语弹幕需求</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-05 00:21:04" itemprop="dateCreated datePublished" datetime="2024-05-05T00:21:04+00:00">2024-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>B站有一个弹幕游戏，叫牧场物语，可以通过弹幕来进行喂鸡、收货、寻宝等动作；于是就想做一个自动点击操作的脚本；现有的技术能力有两种：</p>
<ol>
<li>python+selenium；</li>
<li>JavaScript+油猴插件；</li>
</ol>
<p>方案1已经挑战过了，现在来试试方案2；</p>
<h1 id="代码记录"><a href="#代码记录" class="headerlink" title="代码记录"></a>代码记录</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         牧场物语-喂食-收取-寻宝一条龙</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      2024-05-04</span></span><br><span class="line"><span class="comment">// @description  try to take over the world!</span></span><br><span class="line"><span class="comment">// @author       You</span></span><br><span class="line"><span class="comment">// @match        https://live.bilibili.com/21510733?live_from=84001&amp;spm_id_from=333.337.search-card.all.click</span></span><br><span class="line"><span class="comment">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;【TESTING！！】Start to handle script.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> timer;</span><br><span class="line">    <span class="comment">//timer =setInterval(function()&#123; var lock = getlock(); if(lock == 0)&#123;setval();clearInterval(timer)&#125; &#125;,500)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Global VAR</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">delay</span>(<span class="params">x</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">111</span>);</span><br><span class="line">                <span class="title function_">resolve</span>(x);</span><br><span class="line">            &#125;,<span class="number">2000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">WS</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to WS&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;喂食&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;Aqua&quot;</span>;</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]WS completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">SQ</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to SQ&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;收取&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;Lime&quot;</span>;</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]SQ completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">XB</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to XB&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var DM=document.querySelector(&quot;textarea&quot;);</span></span><br><span class="line">        <span class="comment">//DM.click();</span></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;寻宝&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var SENDB=document.querySelectorAll(&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;)[0];</span></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">            <span class="comment">//DM.value=&quot;寻宝&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]XB completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">DY</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to XB&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var DM=document.querySelector(&quot;textarea&quot;);</span></span><br><span class="line">        <span class="comment">//DM.click();</span></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;d1&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var SENDB=document.querySelectorAll(&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;)[0];</span></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">            <span class="comment">//DM.value=&quot;寻宝&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]XB completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">WS</span>,<span class="number">2000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">SQ</span>,<span class="number">8000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">XB</span>,<span class="number">18000</span>);</span><br><span class="line">    <span class="comment">//setTimeout(DY,18000);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//200s</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123; location.<span class="title function_">reload</span>();&#125;,<span class="number">202000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h2 id="注意点，注意坑！"><a href="#注意点，注意坑！" class="headerlink" title="注意点，注意坑！"></a>注意点，注意坑！</h2><ol>
<li>查找元素的方法为 dom 对象以及其对应的方法，比如 document.querySelector(“标签或者元素”)；</li>
<li>注意大小写！JavaScript是区分大小写的，这个与powershell脚本不同；</li>
<li>DOM的querySelectorAll方法，返回的是数组，所以需要引用该数组对象的第一个；</li>
<li>setTimeout延时函数有毒，是异步执行的，所以写延时函数需要注意网页加载时间；</li>
<li>匿名函数表示方法 ()&#x3D;&gt;{} ;</li>
<li>页面刷新 location.reload();</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/de3b0569/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/de3b0569/" class="post-title-link" itemprop="url">HPE-SAN存储热备盘比例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-04 23:39:36" itemprop="dateCreated datePublished" datetime="2024-05-04T23:39:36+00:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/SAN%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">SAN存储</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h1><p>做SAN存储扩容时，需要供应商做扩容方案。对应的硬件所堆积出来的硬件可用容量到底怎么计算的？这里面有几个问题：</p>
<ol>
<li>裸容量是多少？</li>
<li>可用容量是多少？</li>
<li>热备盘比例是多少？</li>
</ol>
<h1 id="可查资料"><a href="#可查资料" class="headerlink" title="可查资料"></a>可查资料</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Spare rate</span><br><span class="line">A key parameter in the spare policy is the spare rate. The spare rate is a target amount of space to set aside for sparing expressed relative to the number of disks of a given type in the system. A spare rate of 24, for example, sets target spare space equal to the size of one drive for every 24 drives in the array.</span><br><span class="line">The spare rate is defined based on the hardware configuration in the array as follows:</span><br><span class="line">• Spare rate = 40 if there are any magazines present in the array (e.g., 10,000)</span><br><span class="line">• Spare rate = 24 for all others such as 7400/7400c, 7450/7450c, etc.</span><br><span class="line"></span><br><span class="line">Sparing algorithms defined</span><br><span class="line">The spare option is set for the entire array and applied to each disk type (SSD, FC, NL) in the following way.</span><br><span class="line">• Default: Roughly 2.5 percent with minimums</span><br><span class="line">Small configurations (e.g., 7000’s with less than 48 disks, 10000’s with less than 80 disks) have a spare space target equal to the size of two of the largest drives of the type being spared.</span><br><span class="line">• Minimal: Roughly 2.5 percent without minimums</span><br><span class="line">Minimal is the same as default except for small configurations. When the configuration is small, minimal will only set aside spare space equal to one of the largest drives (compared to two for default) of the type being sized.</span><br><span class="line">• Maximal: One disk’s worth in every cage</span><br><span class="line">Spare space is calculated as the space of the largest drive of the drive type being sized for each disk cage.</span><br><span class="line">• Custom: Implemented manually by the administrator using the createspare, showspare, and removespare commands.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认比例为 2.5%；最大比例为 12%；</p>
</blockquote>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://community.hpe.com/t5/hpe-3par-storserv-storage/check-spare-capacity-on-disk-driver/td-p/7085333">https://community.hpe.com/t5/hpe-3par-storserv-storage/check-spare-capacity-on-disk-driver/td-p/7085333</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/1f81934e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/1f81934e/" class="post-title-link" itemprop="url">HPE SAN存储常用指令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-03 17:54:31" itemprop="dateCreated datePublished" datetime="2024-05-03T17:54:31+00:00">2024-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/SAN%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">SAN存储</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常用指令集"><a href="#常用指令集" class="headerlink" title="常用指令集"></a>常用指令集</h1><h2 id="查询类"><a href="#查询类" class="headerlink" title="查询类"></a>查询类</h2><h3 id="查询后端存储端口流量"><a href="#查询后端存储端口流量" class="headerlink" title="查询后端存储端口流量"></a>查询后端存储端口流量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">statport -disk -ni</span><br></pre></td></tr></table></figure>

<h3 id="查询盘笼状态"><a href="#查询盘笼状态" class="headerlink" title="查询盘笼状态"></a>查询盘笼状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showcage</span><br></pre></td></tr></table></figure>

<h3 id="查询-PD-状态，即硬盘状态"><a href="#查询-PD-状态，即硬盘状态" class="headerlink" title="查询 PD 状态，即硬盘状态"></a>查询 PD 状态，即硬盘状态</h3><p>会显示该硬盘的总容量、使用量、可用容量、热备空间；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showpd -c</span><br></pre></td></tr></table></figure>

<h3 id="查询系统信息"><a href="#查询系统信息" class="headerlink" title="查询系统信息"></a>查询系统信息</h3><p>序列号、总容量、已分配容量、空闲容量；</p>
<blockquote>
<p>注意精简置备带来的影响！</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showsys -d</span><br></pre></td></tr></table></figure>

<h3 id="查询CPG策略"><a href="#查询CPG策略" class="headerlink" title="查询CPG策略"></a>查询CPG策略</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showcpg</span><br></pre></td></tr></table></figure>

<h3 id="查询CPG对应的容量分配"><a href="#查询CPG对应的容量分配" class="headerlink" title="查询CPG对应的容量分配"></a>查询CPG对应的容量分配</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showspace -cpg [CPG_NAME]</span><br></pre></td></tr></table></figure>

<h3 id="查询任务"><a href="#查询任务" class="headerlink" title="查询任务"></a>查询任务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">showtask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询具体任务信息</span></span><br><span class="line">showtask -d [PID]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/7b93299d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/7b93299d/" class="post-title-link" itemprop="url">Windows Server 创建计划任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-03 16:08:26" itemprop="dateCreated datePublished" datetime="2024-05-03T16:08:26+00:00">2024-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 14:05:09" itemprop="dateModified" datetime="2025-06-22T14:05:09+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h1><p>任务1：创建自动化任务，到指定时间自动运行脚本；<br>任务2：通过远程下发指令，时间自动化创建自动任务；</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="任务1操作实例-CLI操作界面"><a href="#任务1操作实例-CLI操作界面" class="headerlink" title="任务1操作实例-CLI操作界面"></a>任务1操作实例-CLI操作界面</h2><p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/powershell/module/psscheduledjob/register-scheduledjob?view=powershell-5.1">https://learn.microsoft.com/zh-cn/powershell/module/psscheduledjob/register-scheduledjob?view=powershell-5.1</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/new-scheduledtask?view=winserver2012r2-ps">https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/new-scheduledtask?view=winserver2012r2-ps</a></li>
</ol>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 叫什么：一个名为 TEST 的自动任务</span></span><br><span class="line"><span class="variable">$TASKNAME</span>=<span class="string">&quot;TEST&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 干什么：并执行 test.ps1 脚本</span></span><br><span class="line"><span class="variable">$TESTSCRIPT</span>=<span class="string">&quot;C:\test.ps1&quot;</span>;</span><br><span class="line"><span class="variable">$ACTION</span>=<span class="built_in">New-ScheduledTaskAction</span> <span class="literal">-Execute</span> <span class="string">&quot;Powershell&quot;</span> <span class="literal">-Argument</span> <span class="variable">$TESTCRIPT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 什么时候做：在每周三，晚上7:30执行；</span></span><br><span class="line"><span class="variable">$JOBTRIGGER</span>=<span class="built_in">New-JobTrigger</span> <span class="literal">-Weekly</span> <span class="literal">-At</span> <span class="string">&quot;9:00 PM&quot;</span> <span class="literal">-DaysOfWeek</span> Wednesday <span class="literal">-WeeksInterval</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 谁：拥有最高权限</span></span><br><span class="line"><span class="comment"># 有啥注意事项：无论有没有用户登录，都执行</span></span><br><span class="line"><span class="variable">$PRINCIPAL</span>=<span class="built_in">New-ScheduledTaskPrincipal</span> <span class="literal">-UserId</span> [<span class="type">USER</span>] <span class="literal">-LogonType</span> S4U</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建任务信息</span></span><br><span class="line"><span class="variable">$SCHEDULEDTASKOBJECT</span>=<span class="built_in">New-ScheduledTask</span> <span class="literal">-Action</span> <span class="variable">$ACTION</span> <span class="literal">-Trigger</span> <span class="variable">$JOBTRIGGER</span> <span class="literal">-Principal</span> <span class="variable">$PRINCIPAL</span></span><br><span class="line"><span class="comment"># 注册任务</span></span><br><span class="line"><span class="built_in">Register-ScheduledTask</span> <span class="literal">-TaskName</span> <span class="variable">$TASKNAME</span> <span class="literal">-InputObject</span> [<span class="type">SchedledTaskObjectName</span>];</span><br></pre></td></tr></table></figure>


<h2 id="任务1操作实例-GUI操作界面"><a href="#任务1操作实例-GUI操作界面" class="headerlink" title="任务1操作实例-GUI操作界面"></a>任务1操作实例-GUI操作界面</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lishidefengchen/p/4381565.html">https://www.cnblogs.com/lishidefengchen/p/4381565.html</a></p>
<p>环境说明:</p>
<ol>
<li>Powershell 目录：C:\Windows\SysWOW64\WindowsPowerShell\v1.0\PowerShell.exe;</li>
<li>脚本位置：C:\test.ps1;</li>
</ol>
<h3 id="运行“任务计划程序”"><a href="#运行“任务计划程序”" class="headerlink" title="运行“任务计划程序”"></a>运行“任务计划程序”</h3><ol>
<li>windows + R;</li>
<li>输入 taskschd.msc;</li>
</ol>
<h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p>常规页面：</p>
<ol>
<li>填写任务名称；</li>
<li>勾选“不敢用户是否登录都要运行”</li>
<li>勾选“使用最高权限运行”；【如果有涉及提权操作，则需要勾选】</li>
<li>配置选择为对应的OS版本；</li>
</ol>
<p>触发器页面：</p>
<ol>
<li>新建；</li>
<li>设置自动执行的频率与时间；</li>
</ol>
<p>操作页面：</p>
<ol>
<li>操作，选择“启动程序”；</li>
<li>程序或脚本，输入“powershell”或者Powershell的绝对路径“C:\Windows\SysWOW64\WindowsPowerShell\v1.0\PowerShell.exe”；</li>
<li>添加参数（可选）,输入脚本的绝对路径，用英文状态的双引号包裹；</li>
</ol>
<p>点击确定；</p>
<h3 id="如何DEBUG"><a href="#如何DEBUG" class="headerlink" title="如何DEBUG"></a>如何DEBUG</h3><p>有可能任务运行会失败或者未按预期执行，可以选中任务，点击运行后，可以在“历史History”标签页中看到执行情况。<br>不过此时获取的信息还是比较有限，所以可以在脚本中增加 Start-Transcript 与 Stop-Transcript 指令，检查执行情况。</p>
<h1 id="TASK-LOGON-TYPE-类型"><a href="#TASK-LOGON-TYPE-类型" class="headerlink" title="TASK_LOGON_TYPE 类型"></a>TASK_LOGON_TYPE 类型</h1><p>参考: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/taskschd/ne-taskschd-task_logon_type">https://learn.microsoft.com/en-us/windows/win32/api/taskschd/ne-taskschd-task_logon_type</a></p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="class"><span class="keyword">enum</span> _<span class="title">TASK_LOGON_TYPE</span></span> &#123;</span><br><span class="line">  TASK_LOGON_NONE = <span class="number">0</span>,</span><br><span class="line">  TASK_LOGON_PASSWORD = <span class="number">1</span>,</span><br><span class="line">  TASK_LOGON_S4U = <span class="number">2</span>,</span><br><span class="line">  TASK_LOGON_INTERACTIVE_TOKEN = <span class="number">3</span>,</span><br><span class="line">  TASK_LOGON_GROUP = <span class="number">4</span>,</span><br><span class="line">  TASK_LOGON_SERVICE_ACCOUNT = <span class="number">5</span>,</span><br><span class="line">  TASK_LOGON_INTERACTIVE_TOKEN_OR_PASSWORD = <span class="number">6</span></span><br><span class="line">&#125; TASK_LOGON_TYPE;</span><br></pre></td></tr></table></figure>

<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">TASK_LOGON_NONE</span><br><span class="line">Value: <span class="number">0</span></span><br><span class="line">The logon method is not specified. Used <span class="keyword">for</span> non<span class="literal">-NT</span> credentials.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_PASSWORD</span><br><span class="line">Value: <span class="number">1</span></span><br><span class="line">Use a password <span class="keyword">for</span> logging on the user. The password must be supplied at registration time.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_S4U</span><br><span class="line">Value: <span class="number">2</span></span><br><span class="line">The service will log the user on <span class="keyword">using</span> Service For User (S4U), and the task will run in a non-interactive desktop. When an S4U logon is used, no password is stored by the system and there is no access to either the network or to encrypted files.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_INTERACTIVE_TOKEN</span><br><span class="line">Value: <span class="number">3</span></span><br><span class="line">User must already be logged on. The task will be run only <span class="keyword">in</span> an existing interactive session.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_GROUP</span><br><span class="line">Value: <span class="number">4</span></span><br><span class="line"><span class="built_in">Group</span> activation. The groupId field specifies the <span class="built_in">group</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_SERVICE_ACCOUNT</span><br><span class="line">Value: <span class="number">5</span></span><br><span class="line">Indicates that a Local System, Local Service, or Network Service account is being used as a security context to run the task.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_INTERACTIVE_TOKEN_OR_PASSWORD</span><br><span class="line">Value: <span class="number">6</span></span><br><span class="line">Not <span class="keyword">in</span> use; currently identical to TASK_LOGON_PASSWORD.</span><br><span class="line"></span><br><span class="line">Windows <span class="number">10</span>, version <span class="number">1511</span>, Windows <span class="number">10</span>, version <span class="number">1507</span>, Windows <span class="number">8.1</span>, Windows Server <span class="number">2012</span> R2, Windows <span class="number">8</span>, Windows Server <span class="number">2012</span>, Windows Vista and Windows Server <span class="number">2008</span>:  First use the interactive token. <span class="keyword">If</span> the user is not logged on (no interactive token is available), then the password is used. The password must be specified when a task is registered. This flag is not recommended <span class="keyword">for</span> new tasks because it is less reliable than TASK_LOGON_PASSWORD.</span><br><span class="line"></span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/d5bff2f1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/d5bff2f1/" class="post-title-link" itemprop="url">待补充-Windows Server 通过NTDLL设置注册表权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-23 00:49:16" itemprop="dateCreated datePublished" datetime="2024-04-23T00:49:16+00:00">2024-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="场景说明"><a href="#场景说明" class="headerlink" title="场景说明"></a>场景说明</h1><p>一般在重置 RDS 120天许可会用到，需要删除GracePeriod 注册表才可以恢复120天试用期；但是直接使用Powershell的Remove-Item属性是无法完成这个操作的，必须提权。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/31ea1e9e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/31ea1e9e/" class="post-title-link" itemprop="url">Windows Server  安装其他语言包</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-22 16:44:54" itemprop="dateCreated datePublished" datetime="2024-04-22T16:44:54+00:00">2024-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol>
<li>下载语言包；</li>
<li>将所需的语言cab包传入目标服务器；</li>
<li>运行lpksetup.exe,安装对应的补丁包；</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/zh-cn/000220901/windows-server-2022%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E8%AF%AD%E8%A8%80%E5%8C%85">https://www.dell.com/support/kbdoc/zh-cn/000220901/windows-server-2022%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E8%AF%AD%E8%A8%80%E5%8C%85</a><br><a target="_blank" rel="noopener" href="https://netshopisp.medium.com/how-to-install-language-pack-on-windows-server-2019-8d477d8c3c2e">https://netshopisp.medium.com/how-to-install-language-pack-on-windows-server-2019-8d477d8c3c2e</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/e83d3b1f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/e83d3b1f/" class="post-title-link" itemprop="url">Windows-Server-RDSH初始化清单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-18 19:54:05" itemprop="dateCreated datePublished" datetime="2024-04-18T19:54:05+00:00">2024-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-09-23 15:39:55" itemprop="dateModified" datetime="2025-09-23T15:39:55+00:00">2025-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>RDSH(Remote Desktop Session Host)，用于发布APP给到用户，需要做一些初始化的操作，以及安装一些必要的软件。</p>
<h1 id="确认需求"><a href="#确认需求" class="headerlink" title="确认需求"></a>确认需求</h1><p>比如通过RDSH发布的浏览器或者SSH客户端，用于网页访问、SSH访问；</p>
<h2 id="应用清单"><a href="#应用清单" class="headerlink" title="应用清单"></a>应用清单</h2><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">版本</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Chrome</td>
<td align="center">最新版本</td>
<td align="center">可以用msi包，通过WINRM下发指令安装</td>
</tr>
<tr>
<td align="center">Firefox</td>
<td align="center">最新版本</td>
<td align="center">作为Chrome的备用软件，也可以远程安装</td>
</tr>
<tr>
<td align="center">杀毒软件</td>
<td align="center"></td>
<td align="center">避免用户自行上传恶意包，导致RDSH故障</td>
</tr>
<tr>
<td align="center">XSHELL</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Putty</td>
<td align="center"></td>
<td align="center">作为xshell的备用软件</td>
</tr>
<tr>
<td align="center">Xterm</td>
<td align="center"></td>
<td align="center">作为xshell的备用软件，可以打开X Desktop应用</td>
</tr>
<tr>
<td align="center">VMware Horizon View Agent</td>
<td align="center">有版本关联要求，一般安装稳定版本</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Remote desktop session hosts</td>
<td align="center"></td>
<td align="center">120天限制</td>
</tr>
</tbody></table>
<h2 id="权限与组策略调整"><a href="#权限与组策略调整" class="headerlink" title="权限与组策略调整"></a>权限与组策略调整</h2><h3 id="Chrome没有声音"><a href="#Chrome没有声音" class="headerlink" title="Chrome没有声音"></a>Chrome没有声音</h3><p>可以参照：<a target="_blank" rel="noopener" href="https://rohman-zhu.github.io/2022/10/16/RDSH%E4%B8%AD%E7%9A%84Chrome%E6%B2%A1%E6%9C%89%E5%A3%B0%E9%9F%B3/">https://rohman-zhu.github.io/2022/10/16/RDSH%E4%B8%AD%E7%9A%84Chrome%E6%B2%A1%E6%9C%89%E5%A3%B0%E9%9F%B3/</a></p>
<h3 id="Chrome下载目录"><a href="#Chrome下载目录" class="headerlink" title="Chrome下载目录"></a>Chrome下载目录</h3><ol>
<li>导入Chrome 组策略包；</li>
<li>设置下载路径： \[SAMBA 服务器地址]\路径${user_name}</li>
</ol>
<blockquote>
<p>${user_name}是一个变量，固定写法；</p>
</blockquote>
<h3 id="设置安全策略"><a href="#设置安全策略" class="headerlink" title="设置安全策略"></a>设置安全策略</h3><ol>
<li>隐藏驱动器；</li>
</ol>
<h3 id="设置C盘根目录权限"><a href="#设置C盘根目录权限" class="headerlink" title="设置C盘根目录权限"></a>设置C盘根目录权限</h3><p>一般可以访问RDSH的用户均是 Remote Desktop Users 组，因此对C盘根目录的NTFS权限可以设置 该组 为 <em>写入拒绝</em> 、 <em>读取内容拒绝</em> 权限；</p>
<blockquote>
<p>只有Windows 、 Program Files 、Program Files(x86) 目录无法设置；</p>
</blockquote>
<h2 id="运维相关"><a href="#运维相关" class="headerlink" title="运维相关"></a>运维相关</h2><h3 id="安装-PS-Windows-Update-模块"><a href="#安装-PS-Windows-Update-模块" class="headerlink" title="安装 PS Windows Update 模块"></a>安装 PS Windows Update 模块</h3><p>为了方便以后Windows 补丁安装；</p>
<h3 id="修改-WinRM-监听端口"><a href="#修改-WinRM-监听端口" class="headerlink" title="修改 WinRM 监听端口"></a>修改 WinRM 监听端口</h3><p>默认端口为5985，需要修改为一个不常用的端口；<br>其次要设置防火墙策略，避免被拦截。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启WINRM</span></span><br><span class="line"><span class="built_in">Enable-PSRemoting</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改WINRM端口</span></span><br><span class="line"><span class="built_in">set-item</span> wsman:\localhost\listener\listener*\port <span class="number">5895</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查监听端口</span></span><br><span class="line">winrm enumerate winrm/config/listener</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙</span></span><br><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-Name</span> <span class="string">&quot;AllowWinRM&quot;</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Allow_WINRM_TCP_XXXX&quot;</span> <span class="literal">-Enabled</span> True <span class="literal">-Direction</span> Inbound <span class="literal">-Action</span> ALLOW <span class="literal">-LocalPort</span> <span class="number">5985</span> <span class="literal">-Protocol</span> TCP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置防火墙适用范围</span></span><br><span class="line"><span class="built_in">Get-NetfirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Allow_WINRM_TCP_XXXX&quot;</span> | <span class="built_in">Get-NetFirewallAddressFilter</span> | <span class="built_in">Set-NetFirewallAddressFilter</span> <span class="literal">-RemoteAddress</span> &#123;xx.xx.xx.xx<span class="literal">-xx</span>.xx.xx.xx&#125;,&#123;xx.xx.xx.xx<span class="literal">-xx</span>.xx.xx&#125;;</span><br></pre></td></tr></table></figure>



<h1 id="实战脚本"><a href="#实战脚本" class="headerlink" title="实战脚本"></a>实战脚本</h1><h2 id="RDSH初始化"><a href="#RDSH初始化" class="headerlink" title="RDSH初始化"></a>RDSH初始化</h2><p>拿到RDSH机器后，先要完成基础初始化动作，确保可以由远端下发远程策略；</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name: init-rdsh.ps1</span></span><br><span class="line"><span class="comment"># Version:v2</span></span><br><span class="line"><span class="comment"># Description:Init RDSH powershell script</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$GLOBAL_WINRM_PORT</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="variable">$GLOBAL_IP_MGMT_1</span>=&#123;&#125;;</span><br><span class="line"><span class="variable">$GLOBAL_IP_MGMT_2</span>=&#123;&#125;;</span><br><span class="line"><span class="comment"># Format:IP</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$GLOBAL_Target_MGMT_Account</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment"># Format: domain\username;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$GLOBAL_IP_DNS_1</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$GLOBAL_IP_DNS_2</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment"># Format:IP</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$GLOBAL_TARGET_Domain</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$GLOBAL_MGMT_User</span>=<span class="built_in">Get-Credential</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-WINRM</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$WINRM_PORT</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 开启WINRM</span></span><br><span class="line">    <span class="built_in">Enable-PSRemoting</span> <span class="literal">-Force</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 修改WINRM端口</span></span><br><span class="line">    <span class="built_in">set-item</span> wsman:\localhost\listener\listener*\port <span class="variable">$WINRM_PORT</span> <span class="literal">-Force</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查监听端口</span></span><br><span class="line">    winrm enumerate winrm/config/listener</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 开启防火墙</span></span><br><span class="line">    <span class="built_in">Set-NetfirewallProfile</span> <span class="literal">-Enabled</span> True;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 防火墙</span></span><br><span class="line">    <span class="built_in">New-NetFirewallRule</span> <span class="literal">-Name</span> <span class="string">&quot;AllowWinRM&quot;</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Allow_WINRM_TCP_<span class="variable">$WINRM_PORT</span>&quot;</span> <span class="literal">-Enabled</span> True <span class="literal">-Direction</span> Inbound <span class="literal">-Action</span> ALLOW <span class="literal">-LocalPort</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Protocol</span> TCP;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置防火墙适用范围</span></span><br><span class="line">    <span class="built_in">Get-NetfirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Allow_WINRM_TCP_<span class="variable">$WINRM_PORT</span>&quot;</span> | <span class="built_in">Get-NetFirewallAddressFilter</span> | <span class="built_in">Set-NetFirewallAddressFilter</span> <span class="literal">-RemoteAddress</span> <span class="variable">$GLOBAL_IP_MGMT_1</span>,<span class="variable">$GLOBAL_IP_MGMT_2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-InitDNS</span></span>&#123;</span><br><span class="line">    <span class="variable">$NICNAMESET</span>=<span class="built_in">Get-NetAdapter</span> <span class="literal">-Physical</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$NICNAMESET</span>.Name.GetType().BaseType.Name <span class="operator">-match</span> <span class="string">&quot;Object&quot;</span>)&#123;</span><br><span class="line">        <span class="comment"># 单网卡设置DNS；</span></span><br><span class="line">        <span class="variable">$NICNAME</span>=<span class="variable">$NICNAMESET</span>.Name;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Set-DnsClientServerAddress</span> <span class="literal">-InterfaceAlias</span> <span class="variable">$NICNAME</span> <span class="literal">-ServerAddresses</span> <span class="variable">$GLOBAL_IP_DNS_1</span>,<span class="variable">$GLOBAL_IP_DNS_2</span>;</span><br><span class="line">    &#125;<span class="keyword">elseif</span> (<span class="variable">$NICNAMESET</span>.Name.GetType().BaseType.Name <span class="operator">-match</span> <span class="string">&quot;Array&quot;</span>) &#123;</span><br><span class="line">        <span class="comment"># 多网卡设置DNS</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$NICNAMESET</span>.Length;<span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$NICNAME</span>=<span class="variable">$NICNAMESET</span>.Name[<span class="variable">$i</span>];</span><br><span class="line">            <span class="built_in">Set-DnsClientServerAddress</span> <span class="literal">-InterfaceAlias</span> <span class="variable">$NICNAME</span> <span class="literal">-ServerAddresses</span> <span class="variable">$GLOBAL_IP_DNS_1</span>,<span class="variable">$GLOBAL_IP_DNS_2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-JoinDomain</span></span>&#123;</span><br><span class="line">    <span class="variable">$baseHostname</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="variable">$IPInfo</span>=<span class="variable">$</span>(<span class="variable">$</span>(ipconfig | findstr <span class="string">&quot;IPv4&quot;</span>) <span class="operator">-Split</span> <span class="string">&quot;[:]&quot;</span>)[<span class="number">1</span>].Trim();</span><br><span class="line">    <span class="variable">$index</span>=<span class="variable">$</span>(<span class="variable">$IPInfo</span> <span class="operator">-Split</span> <span class="string">&quot;[.]&quot;</span>)[<span class="number">3</span>].Trim();</span><br><span class="line">    <span class="comment">#将字符型转为整型 </span></span><br><span class="line">    <span class="variable">$flag</span>=[<span class="type">convert</span>]::ToInt32(<span class="variable">$index</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-ge</span> <span class="number">1</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-le</span> <span class="number">9</span>) )&#123;</span><br><span class="line">        <span class="comment"># 在 001 与 009 区间</span></span><br><span class="line">        <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="string">&quot;00&quot;</span> + <span class="variable">$index</span>;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-ge</span> <span class="number">10</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="variable">$flag</span> <span class="operator">-le</span> <span class="number">99</span>))&#123;</span><br><span class="line">        <span class="comment"># 在 100 与 99 区间</span></span><br><span class="line">        <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="string">&quot;0&quot;</span> + <span class="variable">$index</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment"># 大于100</span></span><br><span class="line">        <span class="variable">$newHostname</span>=<span class="variable">$baseHostname</span> + <span class="variable">$index</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Add-Computer</span> <span class="literal">-DomainName</span> <span class="variable">$GLOBAL_TARGET_Domain</span> <span class="literal">-Credential</span> <span class="variable">$GLOBAL_MGMT_User</span> <span class="literal">-NewName</span> <span class="variable">$newHostname</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-InstallRDS</span></span>&#123;</span><br><span class="line">    <span class="comment"># 自动重启需要加参数 -Restart</span></span><br><span class="line">    <span class="built_in">Install-WindowsFeature</span> <span class="literal">-Name</span> <span class="string">&quot;RDS-RD-Server&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-Main</span></span>&#123;</span><br><span class="line">    <span class="built_in">Start-WINRM</span> <span class="variable">$GLOBAL_WINRM_PORT</span>;</span><br><span class="line">    <span class="built_in">Start-InitDNS</span>;</span><br><span class="line">    <span class="built_in">Start-JoinDomain</span>;</span><br><span class="line">    <span class="built_in">Start-InstallRDS</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加管理员至administrators组</span></span><br><span class="line">    net localgroup administrators /add <span class="variable">$GLOBAL_Target_MGMT_Account</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自动重启</span></span><br><span class="line">    shutdown /s /t <span class="number">180</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-Main</span>;</span><br></pre></td></tr></table></figure>

<h2 id="服务器端下发指令"><a href="#服务器端下发指令" class="headerlink" title="服务器端下发指令"></a>服务器端下发指令</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$GLOBAL_WINRM_PORT</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="variable">$GLOBAL_MGMT_User</span>=<span class="built_in">Get-Credential</span>;</span><br><span class="line"><span class="variable">$GLOBAL_USERLIST</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Horizon Agent</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-InstallHorizonAgent</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PS_Session</span>);</span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_Session</span> <span class="literal">-ScriptBlock</span> &#123;mkdir C:\<span class="number">1</span><span class="literal">-InstallPackage</span>;&#125;;</span><br><span class="line">    <span class="built_in">Copy-Item</span> Agent.exe <span class="literal">-Destination</span> C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\Agent.exe <span class="literal">-ToSession</span> <span class="variable">$PS_Session</span>;</span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_Session</span> <span class="literal">-Ar</span> <span class="literal">-ScriptBlock</span> &#123; C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\agent.exe /s /v <span class="string">&#x27;/qn RDP_CHOICE=0 VDM_VC_MANAGED_AGENT=0 VDM_SERVER_NAME=[Connect Server IP] VDM_SERVER_USERNAME=[domain\administratorUsername] VDM_SERVER_PASSWORD=&quot;[密码，需要用双引号]&quot; ADDLOCAL=Core REBOOT=Force&#x27;</span> /l C:\<span class="number">1</span><span class="literal">-InstallPackage</span>\installAgent.log;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-GrantUser</span></span> &#123;</span><br><span class="line">    <span class="keyword">param</span> (<span class="variable">$PS_Session</span>,<span class="variable">$UserList</span>);</span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_Session</span> <span class="literal">-ArgumentList</span> <span class="variable">$UserList</span> <span class="literal">-ScriptBlock</span> &#123; <span class="keyword">param</span>(<span class="variable">$UserList</span>);net localgroup <span class="string">&quot;Remote Desktop Users&quot;</span> /add <span class="variable">$UserList</span>&#125;;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Start-Main</span></span>&#123;</span><br><span class="line">  <span class="keyword">param</span>(<span class="variable">$ServerIP</span>);</span><br><span class="line">  <span class="variable">$Session</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$ServerIP</span> <span class="literal">-Port</span> <span class="variable">$GLOBAL_WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$GLOBAL_MGMT_User</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Start-InstallHorizonAgent</span> <span class="variable">$Session</span>;</span><br><span class="line">  <span class="built_in">Start-GrantUser</span> <span class="variable">$Session</span> <span class="variable">$GLOBAL_USERLIST</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-Main</span> </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3fa89bd7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3fa89bd7/" class="post-title-link" itemprop="url">Horizon-599故障</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 01:14:06" itemprop="dateCreated datePublished" datetime="2024-04-01T01:14:06+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><ol>
<li>连接服务器、安全服务器无法连接TCP-443；</li>
<li>连接 https:&#x2F;&#x2F;安全服务器 ，显示599；</li>
<li>连接服务器的日志（C:\ProgramData\VMware\VDM\log\xxx.log），显示 MEMORY-ALARM:physical memory use &#x3D; 97% ,[ws_perfmon]High memory use….</li>
</ol>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>直接原因：服务器内存已经用满，出现内存泄漏的情况；<br>根本原因：出现补丁更新，未重启；</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>重启服务器。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3f099f5a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3f099f5a/" class="post-title-link" itemprop="url">Powershell实例-远程安装补丁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 00:49:57" itemprop="dateCreated datePublished" datetime="2024-04-01T00:49:57+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 14:00:34" itemprop="dateModified" datetime="2025-06-22T14:00:34+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><ol>
<li>给远端的服务器安装补丁；</li>
<li>检查是否需要重启；</li>
</ol>
<h1 id="实例脚本"><a href="#实例脚本" class="headerlink" title="实例脚本"></a>实例脚本</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Date:2024-03-31</span></span><br><span class="line"><span class="comment"># Version : v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global Veriable</span></span><br><span class="line"><span class="variable">$WINRM_PORT</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="comment"># Target Windows Update  inneed;</span></span><br><span class="line"><span class="variable">$TARGET_WUKB_ARRARY</span>=<span class="string">&quot;KB5035849&quot;</span>,<span class="string">&quot;KB5035849&quot;</span>;</span><br><span class="line"><span class="variable">$TARGETSERVER_List</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$PSCREDENTIAL</span>)&#123;<span class="variable">$PSCREDENTIAL</span>=<span class="built_in">Get-Credential</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-Log</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TYPE</span>,<span class="variable">$CONTENT</span>);</span><br><span class="line">    <span class="variable">$TIMESPAN1</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="variable">$TIMESPAN2</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> <span class="string">&quot;<span class="variable">$TYPE</span>.log&quot;</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check windows updates is installed</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-WindowsUpdate</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB_ARRARY</span>,<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="variable">$WU_CHECK_BLOCK</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB</span>);</span><br><span class="line">        <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">        <span class="variable">$INSTALL_KB_CHECK</span>=<span class="built_in">Get-HotFix</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.HotFixID <span class="operator">-match</span> <span class="variable">$TARGET_WUKB</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$INSTALL_KB_CHECK</span>)&#123;</span><br><span class="line">            <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$INSTALL_FLAG</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TARGET_WUKB_ARRARY</span>.Length;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$WU_PRE_CHECK_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ArgumentList</span> <span class="variable">$TARGET_WUKB_ARRARY</span>[<span class="variable">$i</span>] <span class="literal">-ScriptBlock</span> <span class="variable">$WU_CHECK_BLOCK</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;#注意 ArgumentList 无法传递数组；2024-03-31，废案；</span></span><br><span class="line"><span class="comment">    $WU_CHECK=&#123;</span></span><br><span class="line"><span class="comment">        param($TARGET_WUKB_ARRARY);</span></span><br><span class="line"><span class="comment">        $INSTALL_FLAG=$FALSE;</span></span><br><span class="line"><span class="comment">        for($i = 0; $i -lt $TARGET_WUKB_ARRARY.Length;$i++)&#123;</span></span><br><span class="line"><span class="comment">            $ISINSTALLED=Get-HotFix | Where-Object &#123;$_.HotFixID -match $TARGET_WUKB_ARRARY[$i]&#125;;</span></span><br><span class="line"><span class="comment">            if($null -eq $ISINSTALLED)&#123;</span></span><br><span class="line"><span class="comment">                $INSTALL_FLAG=$TRUE;</span></span><br><span class="line"><span class="comment">                Write-Host &quot;$(hostname) need install $($TARGET_WUKB_ARRARY[$i]);&quot;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return $INSTALL_FLAG;</span></span><br><span class="line"><span class="comment">    &#125;    </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    $READY_FLAG=Invoke-Command -Session $PSSESSION -ScriptBlock $WU_CHECK -ArgumentList $TARGET_WUKB_ARRARY;</span></span><br><span class="line"><span class="comment">    #&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to install windows update &quot;</span></span><br><span class="line">        <span class="built_in">Invoke-WuJob</span> <span class="literal">-ComputerName</span> <span class="variable">$PSSESSION</span>.ComputerName <span class="literal">-Script</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-IgnoreReboot</span> | <span class="built_in">Out-File</span> C:\InstallWindows.log&#125; <span class="literal">-RunNow</span> <span class="literal">-Confirm</span>:<span class="variable">$FALSE</span> <span class="literal">-ErrorAction</span> Ignore;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INSTALL-WU&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) don&#x27;t need to intall <span class="variable">$TARGET_WUKB_ARRARY</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check target windows server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-RebootStatus</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CHECK_REBOOT_BLOCK</span>=&#123;</span><br><span class="line">        <span class="comment">#$ISNEED_REBOOT=$FALSE;</span></span><br><span class="line">        <span class="variable">$ISNEED_REBOOT</span>=<span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISNEED_REBOOT</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$TRUE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$REBOOT_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$CHECK_REBOOT_BLOCK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$REBOOT_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to reboot&quot;</span>;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;REBOOT&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start check target server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-CheckTargetServer</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGETSERVER_LIST_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Content</span> <span class="variable">$TARGETSERVER_LIST_FILE</span> | <span class="built_in">ForEach-Object</span>&#123;</span><br><span class="line">        <span class="variable">$SERVERNAME</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Start connect to <span class="variable">$SERVERNAME</span> &quot;</span>;</span><br><span class="line">        <span class="variable">$SESSION</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$SERVERNAME</span> <span class="literal">-Port</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$PSCREDENTIAL</span>;</span><br><span class="line"></span><br><span class="line">        Check<span class="literal">-WindowsUpdate</span> <span class="variable">$TARGET_WUKB_ARRARY</span> <span class="variable">$SESSION</span>;</span><br><span class="line">        Check<span class="literal">-RebootStatus</span> <span class="variable">$SESSION</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-CheckTargetServer</span> <span class="variable">$TARGETSERVER_List</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>Invoke-Command 传参：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/talentzemin/p/16976197.html">https://www.cnblogs.com/talentzemin/p/16976197.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/46/">46</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"light","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
