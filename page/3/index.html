<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/3/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">428</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3ec2a553/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3ec2a553/" class="post-title-link" itemprop="url">Windows_Server_内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-07 16:35:33" itemprop="dateCreated datePublished" datetime="2024-07-07T16:35:33+00:00">2024-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="任务管理器"><a href="#任务管理器" class="headerlink" title="任务管理器"></a>任务管理器</h1><h2 id="工作集（内存）"><a href="#工作集（内存）" class="headerlink" title="工作集（内存）"></a>工作集（内存）</h2><p>一个程序能够直接使用的所有物理内存大小。</p>
<h2 id="专用工作集"><a href="#专用工作集" class="headerlink" title="专用工作集"></a>专用工作集</h2><p>这个程序独享的物理内存大小。</p>
<h2 id="共享工作集"><a href="#共享工作集" class="headerlink" title="共享工作集"></a>共享工作集</h2><p>和其他程序共享的内存大小。</p>
<h2 id="提交大小"><a href="#提交大小" class="headerlink" title="提交大小"></a>提交大小</h2><p>程序申请的内存大小。</p>
<h2 id="页面错误"><a href="#页面错误" class="headerlink" title="页面错误"></a>页面错误</h2><p>使用虚拟内存读取失败。读取自 pagefile.sys 。 此错误越多，表示虚拟内存读取越频繁，内存运行效率越低。</p>
<blockquote>
<p>参考： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ii421e7Wd/?spm_id_from=333.1007.tianma.12-3-45.click&vd_source=a011e39eb7bf1b3a9f6ca7ec0db87ccf">https://www.bilibili.com/video/BV1ii421e7Wd/?spm_id_from=333.1007.tianma.12-3-45.click&amp;vd_source=a011e39eb7bf1b3a9f6ca7ec0db87ccf</a></p>
</blockquote>
<h1 id="博文：32MiB-Working-Sets-on-a-64-GiB-machine"><a href="#博文：32MiB-Working-Sets-on-a-64-GiB-machine" class="headerlink" title="博文：32MiB Working Sets on a 64 GiB machine"></a>博文：32MiB Working Sets on a 64 GiB machine</h1><p>大佬博客：<a target="_blank" rel="noopener" href="https://randomascii.wordpress.com/2023/10/01/32-mib-working-sets-on-a-64-gib-machine/#more-4032">https://randomascii.wordpress.com/2023/10/01/32-mib-working-sets-on-a-64-gib-machine/#more-4032</a></p>
<p>Memory is a relatively scarce resource on many consumer computers, so a feature to limit how much memory a process uses seems like a good idea, and Microsoft did indeed implement such a feature. However:</p>
<ul>
<li>They didn’t document this (!)</li>
<li>Their implementation doesn’t actually save memory</li>
<li>The implementation can have a prohibitively high CPU cost</li>
</ul>
<p>This feature works by limiting the working set of a process – the amount of memory mapped into the address-space of the process – to 32 MiB. Before reading any further take a moment to guess what the maximum slowdown might be from this feature. That is, if a process repeatedly touched more than 32 MiB of memory – let’s say 64 MiB of memory – then how much longer could these memory operations take compared to if the working set was not limited? Take a moment and write down your guess. The answer is later in this post.</p>
<p>This exploration started when a Chrome user tweeted at me that they kept seeing Chrome’s setup.exe hogging the CPU. Investigating weird Chrome performance problems is literally my job so we started chatting. Eventually they used UIforETW’s circular-buffer recording mode (leave tracing running, save the buffers when the problem happens) to capture an ETW trace. They filed a Chromium bug and shared the trace and I took a look.</p>
<p>The trace did indeed show lots of CPU time being spent in setup.exe (the sampling rate is 1 kHz so each sample represents approximately 1 ms of CPU time), but there was nothing obviously out of order:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb.png?w=601&h=464"></p>
<p>That is, at a first glance there was nothing obviously out of order, however as soon as I drilled down into the hottest call stack I saw something peculiar:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-1.png?w=601&h=548"></p>
<p>A few hundred samples spent in KiPageFault seemed maybe plausible, but more than 20,000 samples is definitely weird.</p>
<p>KiPageFault is triggered whenever a process touches memory that is not currently in the working set of the process. The memory faulted in might be a zeroed page (first use of an allocated page), a page from the standby list (pages in memory that contain data), a compressed page, or a page that is backed by a file (a memory mapped file or the page file). Whatever the source, this function adjusts the page tables to make the page visible inside the process, and then restarts the faulting instruction.</p>
<p>Since KiPageFault is showing up on multiple call stacks (memory can get paged in from almost anywhere, after all) I needed to use a butterfly view to find out the total cost, and get some hints as to why so much time was being spent there. So, I right-clicked on KiPageFault and selected View Callees, By Function. This showed me two very interesting details:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-2.png?w=602&h=253"></p>
<p>The first detail is that of the 46,912 CPU samples taken from this process fully 46,444 of them (99%!) were inside KiPageFault. That is remarkable. In a steady-state process (not allocating excessively) on a system with sufficient memory (this system had 64 GiB of RAM and roughly 47 GiB of that was available) the number of page faults should be close to zero, and this was a long way from that.</p>
<p>The other detail is that most of the time inside of KiPageFault was spent in MiTrimWorkingSet. This makes sense. But at the same time it is, actually, pretty weird. It looks like every time a page is faulted in to the process the system immediately trims the working set, presumably removing another page from the working set. Doing this is expensive, and increases the odds of future page faults. So, it makes sense in that it explains why the process is spending so much time in KiPageFault, but it is weird because I don’t know why Windows would be doing this.</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-3.png?w=293&h=70"></p>
<p>ETW traces contain a wealth of information so I looked at the “Total Commit” table and found that setup.exe only had 47.418 MiB of commit. This measures the total amount of allocated memory in this process, plus a few other types of memory such as stack, and modified global variables. 47.418 MB is a pretty tiny amount and should take less than 10 ms to fault in (see Hidden Costs of Memory Allocation for details), and there were no new allocations during the trace, so the KiPageFault overhead was definitely excessive.</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-4.png?w=296&h=229"></p>
<h2 id="Procrastination"><a href="#Procrastination" class="headerlink" title="Procrastination"></a>Procrastination</h2><p>I thought that SetProcessWorkingSetSize might be involved in triggering this behavior, and a coworker suggested SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN could be a factor, so I thought about doing some experimentation with these functions. But, the issue was reported on Windows 11 and I assumed that there must be some odd-ball configuration triggering this edge case behavior so I didn’t think my tests would be fruitful so I did nothing for three weeks.</p>
<p>I finally got back to the bug and decided to start by doing the simplest possible test. I wrote code that allocated 64 MiB of RAM, touched all of it, then used EmptyWorkingSet, SetProcessWorkingSetSize, and SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN, then touched the memory again. I used some Sleep(5000) calls and Task Manager to monitor the working set. I was not expecting the simplest possible test to reveal the problem.</p>
<p>My tests showed that EmptyWorkingSet and SetProcessWorkingSetSize both emptied the working set almost to nothing, but the working set “refilled” when the memory was touched again. So, the documentation for these functions (as crazy and archaic as it sounds) seems to be mostly accurate. And, unless they were called extremely frequently these functions could not cause the problem.</p>
<p>On the other hand, my tests showed that SetPriorityClass with PROCESS_MODE_BACKGROUND_BEGIN caused the working set to be trimmed to 32 MiB, and kept it there when I touched all the memory again. That is, while touching 64 MiB of memory would normally fault those pages in and push the working set to 64 MiB or higher, instead the working set stayed capped.</p>
<p>Whoa. That’s crazy. It wasn’t supposed to be that simple. I refined the test code more but it’s still fairly simple. In its final form the code allocates 64 MiB of memory and then repeatedly walks over that memory (writing once to each page) to see how many times it can walk over the memory in a second. Then it does the same thing with the process set to background mode. The difference is dramatic:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-5.png?w=685&h=116"></p>
<p>The performance of scanning the memory in the normal mode is quite consistent, taking about 0.2 ms per scan. Scanning in background mode normally takes about 250 times as long per scan (two hundred and fifty times as long!!!). Sometimes the background-mode scanning goes dramatically slower – up to about 800 times as long per scan, 160 ms for 64 MiB.</p>
<p>This dramatic increase in CPU time is not a great way to reduce the impact of background processes.</p>
<h2 id="Limiting-the-Working-Set-Doesn’t-Save-Memory"><a href="#Limiting-the-Working-Set-Doesn’t-Save-Memory" class="headerlink" title="Limiting the Working Set Doesn’t Save Memory!"></a>Limiting the Working Set Doesn’t Save Memory!</h2><p>Okay, so PROCESS_MODE_BACKGROUND_BEGIN makes some operations take more than 250 times as long to run, but at least it saves memory. Right? Right?</p>
<p>Well, no. Not really. Not in any situation I can imagine.</p>
<p>Trimming the working set of a process doesn’t actually save memory. It just moves the memory from the working set of the process to the standby list. Then, if the system is under memory pressure the pages in the standby list are eligible to be compressed, or discarded (if unmodified and backed by a file), or written to the page file. But “eligible” is doing a lot of heavy lifting in that sentence. The OS doesn’t immediately do anything with the page, generally speaking. And, if the system has gobs of free and available memory then it may never do anything with the page, making the trimming pointless. The memory isn’t “saved”, it’s just moved from one list to another. It’s the digital equivalent of paper shuffling.</p>
<p>Another reason this trimming is pointless is because the system already has a (much more efficient) mechanism for managing working sets. Every second the system process wakes up and runs KeBalanceSetManager. Among other things this function calls MiProcessWorkingSets which calls MiTrimOrAgeWorkingSet:</p>
<p><img src="https://randomascii.wordpress.com/wp-content/uploads/2023/10/image_thumb-6.png?w=597&h=349"></p>
<p>All I know about this system is the names of the functions and the frequency of its operation, but I feel pretty confident in speculating about roughly what it’s doing, and it seems like a strictly better solution to the problem. Here’s why MiTrimOrAgeWorkingSet is better than PROCESS_MODE_BACKGROUND_BEGIN:</p>
<ul>
<li>Trimming the working set once per second is far more efficient (uses less CPU time) than trimming it after every page fault, and it greatly reduces the odds of trimming a page just before it is needed</li>
<li>Trimming the working set once per second is just as memory efficient as trimming after every page fault because trimming doesn’t immediately save memory anyway</li>
<li>Trimming the working set every second can more easily respond to changes in memory pressure, doing nothing when there is lots of free memory, and then aggressively trimming rarely-touched pages from idle processes when conditions change.</li>
</ul>
<h2 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h2><p>As far as Chrome is concerned the solution to this problem was simple – don’t call this function, and therefore don’t put Chrome’s setup process into this mode. We still run in low-priority mode, but not the problematic “background” mode.</p>
<p>But this function remains, waiting to snare some future developer. The easiest thing that Microsoft could do would be to change the documentation to acknowledge this behavior. I have in mind a large, red, bold-faced label saying “if your process uses more than 32 MiB of memory then this may make your program run 250 times slower and it won’t really save memory so maybe use THREAD_MODE_BACKGROUND_BEGIN instead.” But fixing the documentation would not be as valuable as fixing the background mode. I have trouble imagining any scenario where capping the working set would be better than the working-set trimming implemented in the system process, so removing this functionality seems like a pure win.</p>
<p>And fixing the background mode would avoid the need for the ugly large, red, bold-faced warning label.</p>
<p>Ironically the impetus for using PROCESS_MODE_BACKGROUND_BEGIN in Chrome was a 2012 Chrome bug (predating my time on the team, and I’ve been there a while) complaining that the updater was using too much CPU time.</p>
<p>This recent issue was reported on Windows 11, but I found a Mozilla bug discussing this flag that linked to a Stack Overflow answer from 2015 that pointed out that PROCESS_MODE_BACKGROUND_BEGIN limited the working set to 32 MiB on Windows 7. This issue has been known for eight years, on many versions of Windows, and it still hasn’t been corrected or even documented. I hope that changes now.</p>
<h2 id="Addendums"><a href="#Addendums" class="headerlink" title="Addendums"></a>Addendums</h2><p>To clarify, it is the working-set that is trimmed to 32 MiB, not the private working set. So, the 32 MiB number includes code as well as data, for what it’s worth.</p>
<p>Also, after posting this I was playing around and found that when I reset the process with PROCESS_MODE_BACKGROUND_END this causes the working set to be trimmed. That’s harmless, but weird. Why would taking the process out of background mode cause the working set to be trimmed as if the process had called EmptyWorkingSet?</p>
<p>A twitter user posted a bit of history and a tool (untested!) to list working-set state for processes on the system.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/269bf723/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/269bf723/" class="post-title-link" itemprop="url">ESXi-无法通过OVF创建虚拟机-提示只有管理此主机的服务器XX.XX.XX.XX才能访问此主机的资源设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-07 16:21:10" itemprop="dateCreated datePublished" datetime="2024-07-07T16:21:10+00:00">2024-07-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>登录ESXi后，无法通过OVF部署虚拟机，会提示“失败-只有管理此主机的服务器‘vCenter IP’才能访问此主机上的资源设置”。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>该ESXi已被vCenter接管，无法通过此ESXi去创建虚拟机，而需要通过vCenter部署虚拟机。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>核心就是先暂停ESXi与vCenter之间的通讯，可以参照以下方法：</p>
<ol>
<li>登录vCenter，选中目标ESXi，选择断开连接；</li>
<li>登录目标ESXi，选择通过OVF部署。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/c2d5fef5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/c2d5fef5/" class="post-title-link" itemprop="url">VMware虚拟机支持使用AVX-512指令集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-26 21:21:55" itemprop="dateCreated datePublished" datetime="2024-06-26T21:21:55+00:00">2024-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h1><p>用户的虚拟机内需要跑一个编译程序，该程序会调用到CPU 的AVX-512指令集。但是查看CPU信息，发现没有此指令集。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lscpu|grep avx</span><br></pre></td></tr></table></figure>

<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>从硬件层到操作系统层逐一分析：</p>
<ol>
<li>硬件层面不支持：此款CPU并没有AVX指令集；</li>
<li>虚拟化层不支持：虚拟化层Hypervisor屏蔽了AVX-512指令集；</li>
<li>系统层不支持：操作系统内没有安装AVX相关的Kernel支持包或者依赖库；</li>
</ol>
<h1 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h1><h2 id="原因一，硬件层的问题"><a href="#原因一，硬件层的问题" class="headerlink" title="原因一，硬件层的问题"></a>原因一，硬件层的问题</h2><p>检查此CPU是否支持AVX-512，可以去英特尔官网查询到相关信息；</p>
<h2 id="原因二，虚拟化层的问题"><a href="#原因二，虚拟化层的问题" class="headerlink" title="原因二，虚拟化层的问题"></a>原因二，虚拟化层的问题</h2><p>看看虚拟机版本是否过低，导致虚拟机无法使用AVX-512指令集。<br>本次有异常的虚拟机版本是11，而无异常的虚拟机版本是14；</p>
<h2 id="原因三，操作系统层的问题"><a href="#原因三，操作系统层的问题" class="headerlink" title="原因三，操作系统层的问题"></a>原因三，操作系统层的问题</h2><p>没有安装对应的依赖包，不过目前测试来看，在虚拟机版本为14、15的情况下，Ubuntu18.04、Ubuntu20.04、CentOS7、Windows Server 2019均是支持AVX-512指令集的，并不需要额外安装。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/94d3e50b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/94d3e50b/" class="post-title-link" itemprop="url">虚拟化环境不同存储类型的CrystalDiskMark测试记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-12 14:51:44" itemprop="dateCreated datePublished" datetime="2024-06-12T14:51:44+00:00">2024-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="测试环境描述"><a href="#测试环境描述" class="headerlink" title="测试环境描述"></a>测试环境描述</h1><p>硬件环境：</p>
<ul>
<li>底层存储类型：</li>
</ul>
<ol>
<li>SSD SAN</li>
<li>SSD DAS,RAID 1</li>
<li>NVMe SSD,PM9A1</li>
</ol>
<p>虚拟化层环境：<br>vSphere:6.7</p>
<p>测试机环境：</p>
<ul>
<li>OS：Windows Server 2019</li>
<li>配置：2C4G</li>
<li>测试软件：CrystalDiskMark</li>
</ul>
<h1 id="测试记录"><a href="#测试记录" class="headerlink" title="测试记录"></a>测试记录</h1><p>8G数据量，测试5次</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/2ceb2015/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/2ceb2015/" class="post-title-link" itemprop="url">待办事项列表</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-04 22:22:11" itemprop="dateCreated datePublished" datetime="2024-06-04T22:22:11+00:00">2024-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%8F%E6%8D%B7%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="index"><span itemprop="name">敏捷实践</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%8F%E6%8D%B7%E5%AE%9E%E8%B7%B5/%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E5%88%97%E8%A1%A8/" itemprop="url" rel="index"><span itemprop="name">待办事项列表</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="信息补充"><a href="#信息补充" class="headerlink" title="信息补充"></a>信息补充</h1><h2 id="VIM-常用配置"><a href="#VIM-常用配置" class="headerlink" title="VIM 常用配置"></a>VIM 常用配置</h2><p><a target="_blank" rel="noopener" href="https://feixia5712.github.io/mynote/linux/base/linux_vim/">https://feixia5712.github.io/mynote/linux/base/linux_vim/</a></p>
<h2 id="工具-，图吧工具箱"><a href="#工具-，图吧工具箱" class="headerlink" title="工具 ，图吧工具箱"></a>工具 ，图吧工具箱</h2><p><a target="_blank" rel="noopener" href="https://www.tbtool.cn/">https://www.tbtool.cn/</a></p>
<h2 id="数据保护"><a href="#数据保护" class="headerlink" title="数据保护"></a>数据保护</h2><p><a target="_blank" rel="noopener" href="https://sspai.com/post/39591">https://sspai.com/post/39591</a></p>
<h2 id="NAS公网发布"><a href="#NAS公网发布" class="headerlink" title="NAS公网发布"></a>NAS公网发布</h2><p><a target="_blank" rel="noopener" href="https://slarker.me/remote-nas/">https://slarker.me/remote-nas/</a></p>
<h2 id="NAS相关科普"><a href="#NAS相关科普" class="headerlink" title="NAS相关科普"></a>NAS相关科普</h2><p><a target="_blank" rel="noopener" href="https://wiki.mynas.chat/resource/search.html">https://wiki.mynas.chat/resource/search.html</a></p>
<h3 id="Meta-Tube"><a href="#Meta-Tube" class="headerlink" title="Meta Tube"></a>Meta Tube</h3><p><a target="_blank" rel="noopener" href="https://wiki.mynas.chat/unraid/javspider.html">https://wiki.mynas.chat/unraid/javspider.html</a><br><a target="_blank" rel="noopener" href="https://metatube-community.github.io/">https://metatube-community.github.io/</a></p>
<h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><p><a target="_blank" rel="noopener" href="https://blog.freessl.cn/ssl-cert-format-introduce/">https://blog.freessl.cn/ssl-cert-format-introduce/</a></p>
<h2 id="VMware-迁移虚拟机问题"><a href="#VMware-迁移虚拟机问题" class="headerlink" title="VMware-迁移虚拟机问题"></a>VMware-迁移虚拟机问题</h2><p><a target="_blank" rel="noopener" href="https://www.dinghui.org/currently-connected-network-interface-network-adapter-1-cannot-use-network-vm-network.html">https://www.dinghui.org/currently-connected-network-interface-network-adapter-1-cannot-use-network-vm-network.html</a></p>
<h2 id="VMware-无法分配许可"><a href="#VMware-无法分配许可" class="headerlink" title="VMware-无法分配许可"></a>VMware-无法分配许可</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_50926286/article/details/131974454">https://blog.csdn.net/weixin_50926286/article/details/131974454</a></p>
<h2 id="CrystalDiskMark-信息记录"><a href="#CrystalDiskMark-信息记录" class="headerlink" title="CrystalDiskMark 信息记录"></a>CrystalDiskMark 信息记录</h2><p>SAN、DAS RAID 1 、 NVMe SSD ，IOPS 、 throughput infomation .</p>
<h2 id="juiceFS-了解"><a href="#juiceFS-了解" class="headerlink" title="juiceFS 了解"></a>juiceFS 了解</h2><h2 id="SAN交换机"><a href="#SAN交换机" class="headerlink" title="SAN交换机"></a>SAN交换机</h2><h2 id="SAN-IO优化"><a href="#SAN-IO优化" class="headerlink" title="SAN IO优化"></a>SAN IO优化</h2><p><a target="_blank" rel="noopener" href="https://thinksystem.lenovofiles.com/storage/help/index.jsp?topic=/san_configuration_guide/6669452E-DF22-4B03-A658-FB69F57C466F_.html">https://thinksystem.lenovofiles.com/storage/help/index.jsp?topic=%2Fsan_configuration_guide%2F6669452E-DF22-4B03-A658-FB69F57C466F_.html</a><br><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2053145">https://knowledge.broadcom.com/external/article?legacyId=2053145</a></p>
<h2 id="dnsmasq-full-与-ipset"><a href="#dnsmasq-full-与-ipset" class="headerlink" title="dnsmasq-full 与 ipset"></a>dnsmasq-full 与 ipset</h2><p><a target="_blank" rel="noopener" href="https://bigeagle.me/2016/02/ipset-policy-routing/">https://bigeagle.me/2016/02/ipset-policy-routing/</a></p>
<h2 id="VMFS-卷，元数据检查"><a href="#VMFS-卷，元数据检查" class="headerlink" title="VMFS 卷，元数据检查"></a>VMFS 卷，元数据检查</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2036767">https://knowledge.broadcom.com/external/article?legacyId=2036767</a><br><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2145294">https://knowledge.broadcom.com/external/article?legacyId=2145294</a></p>
<h2 id="VMFS-卷，修复分区表"><a href="#VMFS-卷，修复分区表" class="headerlink" title="VMFS 卷，修复分区表"></a>VMFS 卷，修复分区表</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2103078">https://knowledge.broadcom.com/external/article?legacyId=2103078</a></p>
<h2 id="SAN-交换机"><a href="#SAN-交换机" class="headerlink" title="SAN 交换机"></a>SAN 交换机</h2><p><a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/zh-cn/000037925/emc34505-connectrix-b-%E7%B3%BB%E5%88%97-%E5%A6%82%E4%BD%95-%E8%A7%A3%E9%87%8A-brocade-porterrshow-%E8%BE%93%E5%87%BA-%E4%BB%A5%E5%8F%8A-%E8%AE%A1%E6%95%B0%E5%99%A8-%E7%9A%84-%E5%90%AB%E4%B9%89">https://www.dell.com/support/kbdoc/zh-cn/000037925/emc34505-connectrix-b-%E7%B3%BB%E5%88%97-%E5%A6%82%E4%BD%95-%E8%A7%A3%E9%87%8A-brocade-porterrshow-%E8%BE%93%E5%87%BA-%E4%BB%A5%E5%8F%8A-%E8%AE%A1%E6%95%B0%E5%99%A8-%E7%9A%84-%E5%90%AB%E4%B9%89</a><br><a target="_blank" rel="noopener" href="https://kb-cn.netapp.com/on-prem/Switches/Brocade-KBs/What_is_the_information_given_from_a_portErrShow_output_on_a_Brocade_switch">https://kb-cn.netapp.com/on-prem/Switches/Brocade-KBs/What_is_the_information_given_from_a_portErrShow_output_on_a_Brocade_switch</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/6fe6417f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/6fe6417f/" class="post-title-link" itemprop="url">【待补充完善】记录一次虚拟机故障-高系统CPU负载引发的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-22 00:24:17" itemprop="dateCreated datePublished" datetime="2024-05-22T00:24:17+00:00">2024-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>虚拟机A：32C512GB；<br>虚拟机B：32CC512GB；</p>
<p>虚拟机A与虚拟机B为集群，双A架构，每一个虚拟机配置两张网卡，一张为业务网络，第二张为存储网络；虚拟机A、虚拟机B此前通过NFS协议挂载一个存储设备C（存储设备C的NFS协议连接是通过第二张网卡访问的），后使用NFS协议挂载另外一个存储设备D（走的是业务网络）；从这个时间点开始，服务器可能就开始出现问题了：</p>
<ul>
<li>问题1 ： 经过更换挂载存储设备后，服务器会产生大量Log写进Messages，导致磁盘空间暴涨；</li>
<li>问题2 ： 经过2周后，开始做第二张存储网络断开操作；从这个时间点开始，虚拟机A、虚拟机B的 CPU Load开始上升；</li>
<li>问题3 ： 出现问题时，无法执行reboot指令，重启会终端；</li>
<li>问题4 ： 会经常出现CPU load上升，业务开始出现异常；</li>
<li>问题5 ： 高负载情况下，无法正常结束应用进程，使用kill -s 9 [PID] 均无法关闭；</li>
<li>问题6 ： 使用重启指令，可以在虚拟机的控制台看到 BUG ： Bad page stae in process swapper pfn :bb4e2;</li>
<li>问题7 ： 重启后，RAM负载接近100%，use态的内存使用量很高；</li>
<li>问题8 ： 虚拟机内的主要应用结束后，内存使用率依旧无法降低；</li>
</ul>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>当前原因还未分析出来，系统的message log已被清空；但从故障现象来看，至少可以肯定，OS的负载不正常，5分钟的平均负载超过100 ，已经超过32Core配置，为配置的3倍，则说明系统中有很多进程在等待CPU资源。<br>虚拟机有两张网卡，其中第一张网卡是用于业务访问，即业务网络；其中第二张网卡是用于访问NAS资源，即存储网络，虚拟机此前使用NFS挂载一个NAS资源，2周前做了变更，更改为另外一个NAS资源，而这个NAS使用的是业务网络；在故障时间点附近，将存储网络断开，预期内不应该有影响，但在操作的时间点附近又出现了业务异常。</p>
<p>已排查或已确认的资源点：</p>
<ol>
<li>虚拟机底层使用的存储无异常，虚拟化蹭可以看到在某一个时间点，瞬时延时达到400ms，但是虚拟机业务没有影响，业务侧反馈是正常的；</li>
<li>虚拟机挂载路径上面已经将旧NAS取消挂载2周，正常来说不应该有访问旧NAS路径；</li>
<li>虚拟机在两周前做了NAS存储变更，取消旧NAS的挂载，换为新NAS的挂载点，旧NAS显示还有连接；虚拟机上面也能看到存储网络与旧NAS有数据交互；</li>
</ol>
<h2 id="经验教训"><a href="#经验教训" class="headerlink" title="经验教训"></a>经验教训</h2><ol>
<li>对于业务方无法确认的业务，比如NAS取消挂载或者无法确定为什么中断NAS连接后，旧NAS还会有连接的问题，这种属于业务侧无法澄清的问题，应属于业务风险；因此在做变更的时候，不应该将所有节点做变更，应该逐个节点操作，等确认没有问题后，再做第二个节点；【时间间隔应该长一些】</li>
<li>做完存储网络断链后，业务侧没有全面检查，应该做一下更细致的检查；</li>
<li>没有日志分析的过程，系统的messages日志已无法做分析，应该保留最近2天的日志量，至少可以用作分析；</li>
<li>出现故障，优先看看内存负载情况；重启服务器后，内存应该会释放；主要应用关闭后，内存应该会释放；</li>
</ol>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>虚拟机需要执行关机；</li>
<li>关机后，从虚拟化层启动虚拟机；</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/8a2adfdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/8a2adfdb/" class="post-title-link" itemprop="url">SUSE-Linux网络配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-22 00:15:40" itemprop="dateCreated datePublished" datetime="2024-05-22T00:15:40+00:00">2024-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>包含SUSE Linux的网络配置、iptable配置。</p>
<h2 id="网卡编辑"><a href="#网卡编辑" class="headerlink" title="网卡编辑"></a>网卡编辑</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置IP</span></span><br><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network/</span><br><span class="line">vim ifcfg-eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#---配置文件ifcfg-eth0</span></span><br><span class="line">BOOTPROTO=<span class="string">&#x27;static&#x27;</span></span><br><span class="line">IPADDR=<span class="string">&#x27;192.168.1.1/24&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置网关</span></span><br><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network</span><br><span class="line">vim routes</span><br><span class="line"></span><br><span class="line"><span class="comment">#---配置文件routes</span></span><br><span class="line">default 192.168.1.254</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启网络服务</span></span><br><span class="line">rcnetwork restart</span><br></pre></td></tr></table></figure>

<h2 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h2><p>SUSE Linux的默认防火墙策略中写了很多策略，INPUT表中，默认是DROP；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清除iptable配置</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 INPUT 表的默认策略为ACCEPT</span></span><br><span class="line">iptables -P INPUT ACCEPT</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/cf3a31ba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/cf3a31ba/" class="post-title-link" itemprop="url">VMware-vMotion相关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-19 00:36:59" itemprop="dateCreated datePublished" datetime="2024-05-19T00:36:59+00:00">2024-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/vSphere/" itemprop="url" rel="index"><span itemprop="name">vSphere</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="vMotion-相关文章"><a href="#vMotion-相关文章" class="headerlink" title="vMotion 相关文章"></a>vMotion 相关文章</h1><h2 id="Powered-off-vMotion-relocate-of-a-large-virtual-machine-across-datastores-may-timeout-in-vCenter"><a href="#Powered-off-vMotion-relocate-of-a-large-virtual-machine-across-datastores-may-timeout-in-vCenter" class="headerlink" title="Powered-off vMotion (relocate) of a large virtual machine across datastores may timeout in vCenter"></a>Powered-off vMotion (relocate) of a large virtual machine across datastores may timeout in vCenter</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/318734/poweredoff-vmotion-relocate-of-a-large-v.html">https://knowledge.broadcom.com/external/article/318734/poweredoff-vmotion-relocate-of-a-large-v.html</a></p>
<h2 id="vMotion-同时迁移的限制"><a href="#vMotion-同时迁移的限制" class="headerlink" title="vMotion 同时迁移的限制"></a>vMotion 同时迁移的限制</h2><p><a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.vcenterhost.doc/GUID-25EA5833-03B5-4EDD-A167-87578B8009B3.html#GUID-25EA5833-03B5-4EDD-A167-87578B8009B3">https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vsphere.vcenterhost.doc/GUID-25EA5833-03B5-4EDD-A167-87578B8009B3.html#GUID-25EA5833-03B5-4EDD-A167-87578B8009B3</a></p>
<h2 id="Multiple-NIC-vMotion-in-vSphere"><a href="#Multiple-NIC-vMotion-in-vSphere" class="headerlink" title="Multiple-NIC vMotion in vSphere"></a>Multiple-NIC vMotion in vSphere</h2><p><a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article?legacyId=2007467">https://knowledge.broadcom.com/external/article?legacyId=2007467</a></p>
<h2 id="Troubleshooting-vMotion"><a href="#Troubleshooting-vMotion" class="headerlink" title="Troubleshooting vMotion"></a>Troubleshooting vMotion</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/09/troubleshooting-vmotion.html">https://blogs.vmware.com/vsphere/2019/09/troubleshooting-vmotion.html</a></p>
<h2 id="How-to-Tune-vMotion-for-Lower-Migration-Times"><a href="#How-to-Tune-vMotion-for-Lower-Migration-Times" class="headerlink" title="How to Tune vMotion for Lower Migration Times?"></a>How to Tune vMotion for Lower Migration Times?</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/09/how-to-tune-vmotion-for-lower-migration-times.html">https://blogs.vmware.com/vsphere/2019/09/how-to-tune-vmotion-for-lower-migration-times.html</a></p>
<h2 id="How-is-Virtual-Memory-Translated-to-Physical-Memory"><a href="#How-is-Virtual-Memory-Translated-to-Physical-Memory" class="headerlink" title="How is Virtual Memory Translated to Physical Memory?"></a>How is Virtual Memory Translated to Physical Memory?</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/03/how-is-virtual-memory-translated-to-physical-memory.html">https://blogs.vmware.com/vsphere/2020/03/how-is-virtual-memory-translated-to-physical-memory.html</a></p>
<h2 id="The-vMotion-Process-Under-the-Hood"><a href="#The-vMotion-Process-Under-the-Hood" class="headerlink" title="The vMotion Process Under the Hood"></a>The vMotion Process Under the Hood</h2><p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2019/07/the-vmotion-process-under-the-hood.html">https://blogs.vmware.com/vsphere/2019/07/the-vmotion-process-under-the-hood.html</a></p>
<h2 id="vSphere-7-vMotion-Enhancements"><a href="#vSphere-7-vMotion-Enhancements" class="headerlink" title="vSphere 7 - vMotion Enhancements"></a>vSphere 7 - vMotion Enhancements</h2><p>The vSphere vMotion feature enables customers to live-migrate workloads from source to destination ESXi hosts. Over time, we have developed vMotion to support new technologies. The vSphere 7 release is no exception to that, as we greatly improved the vMotion feature. The vMotion enhancements in vSphere 7 include a reduced performance impact during the live-migration and a reduced stun time. This blog post will go into details on how the vMotion improvements help customers to be comfortable using vMotion for large workloads.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vmotion-history-2048x463.png" alt="vMotion发展"></p>
<p>To understand what we improved for vMotion in vSphere 7, it is imperative to understand the vMotion internals. Read the vMotion Process Under the Hood to learn more about the vMotion process itself.</p>
<h3 id="Large-VM-vMotion-Challenges"><a href="#Large-VM-vMotion-Challenges" class="headerlink" title="Large VM vMotion Challenges"></a>Large VM vMotion Challenges</h3><p>vSphere is the perfect platform to host large virtual machines (VMs) — also referred to as “Monster” VMs — with the current per VM resource maximums set to 256 vCPU’s and 6 TB of memory. However, we noticed that customers running workloads in large VMs were not always comfortable live-migrating these VMs. That was due to a potential impact on workload performance during the vMotion process, and a switch-over (stun) time that took too long.</p>
<p>For example, large transactional database platforms that are dealing with a substantial number of I&#x2F;Os could experience performance degradation during a vMotion, although the precise impact strongly depends on the workload’s characteristics &amp; sizing. The enhanced logic for vMotion in vSphere 7 overcomes all these challenges and allows us to live-migrate large workloads without significant impact on performance or availability.</p>
<h3 id="Memory-Pre-copy-Optimizations"><a href="#Memory-Pre-copy-Optimizations" class="headerlink" title="Memory Pre-copy Optimizations"></a>Memory Pre-copy Optimizations</h3><p>As explained in this video, we need to keep track of all the changed memory pages for a VM during its vMotion operation. Because it is a live-migration, the guest OS inside the VM will keep writing data to memory during the vMotion. We need to track and resend memory pages that are overwritten during a vMotion.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vMotion-page-trace-v2-old.png" alt="vMotion "></p>
<p>The vMotion process installs a page tracer on all the vCPUs that are configured for the VM. By doing so, vMotion understands what memory pages are being overwritten. This is referred to as a ‘page fire’ during page tracing. We are distributing the tracing work to all the vCPU’s for the VM that is live-migrated.</p>
<p>To install the page tracer and to process a page fire, the vCPUs are briefly stopped. It’s only microseconds, but stopping all vCPUs disrupts the workload. Scaling up the compute resources of a VM increases the impact of a vMotion operation. After stopping the vCPUs for the tracing work, all memory Page Table Entries (PTE) are set to read-only, and the Translation Lookaside Buffers (TLB) are flushed to avoid TLB hits and force a page table walk so the vMotion process fully understands what memory pages have been overwritten. Learn more on these memory constructs in this blog</p>
<h3 id="How-we-do-it-in-vSphere-7"><a href="#How-we-do-it-in-vSphere-7" class="headerlink" title="How we do it in vSphere 7"></a>How we do it in vSphere 7</h3><p>The biggest impact comes from having to stop all the vCPUs for page tracing. What if we can install the page tracers without the need to stop all vCPUs? With vSphere 7, we are introducing the “Loose Page Trace Install.” The method for page tracing mostly remains the same but instead of using all vCPUs, we now only claim one vCPU to perform all the tracing work. All the other vCPUs that are entitled to the VM just continue to run the workload without interruption.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vMotion-page-trace-v2-new.png" alt="vSphere 7 vmotion"></p>
<h3 id="Page-Table-Granularity"><a href="#Page-Table-Granularity" class="headerlink" title="Page Table Granularity"></a>Page Table Granularity</h3><p>So we reduced the cost of tracing, but what if we can make it even more efficient? We optimized the way we set memory to read-only, meaning there’s less work to be done on this part. Less work means increased efficiency. The way memory is set to read-only prior to vSphere 7 is on a 4KB page granularity. All the individual 4KB pages needed to be set to read-only access.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/pagetableoverviewv2.png" alt="Page"></p>
<p>As of vSphere 7, the Virtual Machine Monitor (VMM) process will set the read-only flag at a much larger granularity, on 1GB pages. If a page fire (a memory page is overwritten) occurs, the 1GB PTE is broken down into 2MB and 4KB pages. VMware engineers have seen that a VM is typically not touching all of its memory during a vMotion process. The memory working set size during a vMotion is typically only 10-30%. If more memory is used during the vMotion time, the cost efficiency will be less.</p>
<h3 id="Switch-over-Phase-Enhancements"><a href="#Switch-over-Phase-Enhancements" class="headerlink" title="Switch-over Phase Enhancements"></a>Switch-over Phase Enhancements</h3><p>All the enhancements we have discussed so far are done in the memory pre-copy phase, where the tracing happens. Once we reach memory convergence, meaning almost all memory is copied to the destination host, vMotion is ready to switch-over to the destination ESXi host. In this last phase, the VM on the source ESXi host is suspended and the checkpoint data is sent to the destination host. Remember that we want the switch-over time (stun time) to be 1 second or less. For large VMs, this has become a challenge because of workload sizes that have increased over time.</p>
<p>In the switch-over phase, we send over the checkpoint data and the memory bitmap. The memory bitmap is used to track all the memory of a VM. It know what pages are overwritten and still need to be transmitted the destination ESXi host. As vMotion transfers the last memory pages, the VM on the destination host begins to power on. But it might still need the last pages left for transmission. To identity these pages on the destination, we use the bitmap that is transferred from the source. If customers overcommit memory, the swapped-out pages are tracked in the optional swap bitmap.</p>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/fullbitmapv2.png" alt="full bitmap"></p>
<h3 id="How-vSphere-7-does-it"><a href="#How-vSphere-7-does-it" class="headerlink" title="How vSphere 7 does it"></a>How vSphere 7 does it</h3><p>With VMs running 6TB of memory (or potentially even more in the future), the bitmap is already 192MB. To stay under 1 sec of switch-over time, we need the bitmap to be smaller as sending over 192MB could take up to a second or more. What if we could compact the bitmap, and only send over the information that you really need?</p>
<p><img src="http://blogs.vmware.com/vsphere/files/2020/03/compactedbitmapv2.png" alt="vSphere 7 compacted bitmap"></p>
<p>At this stage we have already copied most of the memory pages, so only the last remaining memory pages need to be sent. Using a compacted memory bitmap, vMotion is able to send bitmaps for large VMs over in milliseconds, drastically lowering the stun time.</p>
<h3 id="Performance-Improvements"><a href="#Performance-Improvements" class="headerlink" title="Performance Improvements"></a>Performance Improvements</h3><p>These enhancements to vMotion in vSphere 7 allow workloads to be live-migrated with almost no performance degradation during a vMotion. The following diagram is an example of a test to show you the potential performance gains in vSphere 7. The testbed is a large VM (72 vCPU &#x2F; 512GB) running a HammerDB workload. We monitor the commits&#x2F;sec over a timeline with a 1 second granularity.</p>
<p>A couple of key takeaways that we noticed during this test in vSphere 7, compared to vSphere 6.7, are:</p>
<ul>
<li>We no longer experience the performance impact during the page trace phase.</li>
<li>The stun time remains within 1 second instead of taking multiple seconds.</li>
<li>The overall live-migration time is almost 20 seconds shorter.</li>
</ul>
<p><img src="https://blogs.vmware.com/vsphere/files/2020/03/vmotion7-improvements.png" alt="vSphere6.7 vSphere7 "></p>
<p>Your mileage may vary depending on vMotion network configurations and VM sizing, but this is an exemplary test to show the potential benefits of these vMotion improvements.</p>
<h3 id="To-Conclude"><a href="#To-Conclude" class="headerlink" title="To Conclude"></a>To Conclude</h3><p>The improvements made in vMotion with vSphere 7 are enormous and greatly reduce the cost paid for a vMotion. You don’t need to anything to enjoy the new and improved vMotion logic, other than to upgrade your systems to vSphere 7.</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/03/vsphere-7-vmotion-enhancements.html">https://blogs.vmware.com/vsphere/2020/03/vsphere-7-vmotion-enhancements.html</a></p>
<h2 id="vSphere-7-Storage-vMotion-Improvements"><a href="#vSphere-7-Storage-vMotion-Improvements" class="headerlink" title="vSphere-7-Storage vMotion Improvements"></a>vSphere-7-Storage vMotion Improvements</h2><p>参考： </p>
<p><a target="_blank" rel="noopener" href="https://blogs.vmware.com/vsphere/2020/06/vsphere-7-storage-vmotion-improvements.html">https://blogs.vmware.com/vsphere/2020/06/vsphere-7-storage-vmotion-improvements.html</a></p>
<h2 id="ESXi提升vMotion速率-，-vMotion的属性设置"><a href="#ESXi提升vMotion速率-，-vMotion的属性设置" class="headerlink" title="ESXi提升vMotion速率 ， vMotion的属性设置"></a>ESXi提升vMotion速率 ， vMotion的属性设置</h2><p>Here’s the situation I was facing. Two Vmware vCenter 7.0.3. clusters on opposite sides of the country, connected via a a 10gig point to point ethernet circuit, and that circuit tends to have a bit of packet loss (0.5%-1%) under heavy utilization. Being cross country, it of course also has latency, typically in 55ms RTT range.</p>
<p>Vmware supports long distance vMotion. They claim you can do it with latency as high as 150ms. I found that to be the case, but whether a zero-loss site to site VPN across the internet, or across this high speed point to point link, I was never able to get vMotion to average more than a few hundred megabits. That is of course complete garbage if you’re trying to move terabytes of VM’s without downtime. If they’re frequently changing, and the rate of change exceeds the speed at which you can move data, you may even find vMotion impossible to use.</p>
<p>I found the above was due to the packet loss. I’ve done the same tests across a proper 10gig wave between locations, with the same latency but without the lossiness. On those I’d see a gigabit or two, but still far from full utilization. I suspect I could get that up to several gigabits after what I’ve learned and will share here, I just didn’t go back to test.</p>
<p>The cause of the problem is the vMotion (hot migrations) and provisioning (cold migrations) network stacks are based on decades out-of-date TCP configurations. They use a choice of two ancient congestion control algorithms, New Reno or Cubic, and both of those treat loss as congestion. When they see loss, they overreact and greatly reduce the TCP window size, causing your throughput to nosedive, then they take an excruciatingly long time to open it back up, and chances are another bit of loss will occur, compounding the issue.</p>
<p>Across this same lossy link, I did testing between two linux nodes set to use the BBR congestion control algorithm, and some other minor tuning I found at <a target="_blank" rel="noopener" href="https://fasterdata.es.net/host-tuning/linux/test-measurement-host-tuning/">https://fasterdata.es.net/host-tuning/linux/test-measurement-host-tuning/</a>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.core.rmem_max = 134217728</span><br><span class="line">net.core.wmem_max = 134217728</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br></pre></td></tr></table></figure>

<p>With that config in place, I can frequently push 7+ Gbps with a single TCP session, where with the default linux congestion control of cubic, and default settings, I’d be lucky to average more than a gigabit.</p>
<p>Vmware doesn’t allow you to tinker with congestion control or windowing &#x2F; buffer settings. So my workarounds for this were focused mostly on multi-stream vmotion, after reading pages like these:</p>
<p><a target="_blank" rel="noopener" href="https://core.vmware.com/resource/how-tune-vmotion-lower-migration-times#section1">https://core.vmware.com/resource/how-tune-vmotion-lower-migration-times#section1</a><br><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/2007467">https://kb.vmware.com/s/article/2007467</a><br>I tinkered extensively with the number of vmotion vmkernel ports defined, and custom values in the following settings:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Migrate.NetExpectedLineRateMBps</span><br><span class="line">Migrate.VMotionStreamHelpers</span><br><span class="line">Net.TcpipRxDispatchQueues</span><br><span class="line">Migrate.BindToVmknic</span><br></pre></td></tr></table></figure>

<p>I probably went through about 30 permutations of settings, and the one that I finally arrived at was:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Two target vmkernel ports</span><br><span class="line">Five <span class="built_in">source</span> vmkernel ports</span><br><span class="line"></span><br><span class="line">Migrate.NetExpectedLineRateMBps = 2000</span><br><span class="line">Net.TcpipRxDispatchQueues = 5</span><br><span class="line">Migrate.BindToVmknic = 2</span><br><span class="line">Migrate.VMotionStreamHelpers = 48</span><br></pre></td></tr></table></figure>

<p>I know that sounds kind of insane to have 48 stream helpers, but I went all the way to 64 in +8 jumps and 48 had the highest throughput for my 16 pCore source vMotion server. With the above config, 55ms 10gig circuit with ~1% loss, I was able to do cross country live vmotions of both VM state and storage at upwards of 2.4 Gbps. I did start out with more vmkernel ports on the target, but for whatever reason, while this config allows for 48 TCP sessions spread evenly across the five source vmkernel ports, they’d still only target two unique IP addresses, so the other three served no purpose.</p>
<p>This above config is also particularly useful if you have a Cogent point to point &#x2F; metroE circuit between locations, because those are often rate limited to around 2 gbps per TCP session even if you’re paying for a full 10gig circuit. Since vMotion spreads the flows evenly across all the TCP sessions, this will let you better utilize the link with no one session hitting the rate limit and being throttled.</p>
<p>Next up, I found a second way to get around this issue which could be of interest to those who want more of a bandaid fix to evacuate one cluster for another; i.e. not permanent. I happened across this reddit thread where u&#x2F;LatinSuD reported having similar issues solved by the use of socat to proxy the TCP session to the remote host. This was intriguing for me because I know my lossy link, in the hands of a modern TCP tuning, is capable of nearly wire speed. I tested it out and it worked. With only crude tuning, I was able to achieve 4 Gbps of vMotion between the same hosts and across the same link, where I could only get 2.4 Gbps with native tuning options. There’s probably more to go too if socat were running on a more modern system, but I have it on an old four core Xeon E3-1225 dating to 2011, so truly ancient hardware. The system has a Mellanox Connect-X 3 10gig NIC.</p>
<p>Here was my config:</p>
<p>Source ESXi host vmotion vmkernel interface: 10.88.0.9&#x2F;24<br>Source ESXi host vmotion network default gateway override: 10.88.0.1<br>Target ESXi host vmotion vmkernel interface: 10.99.0.9&#x2F;24<br>socat proxy linux system vmotion interface: 10.88.0.1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">One target vmkernel port</span><br><span class="line">One <span class="built_in">source</span> vmkernel port</span><br><span class="line"></span><br><span class="line">Migrate.NetExpectedLineRateMBps = 2000</span><br><span class="line">Net.TcpipRxDispatchQueues = 5</span><br><span class="line">Migrate.BindToVmknic = 2</span><br><span class="line">Migrate.VMotionStreamHelpers = 5</span><br></pre></td></tr></table></figure>

<p>The above config results in the source vmotion server wanting to talk to port 8000 on the target 10.99.0.9. However, since it’s been given a default gateway (you could also add a custom static route if needed) of the socat server, it’s going to send its packets to that system regardless.</p>
<p>On the socat server, I alter the packets with a destination NAT rule so it delivers those packets to itself instead of discarding or attempting to route them (if forwarding were enabled):</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -p tcp -d 10.99.0.9 --dport 8000 -j DNAT --to-destination 10.88.0.1:8000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>I also have the earlier sysctl settings in place, and most importantly, BBR congestion control:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">net.core.rmem_max = 134217728</span><br><span class="line">net.core.wmem_max = 134217728</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br></pre></td></tr></table></figure>

<p>Make sure no CPU throttling as socat is cpu-bound:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpupower frequency-set -g performance</span><br></pre></td></tr></table></figure>

<p>Now start socat up to forward the received packets to the vmotion target:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:8000,fork,reuseaddr,<span class="built_in">bind</span>=10.88.0.1 TCP4:10.99.0.9:8000</span><br></pre></td></tr></table></figure>

<p>With the above config, the source vmotion server will use five TCP sessions. Its packets are intercepted by the socat server, rewritten to have a target of the local interface IP, socat is listening and accepts them, five socat children are spawned and connected to the target vmotion interface. It then forwards them as part of a new proxied TCP session to the target vmotion interface. Because of the proxying, the TCP conversation between source and socat occur on the local fast and non-lossy network, and the TCP conversation between the socat server and the target vmotion uses the BBR algorithm and a tuned TCP stack to achieve massively improved throughput. Like I said, old server with a 12 year old CPU and many years old NIC, still saw 4+ Gbps on this lossy link.<br><a target="_blank" rel="noopener" href="https://www.ispcolohost.com/2023/10/02/speeding-up-long-distance-vmotion/">https://www.ispcolohost.com/2023/10/02/speeding-up-long-distance-vmotion/</a></p>
<h3 id="ESXi-属性信息"><a href="#ESXi-属性信息" class="headerlink" title="ESXi 属性信息"></a>ESXi 属性信息</h3><p><a href="https://github.com/lamw/esxi-advanced-and-kernel-settings/blob/master/esxi-80a-advanced-settings.md">https://github.com/lamw/esxi-advanced-and-kernel-settings/blob/master/esxi-80a-advanced-settings.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/cf950940/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/cf950940/" class="post-title-link" itemprop="url">油猴JavaScript脚本-B站牧场物语弹幕需求</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-05 00:21:04" itemprop="dateCreated datePublished" datetime="2024-05-05T00:21:04+00:00">2024-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>B站有一个弹幕游戏，叫牧场物语，可以通过弹幕来进行喂鸡、收货、寻宝等动作；于是就想做一个自动点击操作的脚本；现有的技术能力有两种：</p>
<ol>
<li>python+selenium；</li>
<li>JavaScript+油猴插件；</li>
</ol>
<p>方案1已经挑战过了，现在来试试方案2；</p>
<h1 id="代码记录"><a href="#代码记录" class="headerlink" title="代码记录"></a>代码记录</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         牧场物语-喂食-收取-寻宝一条龙</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      2024-05-04</span></span><br><span class="line"><span class="comment">// @description  try to take over the world!</span></span><br><span class="line"><span class="comment">// @author       You</span></span><br><span class="line"><span class="comment">// @match        https://live.bilibili.com/21510733?live_from=84001&amp;spm_id_from=333.337.search-card.all.click</span></span><br><span class="line"><span class="comment">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;【TESTING！！】Start to handle script.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> timer;</span><br><span class="line">    <span class="comment">//timer =setInterval(function()&#123; var lock = getlock(); if(lock == 0)&#123;setval();clearInterval(timer)&#125; &#125;,500)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Global VAR</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">delay</span>(<span class="params">x</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">111</span>);</span><br><span class="line">                <span class="title function_">resolve</span>(x);</span><br><span class="line">            &#125;,<span class="number">2000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">WS</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to WS&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;喂食&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;Aqua&quot;</span>;</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]WS completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">SQ</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to SQ&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;收取&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;Lime&quot;</span>;</span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]SQ completed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">XB</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to XB&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var DM=document.querySelector(&quot;textarea&quot;);</span></span><br><span class="line">        <span class="comment">//DM.click();</span></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;寻宝&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var SENDB=document.querySelectorAll(&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;)[0];</span></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">            <span class="comment">//DM.value=&quot;寻宝&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]XB completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">DY</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]Ready to XB&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">DM</span>=<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;textarea&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">SENDBUTTON</span>=<span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var DM=document.querySelector(&quot;textarea&quot;);</span></span><br><span class="line">        <span class="comment">//DM.click();</span></span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="property">value</span>=<span class="string">&quot;d1&quot;</span>;</span><br><span class="line">        <span class="variable constant_">DM</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//var SENDB=document.querySelectorAll(&quot;button[class=&#x27;bl-button live-skin-highlight-button-bg live-skin-button-text bl-button--primary bl-button--small&#x27;]&quot;)[0];</span></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;yellow&quot;</span>;</span><br><span class="line">            <span class="comment">//DM.value=&quot;寻宝&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable constant_">SENDBUTTON</span>.<span class="title function_">click</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Script Work]XB completed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">WS</span>,<span class="number">2000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">SQ</span>,<span class="number">8000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="variable constant_">XB</span>,<span class="number">18000</span>);</span><br><span class="line">    <span class="comment">//setTimeout(DY,18000);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//200s</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123; location.<span class="title function_">reload</span>();&#125;,<span class="number">202000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h2 id="注意点，注意坑！"><a href="#注意点，注意坑！" class="headerlink" title="注意点，注意坑！"></a>注意点，注意坑！</h2><ol>
<li>查找元素的方法为 dom 对象以及其对应的方法，比如 document.querySelector(“标签或者元素”)；</li>
<li>注意大小写！JavaScript是区分大小写的，这个与powershell脚本不同；</li>
<li>DOM的querySelectorAll方法，返回的是数组，所以需要引用该数组对象的第一个；</li>
<li>setTimeout延时函数有毒，是异步执行的，所以写延时函数需要注意网页加载时间；</li>
<li>匿名函数表示方法 ()&#x3D;&gt;{} ;</li>
<li>页面刷新 location.reload();</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/de3b0569/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/de3b0569/" class="post-title-link" itemprop="url">HPE-SAN存储热备盘比例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-04 23:39:36" itemprop="dateCreated datePublished" datetime="2024-05-04T23:39:36+00:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/SAN%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">SAN存储</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h1><p>做SAN存储扩容时，需要供应商做扩容方案。对应的硬件所堆积出来的硬件可用容量到底怎么计算的？这里面有几个问题：</p>
<ol>
<li>裸容量是多少？</li>
<li>可用容量是多少？</li>
<li>热备盘比例是多少？</li>
</ol>
<h1 id="可查资料"><a href="#可查资料" class="headerlink" title="可查资料"></a>可查资料</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Spare rate</span><br><span class="line">A key parameter in the spare policy is the spare rate. The spare rate is a target amount of space to set aside for sparing expressed relative to the number of disks of a given type in the system. A spare rate of 24, for example, sets target spare space equal to the size of one drive for every 24 drives in the array.</span><br><span class="line">The spare rate is defined based on the hardware configuration in the array as follows:</span><br><span class="line">• Spare rate = 40 if there are any magazines present in the array (e.g., 10,000)</span><br><span class="line">• Spare rate = 24 for all others such as 7400/7400c, 7450/7450c, etc.</span><br><span class="line"></span><br><span class="line">Sparing algorithms defined</span><br><span class="line">The spare option is set for the entire array and applied to each disk type (SSD, FC, NL) in the following way.</span><br><span class="line">• Default: Roughly 2.5 percent with minimums</span><br><span class="line">Small configurations (e.g., 7000’s with less than 48 disks, 10000’s with less than 80 disks) have a spare space target equal to the size of two of the largest drives of the type being spared.</span><br><span class="line">• Minimal: Roughly 2.5 percent without minimums</span><br><span class="line">Minimal is the same as default except for small configurations. When the configuration is small, minimal will only set aside spare space equal to one of the largest drives (compared to two for default) of the type being sized.</span><br><span class="line">• Maximal: One disk’s worth in every cage</span><br><span class="line">Spare space is calculated as the space of the largest drive of the drive type being sized for each disk cage.</span><br><span class="line">• Custom: Implemented manually by the administrator using the createspare, showspare, and removespare commands.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认比例为 2.5%；最大比例为 12%；</p>
</blockquote>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://community.hpe.com/t5/hpe-3par-storserv-storage/check-spare-capacity-on-disk-driver/td-p/7085333">https://community.hpe.com/t5/hpe-3par-storserv-storage/check-spare-capacity-on-disk-driver/td-p/7085333</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
