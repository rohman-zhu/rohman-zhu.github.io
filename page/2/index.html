<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/2/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">454</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">150</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/9e6ffec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/9e6ffec/" class="post-title-link" itemprop="url">Windows客户端加域后没有产生DNS记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-18 16:18:57" itemprop="dateCreated datePublished" datetime="2025-06-18T16:18:57+00:00">2025-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 09:12:37" itemprop="dateModified" datetime="2025-06-22T09:12:37+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>一些已经加域的客户端，该客户端的主机名无法通过DNS解析到IP；但客户端的加域状态是正常的。</p>
<p>例如：客户端的主机名为 client-demo.domain.com</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping 无法解析目标地址</span></span><br><span class="line">ping client<span class="literal">-demo</span>.domain.com</span><br><span class="line"><span class="comment"># nslookup 无法解析目标地址</span></span><br><span class="line">nslookup client<span class="literal">-demo</span>.domain.com</span><br></pre></td></tr></table></figure>

<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>DNS 注册失效：可能因为网络延迟 或者 服务同步问题导致。</p>
<p>另一个关键的组策略是“注册刷新间隔”：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">指定 DNS 客户端刷新 A 资源注册和 PTR 资源注册所用的间隔。此策略设置仅适用于执行动态 DNS 更新的 DNS 客户端。</span><br><span class="line"></span><br><span class="line">配置为执行 A 资源记录和 PTR 资源记录的动态 DNS 注册的 DNS 客户端，会向 DNS 服务器定期注册其记录，即使记录未发生更改也是如此。如果 DNS 服务器配置为删除过时记录，且需要向 DNS 服务器表明记录是最新记录而且不应被自动删除(清理)，就必须进行这种注册。</span><br><span class="line"></span><br><span class="line">警告: 如果 DNS 区域中启用记录清理，则此策略设置的值不应长于该区域刷新间隔的值。将注册刷新间隔配置为长于 DNS 区域的刷新间隔将导致删除不该删除的 A 资源记录和 PTR 资源记录。</span><br><span class="line"></span><br><span class="line">若要指定注册刷新间隔，请单击“已启用”，然后输入 1800 或是一个更大值。指定的值是与注册刷新间隔所对应的秒数。例如，1800 秒表示注册刷新间隔为 30 分钟。</span><br><span class="line"></span><br><span class="line">如果启用此策略设置，则指定的注册刷新间隔会应用到接收此策略设置的 DNS 客户端所使用的所有网络连接。</span><br><span class="line"></span><br><span class="line">如果禁用或未配置此策略设置，则 DNS 客户端将使用由本地或 DHCP 提供的设置。默认情况下，使用静态 IP 地址配置的 DNS 客户端会尝试每隔 24 小时更新一次其 DNS 资源记录，而 DHCP 客户端会尝试在授予或续订一个 DHCP 租约后更新其 DNS 资源记录。</span><br></pre></td></tr></table></figure>

<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ol>
<li>重启目标客户端：在重启完成后，DNS也会重新发起注册；</li>
<li>手动发起更新</li>
</ol>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键指令</span></span><br><span class="line">ipconfig /registerdns</span><br><span class="line"><span class="comment"># 关键服务</span></span><br><span class="line">net stop dnscache &amp;&amp; net <span class="built_in">start</span> dnscache</span><br></pre></td></tr></table></figure>

<p>WINRM可以远程到目标服务器，而主机名记录无法解析，可以使用这个脚本,统一刷新一下：</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$global_subnet</span>=<span class="string">&quot;192.168.1.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># WINRM</span></span><br><span class="line"><span class="variable">$global_winrm_port</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="variable">$global_winrm_credential</span>=<span class="built_in">Get-Credential</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="number">255</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> <span class="variable">$global_subnet</span><span class="variable">$i</span> <span class="literal">-Port</span> <span class="variable">$global_winrm_port</span> <span class="literal">-Credential</span> <span class="variable">$global_winrm_credential</span> <span class="literal">-ScriptBlock</span>&#123;ipconfig /registerdns&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新一下本地DNS解析</span></span><br><span class="line">ipconfig /flushdns</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/4b4db2fa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/4b4db2fa/" class="post-title-link" itemprop="url">Python脚本实例-HorizonView_API调用过程[未补完]</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 15:10:54 / Modified: 17:00:52" itemprop="dateCreated datePublished" datetime="2025-06-17T15:10:54+00:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><p>需要使用REST API去实现VDI的自动授权。</p>
<h1 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h1><p>VMware Horizon View 其实提供了丰富的API接口，也有一个很好的GUI界面可供调试。</p>
<blockquote>
<p>htttps:&#x2F;&#x2F;<Connection Server IP>&#x2F;rest&#x2F;swagger-ui&#x2F;index.html#&#x2F;</p>
</blockquote>
<p>通过此界面可以了解到各个功能的调用方法与参数内容；</p>
<h2 id="Python-模块"><a href="#Python-模块" class="headerlink" title="Python 模块"></a>Python 模块</h2><p>本次脚本需要的模块有 requests , urllib3 , json , jsonpath_ng ;<br>数据处理有 parse , defaultdict;</p>
<h3 id="关键的第一步：获取认证用的Token"><a href="#关键的第一步：获取认证用的Token" class="headerlink" title="关键的第一步：获取认证用的Token"></a>关键的第一步：获取认证用的Token</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URI：https://&#123;api_host&#125;/rest/login</span><br></pre></td></tr></table></figure>

<p>Request Body , 这3个值都是必需的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AD-TEST-DOMAIN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;&lt;password&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Administrator&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>正确请求会返回 200 代码，以及access_token ，这个access_token 已经是 jwt形式的；</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;jwt.access.token&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;jwt.refresh.token&gt;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="组成一个可用的Python脚本"><a href="#组成一个可用的Python脚本" class="headerlink" title="组成一个可用的Python脚本"></a>组成一个可用的Python脚本</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> jsonpath_ng</span><br><span class="line"><span class="keyword">from</span> jsonpath_ng <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭SSL认证告警</span></span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Global variables</span></span><br><span class="line">global_connection_server=<span class="string">&quot;&quot;</span></span><br><span class="line">global_cs_admin_name=<span class="string">&quot;&quot;</span></span><br><span class="line">global_cs_admin_password=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Base variables</span></span><br><span class="line">headers=&#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">base_url=<span class="string">&quot;https://&quot;</span>+global_connection_server</span><br><span class="line">user_key=&#123;</span><br><span class="line">  <span class="string">&quot;domain&quot;</span>:XXX,</span><br><span class="line">  <span class="string">&quot;passowrd&quot;</span>:XXX,</span><br><span class="line">  <span class="string">&quot;username&quot;</span>:XXX</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Login request</span></span><br><span class="line">login_api = <span class="string">&quot;/rest/login&quot;</span></span><br><span class="line">url_login_api = base_url+login_api</span><br><span class="line">response = requests.post(url_login_api,headers=headers,json=user_key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Status code:&quot;</span>,response.status_code)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Json response:&quot;</span>,response.json())</span><br><span class="line"></span><br><span class="line"><span class="comment">## Insert Authorization Token</span></span><br><span class="line">temp_access_token = response.json()[<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line">temp_headers_token = &#123;<span class="string">&quot;Authorization&quot;</span>:<span class="string">&quot;Bearer&quot;</span>+temp_access_token&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get Desktop Pool</span></span><br><span class="line">get_desktop_pools_api = <span class="string">&quot;/rest/inventory/v1/desktop-pools&quot;</span></span><br><span class="line">url_get_desktop_pools_api = base_url+get_desktop_pools_api</span><br><span class="line">response = requests.get(url_get_desktop_pools_api,headers=temp_headers_token,verify=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Status code:&quot;</span>,response.status_code)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Json response:&quot;</span>,response.json())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Select Target Desktop Pool</span></span><br><span class="line"><span class="comment"># TODO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show machine of target desktop pools</span></span><br><span class="line"><span class="comment"># TODO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Show machine of target desktop pools and more detail</span></span><br><span class="line"><span class="comment"># TODO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Assign user to target machine</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li>VMware 官方API资料（楼主实测得出“不全面”的结论，实际还是要看swagger-ui里面）：<a target="_blank" rel="noopener" href="https://developer.broadcom.com/xapis/vmware-horizon-server-api/latest/">https://developer.broadcom.com/xapis/vmware-horizon-server-api/latest/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/2b74867a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/2b74867a/" class="post-title-link" itemprop="url">WSL常用指令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-07 12:33:30 / Modified: 13:52:49" itemprop="dateCreated datePublished" datetime="2025-06-07T12:33:30+00:00">2025-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WSL-介绍"><a href="#WSL-介绍" class="headerlink" title="WSL 介绍"></a>WSL 介绍</h1><p>开发人员可以在 Windows 计算机上同时访问 Windows 和 Linux 的强大功能。 通过适用于 Linux 的 Windows 子系统 (WSL)，开发人员可以安装 Linux 发行版（例如 Ubuntu、OpenSUSE、Kali、Debian、Arch Linux 等），并直接在 Windows 上使用 Linux 应用程序、实用程序和 Bash 命令行工具，不用进行任何修改，也无需承担传统虚拟机或双启动设置的费用。</p>
<h2 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级WSL至WSL2</span></span><br><span class="line">wsl <span class="literal">--install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查子系统的版本</span></span><br><span class="line">wsl <span class="literal">-l</span> <span class="literal">-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查可用的 Linux</span></span><br><span class="line">wsl <span class="literal">--list</span> <span class="literal">--online</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装  LINUX</span></span><br><span class="line">wsl <span class="literal">--install</span> Ubuntu<span class="literal">-22</span>.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 销毁</span></span><br><span class="line">wsl <span class="literal">--unregister</span> [名称]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/wsl/install">https://learn.microsoft.com/zh-cn/windows/wsl/install</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/419d16d2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/419d16d2/" class="post-title-link" itemprop="url">ls</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-07 11:48:44" itemprop="dateCreated datePublished" datetime="2025-06-07T11:48:44+00:00">2025-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/31e9de8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/31e9de8/" class="post-title-link" itemprop="url">vbs脚本实例-NumberLock按键脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-07 10:43:20 / Modified: 11:37:30" itemprop="dateCreated datePublished" datetime="2025-06-07T10:43:20+00:00">2025-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>操纵vbs脚本去点击 NumberLock 键盘；</p>
<h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><p>间隔 interval 秒后，点击 NUM LOCK 键。</p>
<figure class="highlight vbs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Dim</span> interval</span><br><span class="line">interval = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span> - <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Set</span> wshShell = WScript.<span class="built_in">CreateObject</span>(<span class="string">&quot;WScript.Shell&quot;</span>)</span><br><span class="line">wshShell.popup <span class="string">&quot;Tips:XXXXX&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">0</span> <span class="keyword">to</span> <span class="number">420</span></span><br><span class="line">wshShell.SendKeys <span class="string">&quot;&#123;NUMLOCK&#125;&quot;</span></span><br><span class="line">WScript.sleep <span class="number">500</span></span><br><span class="line">wshShell.SendKeys <span class="string">&quot;&#123;NUMLOCK&#125;&quot;</span></span><br><span class="line">WScript.sleep <span class="number">500</span></span><br><span class="line">Wscript.sleep interval</span><br><span class="line"><span class="keyword">next</span> </span><br><span class="line"></span><br><span class="line">MsgBox <span class="string">&quot;Finished&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="脚本说明"><a href="#脚本说明" class="headerlink" title="脚本说明"></a>脚本说明</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>声明变量 ，需要使用 Dim、Public 或 Private 字段定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dim variable</span><br><span class="line">Public variable</span><br><span class="line">Private variable</span><br></pre></td></tr></table></figure>

<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><ol>
<li>For…Next 语句 - 运行一段代码指定的次数</li>
<li>For Each…Next 语句 - 针对集合中的每个项目或者数组中的每个元素来运行某段代码</li>
<li>Do…Loop 语句 - 运行循环，当条件为 true 或者直到条件为 true 时</li>
<li>While…Wend 语句 - 不要使用这个语句 - 请使用 Do…Loop 语句代替它</li>
</ol>
<h4 id="For-next-循环"><a href="#For-next-循环" class="headerlink" title="For next 循环"></a>For next 循环</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">For counter = start To end [Step step]</span><br><span class="line">    [statements]</span><br><span class="line">    [Exit For]</span><br><span class="line">    [statements]</span><br><span class="line">Next</span><br></pre></td></tr></table></figure>

<p>counter：用做循环计数器的数值变量。这个变量不能是数组元素或用户自定义类型的元素。<br>start：counter的初值。<br>end：counter的终值。<br>step：counter的步长。如果没有指定，则step的默认值为1。</p>
<h3 id="WScript-CreateObject-“WScript-Shell”-对象"><a href="#WScript-CreateObject-“WScript-Shell”-对象" class="headerlink" title="WScript.CreateObject(“WScript.Shell”) 对象"></a>WScript.CreateObject(“WScript.Shell”) 对象</h3><p>Windows脚本宿主提供了一种便捷的方式，可以用于获取系统环境变量的访问、创建快捷方式、访问Windows的特殊文件夹，如Windows Desktop，以及添加或删除注册表条目。还可以使用Shell对象的功能创建更多的定制对话框以进行用户交互。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object=WScript.CreateObject(&quot;WScript.Shell&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="发送按键-WScript-对象，点击按键"><a href="#发送按键-WScript-对象，点击按键" class="headerlink" title="发送按键  WScript 对象，点击按键"></a>发送按键  WScript 对象，点击按键</h4><p>sendkeys 方向活跃窗口发送一次或多次击键(仿佛来自键盘)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object.SendKeys(string)</span><br></pre></td></tr></table></figure>

<p>特殊功能按键</p>
<table>
<thead>
<tr>
<th align="center">说明</th>
<th align="center">VBS值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Backspace</td>
<td align="center">{BACKSPACE}, {BS}, or {BKSP}</td>
</tr>
<tr>
<td align="center">Break</td>
<td align="center">{BREAK}</td>
</tr>
<tr>
<td align="center">Caps Lock</td>
<td align="center">{CAPSLOCK}</td>
</tr>
<tr>
<td align="center">Enter</td>
<td align="center">{ENTER} or ~</td>
</tr>
<tr>
<td align="center">F1</td>
<td align="center">{F1}</td>
</tr>
<tr>
<td align="center">Num Lock</td>
<td align="center">{NUMLOCK}</td>
</tr>
</tbody></table>
<h3 id="等待函数"><a href="#等待函数" class="headerlink" title="等待函数"></a>等待函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WScript.Sleep [毫秒为单位]</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/vbscript/vbscript-tutorial.html">https://www.runoob.com/vbscript/vbscript-tutorial.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/aademeng/articles/12638537.html">https://www.cnblogs.com/aademeng/articles/12638537.html</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/7165c722/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/7165c722/" class="post-title-link" itemprop="url">记录一次Linux网卡配置故障</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-05-18 09:16:44 / Modified: 09:30:04" itemprop="dateCreated datePublished" datetime="2025-05-18T09:16:44+00:00">2025-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>一些CentOS的虚拟机需要变更IP信息，修改网卡配置文件后，重启网络服务，看到网卡上面遗留有原IP和新IP，网关还是原网关地址。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看IP信息</span></span><br><span class="line">ip ad</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网关信息</span></span><br><span class="line">route -n</span><br></pre></td></tr></table></figure>

<p>一些虚拟机跨网段的网络访问不可达，但是能ping通到同网关地址。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><h2 id="故障一，残留原IP"><a href="#故障一，残留原IP" class="headerlink" title="故障一，残留原IP"></a>故障一，残留原IP</h2><p>在 &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F; 文件夹中，同一个网卡有多个IP配置文件，导致网卡无法按照预期更新。</p>
<h2 id="故障二，跨网段访问不可达"><a href="#故障二，跨网段访问不可达" class="headerlink" title="故障二，跨网段访问不可达"></a>故障二，跨网段访问不可达</h2><p>网卡配置文件没有写网关 GATEWAY 参数，导致跨网段的访问无法指向网关。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><h2 id="故障一，残留原IP-1"><a href="#故障一，残留原IP-1" class="headerlink" title="故障一，残留原IP"></a>故障一，残留原IP</h2><ol>
<li>目录 &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F; 移除不需要的网卡配置文件；</li>
<li>刷新网卡配置并重启网络服务(当然也可以重启服务器)；</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ubuntu 网卡配置中存在多IP情况，可以通过 ip addr flush dev 重置;</span></span><br><span class="line">ip addr flush dev [目标网卡] &amp;&amp; /etc/init.d/network restart</span><br></pre></td></tr></table></figure>
<h2 id="故障二，跨网段访问不可达-1"><a href="#故障二，跨网段访问不可达-1" class="headerlink" title="故障二，跨网段访问不可达"></a>故障二，跨网段访问不可达</h2><p>配置网关即可。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键参数</span></span><br><span class="line">NAME=[网卡名]</span><br><span class="line">DEVICE=[网卡名]</span><br><span class="line">IPADDR=[IPv4 地址]</span><br><span class="line">NETMASK=[子网掩码]</span><br><span class="line">GATEWAY=[网关地址]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网卡IP配置协议，可以选静态或者dhcp</span></span><br><span class="line">BOOTPROTO=static</span><br><span class="line"><span class="comment"># 开机自启</span></span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/6125f555/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/6125f555/" class="post-title-link" itemprop="url">Jellyfin刮削异常处理记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-12 04:15:01 / Modified: 04:59:48" itemprop="dateCreated datePublished" datetime="2025-04-12T04:15:01+00:00">2025-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><p>我的Jellyfin应用是通过Docker部署的，Jellyfin里面的硬盘无法被刮削，手动搜索也无法出现硬盘相关信息；<br>宿主机上面的hosts文件已经添加对应解析，且已确认该域名解析没有异常；但 Jellyfin 依旧无法解析。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>在 <a target="_blank" rel="noopener" href="https://dnschecker.org/">https://dnschecker.org/</a> 中查询以下域名记录，并确认中国区可用的解析记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">api.themoviedb.org 108.139.200.113</span><br><span class="line">api.thetvdb.org 192.241.234.54</span><br><span class="line">image.tmdb.org 169.150.207.216</span><br><span class="line">image.thetvdb.org 192.241.234.54</span><br></pre></td></tr></table></figure>

<p>并修改到宿主机的Hosts文件中去本地解析依旧无反应；所以在宿主机中发起抓包，想看看整个流量是怎么走的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nt -s 500 port domain</span><br></pre></td></tr></table></figure>

<p>通过抓包记录，发现每当我在Jellyfin发起刮削时，发现域名 api.themoviedb.org 解析请求会向DNS服务器 114.114.114.114 发起解析请求，而DNS又返回一个错误的结果，那这个就跟我预想的不太一样，正常应该是优先本地解析才对，而不应该是向DNS请求解析。</p>
<p>所以核心的原因是，docker内发起解析请求时，会优先到docker内的hosts文件查询，如果没有的话，再去DNS服务器请求解析，而不会去请求宿主机的hosts文件。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>修改docker中的hosts文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 hosts 文件复制到本地</span></span><br><span class="line">docker <span class="built_in">cp</span> Jellyfin:/etc/hosts ./hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改hosts文件，将目标记录添加进hosts文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 2025-04-12</span></span><br><span class="line"><span class="string">108.139.200.113 api.themoviedb.org</span></span><br><span class="line"><span class="string">192.241.234.54 api.thetvdb.org</span></span><br><span class="line"><span class="string">169.150.207.216 image.tmdb.org</span></span><br><span class="line"><span class="string">192.241.234.54 image.thetvdb.org</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">cp</span> ./hosts Jellyfin:/etc/hosts</span><br></pre></td></tr></table></figure>





      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/41cfa76b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/41cfa76b/" class="post-title-link" itemprop="url">记一次因网络故障导致业务延期交付的故障[待补充]</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-01 16:54:31 / Modified: 17:04:17" itemprop="dateCreated datePublished" datetime="2025-04-01T16:54:31+00:00">2025-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><ol>
<li>服务器与部分业务能联通，与另外一部分业务不能联通；</li>
<li>这个批次的服务器中，有一台可以与外部联通，但也有部分业务不能联通；</li>
</ol>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>经过几轮排查，发现是路由问题，这个排查过程与用到的工具才是关键</p>
<h2 id="抓包-tcpdump"><a href="#抓包-tcpdump" class="headerlink" title="抓包 , tcpdump"></a>抓包 , tcpdump</h2><p>因为是 Linux 服务器，可以直接用 tcpdump 抓包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试1：源端1.2.3.1 访问 目的端的1.2.3.2 TCP-443端口</span></span><br><span class="line"><span class="comment"># 在源端1.2.3.1执行以下指令： </span></span><br><span class="line">ssh -v -p 443 1.2.3.2</span><br><span class="line"><span class="comment"># 在源端开启抓包</span></span><br><span class="line"><span class="comment"># 指令 tcpdump -i [网卡名] dst host [IP或主机名]</span></span><br><span class="line"><span class="comment"># 指令 tcpdump -i [网卡名] dst net [IP/24]</span></span><br><span class="line"><span class="comment"># 指令 tcpdump -i [网卡名] dst host [IP或主机名] and dst host [IP或主机名] </span></span><br><span class="line"><span class="comment"># 指令 tcpdump -i [网卡名] dst host [IP或主机名] or dst host [IP或主机名] </span></span><br><span class="line">tcpdump -i eth0 host 1.2.3.4 tcp port 443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在目的端 1.2.3.2执行以下指令</span></span><br><span class="line">tcpdump -i eth0 host 1.2.3.1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现 源端有发起流量，目的端有接收流量，且有回包流量，但是目的端就无流量记录。</p>
</blockquote>
<h2 id="路由分析-mtr"><a href="#路由分析-mtr" class="headerlink" title="路由分析 mtr"></a>路由分析 mtr</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtr [IP]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现 有环路情况。</p>
</blockquote>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/ad068cdf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/ad068cdf/" class="post-title-link" itemprop="url">记一次Ubuntu因自动更新导致的业务故障[待更新]</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-01 16:51:58 / Modified: 16:53:57" itemprop="dateCreated datePublished" datetime="2025-04-01T16:51:58+00:00">2025-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>业务出现大批量告警</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>查询日志有相关更新记录，新安装的Ubuntu OS默认均会做自动更新，导致关键业务被自动更新</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/731111df/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/731111df/" class="post-title-link" itemprop="url">Ubuntu2004无人值守安装实例【待完善】</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-29 12:20:28" itemprop="dateCreated datePublished" datetime="2025-03-29T12:20:28+00:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-05-18 09:14:09" itemprop="dateModified" datetime="2025-05-18T09:14:09+00:00">2025-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><h2 id="一期需求"><a href="#一期需求" class="headerlink" title="一期需求"></a>一期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，就能自动安装完，并初始化主机名、网卡、镜像源、用户名、初始密码；</p>
<p>一期需求只能实现 服务器挂载镜像后，自动安装操作系统，安装完毕后仍需要使用初始化脚本对主机名、IP进行初始化，因此对镜像的管理由为重要，拟定命名应该包含OS版本信息、启动模式、适配机型、初始硬盘大小；</p>
<blockquote>
<p>ubuntu-20.04.5-live-server-amd64-uefi-pc-10G.iso</p>
</blockquote>
<h2 id="二期需求"><a href="#二期需求" class="headerlink" title="二期需求"></a>二期需求</h2><p>最终输出一个Ubuntu20.04的ISO镜像，服务器挂载此镜像时，自动始化主机名、网卡、镜像源、用户名、初始密码；</p>
<p>关键要求：</p>
<ol>
<li>从安装至交付过程中，仅执行挂载ISO动作即可；</li>
<li>主机名与IP实现自动配置，无需人员参与；</li>
<li>自动配置网卡，将启用的网卡自动做成BOND，无需人员参与；</li>
<li>在无网络的情况下，离线安装软件，并完成配置；</li>
</ol>
<h2 id="三期需求"><a href="#三期需求" class="headerlink" title="三期需求"></a>三期需求</h2><p>通过PXE方式，实现远程挂载镜像自动安装；</p>
<h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h1><p>整体过程：</p>
<ol>
<li>使用虚拟机安装；</li>
<li>先手动安装一遍，并在&#x2F;var&#x2F;log&#x2F;installer&#x2F;autoinstall-user-data</li>
<li>将user-data文件封装进 ISO，并测试安装；</li>
</ol>
<h2 id="一期需求落地"><a href="#一期需求落地" class="headerlink" title="一期需求落地"></a>一期需求落地</h2><h3 id="虚拟机准备"><a href="#虚拟机准备" class="headerlink" title="虚拟机准备"></a>虚拟机准备</h3><p>虚拟化层：使用 VirtualBox 7.1.6 版本；<br>虚拟机配置：1C1G；（低于此配置，可能会在安装的时候触发中断）<br>镜像准备：ubuntu-20.04.5-live-server-amd64.iso (下载地址：<a target="_blank" rel="noopener" href="https://old-releases.ubuntu.com/releases/20.04.5/">https://old-releases.ubuntu.com/releases/20.04.5/</a>  ； 这里有一个坑，我在一个看起来像官网的地方，下载了一个镜像结果怎么样都无法使用)</p>
<h3 id="手动安装准备"><a href="#手动安装准备" class="headerlink" title="手动安装准备"></a>手动安装准备</h3><p>主机名 test001<br>用户名 testuser<br>密码 [自行设置]<br>磁盘 10G：0.5G为EFI分区，2G为boot分区，2G为swap分区，5G为根分区<br>网卡名称：enp0s3<br>IP：192.168.56.101<br>Netmask：255.255.255.0<br>Gateway：192.168.56.1<br>DNS：8.8.8.8,8.8.4.4<br>search domain：rohman.com<br>镜像源： <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/ubuntu/">https://mirrors.aliyun.com/ubuntu/</a><br>安装OpenSSH</p>
<h3 id="自动安装"><a href="#自动安装" class="headerlink" title="自动安装"></a>自动安装</h3><p>通过手动安装，我们获取到了user-data的应答文件，可以开始准备封装自动化安装的镜像。</p>
<h4 id="应答文件-user-data"><a href="#应答文件-user-data" class="headerlink" title="应答文件 user-data"></a>应答文件 user-data</h4><p>从服务器中获取 autoinstall-user-data</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="attr">geoip:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">preserve_sources_list:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># apt 仓库</span></span><br><span class="line">    <span class="attr">primary:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">amd64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">i386</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://ports.ubuntu.com/ubuntu-ports</span></span><br><span class="line">  <span class="attr">drivers:</span></span><br><span class="line">    <span class="attr">install:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 配置主机与用户名信息</span></span><br><span class="line">  <span class="attr">identity:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">test001</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span></span><br><span class="line">    <span class="attr">realname:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testuser</span></span><br><span class="line">  <span class="attr">kernel:</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">linux-generic</span></span><br><span class="line">  <span class="attr">keyboard:</span></span><br><span class="line">    <span class="attr">layout:</span> <span class="string">us</span></span><br><span class="line">    <span class="attr">toggle:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">locale:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># 配置网络</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">ethernets:</span></span><br><span class="line">      <span class="attr">enp0s3:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.102</span><span class="string">/24</span></span><br><span class="line">        <span class="attr">gateway4:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">nameservers:</span></span><br><span class="line">          <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.4</span><span class="number">.4</span></span><br><span class="line">          <span class="attr">search:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rohman.com</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># 配置SSH</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">allow-pw:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorized-keys:</span> []</span><br><span class="line">    <span class="attr">install-server:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 存储配置</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ptable:</span> <span class="string">gpt</span></span><br><span class="line">      <span class="attr">serial:</span> <span class="string">VBOX_HARDDISK_VB84cd466a-d1bb429d</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/dev/sda</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">disk</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">disk-sda</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">564133888</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">boot</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1073741824</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">vfat</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">9097445376</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vg-root</span></span><br><span class="line">      <span class="attr">devices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">partition-sda3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_volgroup</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-swap</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">2147483648B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">swap</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-root</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">5368709120B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot/efi</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-0</span></span><br><span class="line">    <span class="attr">swap:</span></span><br><span class="line">      <span class="attr">swap:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">updates:</span> <span class="string">security</span></span><br><span class="line">  <span class="comment"># 安装完成后，需要执行的指令</span></span><br><span class="line">  <span class="attr">late-commands:</span></span><br><span class="line">    <span class="comment"># NTP服务修改</span></span><br><span class="line">    <span class="bullet">-</span> </span><br><span class="line">  <span class="attr">version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>这份文件需要修改的地方是 “serial: VBOX_HARDDISK_VB84cd466a-d1bb429d”,这个值每一个机器都是独一份的，配置文件中不能复用，否则会报错。</p>
<p>最终的应答文件为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="comment"># 不自动更新OS版本</span></span><br><span class="line">  <span class="attr">refresh-installer:</span></span><br><span class="line">    <span class="attr">update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 必要格式，当前版本为1</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># 禁用security仓库</span></span><br><span class="line">    <span class="comment"># disable_suites: [security]</span></span><br><span class="line">    <span class="attr">geoip:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">preserve_sources_list:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 配置</span></span><br><span class="line">    <span class="attr">primary:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">amd64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">i386</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://ports.ubuntu.com/ubuntu-ports</span></span><br><span class="line">  <span class="attr">drivers:</span></span><br><span class="line">    <span class="attr">install:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 主机名与用户</span></span><br><span class="line">  <span class="attr">identity:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu-server-uefi-img</span></span><br><span class="line">    <span class="comment"># 基于 SHA-512 的密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$6$St6DjEmmG0KypFth$J56GKZ05nU2G3TiJF9o7AfnH8obgB/XKqeAc1964nSu/vnYLJkJGMrwq/abZAO4E8/Agt0pmT3/3CmSCDNI7e.</span></span><br><span class="line">    <span class="attr">realname:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">testuser</span></span><br><span class="line">  <span class="comment"># 时区设置</span></span><br><span class="line">  <span class="attr">timezone:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  <span class="attr">kernel:</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">linux-generic</span></span><br><span class="line">  <span class="attr">keyboard:</span></span><br><span class="line">    <span class="attr">layout:</span> <span class="string">us</span></span><br><span class="line">    <span class="attr">toggle:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">locale:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">  <span class="comment"># 网络配置</span></span><br><span class="line">  <span class="attr">network:</span></span><br><span class="line">    <span class="attr">ethernets:</span></span><br><span class="line">      <span class="attr">enp0s3:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">        <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">        <span class="attr">nameservers:</span></span><br><span class="line">          <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">          <span class="attr">search:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rohman.com</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># SSH配置</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">allow-pw:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorized-keys:</span> []</span><br><span class="line">    <span class="attr">install-server:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 存储配置</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ptable:</span> <span class="string">gpt</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/dev/sda</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock-recursive</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">disk</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">disk-sda</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">564133888</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">boot</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1073741824</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda2</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">vfat</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">partition-sda1</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">device:</span> <span class="string">disk-sda</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">9097445376</span></span><br><span class="line">      <span class="attr">flag:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">grub_device:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">partition-sda3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vg-root</span></span><br><span class="line">      <span class="attr">devices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">partition-sda3</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_volgroup</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-swap</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">2147483648B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">swap</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-swap</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lv-root</span></span><br><span class="line">      <span class="attr">volgroup:</span> <span class="string">lvm-volgroup-vg-root</span></span><br><span class="line">      <span class="attr">size:</span> <span class="string">5368709120B</span></span><br><span class="line">      <span class="attr">wipe:</span> <span class="string">superblock</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">lvm_partition</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fstype:</span> <span class="string">ext4</span></span><br><span class="line">      <span class="attr">volume:</span> <span class="string">lvm-partition-lv-root</span></span><br><span class="line">      <span class="attr">preserve:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">format</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">format-2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot/efi</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">format-partition-sda1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">mount</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">mount-0</span></span><br><span class="line">    <span class="attr">swap:</span></span><br><span class="line">      <span class="attr">swap:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 安装完成后执行的指令</span></span><br><span class="line">  <span class="attr">late-commands:</span></span><br><span class="line">  <span class="comment"># 根目录在/target中</span></span><br><span class="line">    <span class="comment"># DNS恢复</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.3/8.8.8.8/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/1.2.3.4/8.8.4.4/g&quot;</span> <span class="string">/target/etc/netplan/00-installer-config.yaml</span></span><br><span class="line">    <span class="comment"># NTP设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#NTP=/NTP=ntp.ntsc.ac.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#FallbackNTP=ntp.ubuntu.com/FallbackNTP=edu.ntp.org.cn/g&quot;</span> <span class="string">/target/etc/systemd/timesyncd.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">timedatectl</span> <span class="string">set-ntp</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># sudo权限</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;testuser ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/sudoers</span></span><br><span class="line">    <span class="comment"># OpenFile设置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* soft nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;* hard nofile 819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/security/limits.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/#DefaultLimitNOFILE=/DefaultLimitNOFILE=819200/g&quot;</span> <span class="string">/target/etc/systemd/user.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;DefaultLimitNOFILE=819200&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/target/etc/systemd/system.conf</span></span><br><span class="line">    <span class="comment"># 不更新内核</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-image-generic</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curtin</span> <span class="string">in-target</span> <span class="string">--</span> <span class="string">apt-mark</span> <span class="string">hold</span> <span class="string">linux-headers-generic</span></span><br><span class="line">    <span class="comment"># 拷贝脚本</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cp</span> <span class="string">/cdrom/server-init.sh</span> <span class="string">/target/root/</span></span><br><span class="line">  <span class="comment"># 重启</span></span><br><span class="line">  <span class="attr">shutdown:</span> <span class="string">reboot</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="引导文件-grub-cfg"><a href="#引导文件-grub-cfg" class="headerlink" title="引导文件 grub.cfg"></a>引导文件 grub.cfg</h4><p>ISO的引导文件放置在 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>增加 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ fsck.mode&#x3D;skip 字段；关键字段是 autoinstall ds&#x3D;’nocloud;s&#x3D;&#x2F;cdrom&#x2F;‘ 这个是自动安装的关键。</p>
</blockquote>
<p>最终版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if loadfont /boot/grub/font.pf2 ; then</span><br><span class="line">	set gfxmode=auto</span><br><span class="line">	insmod efi_gop</span><br><span class="line">	insmod efi_uga</span><br><span class="line">	insmod gfxterm</span><br><span class="line">	terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">set timeout=5</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Automatic][UEFI]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz autoinstall ds=&#x27;nocloud;s=/cdrom/&#x27; fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">menuentry &quot;[Manual]Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/vmlinuz fsck.mode=skip  quiet  ---</span><br><span class="line">	initrd	/casper/initrd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grub_platform</span><br><span class="line">if [ &quot;$grub_platform&quot; = &quot;efi&quot; ]; then</span><br><span class="line">menuentry &#x27;Boot from next volume&#x27; &#123;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line">menuentry &#x27;UEFI Firmware Settings&#x27; &#123;</span><br><span class="line">	fwsetup</span><br><span class="line">&#125;</span><br><span class="line">fi</span><br><span class="line">submenu &#x27;Boot and Install with the HWE kernel&#x27; &#123;</span><br><span class="line">menuentry &quot;Install Ubuntu Server&quot; &#123;</span><br><span class="line">	set gfxpayload=keep</span><br><span class="line">	linux	/casper/hwe-vmlinuz   quiet  ---</span><br><span class="line">	initrd	/casper/hwe-initrd</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="系统初始化脚本"><a href="#系统初始化脚本" class="headerlink" title="系统初始化脚本"></a>系统初始化脚本</h4><p>完成安装后，我们还需要进入OS内执行初始化指令，比如修改主机名、IP之类的。<br>脚本为server-init.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line"><span class="comment"># Description: Init servername and IP.</span></span><br><span class="line"><span class="comment"># Date:2025-03-30</span></span><br><span class="line"><span class="comment"># Version:v1</span></span><br><span class="line"><span class="comment"># ScriptName:server-init.sh</span></span><br><span class="line"><span class="comment"># Args: servername ip</span></span><br><span class="line"><span class="comment"># Example: bash server-init.sh test001 1.2.3.4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Servername is <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerIP is <span class="variable">$2</span>&quot;</span></span><br><span class="line">hostname=<span class="variable">$1</span></span><br><span class="line">ip=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -n1 -p <span class="string">&quot;Is that information correct?(y/n)&quot;</span> KEY</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$KEY</span> <span class="keyword">in</span></span><br><span class="line">Y | y)</span><br><span class="line">    hostnamectl set-hostname <span class="variable">$hostname</span>;</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.1/<span class="variable">$ip</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    gateway4=$(<span class="built_in">echo</span> <span class="variable">$ip</span> | awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.254&quot;&#125;&#x27;</span>)</span><br><span class="line">    sed -i <span class="string">&quot;s/1.2.3.2/<span class="variable">$gateway4</span>/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class="line">    netplan apply</span><br><span class="line">    apt-mark hold linux-headers-generic</span><br><span class="line">    apt-mark hold linux-image-generic</span><br><span class="line">    ;;</span><br><span class="line">N | n)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Cancel&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR VALUE!&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h4 id="重新封装ISO文件"><a href="#重新封装ISO文件" class="headerlink" title="重新封装ISO文件"></a>重新封装ISO文件</h4><p>这里使用的工具是 UltraISO 工具，用此工具打开原ISO文件，主要放入的四个文件：</p>
<ol>
<li>grub.cfg文件，要替换 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F;boot&#x2F;grub&#x2F;grub.cfg ；</li>
<li>user-data应答文件，要放入  &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>meta-data应答文件的元数据文件，要放入 &#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
<li>server-init.sh放入&#x2F;ubuntu-20.04.5-live-server-amd64.iso&#x2F; 根目录；</li>
</ol>
<p>确认放入后，点击保存即可。</p>
<h4 id="虚拟机验证测试"><a href="#虚拟机验证测试" class="headerlink" title="虚拟机验证测试"></a>虚拟机验证测试</h4><p>VirtualBox创建虚拟机，挂载ISO文件。预期内应该能自动完成安装。</p>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><h5 id="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"><a href="#问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题" class="headerlink" title="问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题"></a>问题1：无法初始化硬盘，安装过程中直接中断暂停，配置文件语法有问题</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash ，搜索Error字段，发现明显的提示 RuntimeError: type:disk id&#x3D;disk-sda has both wipe and preserve</p>
<h6 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h6><p>应答文件中写得有冲突，在存储配置里面，有关于 磁盘是否要保留数据的参数 preserve 参数，填写了 true；<br>新硬盘正常不应该会存在分区，填写了包留分区，则会有冲突，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">preserve: true, false</span><br><span class="line"></span><br><span class="line">When the preserve key is present and set to true curtin will attempt reuse the existing storage device. Curtin will verify aspects of the device against the configuration provided. </span><br><span class="line">For example, when assessing whether curtin can use a preserved partition, curtin checks that the device exists, size of the partition matches the value in the config and checks if the same partition flag is set. </span><br><span class="line">The set of verification checks vary by device type. If curtin encounters a mismatch between config and what is found on the device a RuntimeError will be raised with the expected and found values and halt the installation. </span><br></pre></td></tr></table></figure>

<p>第二个关键参数，wipe;当wipe指定了内容，则是要格式化磁盘，所有内容均会被抹除；原配置文件中带有wipe参数，但是preserve又填为true，因此导致前后冲突。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wipe: superblock, superblock-recursive, pvremove, zero, random</span><br><span class="line"></span><br><span class="line">If wipe is specified, the disk contents will be destroyed. In the case that a disk is a part of virtual block device, like bcache, RAID array, or LVM, then curtin will attempt to tear down the virtual device to allow access to the disk for resetting the disk.</span><br><span class="line"></span><br><span class="line">The most common option for clearing a disk is wipe: superblock. In some cases use of wipe: superblock-recursive is useful to ensure that embedded superblocks on a disk aren’t rediscovered during probing. For example, LVM, bcache and RAID on a partition would have metadata outside of the range of a superblock wipe of the start and end sections of the disk.</span><br><span class="line"></span><br><span class="line">The wipe: zero option will write zeros to each sector of the disk. Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: random option will write pseudo-random data from /dev/urandom Depending on the size and speed of the disk; it may take a long time to complete.</span><br><span class="line"></span><br><span class="line">The wipe: pvremove option will execute the pvremove command to wipe the LVM metadata so that the device is no longer part of an LVM.</span><br></pre></td></tr></table></figure>

<h6 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h6><p>将 preserve: true 全部改成 preserve: false;</p>
<h5 id="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"><a href="#问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足" class="headerlink" title="问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足"></a>问题2：无法初始化硬盘，安装过程中直接中断暂停，原始硬盘空间不足</h5><p>tty1提示在 configuring storage阶段报错，日志写到 &#x2F;var&#x2F;crash&#x2F;xxx.install_fail.crash<br>查看日志，搜索ERROR字段，发现有FAIL:configuring storage;</p>
<h6 id="原因分析-1"><a href="#原因分析-1" class="headerlink" title="原因分析"></a>原因分析</h6><p>目标磁盘sda空间不足，导致无法继续分配空间；</p>
<h6 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1，修改应答文件，将空间缩小；<br>方法2，修改磁盘大小，将初始容量扩大；</p>
<h5 id="问题3：卡在downloading-and-installing-security-updates"><a href="#问题3：卡在downloading-and-installing-security-updates" class="headerlink" title="问题3：卡在downloading and installing security updates"></a>问题3：卡在downloading and installing security updates</h5><p>Log显示downloading and installing security updates</p>
<h6 id="原因分析-2"><a href="#原因分析-2" class="headerlink" title="原因分析"></a>原因分析</h6><p>安装过程中，服务器网络正常可以访问外网则会自动拉取安全更新。</p>
<h6 id="解决方法-2"><a href="#解决方法-2" class="headerlink" title="解决方法"></a>解决方法</h6><p>方法1：安装过程中使网络异常，安装完成后再解除；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp0s3:</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.1</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我个人更倾向使用此方法，安装完毕后，再到操作系统执行初始化脚本 server-init.sh</p>
</blockquote>
<p>方法2：禁用apt的security仓库；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line"> <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">disable_components:</span> []</span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="attr">disable_suites:</span> [<span class="string">security</span>]</span><br></pre></td></tr></table></figure>

<p>但这个会导致默认的源文件会少 security 仓库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span><br><span class="line"># newer versions of the distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal main restricted</span><br><span class="line"></span><br><span class="line">## Major bug fix updates produced after the final release of the</span><br><span class="line">## distribution.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates main restricted</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team. Also, please note that software in universe WILL NOT receive any</span><br><span class="line">## review or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates universe</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span><br><span class="line">## team, and may not be under a free licence. Please satisfy yourself as to</span><br><span class="line">## your rights to use the software. Also, please note that software in</span><br><span class="line">## multiverse WILL NOT receive any review or updates from the Ubuntu</span><br><span class="line">## security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-updates multiverse</span><br><span class="line"></span><br><span class="line">## N.B. software from this repository may not have been tested as</span><br><span class="line">## extensively as that contained in the main release, although it includes</span><br><span class="line">## newer versions of some applications which may provide useful features.</span><br><span class="line">## Also, please note that software in backports WILL NOT receive any review</span><br><span class="line">## or updates from the Ubuntu security team.</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">## Uncomment the following two lines to add software from Canonical&#x27;s</span><br><span class="line">## &#x27;partner&#x27; repository.</span><br><span class="line">## This software is not part of Ubuntu, but is offered by Canonical and the</span><br><span class="line">## respective vendors as a service to Ubuntu users.</span><br><span class="line"># deb http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"># deb-src http://archive.canonical.com/ubuntu focal partner</span><br><span class="line"></span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security main restricted</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security universe</span><br><span class="line"># deb http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br><span class="line"># deb-src http://mirrors.aliyun.com/ubuntu focal-security multiverse</span><br></pre></td></tr></table></figure>

<h5 id="问题4：提示netplan-apply-returned-non-zero-exit-status-1"><a href="#问题4：提示netplan-apply-returned-non-zero-exit-status-1" class="headerlink" title="问题4：提示netplan apply returned non-zero exit status 1"></a>问题4：提示netplan apply returned non-zero exit status 1</h5><p>自动安装过程中，网卡显示中断</p>
<h6 id="原因分析-3"><a href="#原因分析-3" class="headerlink" title="原因分析"></a>原因分析</h6><p>网卡配置写错了，需要复核一下每一个参数是否拼写有误，比如应该写interfaces的选项，写成interface；比如缩进有问题，空格键与tab键混用；</p>
<h6 id="解决方法-3"><a href="#解决方法-3" class="headerlink" title="解决方法"></a>解决方法</h6><p>可以切换至tty2,手动使用netplan apply看看具体报错。</p>
<h5 id="问题5：user-data文件异常，无法使用【待复核确认】"><a href="#问题5：user-data文件异常，无法使用【待复核确认】" class="headerlink" title="问题5：user-data文件异常，无法使用【待复核确认】"></a>问题5：user-data文件异常，无法使用【待复核确认】</h5><p>配置文件未正常生效，安装时仍然进入手动安装界面。</p>
<h6 id="原因分析-4"><a href="#原因分析-4" class="headerlink" title="原因分析"></a>原因分析</h6><p>为yaml文件的配置语法有异常，导致整片yaml配置无法使用。</p>
<h6 id="解决方法-4"><a href="#解决方法-4" class="headerlink" title="解决方法"></a>解决方法</h6><ol>
<li>缩进、空格不能混用；</li>
<li>参数与值之间要空格；如 item: value</li>
</ol>
<h5 id="问题6：安装中断，模拟curtin-继续执行"><a href="#问题6：安装中断，模拟curtin-继续执行" class="headerlink" title="问题6：安装中断，模拟curtin 继续执行"></a>问题6：安装中断，模拟curtin 继续执行</h5><p>指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在目标系统中执行安装任务</span></span><br><span class="line">curtin in-target --target=/target -- [指令内容]</span><br><span class="line"></span><br><span class="line"><span class="comment"># dpkg 安装软件</span></span><br><span class="line"><span class="comment"># [/target内的绝对路径] 需要的文件是在/target中，比如 /target/root/xxx.deb ,实际要写 /root/xxx.deb</span></span><br><span class="line">curtin in-target --target=/target -- dpkg -i [/target内的绝对路径]</span><br></pre></td></tr></table></figure>

<h2 id="二期需求落地"><a href="#二期需求落地" class="headerlink" title="二期需求落地"></a>二期需求落地</h2><p>实现思路：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 主机名与IP自动配置 -- 可以锚定服务器序列号，基于序列号去匹配主机名、业务IP；</span><br><span class="line">2. 自动配置网卡 -- 先写一个通用配置，在安装过程中检测哪一些网卡是启用的，将通用配置文件中的网卡替换为启用的网卡；</span><br><span class="line">3. 离线安装软件包 -- 下载deb包与依赖包，封装到镜像中执行安装；</span><br></pre></td></tr></table></figure>

<p>各模块分工如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">autoinstall,即user-data文件: </span><br><span class="line">负责初始配置，如 apt 、 identity 、 timezone 、 kernel 、 keyboard 、locale 、 ssh 、 storage 模块；其他的放置在 late-commands内，以启动第二部分工作；</span><br><span class="line"></span><br><span class="line">late-commands,即自动初始化的start-init.sh文件：</span><br><span class="line">负责一些定制化的操作，如设置主机名、业务IP与DNS配置、网口组BOND、一些软件的安装；</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="脚本分工实例"><a href="#脚本分工实例" class="headerlink" title="脚本分工实例"></a>脚本分工实例</h3><h4 id="user-data-应答文件"><a href="#user-data-应答文件" class="headerlink" title="user-data 应答文件"></a>user-data 应答文件</h4><blockquote>
<p>一定要注意yaml格式，tab与空格不能混用，否则自动应答无法启用。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user-data 关键节选：</span></span><br><span class="line"><span class="attr">late-commands:</span></span><br><span class="line">  <span class="comment"># start-init.sh默认是放在安装盘的根目录，该分区/cdrom为只读目录，会影响我们一些临时文件的生成；</span></span><br><span class="line">  <span class="comment"># 所以将start-init.sh拷贝至当前目录，当前目录是一个临时目录，拥有读写权限；</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cp</span> <span class="string">/cdrom/start-init.sh</span> <span class="string">./</span></span><br><span class="line">  <span class="comment"># 执行脚本</span></span><br><span class="line">  <span class="comment"># 开启自定义</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bash</span> <span class="string">./start-init.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="start-init-sh-初始化脚本文件"><a href="#start-init-sh-初始化脚本文件" class="headerlink" title="start-init.sh 初始化脚本文件"></a>start-init.sh 初始化脚本文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /bin/bash</span></span><br><span class="line"><span class="comment"># Date:2025-04-12</span></span><br><span class="line"><span class="comment"># Version:v1</span></span><br><span class="line"><span class="comment"># Description:用于初始化服务器的脚本</span></span><br><span class="line"><span class="comment"># ScriptName:start-init.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建序列号与主机名对应关系</span></span><br><span class="line"><span class="comment"># [TODO]:镜像封装前，需手动录入</span></span><br><span class="line"><span class="built_in">cat</span> &gt; serverlist &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 格式为:序列号;主机名;IP</span></span><br><span class="line"><span class="string">sn1;hostname1;ip1;</span></span><br><span class="line"><span class="string">sn2;hostname2;ip2;</span></span><br><span class="line"><span class="string">sn3;hostname3;ip3;</span></span><br><span class="line"><span class="string">sn4;hostname4;ip4;</span></span><br><span class="line"><span class="string">VirtualBox-f4d15401-dcdb-4eae-b59e-dc67ab31dce2;test01;192.168.56.114</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局参数</span></span><br><span class="line"><span class="comment"># [TODO]:镜像封装前，需手动录入</span></span><br><span class="line">GLOBAL_DNS_1=<span class="string">&quot;8.8.8.8&quot;</span></span><br><span class="line">GLOBAL_DNS_2=<span class="string">&quot;8.8.8.4&quot;</span></span><br><span class="line">GLOBAL_NTP_1=<span class="string">&quot;ntp.ubuntu.com&quot;</span></span><br><span class="line">GLOBAL_NTP_2=<span class="string">&quot;&quot;</span></span><br><span class="line">GLOBAL_DEFAULT_USER=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网卡配置文件的网卡为 temp_eth_1,temp_eth_2;</span></span><br><span class="line"><span class="comment"># 创建网卡配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /target/etc/netplan/99-netplan.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">network:</span></span><br><span class="line"><span class="string">  bonds:</span></span><br><span class="line"><span class="string">    bond0:</span></span><br><span class="line"><span class="string">      addresses:</span></span><br><span class="line"><span class="string">      - 1.2.3.1/24</span></span><br><span class="line"><span class="string">      gateway4: 1.2.3.2</span></span><br><span class="line"><span class="string">      interfaces:</span></span><br><span class="line"><span class="string">      - temp_eth_1</span></span><br><span class="line"><span class="string">      - temp_eth_2</span></span><br><span class="line"><span class="string">      parameters:</span></span><br><span class="line"><span class="string">        lacp-rate: slow</span></span><br><span class="line"><span class="string">        mode: 802.3ad</span></span><br><span class="line"><span class="string">        transmit-hash-policy: layer2</span></span><br><span class="line"><span class="string">  ethernets:</span></span><br><span class="line"><span class="string">    temp_eth_1: &#123;&#125;</span></span><br><span class="line"><span class="string">    temp_eth_2: &#123;&#125;</span></span><br><span class="line"><span class="string">  version: 2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块1：判断哪一些网络端口是可用的；并自动设置网口；</span></span><br><span class="line"><span class="comment"># 所有的网卡默认启用连接，并设置为DHCP模式；</span></span><br><span class="line"><span class="comment"># 已连接的网口，可以通过 ip ad指令查看，会有 &quot;BROADCAST,MULTICAST,UP,LOWER_UP&quot; 字样，与，“state UP”字样</span></span><br><span class="line"><span class="comment"># 获取已连接的端口,默认是两张网卡</span></span><br><span class="line"><span class="keyword">function</span> set_networkAdapter &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第一张网卡名</span></span><br><span class="line">    net_adapter_1=`ip ad|grep <span class="string">&quot;state UP&quot;</span>|awk -F <span class="string">&quot;: &quot;</span> <span class="string">&#x27; &#123;print $2&#125;&#x27;</span>|<span class="built_in">head</span> -n 1`</span><br><span class="line">    <span class="comment"># 第二张网卡名</span></span><br><span class="line">    net_adapter_2=`ip ad|grep <span class="string">&quot;state UP&quot;</span>|awk -F <span class="string">&quot;: &quot;</span> <span class="string">&#x27; &#123;print $2&#125;&#x27;</span>|<span class="built_in">tail</span> -n 1`</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 替换网卡名称</span></span><br><span class="line">    sed -i.bak <span class="string">&quot;s/temp_eth_1/<span class="variable">$net_adapter_1</span>/g&quot;</span> /target/etc/netplan/99-netplan.yaml</span><br><span class="line">    sed -i.bak <span class="string">&quot;s/temp_eth_2/<span class="variable">$net_adapter_2</span>/g&quot;</span> /target/etc/netplan/99-netplan.yaml</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将默认网卡配置文件重命名，避免冲突</span></span><br><span class="line">    <span class="built_in">mv</span> /target/etc/netplan/00-installer-config.yaml /target/etc/netplan/00-installer-config.yaml.bak.$(<span class="built_in">date</span> <span class="string">&quot;+%Y%m%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块2：设置IP,参数1为服务器的IP</span></span><br><span class="line"><span class="keyword">function</span> set_ip &#123;</span><br><span class="line">    targetip=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果是目标序列号</span></span><br><span class="line">    <span class="comment"># 执行动作</span></span><br><span class="line">    <span class="comment"># 变更IP</span></span><br><span class="line">    gw4=$(<span class="built_in">echo</span> <span class="variable">$targetip</span> | awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27; &#123;print $1&quot;.&quot;$2&quot;.&quot;$3&quot;.254&quot;&#125;&#x27;</span>)</span><br><span class="line">    sed -i.bak <span class="string">&quot;s/1.2.3.1/<span class="variable">$targetip</span>/g&quot;</span> /target/etc/netplan/99-netplan.yaml</span><br><span class="line">    sed -i.bak <span class="string">&quot;s/1.2.3.2/<span class="variable">$gw4</span>/g&quot;</span> /target/etc/netplan/99-netplan.yaml</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将网卡配置文件也拷贝至当前环境，如果要涉及联网安装，则需要配置好业务网络，临时使用；</span></span><br><span class="line">    <span class="built_in">cp</span> /target/etc/netplan/99-netplan.yaml /etc/netplan/99-netplan.yaml</span><br><span class="line">    netplan apply</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置主机名，参数1为服务器的主机名</span></span><br><span class="line"><span class="keyword">function</span> set_hostname &#123;</span><br><span class="line">    targethostname=<span class="variable">$1</span></span><br><span class="line">    <span class="comment"># curtinin-target + hostnamectl 实际用下来没有效果，还是直接修改/etc/hostname吧；</span></span><br><span class="line">    <span class="comment"># curtin in-target --target=/target -- hostnamectl set-hostname $targethostname;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$targethostname</span> &gt; /target/etc/hostname</span><br><span class="line">    sed -i.bak <span class="string">&quot;s/ubuntu-server-uefi-img/<span class="variable">$targethostname</span>/g&quot;</span> /target/etc/hosts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># DNS配置</span></span><br><span class="line"><span class="keyword">function</span> set_dns &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关闭Ubuntu默认的DNS服务，手动创建resolv.conf文件</span></span><br><span class="line">    systemctl <span class="built_in">disable</span> systemd-resolved</span><br><span class="line"></span><br><span class="line">    curtin in-target --target=/target -- systemctl <span class="built_in">disable</span> systemd-resolved</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rm</span> -f /etc/resolv.conf</span><br><span class="line">    <span class="built_in">rm</span> -f /target/etc/resolv.conf</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nameserver <span class="variable">$GLOBAL_DNS_1</span>&quot;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nameserver <span class="variable">$GLOBAL_DNS_2</span>&quot;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nameserver <span class="variable">$GLOBAL_DNS_2</span>&quot;</span> &gt;&gt; /target/etc/resolv.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nameserver <span class="variable">$GLOBAL_DNS_2</span>&quot;</span> &gt;&gt; /target/etc/resolv.conf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> set-sudopermission &#123;</span><br><span class="line">    <span class="comment"># 设置默认账户sudo免密</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$GLOBAL_DEFAULT_USER</span>&quot;</span> ALL=(ALL) NOPASSWD:ALL &gt;&gt; /target/etc/sudoers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> lv_autoexpand &#123;</span><br><span class="line">    <span class="comment"># 磁盘默认分区是最小化的</span></span><br><span class="line">    <span class="comment"># 需要将根目录做自动扩容</span></span><br><span class="line">    growpart /dev/sda 3</span><br><span class="line">    pvresize /dev/sda3</span><br><span class="line">    lvextend -l +100%free /dev/vg-root/lv-root</span><br><span class="line">    resize2fs /dev/vg-root/lv-root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块3：一些需要在联网后才能操作的动作或者最后再执行的动作</span></span><br><span class="line"><span class="keyword">function</span> install_module &#123;</span><br><span class="line">    <span class="comment"># 关闭自动更新</span></span><br><span class="line">    curtin in-target --target=/target -- systemctl <span class="built_in">disable</span> unattended-upgrades</span><br><span class="line">    curtin in-target --target=/target -- systemctl <span class="built_in">disable</span> apt-daily.timer</span><br><span class="line">    curtin in-target --target=/target -- systemctl <span class="built_in">disable</span> apt-daily-upgrade.timer</span><br><span class="line">    curtin in-target --target=/target -- systemctl stop unattended-upgrades</span><br><span class="line">    curtin in-target --target=/target -- systemctl stop apt-daily.timer</span><br><span class="line">    curtin in-target --target=/target -- systemctl stop apt-daily-upgrade.timer</span><br><span class="line"></span><br><span class="line">    <span class="comment"># OpenFile设置</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;* soft nofile 819200&quot;</span> &gt;&gt; /target/etc/security/limits.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;* hard nofile 819200&quot;</span> &gt;&gt; /target/etc/security/limits.conf</span><br><span class="line">    sed -i <span class="string">&quot;s/#DefaultLimitNOFILE=/DefaultLimitNOFILE=819200/g&quot;</span> /target/etc/systemd/user.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;DefaultLimitNOFILE=819200&quot;</span> &gt;&gt; /target/etc/systemd/system.conf</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NTP 设置</span></span><br><span class="line">    sed -i <span class="string">&quot;s/#NTP=/NTP=<span class="variable">$GLOBAL_NTP_1</span>/g&quot;</span> /target/etc/systemd/timesyncd.conf</span><br><span class="line">    sed -i <span class="string">&quot;s/#FallbackNTP=ntp.ubuntu.com/FallbackNTP=<span class="variable">$GLOBAL_NTP_2</span>/g&quot;</span> /target/etc/systemd/timesyncd.conf</span><br><span class="line">    curtin in-target --target=/target -- timedatectl set-ntp</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Zabbix安装</span></span><br><span class="line">    <span class="built_in">cp</span> /cdrom/zabbix-agent_4.0.44-1+focal_amd64.deb /target/root/zabbix-agent_4.0.44-1+focal_amd64.deb</span><br><span class="line">    curtin in-target --target=/target  -- dpkg -i /root/zabbix-agent_4.0.44-1+focal_amd64.deb</span><br><span class="line">    curtin in-target --target=/target  -- systemctl <span class="built_in">enable</span> zabbix-agent</span><br><span class="line">    <span class="built_in">cat</span> &gt; /target/etc/zabbix/zabbix_agentd.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">    # zabbix配置内容</span></span><br><span class="line"><span class="string">    # [TODO] 镜像封装前需要手动录入Zabbix的配置文件；</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 内核更新</span></span><br><span class="line">    <span class="comment"># 在线安装方式</span></span><br><span class="line">    curtin in-target --target=/target -- apt-get update</span><br><span class="line">    curtin in-target --target=/target -- apt-get install linux-image-5.15.0-46-generic -y</span><br><span class="line">    curtin in-target --target=/target -- apt-get install linux-headers-5.15.0-46-generic -y</span><br><span class="line">    curtin in-target --target=/target -- apt-get install linux-modules-5.15.0-46-generic -y</span><br><span class="line">    curtin in-target --target=/target -- apt-get install linux-modules-extra-5.15.0-46-generic -y</span><br><span class="line">    curtin in-target --target=/target -- update-grub2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 离线安装方式</span></span><br><span class="line">    <span class="comment"># 关键 headers \ modules \ modules-extra \ image \hwe</span></span><br><span class="line">    <span class="comment"># 使用curtin in-target的安装方式：需要写绝对路径，不能写通配符；</span></span><br><span class="line">    <span class="comment"># 使用curtin in-target的安装方式：有关联的DEB包，需要写到同一个指令中；</span></span><br><span class="line">    <span class="comment"># 离线包下载方式，可以到 https://ubuntu.pkgs.org/ 搜索，可以看到关键包的下载地址；</span></span><br><span class="line">    <span class="comment"># linux-image-5.15.0-46-generic：http://archive.ubuntu.com/ubuntu/pool/main/l/linux-signed-hwe-5.15/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span></span><br><span class="line">    <span class="comment"># linux-headers-5.15.0-46-generic：http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-headers-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span></span><br><span class="line">    <span class="comment"># linux-modules-5.15.0-46-generic：http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span></span><br><span class="line">    <span class="comment"># linux-modules-extra-5.15.0-46-generic：http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span></span><br><span class="line">    <span class="comment"># 错误写法：curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/*.deb</span></span><br><span class="line">    <span class="built_in">cp</span> -rf /cdrom/kernel-5.15.0-46 /target/root/kernel-5.15.0-46</span><br><span class="line">    curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-headers-5.1</span><br><span class="line">    5.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br><span class="line"></span><br><span class="line">    curtin in-target --target=/target -- update-grub2</span><br><span class="line"></span><br><span class="line">    curtin in-target --target=/target -- apt-mark hold linux-image-generic</span><br><span class="line">    curtin in-target --target=/target -- apt-mark hold linux-headers-generic</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> start-main &#123;</span><br><span class="line">    <span class="comment"># 服务器信息</span></span><br><span class="line">    serialnumber=$(dmidecode -t system |grep <span class="string">&quot;Serial Number&quot;</span> | awk -F <span class="string">&quot;: &quot;</span> <span class="string">&#x27; &#123;print $2&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 前置脚本信息</span></span><br><span class="line">    targetip=$(<span class="built_in">cat</span> serverlist | grep <span class="variable">$serialnumber</span> | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27; &#123;print $3&#125;&#x27;</span>)</span><br><span class="line">    targethostname=$(<span class="built_in">cat</span> serverlist | grep <span class="variable">$serialnumber</span> | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27; &#123;print $2&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    set_networkAdapter</span><br><span class="line">    set_ip <span class="variable">$targetip</span></span><br><span class="line">    set_hostname <span class="variable">$targethostname</span></span><br><span class="line">    set_dns</span><br><span class="line">    set-sudopermission</span><br><span class="line">    lv_autoexpand</span><br><span class="line">    install_module</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动配置文件</span></span><br><span class="line">start-main</span><br></pre></td></tr></table></figure>

<h5 id="安装中的问题"><a href="#安装中的问题" class="headerlink" title="安装中的问题"></a>安装中的问题</h5><h5 id="问题1-默认安装过程中，已连接的网卡会默认为UP；而安装完后，则没有UP状态；"><a href="#问题1-默认安装过程中，已连接的网卡会默认为UP；而安装完后，则没有UP状态；" class="headerlink" title="问题1 默认安装过程中，已连接的网卡会默认为UP；而安装完后，则没有UP状态；"></a>问题1 默认安装过程中，已连接的网卡会默认为UP；而安装完后，则没有UP状态；</h5><p>因为Ubuntu安装镜像过程中，是默认将所有网卡配置为 DHCP ，所以只要网络有联通的网卡，会出现UP字样；<br>即，已连接的网口，可以通过 ip ad指令查看，会有 “BROADCAST,MULTICAST,UP,LOWER_UP” 字样，与，“state UP”字样；</p>
<p>以下为netplan的默认配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zz-all-en:</span></span><br><span class="line">  <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">en*</span></span><br><span class="line"><span class="attr">zz-all-eth:</span></span><br><span class="line">  <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eth*</span></span><br></pre></td></tr></table></figure>

<h5 id="问题2-如何离线下载deb包；"><a href="#问题2-如何离线下载deb包；" class="headerlink" title="问题2 如何离线下载deb包；"></a>问题2 如何离线下载deb包；</h5><p>离线包下载方式，可以到 <a target="_blank" rel="noopener" href="https://ubuntu.pkgs.org/">https://ubuntu.pkgs.org/</a> 搜索，可以看到关键包的下载地址；</p>
<p>比如本次用到的内核升级包：</p>
<ul>
<li>linux-image-5.15.0-46-generic：<a target="_blank" rel="noopener" href="http://archive.ubuntu.com/ubuntu/pool/main/l/linux-signed-hwe-5.15/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb">http://archive.ubuntu.com/ubuntu/pool/main/l/linux-signed-hwe-5.15/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</a></li>
<li>linux-headers-5.15.0-46-generic：<a target="_blank" rel="noopener" href="http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-headers-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb">http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-headers-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</a></li>
<li>linux-modules-5.15.0-46-generic：<a target="_blank" rel="noopener" href="http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb">http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</a></li>
<li>linux-modules-extra-5.15.0-46-generic：<a target="_blank" rel="noopener" href="http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb">http://archive.ubuntu.com/ubuntu/pool/main/l/linux-hwe-5.15/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</a></li>
</ul>
<h5 id="问题3-使用-dpkg-安装内核包时会出现依赖问题"><a href="#问题3-使用-dpkg-安装内核包时会出现依赖问题" class="headerlink" title="问题3 使用 dpkg 安装内核包时会出现依赖问题"></a>问题3 使用 dpkg 安装内核包时会出现依赖问题</h5><p>正常情况下 ，可以用 “dpkg -i .&#x2F;*.deb” 把所有关键包都安装完毕，但本次在curtin in-target的方式安装时，会报错，提示无法找到文件，即无法用通配符去匹配安装包，需要写绝对路径。</p>
<p>比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变更前：</span></span><br><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/*.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 变更后：</span></span><br><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-headers-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-hwe-5.15/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br></pre></td></tr></table></figure>

<p>但以上方式依旧有问题，安装 modules 时会提示 image未安装，安装image时会提示module不存在，这些包之间相互均有依赖，所以要将这些安装包放在同一个指令中，如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curtin in-target --target=/target -- dpkg -i /root/kernel-5.15.0-46/linux-image-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-headers-5.1</span><br><span class="line">5.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-modules-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb /root/kernel-5.15.0-46/linux-modules-extra-5.15.0-46-generic_5.15.0-46.49~20.04.1_amd64.deb</span><br></pre></td></tr></table></figure>
<h5 id="问题4-本次脚本有哪一些可以总结归纳的经验"><a href="#问题4-本次脚本有哪一些可以总结归纳的经验" class="headerlink" title="问题4 本次脚本有哪一些可以总结归纳的经验"></a>问题4 本次脚本有哪一些可以总结归纳的经验</h5><p>函数的定义</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键字 函数名 函数体</span></span><br><span class="line"><span class="keyword">function</span> this_function &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意 &#123;&#125; 前后均需要空格；</span></span><br><span class="line"><span class="comment"># function 可以缺省；</span></span><br><span class="line"><span class="comment"># 传参 $1 为第一个参数，$2为第二个参数</span></span><br></pre></td></tr></table></figure>

<p>服务器序列号查询</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serialnumber=$(dmidecode -t system |grep <span class="string">&quot;Serial Number&quot;</span> | awk -F <span class="string">&quot;: &quot;</span> <span class="string">&#x27; &#123;print $2&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="三期需求落地【待更新】"><a href="#三期需求落地【待更新】" class="headerlink" title="三期需求落地【待更新】"></a>三期需求落地【待更新】</h2><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《制作自动安装Ubuntu22.04-server的iso镜像以及安装过程详解》： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/luokeli0755/p/17861638.html">https://www.cnblogs.com/luokeli0755/p/17861638.html</a><br>《grub2详解(翻译和整理官方手册)》：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7094693.html">https://www.cnblogs.com/f-ck-need-u/p/7094693.html</a><br>《如何使用 autoinstall 编写和执行 Ubuntu 无人值守安装》：<a target="_blank" rel="noopener" href="https://cn.linux-console.net/?p=33717">https://cn.linux-console.net/?p=33717</a><br>《Ubuntu&#x2F;Debian无人值守 Autoinstall》：<a target="_blank" rel="noopener" href="https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html">https://gitbook.curiouser.top/origin/ubuntu-autoinstall.html</a><br>《配置界面存储的语法Storage》：<a target="_blank" rel="noopener" href="https://curtin.readthedocs.io/en/latest/topics/storage.html">https://curtin.readthedocs.io/en/latest/topics/storage.html</a><br>《Ubuntu的autoinstall自动安装配置》<a target="_blank" rel="noopener" href="https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html">https://scc.ustc.edu.cn/hmli/doc/linux/ubuntu-autoinstall/ubuntu-autoinstall.html</a><br>《ubuntu20.04打包iso镜像自动安装》 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/super-age/p/14952469.html">https://www.cnblogs.com/super-age/p/14952469.html</a><br>《Ubuntu无人值守安装保姆级教程》 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/1886733079500007398">https://zhuanlan.zhihu.com/p/1886733079500007398</a><br>《NoCloud》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html">https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html</a><br>《User-data formats》<a target="_blank" rel="noopener" href="https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats">https://cloudinit.readthedocs.io/en/latest/explanation/format.html#user-data-formats</a><br>《Autoinstall configuration reference manual》<a target="_blank" rel="noopener" href="https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html">https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html</a><br>《how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config》<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config">https://askubuntu.com/questions/1410553/how-to-disable-unattended-upgrades-during-autoinstall-user-data-cloud-config</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/46/">46</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"light","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
