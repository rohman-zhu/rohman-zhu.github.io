<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/8/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">463</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">152</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3fa89bd7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3fa89bd7/" class="post-title-link" itemprop="url">Horizon-599故障</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 01:14:06" itemprop="dateCreated datePublished" datetime="2024-04-01T01:14:06+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><ol>
<li>连接服务器、安全服务器无法连接TCP-443；</li>
<li>连接 https:&#x2F;&#x2F;安全服务器 ，显示599；</li>
<li>连接服务器的日志（C:\ProgramData\VMware\VDM\log\xxx.log），显示 MEMORY-ALARM:physical memory use &#x3D; 97% ,[ws_perfmon]High memory use….</li>
</ol>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>直接原因：服务器内存已经用满，出现内存泄漏的情况；<br>根本原因：出现补丁更新，未重启；</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>重启服务器。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/3f099f5a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/3f099f5a/" class="post-title-link" itemprop="url">Powershell实例-远程安装补丁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 00:49:57" itemprop="dateCreated datePublished" datetime="2024-04-01T00:49:57+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 14:00:34" itemprop="dateModified" datetime="2025-06-22T14:00:34+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><ol>
<li>给远端的服务器安装补丁；</li>
<li>检查是否需要重启；</li>
</ol>
<h1 id="实例脚本"><a href="#实例脚本" class="headerlink" title="实例脚本"></a>实例脚本</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Date:2024-03-31</span></span><br><span class="line"><span class="comment"># Version : v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global Veriable</span></span><br><span class="line"><span class="variable">$WINRM_PORT</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="comment"># Target Windows Update  inneed;</span></span><br><span class="line"><span class="variable">$TARGET_WUKB_ARRARY</span>=<span class="string">&quot;KB5035849&quot;</span>,<span class="string">&quot;KB5035849&quot;</span>;</span><br><span class="line"><span class="variable">$TARGETSERVER_List</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$PSCREDENTIAL</span>)&#123;<span class="variable">$PSCREDENTIAL</span>=<span class="built_in">Get-Credential</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-Log</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TYPE</span>,<span class="variable">$CONTENT</span>);</span><br><span class="line">    <span class="variable">$TIMESPAN1</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="variable">$TIMESPAN2</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> <span class="string">&quot;<span class="variable">$TYPE</span>.log&quot;</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check windows updates is installed</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-WindowsUpdate</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB_ARRARY</span>,<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="variable">$WU_CHECK_BLOCK</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB</span>);</span><br><span class="line">        <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">        <span class="variable">$INSTALL_KB_CHECK</span>=<span class="built_in">Get-HotFix</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.HotFixID <span class="operator">-match</span> <span class="variable">$TARGET_WUKB</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$INSTALL_KB_CHECK</span>)&#123;</span><br><span class="line">            <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$INSTALL_FLAG</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TARGET_WUKB_ARRARY</span>.Length;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$WU_PRE_CHECK_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ArgumentList</span> <span class="variable">$TARGET_WUKB_ARRARY</span>[<span class="variable">$i</span>] <span class="literal">-ScriptBlock</span> <span class="variable">$WU_CHECK_BLOCK</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;#注意 ArgumentList 无法传递数组；2024-03-31，废案；</span></span><br><span class="line"><span class="comment">    $WU_CHECK=&#123;</span></span><br><span class="line"><span class="comment">        param($TARGET_WUKB_ARRARY);</span></span><br><span class="line"><span class="comment">        $INSTALL_FLAG=$FALSE;</span></span><br><span class="line"><span class="comment">        for($i = 0; $i -lt $TARGET_WUKB_ARRARY.Length;$i++)&#123;</span></span><br><span class="line"><span class="comment">            $ISINSTALLED=Get-HotFix | Where-Object &#123;$_.HotFixID -match $TARGET_WUKB_ARRARY[$i]&#125;;</span></span><br><span class="line"><span class="comment">            if($null -eq $ISINSTALLED)&#123;</span></span><br><span class="line"><span class="comment">                $INSTALL_FLAG=$TRUE;</span></span><br><span class="line"><span class="comment">                Write-Host &quot;$(hostname) need install $($TARGET_WUKB_ARRARY[$i]);&quot;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return $INSTALL_FLAG;</span></span><br><span class="line"><span class="comment">    &#125;    </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    $READY_FLAG=Invoke-Command -Session $PSSESSION -ScriptBlock $WU_CHECK -ArgumentList $TARGET_WUKB_ARRARY;</span></span><br><span class="line"><span class="comment">    #&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to install windows update &quot;</span></span><br><span class="line">        <span class="built_in">Invoke-WuJob</span> <span class="literal">-ComputerName</span> <span class="variable">$PSSESSION</span>.ComputerName <span class="literal">-Script</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-IgnoreReboot</span> | <span class="built_in">Out-File</span> C:\InstallWindows.log&#125; <span class="literal">-RunNow</span> <span class="literal">-Confirm</span>:<span class="variable">$FALSE</span> <span class="literal">-ErrorAction</span> Ignore;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INSTALL-WU&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) don&#x27;t need to intall <span class="variable">$TARGET_WUKB_ARRARY</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check target windows server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-RebootStatus</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CHECK_REBOOT_BLOCK</span>=&#123;</span><br><span class="line">        <span class="comment">#$ISNEED_REBOOT=$FALSE;</span></span><br><span class="line">        <span class="variable">$ISNEED_REBOOT</span>=<span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISNEED_REBOOT</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$TRUE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$REBOOT_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$CHECK_REBOOT_BLOCK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$REBOOT_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to reboot&quot;</span>;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;REBOOT&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start check target server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-CheckTargetServer</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGETSERVER_LIST_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Content</span> <span class="variable">$TARGETSERVER_LIST_FILE</span> | <span class="built_in">ForEach-Object</span>&#123;</span><br><span class="line">        <span class="variable">$SERVERNAME</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Start connect to <span class="variable">$SERVERNAME</span> &quot;</span>;</span><br><span class="line">        <span class="variable">$SESSION</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$SERVERNAME</span> <span class="literal">-Port</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$PSCREDENTIAL</span>;</span><br><span class="line"></span><br><span class="line">        Check<span class="literal">-WindowsUpdate</span> <span class="variable">$TARGET_WUKB_ARRARY</span> <span class="variable">$SESSION</span>;</span><br><span class="line">        Check<span class="literal">-RebootStatus</span> <span class="variable">$SESSION</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-CheckTargetServer</span> <span class="variable">$TARGETSERVER_List</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>Invoke-Command 传参：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/talentzemin/p/16976197.html">https://www.cnblogs.com/talentzemin/p/16976197.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/add0804a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/add0804a/" class="post-title-link" itemprop="url">Powershell脚本实例-检查域账户状态并删除禁用账户</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-31 01:00:28" itemprop="dateCreated datePublished" datetime="2024-03-31T01:00:28+00:00">2024-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-22 14:05:40" itemprop="dateModified" datetime="2025-06-22T14:05:40+00:00">2025-06-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/Powershell/" itemprop="url" rel="index"><span itemprop="name">Powershell</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>目标： 通过WMRM将指令下发至远端服务器，删除该服务器内无效的用户配置（AD账户已被禁用），以释放空间；</p>
<ol>
<li>获取远端服务器的用户配置信息列表，路径为 C:\Users\；检查目标账户是否为停用状态；</li>
<li>若为停用状态的账户，则下发指令删除配置文件；</li>
</ol>
<h1 id="脚本思路"><a href="#脚本思路" class="headerlink" title="脚本思路"></a>脚本思路</h1><ol>
<li>向远端获取该服务器的用户列表 : Get-ChildItem -Path “C:\Users”;</li>
<li>判断账户是否停用: $USER_INFOS&#x3D;net user $TARGET_USERNAME &#x2F;domain;$USER_INFOS[7] - match “No”;</li>
<li>删除用户配置；</li>
</ol>
<h1 id="脚本实例"><a href="#脚本实例" class="headerlink" title="脚本实例"></a>脚本实例</h1><h2 id="第一版本-v1"><a href="#第一版本-v1" class="headerlink" title="第一版本 :v1"></a>第一版本 :v1</h2><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Date : 2024-3-30</span></span><br><span class="line"><span class="comment"># Version : v1</span></span><br><span class="line"><span class="comment">#requires -RunAsAdministrator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global veriable</span></span><br><span class="line"><span class="variable">$DOMAIN</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$TARGETSERVER_LIST</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$WINRM_PORT</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$PSCREDENTIAL</span>)&#123;<span class="variable">$PSCREDENTIAL</span>=<span class="built_in">Get-Credential</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function Delete user profile</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-DelUserProfile</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$TARGET_SERVER_PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$DELUSERPROFILE_BLOCK</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$DOMAIN</span>);</span><br><span class="line">        <span class="comment"># get user SID</span></span><br><span class="line">        <span class="variable">$USER_SID</span> = (<span class="built_in">New-Object</span> Security.Principal.NTAccount(<span class="variable">$DOMAIN</span>, <span class="variable">$TARGET_USERNAME</span>)).Translate([<span class="type">Security.Principal.SecurityIdentifier</span>]).Value;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Get-WmiObject</span> <span class="literal">-ClassName</span> Win32_UserProfile <span class="literal">-Filter</span> <span class="string">&quot;SID=&#x27;<span class="variable">$USER_SID</span>&#x27;&quot;</span> |</span><br><span class="line">        <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">            <span class="variable">$_</span>.Delete();</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span> &#x27;s profile dir has been deleted.&quot;</span></span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$TARGET_SERVER_PSSESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$DELUSERPROFILE_BLOCK</span> <span class="literal">-ArgumentList</span> <span class="variable">$TARGET_USERNAME</span>,<span class="variable">$DOMAIN</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check target user status;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-CheckUserStatus</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$TARGET_SERVER_PSSESSION</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Check on localfile</span></span><br><span class="line">    <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;NULL&quot;</span>;</span><br><span class="line">    <span class="comment">## Disabled user file check.</span></span><br><span class="line">    <span class="variable">$ISVALID</span>=<span class="built_in">Get-Content</span> disabled<span class="literal">-user</span>.list | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISVALID</span>)&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , cannot be found on disbaled-user.list.&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , was been found on disbaled-user.list.&quot;</span>;</span><br><span class="line">        <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;DISABLED&quot;</span>;</span><br><span class="line">        <span class="built_in">Start-DelUserProfile</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ISVALID</span>=<span class="built_in">Get-Content</span> enabled<span class="literal">-user</span>.list | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span>&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISVALID</span>)&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , cannot be found on enabled-user.list.&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , was been found on enabled-user.list.&quot;</span>;</span><br><span class="line">        <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;ENABLED&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;NULL&quot;</span> <span class="operator">-match</span> <span class="variable">$LOCAL_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$TARGET_USER_STATUS</span>=<span class="variable">$</span>(net user <span class="variable">$TARGET_USERNAME</span> /domain);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$TARGET_USER_STATUS</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;Yes&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Add-Content</span> enabled<span class="literal">-user</span>.list <span class="variable">$TARGET_USERNAME</span>;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> was enabled , add to enabled-user.list.&quot;</span></span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="variable">$TARGET_USER_STATUS</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;No&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Add-Content</span> disbaled<span class="literal">-user</span>.list <span class="variable">$TARGET_USERNAME</span>;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> was disabled , add to disabled-user.list.&quot;</span></span><br><span class="line">            <span class="built_in">Start-DelUserProfile</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start current mission</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-InvokeDelUserProfil</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGETSERVER_LIST_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init local file</span></span><br><span class="line">    <span class="built_in">Add-Content</span> enabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> disabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Clear-Content</span> enabled<span class="literal">-user</span>.list;</span><br><span class="line">    <span class="built_in">Clear-Content</span> disbaled<span class="literal">-user</span>.list;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start handle</span></span><br><span class="line">    <span class="built_in">Get-Content</span> <span class="variable">$TARGETSERVER_LIST_FILE</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">        <span class="variable">$TARGET_SERVERNAME</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Start handle target server : <span class="variable">$TARGET_SERVERNAME</span> . &quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$TARGET_SERVER_PSSESSION</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$TARGET_SERVERNAME</span> <span class="literal">-Port</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$PSCREDENTIAL</span>;</span><br><span class="line">        <span class="variable">$TARGET_USER_SET</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$TARGET_SERVER_PSSESSION</span> <span class="literal">-ScriptBlock</span> &#123;<span class="built_in">Get-ChildItem</span> <span class="string">&quot;C:\Users&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TARGET_USER_SET</span>.Length ; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$TARGET_USERNAME</span>=<span class="variable">$TARGET_USER_SET</span>[<span class="variable">$i</span>].Name;</span><br><span class="line">            <span class="built_in">Start-CheckUserStatus</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Archive user list;</span></span><br><span class="line">    <span class="variable">$TIMESPAN</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyyMMdd-HHmm&quot;</span>;</span><br><span class="line">    <span class="built_in">Rename-Item</span> enabled<span class="literal">-user</span>.list enabeld<span class="literal">-user-</span><span class="variable">$TIMESPAN</span>.list;</span><br><span class="line">    <span class="built_in">Rename-Item</span> disbaled<span class="literal">-user</span>.list disabled<span class="literal">-user-</span><span class="variable">$TIMESPAN</span>.list;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-InvokeDelUserProfil</span> <span class="variable">$TARGETSERVER_LIST</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="迭代升级版本-v2"><a href="#迭代升级版本-v2" class="headerlink" title="迭代升级版本 v2"></a>迭代升级版本 v2</h2><p>增加特性：账户状态为启用的，但是已经超过1年没有访问记录，则删除文件。</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment">Date:2025-06-22</span></span><br><span class="line"><span class="comment">Version:v2</span></span><br><span class="line"><span class="comment">Description:</span></span><br><span class="line"><span class="comment">1. Remove user profile folder;</span></span><br><span class="line"><span class="comment">2. Remove Out of date folder which over 365day not access record;</span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;# Global Variables#&gt;</span></span><br><span class="line"><span class="variable">$Global_Domain_Name</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$Gloabl_Winrm_Port</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$Global_Computer_Name_Index</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$Global_Out_of_Day</span>=<span class="number">365</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$Global_Winrm_Credential</span>)&#123;<span class="variable">$Global_Winrm_Credential</span>=<span class="built_in">Get-Credential</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;# Log Function #&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-Log</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$LOGTYPE</span>,<span class="variable">$LOG_CONTENT_TEMP</span>);</span><br><span class="line">    <span class="variable">$CURRENT_PATH</span>=(<span class="built_in">Get-Location</span>).Path;</span><br><span class="line">    <span class="variable">$LOGFILE</span>=<span class="string">&quot;<span class="variable">$</span>(<span class="variable">$CURRENT_PATH</span>)\\runtime.log&quot;</span>;</span><br><span class="line">    <span class="variable">$LOG_CONTENT_FIN</span>=<span class="string">&quot;<span class="variable">$</span>(Get-Date -Format &quot;</span>[<span class="type">yyyy</span>-<span class="type">MM</span>-<span class="type">dd</span>][<span class="type">HH</span>:<span class="type">mm</span>:<span class="type">ss</span>]<span class="string">&quot;)[<span class="variable">$LOGTYPE</span>],<span class="variable">$LOG_CONTENT_TEMP</span>;&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$LOGTYPE</span>):<span class="variable">$</span>(<span class="variable">$LOG_CONTENT_FIN</span>)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$</span>(<span class="built_in">Get-Item</span> <span class="variable">$LOGFILE</span>))&#123;</span><br><span class="line">        <span class="built_in">Add-Content</span> <span class="variable">$LOGFILE</span> <span class="string">&quot;<span class="variable">$</span>(Get-Date -Format &quot;</span>[<span class="type">yyyy</span>-<span class="type">MM</span>-<span class="type">dd</span>][<span class="type">HH</span>:<span class="type">mm</span>:<span class="type">ss</span>]<span class="string">&quot;)[INFO],Start create log file;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Add-Content</span> <span class="variable">$LOGFILE</span> <span class="variable">$LOG_CONTENT_FIN</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查C盘剩余空间占比</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-DriverFreeSpcaeUsage</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PS_SESSION</span>,<span class="variable">$DRIVER_NAME</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CodeBlock</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$DRIVER_NAME</span>)</span><br><span class="line">        <span class="variable">$Driver</span>=<span class="built_in">Get-PSDrive</span> <span class="literal">-Name</span> <span class="variable">$DRIVER_NAME</span>;</span><br><span class="line">        <span class="comment">#$Available_Space=$Driver.Free/$Driver.Used;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Driver</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Driver</span>=<span class="variable">$</span>(<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$CodeBlock</span> <span class="literal">-ArgumentList</span> <span class="variable">$DRIVER_NAME</span>; );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PS_SESSION</span>.ComputerName) driver <span class="variable">$</span>(<span class="variable">$DRIVER_NAME</span>):\ Total Space: <span class="variable">$</span>((<span class="variable">$Driver</span>.Free + <span class="variable">$Driver</span>.Used))&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PS_SESSION</span>.ComputerName) driver <span class="variable">$</span>(<span class="variable">$DRIVER_NAME</span>):\ Used Space: <span class="variable">$</span>(<span class="variable">$Driver</span>.Used)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PS_SESSION</span>.ComputerName) driver <span class="variable">$</span>(<span class="variable">$DRIVER_NAME</span>):\ Free Space: <span class="variable">$</span>(<span class="variable">$Driver</span>.Free)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PS_SESSION</span>.ComputerName) driver <span class="variable">$</span>(<span class="variable">$DRIVER_NAME</span>):\ Free Space percentage: <span class="variable">$</span>(<span class="variable">$Driver</span>.Free/(<span class="variable">$Driver</span>.Free + <span class="variable">$Driver</span>.Used))&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$Free_Space_Usage</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;# Check account Function #&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-UserActive</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$USERNAME</span>);</span><br><span class="line">    <span class="variable">$IS_ACTIVE</span>=<span class="variable">$FALSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$USERNAME</span>]Checking account status&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CHECK_CONTENT</span>=<span class="variable">$</span>(net user <span class="variable">$USERNAME</span> /domain);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$USERNAME</span>]CHECK_CONTENT:<span class="variable">$</span>(<span class="variable">$CHECK_CONTENT</span>)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$CHECK_CONTENT</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;YES&quot;</span>)&#123;</span><br><span class="line">        <span class="comment"># account status is enabled</span></span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$USERNAME</span> is active&quot;</span>;</span><br><span class="line">        <span class="variable">$IS_ACTIVE</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="variable">$CHECK_CONTENT</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;NO&quot;</span>)&#123;</span><br><span class="line">        <span class="comment"># account status is disabled</span></span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$USERNAME</span> is inactive&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment"># locked status , etc.</span></span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$USERNAME</span> status unknow&quot;</span>;</span><br><span class="line">        <span class="variable">$IS_ACTIVE</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$IS_ACTIVE</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-UserUnderList</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$Target_USER</span>,<span class="variable">$ENABLED_FILE</span>,<span class="variable">$DISABLED_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$FLAG_ENABLED_LIST</span>=<span class="variable">$</span>(<span class="built_in">Get-Content</span> <span class="variable">$ENABLED_FILE</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="variable">$Target_USER</span>&#125;);</span><br><span class="line">    <span class="variable">$FLAG_DISABLED_LIST</span>=<span class="variable">$</span>(<span class="built_in">Get-Content</span> <span class="variable">$DISABLED_FILE</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="variable">$Target_USER</span>&#125;);</span><br><span class="line">    <span class="variable">$FLAG_IS_Target_USER_ENABLED</span>=<span class="variable">$TRUE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$FLAG_ENABLED_LIST</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$DISABLED_FILE</span>) does not contain  <span class="variable">$Target_USER</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$FLAG_DISABLED_LIST</span>)&#123;</span><br><span class="line">            <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$ENABLED_FILE</span>) does not contain  <span class="variable">$Target_USER</span>&quot;</span>;</span><br><span class="line">            <span class="variable">$FLAG_IS_Target_USER_ENABLED</span>=<span class="variable">$</span>(Check<span class="literal">-UserActive</span> <span class="variable">$Target_USER</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$FLAG_IS_Target_USER_ENABLED</span>)&#123;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$Target_USER</span> is active&quot;</span>;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Write <span class="variable">$Target_USER</span> to <span class="variable">$</span>(<span class="variable">$ENABLED_FILE</span>)&quot;</span>;</span><br><span class="line">                <span class="built_in">Add-Content</span> <span class="variable">$ENABLED_FILE</span> <span class="variable">$Target_USER</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$Target_USER</span> is inactive&quot;</span>;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Write <span class="variable">$Target_USER</span> to <span class="variable">$</span>(<span class="variable">$DISABLED_FILE</span>)&quot;</span>;</span><br><span class="line">                <span class="built_in">Add-Content</span> <span class="variable">$DISABLED_FILE</span> <span class="variable">$Target_USER</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">Get-Log</span> <span class="string">&quot;[INFO]&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$DISABLED_FILE</span>) is contain <span class="variable">$Target_USER</span>&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;[INFO]&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$ENABLED_FILE</span>) is contain <span class="variable">$Target_USER</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除禁用状态用户的AD配置</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Invoke-RemoveInactieUserPorfile</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PS_SESSION</span>,<span class="variable">$Target_USER</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Code_Block</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$DOMAIN_NAME</span>,<span class="variable">$Target_USER</span>)</span><br><span class="line">        <span class="comment"># get user SID</span></span><br><span class="line">        <span class="variable">$sid</span> = (<span class="built_in">New-Object</span> Security.Principal.NTAccount(<span class="variable">$DOMAIN_NAME</span>, <span class="variable">$Target_USER</span>)).Translate([<span class="type">Security.Principal.SecurityIdentifier</span>]).Value</span><br><span class="line">        <span class="built_in">Get-WmiObject</span> <span class="literal">-ClassName</span> Win32_UserProfile <span class="literal">-Filter</span> <span class="string">&quot;SID=&#x27;<span class="variable">$sid</span>&#x27;&quot;</span> |</span><br><span class="line">        <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">            <span class="variable">$_</span>.Delete()</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$Code_Block</span> <span class="literal">-ArgumentList</span> <span class="variable">$Global_Domain_Name</span>,<span class="variable">$Target_USER</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除过期文件</span></span><br><span class="line"><span class="comment"># 过期：超过365天</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-TargetObjectIfOutOfDat</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TIME_SPAN</span>);</span><br><span class="line">    <span class="variable">$FLAG_IS_OVER_DAY</span>=<span class="variable">$FALSE</span>;</span><br><span class="line">    <span class="variable">$Temp_Timespan</span>=<span class="built_in">New-TimeSpan</span> <span class="variable">$TIME_SPAN</span> <span class="variable">$</span>(<span class="built_in">Get-Date</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$Temp_Timespan</span>.Days <span class="operator">-gt</span> <span class="variable">$Global_Out_of_Day</span>)&#123;</span><br><span class="line">        <span class="variable">$FLAG_IS_OVER_DAY</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$FLAG_IS_OVER_DAY</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Invoke-RemoveUserProfileByAccessTime</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PS_SESSION</span>,<span class="variable">$TARGET_USER</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Temp_Parent_Folder_Path</span>=<span class="string">&quot;C:\\users\\<span class="variable">$TARGET_USER</span>&quot;</span>;</span><br><span class="line">    <span class="variable">$Temp_Folder_Path_1</span>=<span class="string">&quot;<span class="variable">$Temp_Parent_Folder_Path</span>\\AppData&quot;</span>;</span><br><span class="line">    <span class="variable">$Temp_Folder_Path_2</span>=<span class="string">&quot;<span class="variable">$Temp_Folder_Path_1</span>\\Roaming&quot;</span>;</span><br><span class="line">    <span class="variable">$Temp_Folder_Path_3</span>=<span class="string">&quot;<span class="variable">$Temp_Folder_Path_1</span>\\Local&quot;</span>;</span><br><span class="line">    <span class="variable">$Temp_Folder_Path_4</span>=<span class="string">&quot;<span class="variable">$Temp_Folder_Path_1</span>\\LocalLow&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_1</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_2</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_3</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_4</span>)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Code_Block</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$Target_Path</span>);</span><br><span class="line">        <span class="variable">$Target_Object</span>=<span class="built_in">Get-Item</span> <span class="variable">$Target_Path</span> <span class="literal">-Force</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Target_Object</span>.LastAccessTime;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Temp_Folder_Object_1_LastAccessTime</span>=<span class="variable">$</span>(<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$Code_Block</span> <span class="literal">-ArgumentList</span> <span class="variable">$Temp_Folder_Path_1</span>;)</span><br><span class="line">    <span class="variable">$Temp_Folder_Object_2_LastAccessTime</span>=<span class="variable">$</span>(<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$Code_Block</span> <span class="literal">-ArgumentList</span> <span class="variable">$Temp_Folder_Path_2</span>;)</span><br><span class="line">    <span class="variable">$Temp_Folder_Object_3_LastAccessTime</span>=<span class="variable">$</span>(<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$Code_Block</span> <span class="literal">-ArgumentList</span> <span class="variable">$Temp_Folder_Path_3</span>;)</span><br><span class="line">    <span class="variable">$Temp_Folder_Object_4_LastAccessTime</span>=<span class="variable">$</span>(<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PS_SESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$Code_Block</span> <span class="literal">-ArgumentList</span> <span class="variable">$Temp_Folder_Path_4</span>;)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_1</span>) . LastAccessTime: <span class="variable">$</span>(<span class="variable">$Temp_Folder_Object_1_LastAccessTime</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_2</span>) . LastAccessTime: <span class="variable">$</span>(<span class="variable">$Temp_Folder_Object_2_LastAccessTime</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_3</span>) . LastAccessTime: <span class="variable">$</span>(<span class="variable">$Temp_Folder_Object_3_LastAccessTime</span>)&quot;</span>;</span><br><span class="line">    <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Checking folder : <span class="variable">$</span>(<span class="variable">$Temp_Folder_Path_4</span>) . LastAccessTime: <span class="variable">$</span>(<span class="variable">$Temp_Folder_Object_4_LastAccessTime</span>)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$</span>(<span class="built_in">Get-TargetObjectIfOutOfDat</span> <span class="variable">$Temp_Folder_Object_1_LastAccessTime</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="built_in">Get-TargetObjectIfOutOfDat</span> <span class="variable">$Temp_Folder_Object_2_LastAccessTime</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="built_in">Get-TargetObjectIfOutOfDat</span> <span class="variable">$Temp_Folder_Object_3_LastAccessTime</span>) <span class="operator">-and</span> <span class="variable">$</span>(<span class="built_in">Get-TargetObjectIfOutOfDat</span> <span class="variable">$Temp_Folder_Object_4_LastAccessTime</span>))&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;All object has over <span class="variable">$</span>(<span class="variable">$Global_Out_of_Day</span>)&quot;</span>;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Ready to remove target folder&quot;</span>;</span><br><span class="line">        <span class="comment"># Delete user profile</span></span><br><span class="line">        <span class="comment"># Invoke-RemoveInactieUserPorfile $PS_SESSION $TARGET_USER;</span></span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;All object not over <span class="variable">$</span>(<span class="variable">$Global_Out_of_Day</span>)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-Main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Init file</span></span><br><span class="line">    <span class="built_in">Add-Content</span> enabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> disabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">Clear-Content</span> enabled<span class="literal">-user</span>.list;</span><br><span class="line">    <span class="built_in">Clear-Content</span> disabled<span class="literal">-user</span>.list;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init PSession</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="number">1</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$Computer_Name</span>=<span class="string">&quot;<span class="variable">$</span>(<span class="variable">$Global_Computer_Name_Index</span>)<span class="variable">$i</span>&quot;</span>;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Start connect to <span class="variable">$Computer_Name</span>&quot;</span>;</span><br><span class="line">        <span class="variable">$Ps_session</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$Computer_Name</span> <span class="literal">-Port</span> <span class="variable">$Gloabl_Winrm_Port</span> <span class="literal">-Credential</span> <span class="variable">$Global_Winrm_Credential</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$Ps_session</span>)&#123;</span><br><span class="line">            <span class="built_in">Get-DriverFreeSpcaeUsage</span> <span class="variable">$Ps_session</span> <span class="string">&quot;C&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$UserList</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$Ps_session</span> <span class="literal">-ScriptBlock</span> &#123;<span class="built_in">Get-ChildItem</span> <span class="string">&#x27;C:\Users&#x27;</span>&#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$UserList</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">                <span class="variable">$Username</span>=<span class="variable">$_</span>;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$Computer_Name</span>]Start check user: <span class="variable">$Username</span>&quot;</span>;</span><br><span class="line">                Check<span class="literal">-UserUnderList</span> <span class="variable">$Username</span> enabled<span class="literal">-user</span>.list disabled<span class="literal">-user</span>.list;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">Get-Content</span> disabled<span class="literal">-user</span>.list | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">                <span class="variable">$Username</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$Computer_Name</span>]Start remove user profile: <span class="variable">$Username</span>&quot;</span>;</span><br><span class="line">                <span class="built_in">Invoke-RemoveInactieUserPorfile</span> <span class="variable">$Ps_session</span> <span class="variable">$Username</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Get-Content</span> enabled<span class="literal">-user</span>.list | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">                <span class="variable">$Username</span>=<span class="variable">$_</span>;</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$Computer_Name</span>]Start remove user profile which out of <span class="variable">$</span>(<span class="variable">$Global_Out_of_Day</span>)&quot;</span>.</span><br><span class="line">                <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;[<span class="variable">$Computer_Name</span>][<span class="variable">$Username</span>] Checking...&quot;</span></span><br><span class="line">                <span class="built_in">Invoke-RemoveUserProfileByAccessTime</span> <span class="variable">$Ps_session</span> <span class="variable">$Username</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Get-DriverFreeSpcaeUsage</span> <span class="variable">$Ps_session</span> <span class="string">&quot;C&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Timespan</span>=<span class="variable">$</span>(<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyyMMdd-HHmm&quot;</span>);</span><br><span class="line">    <span class="built_in">Rename-Item</span> enabled<span class="literal">-user</span>.list enabled<span class="literal">-user-</span><span class="variable">$Timespan</span>.list;</span><br><span class="line">    <span class="built_in">Rename-Item</span> disabled<span class="literal">-user</span>.list disabled<span class="literal">-user-</span><span class="variable">$Timespan</span>.list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-Main</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>删除配置文件：<a target="_blank" rel="noopener" href="https://blog.vichamp.com/2017/12/27/deleting-user-profiles/#:~:text=%E4%BB%A5%E4%B8%8B%E6%98%AF%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A%20%E9%A6%96%E5%85%88%EF%BC%8C%E8%B0%83%E6%95%B4%20%24domain%20%E5%92%8C%20%24username,%E5%8F%98%E9%87%8F%E6%8C%87%E5%90%91%E6%82%A8%E6%83%B3%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82%20%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8%20PowerShell%20%E4%B8%AD%E4%BB%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%89%B9%E6%9D%83%E8%BF%90%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%20123456789101112">https://blog.vichamp.com/2017/12/27/deleting-user-profiles/#:~:text=%E4%BB%A5%E4%B8%8B%E6%98%AF%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A%20%E9%A6%96%E5%85%88%EF%BC%8C%E8%B0%83%E6%95%B4%20%24domain%20%E5%92%8C%20%24username,%E5%8F%98%E9%87%8F%E6%8C%87%E5%90%91%E6%82%A8%E6%83%B3%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82%20%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8%20PowerShell%20%E4%B8%AD%E4%BB%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%89%B9%E6%9D%83%E8%BF%90%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%20123456789101112</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/f533adf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/f533adf/" class="post-title-link" itemprop="url">VPN配置-WireGuard配置实例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-22 23:16:31" itemprop="dateCreated datePublished" datetime="2024-03-22T23:16:31+00:00">2024-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求1–需求说明"><a href="#需求1–需求说明" class="headerlink" title="需求1–需求说明"></a>需求1–需求说明</h1><p>通过云服务器、VPN 隧道将内网的服务器打通，实现互联。</p>
<p>拓扑： 内网服务器 &lt;–VPN IPSec–&gt; 云服务器</p>
<h2 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装WireGuard</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu\Debian</span></span><br><span class="line">$ <span class="built_in">sudo</span> apt install wireguard</span><br><span class="line"></span><br><span class="line"><span class="comment"># RedHat 8</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line"><span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kmod-wireguard wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line"><span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm</span><br><span class="line"><span class="built_in">sudo</span> subscription-manager repos --<span class="built_in">enable</span> codeready-builder-for-rhel-8-$(<span class="built_in">arch</span>)-rpms</span><br><span class="line"><span class="built_in">sudo</span> yum copr <span class="built_in">enable</span> jdoss/wireguard</span><br><span class="line"><span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS8</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-utils epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=<span class="string">&quot;kernel-plus, kernel-plus-*&quot;</span> --<span class="built_in">setopt</span>=centosplus.enabled=1 --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel-core$/DEFAULTKERNEL=kernel-plus-core/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kernel-plus wireguard-tools</span><br><span class="line">$ <span class="built_in">sudo</span> reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=<span class="string">&quot;kernel-plus, kernel-plus-*&quot;</span> --<span class="built_in">setopt</span>=centosplus.enabled=1 --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel-core$/DEFAULTKERNEL=kernel-plus-core/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 3</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum config-manager --set-enabled PowerTools</span><br><span class="line">$ <span class="built_in">sudo</span> yum copr <span class="built_in">enable</span> jdoss/wireguard</span><br><span class="line">$ <span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-utils epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=kernel-plus --enablerepo=centosplus --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel$/DEFAULTKERNEL=kernel-plus/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kernel-plus wireguard-tools</span><br><span class="line">$ <span class="built_in">sudo</span> reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install epel-release elrepo-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-plugin-elrepo</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kmod-wireguard wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 3</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">$ <span class="built_in">sudo</span> curl -o /etc/yum.repos.d/jdoss-wireguard-epel-7.repo https://copr.fedorainfracloud.org/coprs/jdoss/wireguard/repo/epel-7/jdoss-wireguard-epel-7.repo</span><br><span class="line">$ <span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># MacOS</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line"> brew install wireguard-tools</span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ port install wireguard-tools</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="服务器节点说明"><a href="#服务器节点说明" class="headerlink" title="服务器节点说明"></a>服务器节点说明</h3><table>
<thead>
<tr>
<th align="center">角色</th>
<th align="center">公网IP</th>
<th align="center">VPN IP</th>
<th align="center">内网IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">公网服务器</td>
<td align="center">1.1.1.1</td>
<td align="center">192.168.1.1</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">内网服务器节点1</td>
<td align="center">-</td>
<td align="center">192.168.1.11</td>
<td align="center">192.168.2.11</td>
</tr>
<tr>
<td align="center">内网服务器节点2</td>
<td align="center">-</td>
<td align="center">192.168.1.12</td>
<td align="center">192.168.2.12</td>
</tr>
</tbody></table>
<blockquote>
<p>WireGuard TCP 端口 65535</p>
</blockquote>
<h3 id="服务器节点安装与配置"><a href="#服务器节点安装与配置" class="headerlink" title="服务器节点安装与配置"></a>服务器节点安装与配置</h3><h4 id="生成密钥对"><a href="#生成密钥对" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件"><a href="#配置-WireGuard-的配置文件" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>WireGuard 的配置文件一般情况下放在 &#x2F;etc&#x2F;wireguard 中，且为了安全考虑，需要将这个目录的所有者设置为 root，权限设置为 700。<br>一般情况下，配置文件可依次命名为 wgX.conf，其中 X 为任意的编号，wgX 最终也是创建出来的网络接口的名称。<br>此处，在服务端与客户端中，都将命名为 wg0.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line"><span class="comment"># 会自动添加至路由策略表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端节点安装与配置"><a href="#客户端节点安装与配置" class="headerlink" title="客户端节点安装与配置"></a>客户端节点安装与配置</h3><h4 id="生成密钥对-1"><a href="#生成密钥对-1" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-1"><a href="#配置-WireGuard-的配置文件-1" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>客户端与服务端不同的地方在于：</p>
<ul>
<li>Interface 配置中没有 ListenPort</li>
<li>Peer 即为服务端，与服务端不同的地方在于多了一个 Endpoint</li>
</ul>
<p>一般情况下，只有主动发起连接的端需要在 Peer 中指定 Endpoint，此处为服务器的公网 IP 和监听的端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端配置 ，Interface属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的 私钥；</span></span><br><span class="line">PrivateKey = Client private key</span><br><span class="line"><span class="comment"># 配置本端的内网IP；</span></span><br><span class="line">Address = 192.168.1.2/32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端，即服务器端，Peer属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 服务端的公钥；</span></span><br><span class="line">PublicKey = Server public key</span><br><span class="line"><span class="comment"># 允许对端的IP流量</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"><span class="comment"># 服务端的IP与端口；</span></span><br><span class="line">Endpoint = 1.1.1.1:28385</span><br><span class="line"><span class="comment"># 每10秒发送keepalive心跳；</span></span><br><span class="line">PersistentKeepalive = 10</span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<h1 id="需求2–需求说明"><a href="#需求2–需求说明" class="headerlink" title="需求2–需求说明"></a>需求2–需求说明</h1><p>通过云服务器、VPN 隧道将内网DMZ区的服务器打通，通过DMZ服务器转发流量包至内网，实现互联。</p>
<p>拓扑： 内网服务器&lt;–双网卡–&gt;内网DMZ服务器 &lt;–VPN IPSec–&gt; 云服务器</p>
<h2 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h2><h3 id="服务器节点说明-1"><a href="#服务器节点说明-1" class="headerlink" title="服务器节点说明"></a>服务器节点说明</h3><table>
<thead>
<tr>
<th align="center">角色</th>
<th align="center">公网IP</th>
<th align="center">VPN IP</th>
<th align="center">内网IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">公网服务器</td>
<td align="center">1.1.1.1</td>
<td align="center">192.168.1.1</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">内网DMZ服务器节点1</td>
<td align="center">-</td>
<td align="center">192.168.1.11</td>
<td align="center">192.168.2.11</td>
</tr>
<tr>
<td align="center">内网服务器节点2</td>
<td align="center">-</td>
<td align="center">192.168.1.12</td>
<td align="center">192.168.2.12</td>
</tr>
</tbody></table>
<blockquote>
<p>WireGuard TCP 端口 65535</p>
</blockquote>
<blockquote>
<p>公网服务器：因为作为VPN服务端，需开启流量转发，且需配置防火墙转发策略（集群内的节点若无通讯需求，可不用配置）；<br>内网DMZ服务器节点1：双网卡，因承担流量转发的角色，需要开启流量转发，且需要配置 SNAT 策略；</p>
</blockquote>
<h3 id="服务器节点安装与配置-1"><a href="#服务器节点安装与配置-1" class="headerlink" title="服务器节点安装与配置"></a>服务器节点安装与配置</h3><h4 id="生成密钥对-2"><a href="#生成密钥对-2" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-2"><a href="#配置-WireGuard-的配置文件-2" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>WireGuard 的配置文件一般情况下放在 &#x2F;etc&#x2F;wireguard 中，且为了安全考虑，需要将这个目录的所有者设置为 root，权限设置为 700。<br>一般情况下，配置文件可依次命名为 wgX.conf，其中 X 为任意的编号，wgX 最终也是创建出来的网络接口的名称。<br>此处，在服务端与客户端中，都将命名为 wg0.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line"><span class="comment"># 会自动添加至路由策略表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br></pre></td></tr></table></figure>

<p>需要补充端口转发流量，以及iptable进行放行；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放行wg0端口的VPN网段</span></span><br><span class="line">iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT </span><br><span class="line"><span class="comment"># 放行 VPN 转发到内网的流量</span></span><br><span class="line">iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT </span><br><span class="line"><span class="comment"># 放行内网 转发到 VPN 的流量</span></span><br><span class="line">iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT </span><br></pre></td></tr></table></figure>

<p>所以最终配置文件应该为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙策略</span></span><br><span class="line">PostUp = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line">PostUp = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT</span><br><span class="line">PostUP = iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT</span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端节点安装与配置-1"><a href="#客户端节点安装与配置-1" class="headerlink" title="客户端节点安装与配置"></a>客户端节点安装与配置</h3><h4 id="生成密钥对-3"><a href="#生成密钥对-3" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-3"><a href="#配置-WireGuard-的配置文件-3" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>客户端与服务端不同的地方在于：</p>
<ul>
<li>Interface 配置中没有 ListenPort</li>
<li>Peer 即为服务端，与服务端不同的地方在于多了一个 Endpoint</li>
</ul>
<p>一般情况下，只有主动发起连接的端需要在 Peer 中指定 Endpoint，此处为服务器的公网 IP 和监听的端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端配置 ，Interface属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的 私钥；</span></span><br><span class="line">PrivateKey = Client private key</span><br><span class="line"><span class="comment"># 配置本端的内网IP；</span></span><br><span class="line">Address = 192.168.1.2/32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 iptables 作为 SNAT</span></span><br><span class="line"><span class="comment"># --to-source 的IP作为内网中的IP地址；</span></span><br><span class="line">PostUp = iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 192.168.2.11</span><br><span class="line">PostUp = iptables -t nat -D POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 192.168.2.11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端，即服务器端，Peer属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 服务端的公钥；</span></span><br><span class="line">PublicKey = Server public key</span><br><span class="line"><span class="comment"># 允许对端的IP流量</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"><span class="comment"># 服务端的IP与端口；</span></span><br><span class="line">Endpoint = 1.1.1.1:28385</span><br><span class="line"><span class="comment"># 每10秒发送keepalive心跳；</span></span><br><span class="line">PersistentKeepalive = 10</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h1 id="WireGuard-的缺陷"><a href="#WireGuard-的缺陷" class="headerlink" title="WireGuard 的缺陷"></a>WireGuard 的缺陷</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ryanyangcs/p/14339053.html">https://www.cnblogs.com/ryanyangcs/p/14339053.html</a></p>
<h2 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h2><p>作为终端用户，其实无需考虑协议的复杂度。</p>
<p>如果复杂度真的影响很大，我们肯定早就摆脱 SIP、 H.323 和 FTP 等不能很好地应对NAT的协议了，然而并没有。讲道理，IPsec 比 WireGuard 更复杂是有原因的：它能做的事情太多了。<br>比如，使用用户名&#x2F;密码或带有 EAP 的 SIM 卡进行用户认证；也可以扩展新的加密方式。</p>
<p>而 WireGuard 呢？这些功能都没有。这就意味着当某一天它的固定的那些加密方式被破解或削弱了之后，就彻底崩盘了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WireGuard 在加密方式上比较偏执，故意砍掉了加密协议的敏捷性，不支持扩展加密协议，因为这么做会大大降低软件的复杂度。如果底层的加密协议出现了漏洞，只能更新所有端点来修复漏洞。</span><br></pre></td></tr></table></figure>

<h2 id="更新密钥"><a href="#更新密钥" class="headerlink" title="更新密钥"></a>更新密钥</h2><p>当 WireGuard 密钥更新后，每一个客户端需要更新配置文件中的 服务端的公钥；</p>
<h2 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h2><p>WireGuard 使用以下加密技术来保障数据的安全：</p>
<ul>
<li>使用 ChaCha20 进行对称加密，使用 Poly1305 进行数据验证。</li>
<li>利用 Curve25519 进行密钥交换。</li>
<li>使用 BLAKE2 作为哈希函数。</li>
<li>使用 HKDF 进行解密。</li>
</ul>
<p>而 IPSec 和 OpenVPN 使用的都是标准的 ChaCha20-Poly1305 加密算法。</p>
<p>BLAKE2算法是 BLAKE 算法的升级版，而 BLAKE 是 SHA-3 的入围者，与 SHA-2 非常相似，所以没有获奖。如果哪天 SHA-2 被破解了，BLAKE 也很有可能被破解。</p>
<p>IPSec 和 OpenVPN 使用的加密方式和 WireGuard 是类似的，比如对称加密使用的是标准的 ChaCha20-Poly1305 算法。唯一没有用到的就是 BLAKE2，因为它目前没有列入标准。即使不用 BLAKE2，也没什么大不了的，因为 VPN 是使用 HMACs 来保障数据的完整性，即使使用 MD5 也仍然没问题。</p>
<p>我的结论是：实际上所有的 VPN 都可以使用相同的加密技术，WireGuard 在加密或数据完整性方面并没有比其他的 VPN 更安全或更不安全。</p>
<p>然而白皮书上说了，加密不是重点，速度才是。</p>
<h1 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h1><h2 id="AllowedIPs-进行ACL-设置"><a href="#AllowedIPs-进行ACL-设置" class="headerlink" title="AllowedIPs 进行ACL 设置"></a>AllowedIPs 进行ACL 设置</h2><p>AllowedIPs控制了哪些流量允许使用该vpn，未匹配的流量会直连。个人翻墙时会使用全局VPN，但服务器之间连接时，基本不会把wiregaurd当做全局VPN使用。设置这里就非常方便。</p>
<p>AllowedIPs &#x3D; 0.0.0.0&#x2F;0,::&#x2F;0 表示所有ipv4及ipv6的流量都要走vpn，适合个人用户。<br>AllowedIPs &#x3D; 10.10.0.0&#x2F;24,192.168.1.0&#x2F;24 表示只有目的IP是这两个网段时走wireguard,其余流量走服务器默认的路由。</p>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>wireguard的客户端都会有连接的日志，查看wireguard服务器端日志只能通过查看内核日志的方方式，内核要支持Dynamic Debugging,正常情况下需编译内核开启CONFIG_DYNAMIC_DEBUG，有些发型版已经默认开启。可以执行以下命令进行查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mount | grep debug</span><br><span class="line">debugfs on /sys/kernel/debug <span class="built_in">type</span> debugfs (rw,relatime)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置开启调试日志</span></span><br><span class="line">modprobe wireguard </span><br><span class="line"><span class="built_in">echo</span> module wireguard +p &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line"> dmesg -wH</span><br><span class="line"> journalctl -kf</span><br></pre></td></tr></table></figure>

<h2 id="报错1-linux做为客户端时启动wireguard报错：-RTNETLINK-answers-Operation-not-supported"><a href="#报错1-linux做为客户端时启动wireguard报错：-RTNETLINK-answers-Operation-not-supported" class="headerlink" title="报错1: linux做为客户端时启动wireguard报错： RTNETLINK answers: Operation not supported"></a>报错1: linux做为客户端时启动wireguard报错： RTNETLINK answers: Operation not supported</h2><p>该报错需重启服务器或客户端</p>
<h2 id="报错2-vpn服务器ping客户端时报错：-ping-sendmsg-Required-key-not-available"><a href="#报错2-vpn服务器ping客户端时报错：-ping-sendmsg-Required-key-not-available" class="headerlink" title="报错2: vpn服务器ping客户端时报错： ping: sendmsg: Required key not available"></a>报错2: vpn服务器ping客户端时报错： ping: sendmsg: Required key not available</h2><p>该错最有可能是服务器端的peer部分AllowedIPs配置不对，网上一些教程使用SaveConfig&#x3D;true，该配置是在关闭或重启wireguard时才添加配置，导致如果客户端连接后如果服务器端未重启，就会出现该错误，不建议使用saveConfig&#x3D;true。</p>
<h2 id="报错3-服务器端ping客户端时提示：-ping-sendmsg-Destination-address-required"><a href="#报错3-服务器端ping客户端时提示：-ping-sendmsg-Destination-address-required" class="headerlink" title="报错3: 服务器端ping客户端时提示： ping: sendmsg: Destination address required"></a>报错3: 服务器端ping客户端时提示： ping: sendmsg: Destination address required</h2><p>一般是服务器端更改配置后，客户端未重新连接，客户端重新连接即可</p>
<h2 id="报错4-启动wireguard时报错：-Error-Unknown-device-type-Unable-to-access-interface-Protocol-not-supported-或执行-modprobe-wireguard-命令报错：-modprobe-FATAL-Module-wireguard-not-found-in-directory"><a href="#报错4-启动wireguard时报错：-Error-Unknown-device-type-Unable-to-access-interface-Protocol-not-supported-或执行-modprobe-wireguard-命令报错：-modprobe-FATAL-Module-wireguard-not-found-in-directory" class="headerlink" title="报错4: 启动wireguard时报错： Error: Unknown device type. Unable to access interface: Protocol not supported 或执行 modprobe wireguard 命令报错： modprobe: FATAL: Module wireguard not found in directory"></a>报错4: 启动wireguard时报错： Error: Unknown device type. Unable to access interface: Protocol not supported 或执行 modprobe wireguard 命令报错： modprobe: FATAL: Module wireguard not found in directory</h2><p>这个错误通常是因为升级内核导致的，wireguard的内核模块安装在旧版内核上，新内核没有wireguard模块，解决方法是卸载旧版内核、旧版kernel-header、旧版kernel-devel等,重新安装wireguard即可。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>WireGuard 安装说明： <a target="_blank" rel="noopener" href="https://www.wireguard.com/install/">https://www.wireguard.com/install/</a><br>使用 WireGuard 无缝接入内网: <a target="_blank" rel="noopener" href="https://devld.me/2020/07/27/wireguard-setup/">https://devld.me/2020/07/27/wireguard-setup/</a><br><a target="_blank" rel="noopener" href="https://blog.d0zingcat.dev/p/vpn-connect-work-home/">https://blog.d0zingcat.dev/p/vpn-connect-work-home/</a><br><a target="_blank" rel="noopener" href="https://opswill.com/articles/wireguard-howtos.html">https://opswill.com/articles/wireguard-howtos.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/e0587402/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/e0587402/" class="post-title-link" itemprop="url">vRops指标-数据存储卷</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-19 23:14:41" itemprop="dateCreated datePublished" datetime="2024-03-19T23:14:41+00:00">2024-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h1><p>数据存储卷：设备：所有实例的汇总：</p>
<ol>
<li>物理设备延迟(ms)</li>
<li>总延迟(ms)</li>
<li>内核延迟(ms)</li>
</ol>
<h1 id="数据存储卷的仪表盘"><a href="#数据存储卷的仪表盘" class="headerlink" title="数据存储卷的仪表盘"></a>数据存储卷的仪表盘</h1><p>仪表板–主页–性能–数据存储性能</p>
<blockquote>
<p>可以查看各个存储卷的性能以及虚拟机性能详情。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/ad183cc1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/ad183cc1/" class="post-title-link" itemprop="url">记录一次SAN存储控制器重启故障-VMware层影响</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-19 22:17:33" itemprop="dateCreated datePublished" datetime="2024-03-19T22:17:33+00:00">2024-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:49" itemprop="dateModified" datetime="2024-12-22T05:27:49+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h1><p>SAN存储触发的告警为：控制 Offline 告警邮件，显示 Node 1 失败（Node unexpectedly offline ）;<br>虚拟化层触发的告警为：StorageConnectivityAlarm;</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>SAN存储固件异常，导致控制器自行重启。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>升级SAN存储控制器固件至指定版本。</p>
<h2 id="关于ESXi多路径排查过程"><a href="#关于ESXi多路径排查过程" class="headerlink" title="关于ESXi多路径排查过程"></a>关于ESXi多路径排查过程</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入ESXi Shell</span></span><br><span class="line"><span class="comment"># 查看VMware kernel日志 ，路径为 /var/log/vmkernel.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找关键字 3470， CmdSN  xxx from world xxx to dev &quot;xxxx&quot; failed </span></span><br><span class="line"><span class="comment"># 参考 ：https://blog.csdn.net/Pespi_Co1a/article/details/111191902</span></span><br><span class="line"><span class="comment"># 参考 ： https://kb.vmware.com/s/article/1029039?lang=zh_cn</span></span><br><span class="line"><span class="comment"># H:0x0 , D0x2 ,P:0x0</span></span><br><span class="line"><span class="comment"># Host ID</span></span><br><span class="line"><span class="comment"># 0x0 当主机端不存在任何错误时，返回此状态。</span></span><br><span class="line"><span class="comment"># 0x01 如果与LUN的连接丢失，将返回此状态。【发生在LUN不再从阵列端对主机可见，或者如果与阵列的物理连接已被移除，则会发生这种情况】【https://kb.vmware.com/s/article/1003433?lang=zh_cn】</span></span><br><span class="line"><span class="comment"># 0x02 当HBA驱动程序无法项设备发出命令时，将返回此状态。【发生在环境中丢弃了FCP帧】</span></span><br><span class="line"><span class="comment"># 0x03 当正在对阵列执行的命令超时时，将返回此状态。</span></span><br><span class="line"><span class="comment"># 0x04 驱动程序对发生故障的目标中止命令后，将返回此状态。【通常发生在硬件错误时；如果向发生故障的目标ID发送命令也会出现】</span></span><br><span class="line"><span class="comment"># 0x05 如果驱动程序必须对目标中止的命令，将返回此状态。【命令超时或帧中出现奇偶校验错误】</span></span><br><span class="line"><span class="comment"># 0x06 将为一般错误反馈此状态。【针对其他错误（如数据超限或不足）未涵盖的事件而发生】</span></span><br><span class="line"><span class="comment"># 0x07 当由于存储器错误已重置设备时，将返回此状态。【通常过时的HBA固件，或者可能是发生故障的HBA】</span></span><br><span class="line"><span class="comment"># 0x08 遗留错误，不会返回。</span></span><br><span class="line"><span class="comment"># 0x0a 遗留错误，不会返回。</span></span><br><span class="line"><span class="comment"># 0x0b HBA驱动程序返回 DID_REQUEUE 命令，将返回此状态。【在接受到这个状态时，将重新发出I/O命令】</span></span><br><span class="line"><span class="comment"># 0x0c 由于暂时性错误，将返回此状态。【I/O命令将重新加入阵列并重新发出】</span></span><br><span class="line"><span class="comment"># 0x0d 当HBA驱动程序尝试中止命令（随后会对iocb ring中的所有命令设置IOSTAT_LOCAL_REJECT状态）时，将返回此状态。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Vital Product Data(VPD)</span></span><br><span class="line"><span class="comment"># https://kb.vmware.com/s/article/1010244?lang=zh_cn</span></span><br><span class="line"><span class="comment"># https://kb.vmware.com/s/article/289902?lang=zh_cn</span></span><br><span class="line"><span class="comment"># https://www.t10.org/lists/2asc.htm</span></span><br><span class="line"><span class="comment"># 0x80 ,设备序列号</span></span><br><span class="line"><span class="comment"># 0x83 ,设备标志号</span></span><br><span class="line"><span class="comment"># 0x85 ,管理网络地址</span></span><br><span class="line"><span class="comment"># 存储设备重新枚举期间，VMware ESX/ESXi VMkernel 向目标发送 SCSI 报告 LUN 命令 (0xa0) 以检索 LUN 列表，向每个 LUN 发送 SCSI 查询命令 (0x12) 以确定设备类型（磁盘、CD-ROM、USB 等）、设备品牌和型号以及设备支持的功能。</span></span><br><span class="line"><span class="comment"># 如果 SCSI 设备不支持某个 VPD 页面 VPD，它在响应此类请求时可能会出现错误。尤其是，它可能会返回 SCSI 状态 2（检查状况），其中，感知密匙为 5（非法请求），附加感知代码 (ASC) 和附加感知代码标识符 (ASCQ) 设置为 0x20/0x0 或 0x24/0x0。</span></span><br><span class="line"><span class="comment"># 1. 本地存储设备通常不支持 VPD 页面 0x83，从而无法用于裸设备映射 (RDM)。页面 0x83 的内容用作设备的唯一标识符。</span></span><br><span class="line"><span class="comment"># 2. CD 或 DVD-ROM 设备通常不支持 VPD 页面 0x80、0x83 或 0x85。</span></span><br><span class="line"><span class="comment"># 3. 一些设备控制器不支持报告 LUN。如果不存在 LUN 0 或报告的 SCSI 版本为 2 或更低版本，ESX/ESXi 主机会对此控制器上的 LUN 进行迭代扫描。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找关键字 lpfc_els_rcv_rscn </span></span><br><span class="line"><span class="comment"># https://kb.vmware.com/s/article/2151839?lang=zh_CN</span></span><br><span class="line"><span class="comment"># lpfc为驱动程序</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># [恢复] 查找关键之 Device .... performance has improved . I/O latency reduced from xxxx microseconds to xxx microseconds.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [恢复] lpfc : lpfc_reportStats: xxxxx Compression log for fcp target 8 , path is ok ,IO errors: busy 9 , retry xxxxx,no_connect xx,fcperr xxxx ,tmo x;</span></span><br><span class="line"><span class="comment"># https://kb.vmware.com/s/article/76350</span></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/d444b552/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/d444b552/" class="post-title-link" itemprop="url">Excel-常用公示</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-17 17:48:49" itemprop="dateCreated datePublished" datetime="2024-03-17T17:48:49+00:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="比较两个日期间隔多少小时"><a href="#比较两个日期间隔多少小时" class="headerlink" title="比较两个日期间隔多少小时"></a>比较两个日期间隔多少小时</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cell 1 = 2024-03-17 17:50</span><br><span class="line">cell 2 = 2024-03-28 20:00</span><br><span class="line"></span><br><span class="line">间隔天 = (cell2 - cell1) </span><br><span class="line">间隔小时 = (cell2 - cell1) * 24</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="比较两个日期间隔天、月、年"><a href="#比较两个日期间隔天、月、年" class="headerlink" title="比较两个日期间隔天、月、年"></a>比较两个日期间隔天、月、年</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cell 1 = 2024-03-17 17:50</span><br><span class="line">cell 2 = 2024-03-28 20:00</span><br><span class="line">天=datedif(cell1,cell2,&quot;d&quot;)</span><br><span class="line">月=datedif(cell1,cell2,&quot;m&quot;)</span><br><span class="line">天=datedif(cell1,cell2,&quot;d&quot;)</span><br></pre></td></tr></table></figure>

<h1 id="保留小数位"><a href="#保留小数位" class="headerlink" title="保留小数位"></a>保留小数位</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">round(number,num_digits)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/53d72df5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/53d72df5/" class="post-title-link" itemprop="url">Docker-学习记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-17 14:45:03" itemprop="dateCreated datePublished" datetime="2024-03-17T14:45:03+00:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:47" itemprop="dateModified" datetime="2024-12-22T05:27:47+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这段时间看到一位大佬的学习记录，因此这里有大部分内容是转载的。推荐看原文!!!</p>
<p>转载自：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/4286">https://www.zsythink.net/archives/4286</a></li>
</ul>
<h1 id="什么是Docker-与-安装-Docker"><a href="#什么是Docker-与-安装-Docker" class="headerlink" title="什么是Docker 与 安装 Docker"></a>什么是Docker 与 安装 Docker</h1><p>咱们还是以传统意义上的“虚拟机”作为切入点，假设，有一台物理服务器，我们把这台服务器当做宿主机，在宿主机上虚出了虚机A、虚机B等虚拟机，对于这些虚拟机来说，它们各自都独占了一套完整的操作系统，准确的说，应该是一套完整的“操作系统发行版”，注意，这里强调一下“发行版”三个字，以linux系统为例，组成一个“linux系统发行版”，首先需要有“linux内核”，其次还需要有相关软件依赖的运行环境软件包，比如说一些类库包、命令行工具等等，不同的linux发行版基于相同的linux内核开发，但是由于组成运行环境的包的不同，所以产生了不同的发行版，比如ubuntu和centos就是不同的linux发行版，对于虚机A和虚机B来说，它们各自拥有一套完整的操作系统（即使A和B都安装了centos7.9，本质上也是两个相互独立的操作系统），从隔离层面上来说，A和B之间是“linux系统发行版”的完整隔离，A和B都各自使用自己的内核和运行环境依赖包，各自使用自己的虚拟硬件，这是虚拟机在操作系统层面的隔离，理解上述概念，是避免搞混docker和传统虚拟化的关键。</p>
<p>现在再来聊聊docker，我们知道docker是一种容器引擎，docker运行容器的本质目的是去运行某个程序，docker通过应用程序镜像，安装并运行对应的程序，比如，我需要运行nginx，只需要下载对应的nginx镜像，docker就可以把这个nginx镜像运行成一个容器，容器把内部的nginx服务端口暴露出来，我们就可以访问nginx服务了，其他服务软件同理，在没有使用docker之前，看到“镜像”这个词，我又情不自禁的想到了虚拟机，只不过，虚拟机是通过“操作系统镜像”安装运行系统，docker是通过“应用程序镜像”安装运行对应的软件，当我搜索docker和虚拟机有什么不同的时候，我看到了下面这张图</p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2022/01/16421268329864.jpg" alt="Docker与虚拟机区别"></p>
<p>从上图来看，每个虚拟机都有自己的完整的操作系统（上图的GUEST OS就是虚拟机的操作系统，但是此处，我们应该把它拆成两部分理解，GUEST OS是由其内核和运行环境包组成的），VM1虚拟机上的所有APP使用的是同一套运行库和内核，其他虚拟机同理，Hypervisor层对硬件资源进行划分，各个虚拟机在整个操作系统发行版层面进行了隔离，而容器则不同，容器是将APP和其需要依赖的运行库打包成一个镜像，在APP进程和运行库层面进行了隔离（上图中CONTAINER中的APP就是应用程序镜像，这个镜像中包含应用本身和其需要的运行时依赖包），不同的APP各自使用自己的运行时环境，容器所运行的镜像中不需要内核，所有容器共用所在主机HostOS的内核，统一通过HostOS的内核与硬件进行交互，docker就是运行在HostOS中的容器引擎，理解了上图以后，我们就能明显感觉到它们的区别了，上图中最凸显的区别就是隔离层面的不同，虚拟机是针对整个系统发行版层面的隔离，而容器则是对程序进程和其依赖的运行环境的隔离，虚拟机的隔离性更强，隔离范围大，容器的隔离性没有虚拟机强，但是隔离范围更小，容器并不涉及Hypervisor层，它是一种进程隔离技术，从这个方面讲，它不应该算做“传统虚拟化”的范围，人们愿意把它称之为容器“虚拟化”技术，我觉得是因为容器更偏向于“java虚拟机”或者“python虚拟环境”这种软件意义上的“虚拟”，所以说，容器并不会取代虚拟机，它们之间也并不冲突，它们应该是相辅相成的。</p>
<p>把应用程序和其运行时依赖库打包隔离的好处有哪些呢？首先，由于隔离的范围更小了，所以当出现问题时，影响的范围也会更小，只会影响这个应用程序容器的进程本身，而不是其他程序的容器和HOST操作系统，其次，由于应用程序和其依赖的运行时环境是打包在一起的（打包成一个docker镜像），这就表示，如果一个程序的镜像在我的centos7上能够运行，那么在你的centos7上用也能够正常运行，不会出现某个程序在开发人员的笔记本中可以运行，但是放在服务器上就不能正常运行的情况（因为服务器上可能没有安装程序所依赖的包），这就是把程序和依赖打包在一起的好处。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Ubuntu 安装Docker</span></span><br><span class="line"><span class="comment"># 参考 https://docs.docker.com/desktop/install/ubuntu/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 Docker 源</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install ca-certificates curl -y</span><br><span class="line"><span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line"><span class="built_in">sudo</span> curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.asc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the repository to Apt sources:</span></span><br><span class="line"><span class="built_in">echo</span> </span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(. /etc/os-release &amp;&amp; echo <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | </span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Docker GUI 版本</span></span><br><span class="line">apt-get install ./docker-desktop-&lt;vsersion&gt;-&lt;<span class="built_in">arch</span>&gt;.deb</span><br><span class="line">apt-get install ./docker-desktop-4.28.0-amd64.deb</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository</span></span><br><span class="line"> <span class="built_in">sudo</span> apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="初始化-仓库、镜像、容器"><a href="#初始化-仓库、镜像、容器" class="headerlink" title="初始化 仓库、镜像、容器"></a>初始化 仓库、镜像、容器</h1><p>参考 <a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/4302">https://www.zsythink.net/archives/4302</a></p>
<p>从docker hub默认仓库获取镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 表示从docker hub的nginx官方仓库中拉取tag为latest的镜像（即从nginx官方仓库中拉取最新版本的nginx镜像</span></span><br><span class="line">docker pull docker.io/library/nginx:latest</span><br><span class="line"><span class="comment"># 等效于 </span></span><br><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>

<p>关于 URL ： docker.io&#x2F;library&#x2F;nginx:latest<br><img src="https://www.zsythink.net/wp-content/uploads/2022/02/16443754787791.jpg" alt="Docker URL"></p>
<p>第1部分 docker.io ：代表从哪个仓库服务中心下载镜像，docker.io就是官方的仓库服务中心（其实就是docker hub，官方的仓库服务器），这个仓库服务器中有很多组织，也有很多个人，每个组织或者个人都可以在这个仓库服务器创建仓库，然后把镜像存放在仓库中，前文说过，docker hub的官网地址是registry.hub.docker.com，这个地址是方便我们从web页面查找镜像使用的，使用命令行从docker hub拉取镜像时，默认使用的是docker.io这个地址。除了docker官方的docker hub，还有一些其他仓库服务器，我们也可以自建仓库服务器，当使用其他仓库服务器或者自建仓库服务器时，要把第1部分改为对应的域名或IP，如果我们就是想要从官方的docker hub下载镜像，上图中的第1部分可以不写，当省略第1部分时，默认就是使用docker.io这个仓库服务器的，仓库服务或者仓库服务中心的英文原文是registry，简单来说，第1部分就是registry的地址。</p>
<p>第2部分 library：代表组织或者个人的“命名空间”，命名空间是什么意思呢？举个例子，我们每个人都可以docker hub上注册自己的账号，然后使用自己的账号在docker hub上创建仓库，比如，我在docker hub上的账号id是zsythink，那么我就可以在docker hub的zsythink命名空间下创建仓库，如果我创建了一个名为nginx的仓库，那么我就可以通过如下url，获取到这个nginx仓库中的镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker.io/zsythink/nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>library，这个命名空间比较特殊，library是专门给上游软件提供商官方使用的命名空间，比如，nginx官方（或者说nginx组织）的nginx的仓库，并不会使用docker.io&#x2F;nginx&#x2F;nginx，而是会使用docker.io&#x2F;library&#x2F;nginx，同理，redis官方的redis仓库，也不会使用docker.io&#x2F;redis&#x2F;redis，而是会使用docker.io&#x2F;library&#x2F;redis，官方仓库中的镜像被称之为官方镜像，docker有一个专门的团队，负责审核和发布官方镜像，这个团队会与软件提供商、社区以及安全专家合作，共同维护这些官方仓库中的镜像，官方镜像的更多内容，可以参考如下链接<a target="_blank" rel="noopener" href="https://docs.docker.com/docker-hub/official_images%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E4%BB%8E%E5%AE%98%E6%96%B9%E4%BB%93%E5%BA%93%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%97%B6%EF%BC%8C%E6%98%AF%E5%8F%AF%E4%BB%A5%E7%9C%81%E7%95%A5library%E7%9A%84%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%8C%E6%88%91%E6%83%B3%E8%A6%81%E7%9B%B4%E6%8E%A5%E4%BB%8Edocker">https://docs.docker.com/docker-hub/official_images，当我们想要从官方仓库下载镜像时，是可以省略library的，比如，我想要直接从docker</a> hub的nginx官方仓库中下载镜像，可以直接使用docker pull nginx命令，此命令等效于docker pull docker.io&#x2F;library&#x2F;nginx，需要注意，只有官方仓库可以省略（即只有library可以省略），其他组织或者个人的命名空间不能省略。</p>
</blockquote>
<p>第3部分 nginx：代表仓库名，在介绍第2部分时，我们已经描述的比较清楚了，我们可以在自己的命名空间下创建很多仓库，比如nginx仓库、redis仓库等，nginx仓库专门用来存放nginx镜像，redis仓库专门用来存放redis镜像，创建仓库时，我们可以选择是否公开仓库，如果不公开，只有通过认证后，才能够获取仓库中的镜像，仓库的英文原文为repository，简单来说，第3部分就是repository的名字。</p>
<p>第4部分 latest：代表镜像对应的标签（tag），通常情况下，我们会通过标签对镜像的版本进行区分，比如，nginx仓库中有十个nginx镜像，第一个nginx镜像对应的版本为nginxV1.1，第二个nginx镜像对应的版本为nginxV1.2，那么第一个镜像的tag就是1.1，第二个镜像的tag就是1.2，以此类推，当我们在拉取镜像时，如果没有指定tag，默认会使用”latest”作为tag，也就是图例中第4部分的标签，”latest”表示最新版，当省略标签或者标签为latest时，会从仓库中下载最新版本的镜像，但是今天的最新版可能就是明天的旧版本，所以，在生产环境中，不要使用latest这个tag，或者说，不要省略tag，最好是指定一个明确的版本tag，这样做是为了防止”latest”这个特殊的tag对应的镜像发生了更新。tag和仓库名之间需要用冒号隔开，比如，nginx:1.21表示nginx库中的tag为1.21的镜像。</p>
<p>启动镜像，基于nginx:latest这个镜像，创建一个名为nginx-demo的容器，并启动这个容器，-d表示后台运行这个容器，-p 80:80表示将docker主机的80端口和容器内nginx服务的80端口进行映射，映射后，访问docker主机的80端口，即相当于访问容器内的nginx服务的80端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx-demo -d -p 80:80 nginx:latest</span><br></pre></td></tr></table></figure>

<h1 id="与Docker交互"><a href="#与Docker交互" class="headerlink" title="与Docker交互"></a>与Docker交互</h1><p>已有一个名为 nginx-demo 的容器，需要进入容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx-demo /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># -i参数表示interactive，即交互模式。</span></span><br><span class="line"><span class="comment"># -t参数表示分配一个伪终端。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行上述命令后，命令提示符会从host主机的提示符变成了容器的提示符（host主机就是容器所在的主机</span></span><br><span class="line">[root@kvm32docker2 ~]# docker <span class="built_in">exec</span> -it nginx-demo /bin/bash</span><br><span class="line">root@55e0b2020fc0:/# </span><br><span class="line">root@55e0b2020fc0:/# </span><br></pre></td></tr></table></figure>

<blockquote>
<p>55e0b2020fc0为容器的ID</p>
</blockquote>
<p>修改Docker内的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1，将文件拷贝出来做修改操作</span></span><br><span class="line">docker <span class="built_in">cp</span> nginx-demo:/etc/nginx/nginx.conf ./</span><br><span class="line"><span class="comment"># 修改完毕后，拷贝回去</span></span><br><span class="line">docker <span class="built_in">cp</span> ./nginx.conf nginx-demo:/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2，进入docker，执行修改指令</span></span><br><span class="line">docker <span class="built_in">exec</span> -it nginx-demo /bin/bash</span><br><span class="line">vi [target.file]</span><br></pre></td></tr></table></figure>

<h2 id="关于进程隔离"><a href="#关于进程隔离" class="headerlink" title="关于进程隔离"></a>关于进程隔离</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/4321">https://www.zsythink.net/archives/4321</a></p>
<p>在host主机中通过docker top命令查询出的pid，和在容器中通过ps命令查询出的pid不同，前文说过，docker的本质是一种进程隔离技术，docker是通过Linux内核的namespace功能实现PID的隔离的，pid namespace将host上的PID映射为容器内的PID，这样可以让不同的PID namespace中存在相同的进程号，并控制进程间的关系。</p>
<p>这样说可能不太容易理解，咱们换个方式解释一下，假设，现在有两个容器，一个nginx容器，一个redis容器，在nginx容器中，nginx的master进程的pid为1，在redis容器中，redis-server进程的pid为1，对于nginx-master进程或者redis-server进程来说，它们都以为自己是这个世界上的王者，因为它们只能看到自己的世界，而且在自己看到的世界中，自己是主进程（PID为1）。</p>
<p>其实，它们都只不过是host主机中的一个普通进程罢了，nginx容器的master进程在host主机中的PID可能是1234，redis容器中的server进程在host主机中的PID可能是5678，即使在各自的容器中，它们的PID都是1，也许这就是pid namespace进程隔离最直观的感受吧。所以，docker top命令查看的是容器进程在host中的pid，在容器内执行ps命令查看的是容器进程在容器内的pid。</p>
<h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><p>镜像来源：</p>
<ol>
<li>官方镜像库；</li>
<li>自定义镜像；</li>
</ol>
<p>自定义镜像流程：</p>
<ol>
<li>初始化一个容器</li>
<li>进入容器做自定义修改</li>
<li>打包镜像</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line">docker run -td --name alpine-test alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it alpine-test sh</span><br><span class="line">apk add nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">docker commit -p -c <span class="string">&#x27;CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]&#x27;</span> alpine-test zsythink/nginx:test1</span><br><span class="line"><span class="comment"># docker commit 提交容器为镜像</span></span><br><span class="line"><span class="comment"># 基于 alpine-test 创建名为 zsythink/nginx:test1 的镜像</span></span><br><span class="line"><span class="comment"># 上例标签中的zsythink是作者在docker hub上注册的账号ID，zsythink/nginx表示zsythink账号下名为nginx的仓库，完整的写法应该是docker.io/zsythink/nginx:test1，表示docker hub上zsythink账户下nginx仓库中的tag为test1的镜像，但是由于是docker hub上的仓库，所以可以省略registry地址，于是就写成了zsythink/nginx:test1</span></span><br><span class="line"><span class="comment"># -c选项用于设定镜像的各种参数，上例-c选项的值为&#x27;CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]&#x27;，表示将镜像的默认运行的程序设置为nginx</span></span><br></pre></td></tr></table></figure>


<h2 id="Docker-构建新镜像"><a href="#Docker-构建新镜像" class="headerlink" title="Docker 构建新镜像"></a>Docker 构建新镜像</h2><p>基于现有的镜像，重新封装一个新的镜像；需要有原始镜像，并且需要有dockerfile文件</p>
<p>以下为基于node最新镜像，封装安装一个hexo博客引擎镜像；</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> your_name &lt;your_mail&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /hexo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Hexo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install hexo-cli -g</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> hexo init .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置git</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.name <span class="string">&quot;your_name&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.email <span class="string">&quot;your_mail&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 映射端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>文件写完后，执行指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;hexo:latest&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>编译完成后，会出现镜像 hexo:latest</p>
</blockquote>
<h2 id="Docker-Compose-应用"><a href="#Docker-Compose-应用" class="headerlink" title="Docker Compose 应用"></a>Docker Compose 应用</h2><p>将一些列动作打包至一个配置文件中，并将最终的docker以服务的方式运行。</p>
<blockquote>
<p>先决条件：涉及镜像封装，需要有dockerfile ；</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置一个hexo的compose文件</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">blog:</span></span><br><span class="line">    <span class="comment"># 如果镜像有异常就直接执行重启</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">        <span class="comment"># 涉及构建，dockerfile所在的文件夹为context属性，即为上下文</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">hexo_docker</span></span><br><span class="line">        <span class="comment"># 对应的dockerfile</span></span><br><span class="line">        <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="comment"># 构建完的镜像名</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextblog:24</span></span><br><span class="line">    <span class="comment"># 新起的docker服务名</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">temp_simple_test</span></span><br><span class="line">    <span class="comment"># 映射端口</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4000:4000&quot;</span></span><br><span class="line">    <span class="comment"># 映射的目录</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">$PWD:/hexo</span></span><br></pre></td></tr></table></figure>

<p>检查compose过程中的报错日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f --<span class="built_in">tail</span>=50 </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/37b1e185/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/37b1e185/" class="post-title-link" itemprop="url">Docker-常用指令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-17 14:41:00" itemprop="dateCreated datePublished" datetime="2024-03-17T14:41:00+00:00">2024-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-28 12:19:13" itemprop="dateModified" datetime="2025-02-28T12:19:13+00:00">2025-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure>

<h1 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull [image name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加代理</span></span><br><span class="line">docker pull dockerproxy.cn/[image name]:[version]</span><br></pre></td></tr></table></figure>

<h1 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --name [docker name] -d -p [host port]:[dokcer port] [image name]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run  -td --name [docker name] -d -p [host port]:[dokcer port] [image name]</span><br><span class="line"><span class="comment"># -t表示为容器分配伪终端</span></span><br><span class="line"><span class="comment"># -d表示让容器在后台运行</span></span><br><span class="line"><span class="comment"># 如果只是用-t选项，不使用-d选项，为容器分配的伪终端会直接占用host的命令行，所以，-t选项配合-d选项，让容器在后台运行，可以避免容器一直占用host的命令行窗口，并持续运行容器。</span></span><br><span class="line"><span class="comment"># 如果只使用-d选项，不使用-t选项，会无法正常运行容器，原因是pid为1的主进程结束时，容器也会自动停止，具体情况是这样的，这些操作系统类的基础镜像默认运行的程序通常都是shell，比如bash，也就是说，bash是容器中的主进程，pid是1，如果不使用-t选项为bash分配伪终端，单独执行bash命令后，bash进程就直接结束了（没有绑定任何终端，相当于执行bash命令后一闪而过，没有任何输入输出，直接结束进程）</span></span><br></pre></td></tr></table></figure>

<h1 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h1 id="下载Docker或上传文件至Docker"><a href="#下载Docker或上传文件至Docker" class="headerlink" title="下载Docker或上传文件至Docker"></a>下载Docker或上传文件至Docker</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">docker <span class="built_in">cp</span> [Docker]:/..../target.file  ./</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line">docker ./target.file [Docker]:/..../target.file </span><br></pre></td></tr></table></figure>

<h1 id="与容器交互"><a href="#与容器交互" class="headerlink" title="与容器交互"></a>与容器交互</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以bash进行交互</span></span><br><span class="line">docker <span class="built_in">exec</span> -it [docker name] /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出，结束当前终端</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="comment"># 退出，不结束当前终端</span></span><br><span class="line">Ctrl + p + q</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker exec命令指定在nginx-demo中运行ls -l /etc/nginx/命令，并将容器内的运行结果返回到当前的命令行中，从而查看到了容器内部/etc/nginx/目录中的信息。</span></span><br><span class="line">docker <span class="built_in">exec</span> nginx-demo <span class="built_in">ls</span> -l /etc/nginx/</span><br></pre></td></tr></table></figure>

<h1 id="关闭容器"><a href="#关闭容器" class="headerlink" title="关闭容器"></a>关闭容器</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop [docker name]</span><br><span class="line">docker <span class="built_in">kill</span> --signal=HUP [docker name]</span><br></pre></td></tr></table></figure>

<h1 id="查看docker对象的详细信息"><a href="#查看docker对象的详细信息" class="headerlink" title="查看docker对象的详细信息"></a>查看docker对象的详细信息</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect [docker name]</span><br></pre></td></tr></table></figure>

<h1 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要先停止运行的容器才能删除目标容器</span></span><br><span class="line">docker <span class="built_in">rm</span> [docker name]</span><br><span class="line">docker ps</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<h1 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi [image name]</span><br></pre></td></tr></table></figure>

<h1 id="修改镜像的标签"><a href="#修改镜像的标签" class="headerlink" title="修改镜像的标签"></a>修改镜像的标签</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag [旧镜像名称]:[旧标签] [新镜像标签]:[新标签]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个动作会保留原有的标签，同时克隆一个新的标签；</span></span><br><span class="line"><span class="comment"># 可以将旧的标签删除 docker rmi [旧镜像名称]:[旧标签]</span></span><br></pre></td></tr></table></figure>

<h1 id="构建自己的镜像"><a href="#构建自己的镜像" class="headerlink" title="构建自己的镜像"></a>构建自己的镜像</h1><p>Dockerfile 是用于定义和构建 docker 镜像的文本文件。<br>包含一些指令与参数，用于描述镜像的构建过程，包含基础镜像、软件安装包、文件拷贝、环境变量设置；</p>
<p>编写规则：</p>
<ol>
<li>每一个执行指令，均为大写字母，且需要跟随参数；</li>
<li>文件按照由上至下执行；</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考 https://chunchengwei.github.io/ruan-jian/ji-yu-docker-de-hexo-bo-ke-da-jian/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 先要有一个基础镜像</span></span><br><span class="line">docker pull node:10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 编写docker的构建文件</span></span><br><span class="line"><span class="comment"># 命名为Dockerfile</span></span><br><span class="line"><span class="comment"># 文件内容： </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># *****************************************************************************</span></span><br><span class="line"><span class="comment"># File Name: Dockerfile</span></span><br><span class="line"><span class="comment"># Auther: Chuncheng Wei</span></span><br><span class="line"><span class="comment"># Email: weicc1989@gmail.com</span></span><br><span class="line"><span class="comment"># Created Time: Fri Nov 30 23:08:07 2018</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     This bases on node:10 image</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># *****************************************************************************</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line">FROM node:10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line">MAINTAINER your_name &lt;your_mail&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line">WORKDIR /hexo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Hexo</span></span><br><span class="line">RUN npm install hexo-cli -g</span><br><span class="line">RUN hexo init .</span><br><span class="line">RUN npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置git</span></span><br><span class="line">RUN git config --global user.name <span class="string">&quot;your_name&quot;</span></span><br><span class="line">RUN git config --global user.email <span class="string">&quot;your_mail&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 映射端口</span></span><br><span class="line">EXPOSE 4000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开始构建</span></span><br><span class="line">docker build -t <span class="string">&quot;新镜像名:版本号&quot;</span>  -f ./Dockerfile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="普通用户执行-Docker-指令"><a href="#普通用户执行-Docker-指令" class="headerlink" title="普通用户执行 Docker 指令"></a>普通用户执行 Docker 指令</h1><p>非root用户执行docker指令，会提示 “permission denied while trying to connect to the Docker daemon socket at…”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gpasswd -a [User] docker</span><br><span class="line"></span><br><span class="line">newgrp docker</span><br><span class="line"><span class="comment"># newgrp 命令更改用户的实型组标识。 运行该命令时，系统将使您处于一个新的 shell 中，并且将您的实型组名称更改为用 Group 参数指定的组。 缺省情况下，newgrp 命令将您的实型组更改为 /etc/passwd 文件中所指定的组。</span></span><br><span class="line"><span class="comment"># https://www.ibm.com/docs/zh/aix/7.3?topic=n-newgrp-command</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新登录后，就可以执行docker指令</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/posts/c153b50a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/posts/c153b50a/" class="post-title-link" itemprop="url">Python程序实例-Selenium应用-获取页面信息</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-16 18:11:15" itemprop="dateCreated datePublished" datetime="2024-03-16T18:11:15+00:00">2024-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-12-22 05:27:48" itemprop="dateModified" datetime="2024-12-22T05:27:48+00:00">2024-12-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E7%BC%96%E7%A8%8B/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h1><p>需要进入多个页面获取信息内容，并输出至文本，用于后期Excel数据展示。</p>
<h1 id="涉及知识点"><a href="#涉及知识点" class="headerlink" title="涉及知识点"></a>涉及知识点</h1><h2 id="Python-逐行读取文件"><a href="#Python-逐行读取文件" class="headerlink" title="Python 逐行读取文件"></a>Python 逐行读取文件</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方案1</span></span><br><span class="line"><span class="comment"># 全部读取</span></span><br><span class="line">FILE=<span class="built_in">open</span>(<span class="string">&quot;TEST.demo&quot;</span>)</span><br><span class="line"><span class="comment"># read()表示一次性读取文件全部内容</span></span><br><span class="line">LINE=FILE.read()</span><br><span class="line"><span class="built_in">print</span>(LINE)</span><br><span class="line">FILE.<span class="built_in">open</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案2</span></span><br><span class="line"><span class="comment"># 逐行读取</span></span><br><span class="line">FILE=<span class="built_in">open</span>(<span class="string">&quot;TEST.demo&quot;</span>)</span><br><span class="line">LINE=FILE.readline()</span><br><span class="line"><span class="keyword">while</span> LINE:</span><br><span class="line">    <span class="built_in">print</span>(LINE)</span><br><span class="line">    LINE=FILE.readline()</span><br><span class="line">FILE.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案3</span></span><br><span class="line"><span class="comment"># 读取所有行</span></span><br><span class="line">FILE=<span class="built_in">open</span>(<span class="string">&quot;TEST.demo&quot;</span>)</span><br><span class="line">LINES=FILE.readlines()</span><br><span class="line"><span class="keyword">for</span> LINE <span class="keyword">in</span> LINES:</span><br><span class="line">    <span class="built_in">print</span>(LINE)</span><br><span class="line">    LINE=FILE.readline()</span><br><span class="line">FILE.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="程序休眠"><a href="#程序休眠" class="headerlink" title="程序休眠"></a>程序休眠</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># 休眠</span></span><br><span class="line">time.sleep([SECONDS])</span><br></pre></td></tr></table></figure>

<h2 id="for-循环逐行读取"><a href="#for-循环逐行读取" class="headerlink" title="for 循环逐行读取"></a>for 循环逐行读取</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> iterating_var <span class="keyword">in</span> sequence:</span><br><span class="line">    statements(s)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历字符串：</span></span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> <span class="string">&#x27;Python&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Current char $s&quot;</span>% char)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历0-100的数字：</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等效于 Powershell 语言</span></span><br><span class="line"><span class="comment"># for ($i=0;$i -lt 100;$i ++)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历50-100的数字：</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<h2 id="数字整型转换成字符型"><a href="#数字整型转换成字符型" class="headerlink" title="数字整型转换成字符型"></a>数字整型转换成字符型</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TARGET_INT=<span class="number">10</span></span><br><span class="line">TARGET_STRING=<span class="built_in">str</span>(TARGET_INT)</span><br></pre></td></tr></table></figure>

<h2 id="字符型转换为整型"><a href="#字符型转换为整型" class="headerlink" title="字符型转换为整型"></a>字符型转换为整型</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认十进制</span></span><br><span class="line">TARGET_NUMBER=<span class="built_in">int</span>(<span class="string">&quot;20&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为十六进制</span></span><br><span class="line">TARGET_NUMBER=<span class="built_in">int</span>(<span class="string">&quot;20&quot;</span>,<span class="number">16</span>)</span><br></pre></td></tr></table></figure>

<h2 id="文件输出"><a href="#文件输出" class="headerlink" title="文件输出"></a>文件输出</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 覆盖文件内容，作用相当于 echo &quot;&quot; &gt; test.demo</span></span><br><span class="line">FILE=<span class="built_in">open</span>(<span class="string">&#x27;test.demo&#x27;</span>,<span class="string">&quot;w&quot;</span>)</span><br><span class="line">FILE.write(<span class="string">&quot;TARGET CONTENT&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 追加文件内容，作用相当于 echo &quot;&quot; &gt;&gt; test.demo</span></span><br><span class="line"><span class="comment"># 等价于 Powershell 的 Add-Content</span></span><br><span class="line">FILE=<span class="built_in">open</span>(<span class="string">&#x27;test.demo&#x27;</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">FILE.write(<span class="string">&quot;TARGET CONTENT&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="字符比较判断"><a href="#字符比较判断" class="headerlink" title="字符比较判断"></a>字符比较判断</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 汉字比较</span></span><br><span class="line">TEST_CHAT=<span class="string">&quot;用于测试的字符&quot;</span></span><br><span class="line">TARGET_CHAT=<span class="string">&quot;用于匹配判断的字符&quot;</span></span><br><span class="line"><span class="keyword">if</span> TEST_CHAT <span class="keyword">in</span> TARGET_CHAT:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;匹配成功&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TARGET_STRING1=<span class="string">&#x27;字符串1&#x27;</span></span><br><span class="line">TARGET_STRING2=<span class="string">&#x27;字符串2&#x27;</span></span><br><span class="line">TARGET_STRING3=<span class="string">&#x27;字符串3&#x27;</span></span><br><span class="line">TOTAL_STRING=TARGET_STRING1 + TARGET_STRING2 + TARGET_STRING3</span><br></pre></td></tr></table></figure>

<h2 id="字符串替代"><a href="#字符串替代" class="headerlink" title="字符串替代"></a>字符串替代</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_STRING=<span class="string">&quot;DEFUALTSTRING&quot;</span></span><br><span class="line">TEMP_STRING=<span class="string">&quot;I need to replace DEFUALTSTRING&quot;</span></span><br><span class="line">NEW_STRING=TEMP_STRING(<span class="string">&quot;DEFAULTSTRING&quot;</span>,<span class="string">&quot;NEWSTRING&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="异常处理或异常"><a href="#异常处理或异常" class="headerlink" title="异常处理或异常"></a>异常处理或异常</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    Code_Block</span><br><span class="line"><span class="keyword">except</span> [Except_type]:</span><br><span class="line">    Handle_EXCEPT_CODE_Block</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    Code Block</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">    <span class="built_in">print</span>(ex)</span><br></pre></td></tr></table></figure>

<h1 id="脚本内容"><a href="#脚本内容" class="headerlink" title="脚本内容"></a>脚本内容</h1><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> selenium.webdriver <span class="keyword">as</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver。common.keys <span class="keyword">import</span> Keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">WriteLog</span>(<span class="params">INFO</span>):</span><br><span class="line">    FILE=<span class="built_in">open</span>(<span class="string">&quot;Output.log&quot;</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    FILE.write(INFO)</span><br><span class="line">    FILE.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetXPATHELEM</span>(<span class="params">DRIVER,TARGET_XPATH</span>):</span><br><span class="line">    ELEM=DRIVER.find_element(By.XPATH,TARGET_XPATH)</span><br><span class="line">    <span class="keyword">return</span> ELEM</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HandleElementInfo</span>(<span class="params">DRIVER</span>):</span><br><span class="line">    TARGET_ELEM_XPATH=<span class="string">&quot;&quot;</span></span><br><span class="line">    TARGET_CONTENT=GetXPATHELEM(DRIVER,TARGET_ELEM_XPATH).text</span><br><span class="line">    <span class="keyword">return</span> TARGET_CONTENT</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HandleURL</span>(<span class="params">DRIVER,TARGET_URL</span>):</span><br><span class="line">    <span class="comment"># 避免被服务端禁用，需要暂停10s再执行</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    DEFAULT_URL=<span class="string">&quot;&quot;</span></span><br><span class="line">    NEW_URL=DEFAULT_URL.replace(<span class="string">&quot;&quot;</span>,TARGET_URL)</span><br><span class="line">    DRIVER.get(NEW_URL)</span><br><span class="line"></span><br><span class="line">driver=webdriver.Chrome()</span><br><span class="line">HandleURL(driver,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Chrome-Driver-下载"><a href="#Chrome-Driver-下载" class="headerlink" title="Chrome Driver 下载"></a>Chrome Driver 下载</h1><p><a target="_blank" rel="noopener" href="https://googlechromelabs.github.io/chrome-for-testing">https://googlechromelabs.github.io/chrome-for-testing</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/47/">47</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"light","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
