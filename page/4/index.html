<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="诺曼实验室">
<meta property="og:url" content="http://github.com/rohman-zhu/page/4/index.html">
<meta property="og:site_name" content="诺曼实验室">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rohman.Zhu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://github.com/rohman-zhu/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh_cn","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>诺曼实验室</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">诺曼实验室</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">429</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/05/03/HPE-SAN%E5%AD%98%E5%82%A8%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/03/HPE-SAN%E5%AD%98%E5%82%A8%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/" class="post-title-link" itemprop="url">HPE SAN存储常用指令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-03 17:54:31 / Modified: 10:04:15" itemprop="dateCreated datePublished" datetime="2024-05-03T17:54:31+00:00">2024-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">服务器与存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8/SAN%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">SAN存储</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常用指令集"><a href="#常用指令集" class="headerlink" title="常用指令集"></a>常用指令集</h1><h2 id="查询类"><a href="#查询类" class="headerlink" title="查询类"></a>查询类</h2><h3 id="查询后端存储端口流量"><a href="#查询后端存储端口流量" class="headerlink" title="查询后端存储端口流量"></a>查询后端存储端口流量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">statport -disk -ni</span><br></pre></td></tr></table></figure>

<h3 id="查询盘笼状态"><a href="#查询盘笼状态" class="headerlink" title="查询盘笼状态"></a>查询盘笼状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showcage</span><br></pre></td></tr></table></figure>

<h3 id="查询-PD-状态，即硬盘状态"><a href="#查询-PD-状态，即硬盘状态" class="headerlink" title="查询 PD 状态，即硬盘状态"></a>查询 PD 状态，即硬盘状态</h3><p>会显示该硬盘的总容量、使用量、可用容量、热备空间；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showpd -c</span><br></pre></td></tr></table></figure>

<h3 id="查询系统信息"><a href="#查询系统信息" class="headerlink" title="查询系统信息"></a>查询系统信息</h3><p>序列号、总容量、已分配容量、空闲容量；</p>
<blockquote>
<p>注意精简置备带来的影响！</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showsys -d</span><br></pre></td></tr></table></figure>

<h3 id="查询CPG策略"><a href="#查询CPG策略" class="headerlink" title="查询CPG策略"></a>查询CPG策略</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showcpg</span><br></pre></td></tr></table></figure>

<h3 id="查询CPG对应的容量分配"><a href="#查询CPG对应的容量分配" class="headerlink" title="查询CPG对应的容量分配"></a>查询CPG对应的容量分配</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showspace -cpg [CPG_NAME]</span><br></pre></td></tr></table></figure>

<h3 id="查询任务"><a href="#查询任务" class="headerlink" title="查询任务"></a>查询任务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">showtask</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询具体任务信息</span></span><br><span class="line">showtask -d [PID]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/05/03/Windows-Server-%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/03/Windows-Server-%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">Windows Server 创建计划任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-05-03 16:08:26 / Modified: 09:10:27" itemprop="dateCreated datePublished" datetime="2024-05-03T16:08:26+00:00">2024-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h1><p>任务1：创建自动化任务，到指定时间自动运行脚本；<br>任务2：通过远程下发指令，时间自动化创建自动任务；</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="任务1操作实例-CLI操作界面"><a href="#任务1操作实例-CLI操作界面" class="headerlink" title="任务1操作实例-CLI操作界面"></a>任务1操作实例-CLI操作界面</h2><p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/powershell/module/psscheduledjob/register-scheduledjob?view=powershell-5.1">https://learn.microsoft.com/zh-cn/powershell/module/psscheduledjob/register-scheduledjob?view=powershell-5.1</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/new-scheduledtask?view=winserver2012r2-ps">https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/new-scheduledtask?view=winserver2012r2-ps</a></li>
</ol>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 叫什么：一个名为 TEST 的自动任务</span></span><br><span class="line"><span class="variable">$TASKNAME</span>=<span class="string">&quot;TEST&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 干什么：并执行 test.ps1 脚本</span></span><br><span class="line"><span class="variable">$TESTSCRIPT</span>=<span class="string">&quot;C:\test.ps1&quot;</span>;</span><br><span class="line"><span class="variable">$ACTION</span>=<span class="built_in">New-ScheduledTaskAction</span> <span class="literal">-Execute</span> <span class="string">&quot;Powershell&quot;</span> <span class="literal">-Argument</span> <span class="variable">$TESTCRIPT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 什么时候做：在每周三，晚上7:30执行；</span></span><br><span class="line"><span class="variable">$JOBTRIGGER</span>=<span class="built_in">New-JobTrigger</span> <span class="literal">-Weekly</span> <span class="literal">-At</span> <span class="string">&quot;9:00 PM&quot;</span> <span class="literal">-DaysOfWeek</span> Wednesday <span class="literal">-WeeksInterval</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 谁：拥有最高权限</span></span><br><span class="line"><span class="comment"># 有啥注意事项：无论有没有用户登录，都执行</span></span><br><span class="line"><span class="variable">$PRINCIPAL</span>=<span class="built_in">New-ScheduledTaskPrincipal</span> <span class="literal">-UserId</span> [<span class="type">USER</span>] <span class="literal">-LogonType</span> S4U</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建任务信息</span></span><br><span class="line"><span class="variable">$SCHEDULEDTASKOBJECT</span>=<span class="built_in">New-ScheduledTask</span> <span class="literal">-Action</span> <span class="variable">$ACTION</span> <span class="literal">-Trigger</span> <span class="variable">$JOBTRIGGER</span> <span class="literal">-Principal</span> <span class="variable">$PRINCIPAL</span></span><br><span class="line"><span class="comment"># 注册任务</span></span><br><span class="line"><span class="built_in">Register-ScheduledTask</span> <span class="literal">-TaskName</span> <span class="variable">$TASKNAME</span> <span class="literal">-InputObject</span> [<span class="type">SchedledTaskObjectName</span>];</span><br></pre></td></tr></table></figure>


<h2 id="任务1操作实例-GUI操作界面"><a href="#任务1操作实例-GUI操作界面" class="headerlink" title="任务1操作实例-GUI操作界面"></a>任务1操作实例-GUI操作界面</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lishidefengchen/p/4381565.html">https://www.cnblogs.com/lishidefengchen/p/4381565.html</a></p>
<p>环境说明:</p>
<ol>
<li>Powershell 目录：C:\Windows\SysWOW64\WindowsPowerShell\v1.0\PowerShell.exe;</li>
<li>脚本位置：C:\test.ps1;</li>
</ol>
<h3 id="运行“任务计划程序”"><a href="#运行“任务计划程序”" class="headerlink" title="运行“任务计划程序”"></a>运行“任务计划程序”</h3><ol>
<li>windows + R;</li>
<li>输入 taskschd.msc;</li>
</ol>
<h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p>常规页面：</p>
<ol>
<li>填写任务名称；</li>
<li>勾选“不敢用户是否登录都要运行”</li>
<li>勾选“使用最高权限运行”；【如果有涉及提权操作，则需要勾选】</li>
<li>配置选择为对应的OS版本；</li>
</ol>
<p>触发器页面：</p>
<ol>
<li>新建；</li>
<li>设置自动执行的频率与时间；</li>
</ol>
<p>操作页面：</p>
<ol>
<li>操作，选择“启动程序”；</li>
<li>程序或脚本，输入“powershell”或者Powershell的绝对路径“C:\Windows\SysWOW64\WindowsPowerShell\v1.0\PowerShell.exe”；</li>
<li>添加参数（可选）,输入脚本的绝对路径，用英文状态的双引号包裹；</li>
</ol>
<p>点击确定；</p>
<h3 id="如何DEBUG"><a href="#如何DEBUG" class="headerlink" title="如何DEBUG"></a>如何DEBUG</h3><p>有可能任务运行会失败或者未按预期执行，可以选中任务，点击运行后，可以在“历史History”标签页中看到执行情况。<br>不过此时获取的信息还是比较有限，所以可以在脚本中增加 Start-Transcript 与 Stop-Transcript 指令，检查执行情况。</p>
<h1 id="TASK-LOGON-TYPE-类型"><a href="#TASK-LOGON-TYPE-类型" class="headerlink" title="TASK_LOGON_TYPE 类型"></a>TASK_LOGON_TYPE 类型</h1><p>参考: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/taskschd/ne-taskschd-task_logon_type">https://learn.microsoft.com/en-us/windows/win32/api/taskschd/ne-taskschd-task_logon_type</a></p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="class"><span class="keyword">enum</span> _<span class="title">TASK_LOGON_TYPE</span></span> &#123;</span><br><span class="line">  TASK_LOGON_NONE = <span class="number">0</span>,</span><br><span class="line">  TASK_LOGON_PASSWORD = <span class="number">1</span>,</span><br><span class="line">  TASK_LOGON_S4U = <span class="number">2</span>,</span><br><span class="line">  TASK_LOGON_INTERACTIVE_TOKEN = <span class="number">3</span>,</span><br><span class="line">  TASK_LOGON_GROUP = <span class="number">4</span>,</span><br><span class="line">  TASK_LOGON_SERVICE_ACCOUNT = <span class="number">5</span>,</span><br><span class="line">  TASK_LOGON_INTERACTIVE_TOKEN_OR_PASSWORD = <span class="number">6</span></span><br><span class="line">&#125; TASK_LOGON_TYPE;</span><br></pre></td></tr></table></figure>

<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">TASK_LOGON_NONE</span><br><span class="line">Value: <span class="number">0</span></span><br><span class="line">The logon method is not specified. Used <span class="keyword">for</span> non<span class="literal">-NT</span> credentials.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_PASSWORD</span><br><span class="line">Value: <span class="number">1</span></span><br><span class="line">Use a password <span class="keyword">for</span> logging on the user. The password must be supplied at registration time.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_S4U</span><br><span class="line">Value: <span class="number">2</span></span><br><span class="line">The service will log the user on <span class="keyword">using</span> Service For User (S4U), and the task will run in a non-interactive desktop. When an S4U logon is used, no password is stored by the system and there is no access to either the network or to encrypted files.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_INTERACTIVE_TOKEN</span><br><span class="line">Value: <span class="number">3</span></span><br><span class="line">User must already be logged on. The task will be run only <span class="keyword">in</span> an existing interactive session.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_GROUP</span><br><span class="line">Value: <span class="number">4</span></span><br><span class="line"><span class="built_in">Group</span> activation. The groupId field specifies the <span class="built_in">group</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_SERVICE_ACCOUNT</span><br><span class="line">Value: <span class="number">5</span></span><br><span class="line">Indicates that a Local System, Local Service, or Network Service account is being used as a security context to run the task.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TASK_LOGON_INTERACTIVE_TOKEN_OR_PASSWORD</span><br><span class="line">Value: <span class="number">6</span></span><br><span class="line">Not <span class="keyword">in</span> use; currently identical to TASK_LOGON_PASSWORD.</span><br><span class="line"></span><br><span class="line">Windows <span class="number">10</span>, version <span class="number">1511</span>, Windows <span class="number">10</span>, version <span class="number">1507</span>, Windows <span class="number">8.1</span>, Windows Server <span class="number">2012</span> R2, Windows <span class="number">8</span>, Windows Server <span class="number">2012</span>, Windows Vista and Windows Server <span class="number">2008</span>:  First use the interactive token. <span class="keyword">If</span> the user is not logged on (no interactive token is available), then the password is used. The password must be specified when a task is registered. This flag is not recommended <span class="keyword">for</span> new tasks because it is less reliable than TASK_LOGON_PASSWORD.</span><br><span class="line"></span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/04/23/Windows-Server-%E9%80%9A%E8%BF%87NTDLL%E8%AE%BE%E7%BD%AE%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/23/Windows-Server-%E9%80%9A%E8%BF%87NTDLL%E8%AE%BE%E7%BD%AE%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90/" class="post-title-link" itemprop="url">待补充-Windows Server 通过NTDLL设置注册表权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-23 00:49:16" itemprop="dateCreated datePublished" datetime="2024-04-23T00:49:16+00:00">2024-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-04-22 17:00:01" itemprop="dateModified" datetime="2024-04-22T17:00:01+00:00">2024-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="场景说明"><a href="#场景说明" class="headerlink" title="场景说明"></a>场景说明</h1><p>一般在重置 RDS 120天许可会用到，需要删除GracePeriod 注册表才可以恢复120天试用期；但是直接使用Powershell的Remove-Item属性是无法完成这个操作的，必须提权。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/04/22/Windows-Server-%E5%AE%89%E8%A3%85%E5%85%B6%E4%BB%96%E8%AF%AD%E8%A8%80%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/22/Windows-Server-%E5%AE%89%E8%A3%85%E5%85%B6%E4%BB%96%E8%AF%AD%E8%A8%80%E5%8C%85/" class="post-title-link" itemprop="url">Windows Server  安装其他语言包</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-22 16:44:54 / Modified: 08:47:09" itemprop="dateCreated datePublished" datetime="2024-04-22T16:44:54+00:00">2024-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol>
<li>下载语言包；</li>
<li>将所需的语言cab包传入目标服务器；</li>
<li>运行lpksetup.exe,安装对应的补丁包；</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/zh-cn/000220901/windows-server-2022%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E8%AF%AD%E8%A8%80%E5%8C%85">https://www.dell.com/support/kbdoc/zh-cn/000220901/windows-server-2022%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E8%AF%AD%E8%A8%80%E5%8C%85</a><br><a target="_blank" rel="noopener" href="https://netshopisp.medium.com/how-to-install-language-pack-on-windows-server-2019-8d477d8c3c2e">https://netshopisp.medium.com/how-to-install-language-pack-on-windows-server-2019-8d477d8c3c2e</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/04/18/Windows-Server-RDSH%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%85%E5%8D%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/18/Windows-Server-RDSH%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%85%E5%8D%95/" class="post-title-link" itemprop="url">Windows-Server-RDSH初始化清单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-04-18 19:54:05 / Modified: 12:07:54" itemprop="dateCreated datePublished" datetime="2024-04-18T19:54:05+00:00">2024-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>RDSH(Remote Desktop Session Host)，用于发布APP给到用户，需要做一些初始化的操作，以及安装一些必要的软件。</p>
<h1 id="确认需求"><a href="#确认需求" class="headerlink" title="确认需求"></a>确认需求</h1><p>比如通过RDSH发布的浏览器或者SSH客户端，用于网页访问、SSH访问；</p>
<h2 id="应用清单"><a href="#应用清单" class="headerlink" title="应用清单"></a>应用清单</h2><table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">版本</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Chrome</td>
<td align="center">最新版本</td>
<td align="center">可以用msi包，通过WINRM下发指令安装</td>
</tr>
<tr>
<td align="center">Firefox</td>
<td align="center">最新版本</td>
<td align="center">作为Chrome的备用软件，也可以远程安装</td>
</tr>
<tr>
<td align="center">杀毒软件</td>
<td align="center"></td>
<td align="center">避免用户自行上传恶意包，导致RDSH故障</td>
</tr>
<tr>
<td align="center">XSHELL</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Putty</td>
<td align="center"></td>
<td align="center">作为xshell的备用软件</td>
</tr>
<tr>
<td align="center">Xterm</td>
<td align="center"></td>
<td align="center">作为xshell的备用软件，可以打开X Desktop应用</td>
</tr>
<tr>
<td align="center">VMware Horizon View Agent</td>
<td align="center">有版本关联要求，一般安装稳定版本</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Remote desktop session hosts</td>
<td align="center"></td>
<td align="center">120天限制</td>
</tr>
</tbody></table>
<h2 id="权限与组策略调整"><a href="#权限与组策略调整" class="headerlink" title="权限与组策略调整"></a>权限与组策略调整</h2><h3 id="Chrome没有声音"><a href="#Chrome没有声音" class="headerlink" title="Chrome没有声音"></a>Chrome没有声音</h3><p>可以参照：<a target="_blank" rel="noopener" href="https://rohman-zhu.github.io/2022/10/16/RDSH%E4%B8%AD%E7%9A%84Chrome%E6%B2%A1%E6%9C%89%E5%A3%B0%E9%9F%B3/">https://rohman-zhu.github.io/2022/10/16/RDSH%E4%B8%AD%E7%9A%84Chrome%E6%B2%A1%E6%9C%89%E5%A3%B0%E9%9F%B3/</a></p>
<h3 id="Chrome下载目录"><a href="#Chrome下载目录" class="headerlink" title="Chrome下载目录"></a>Chrome下载目录</h3><ol>
<li>导入Chrome 组策略包；</li>
<li>设置下载路径： \[SAMBA 服务器地址]\路径${user_name}</li>
</ol>
<blockquote>
<p>${user_name}是一个变量，固定写法；</p>
</blockquote>
<h3 id="设置安全策略"><a href="#设置安全策略" class="headerlink" title="设置安全策略"></a>设置安全策略</h3><ol>
<li>隐藏驱动器；</li>
</ol>
<h3 id="设置C盘根目录权限"><a href="#设置C盘根目录权限" class="headerlink" title="设置C盘根目录权限"></a>设置C盘根目录权限</h3><p>一般可以访问RDSH的用户均是 Remote Desktop Users 组，因此对C盘根目录的NTFS权限可以设置 该组 为 <em>写入拒绝</em> 、 <em>读取内容拒绝</em> 权限；</p>
<blockquote>
<p>只有Windows 、 Program Files 、Program Files(x86) 目录无法设置；</p>
</blockquote>
<h2 id="运维相关"><a href="#运维相关" class="headerlink" title="运维相关"></a>运维相关</h2><h3 id="安装-PS-Windows-Update-模块"><a href="#安装-PS-Windows-Update-模块" class="headerlink" title="安装 PS Windows Update 模块"></a>安装 PS Windows Update 模块</h3><p>为了方便以后Windows 补丁安装；</p>
<h3 id="修改-WinRM-监听端口"><a href="#修改-WinRM-监听端口" class="headerlink" title="修改 WinRM 监听端口"></a>修改 WinRM 监听端口</h3><p>默认端口为5985，需要修改为一个不常用的端口；<br>其次要设置防火墙策略，避免被拦截。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/04/01/Horizon-599%E6%95%85%E9%9A%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Horizon-599%E6%95%85%E9%9A%9C/" class="post-title-link" itemprop="url">Horizon-599故障</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 01:14:06" itemprop="dateCreated datePublished" datetime="2024-04-01T01:14:06+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-31 17:21:05" itemprop="dateModified" datetime="2024-03-31T17:21:05+00:00">2024-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/" itemprop="url" rel="index"><span itemprop="name">VMware</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/VMware/Horizon-View/" itemprop="url" rel="index"><span itemprop="name">Horizon View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="故障描述"><a href="#故障描述" class="headerlink" title="故障描述"></a>故障描述</h1><ol>
<li>连接服务器、安全服务器无法连接TCP-443；</li>
<li>连接 https:&#x2F;&#x2F;安全服务器 ，显示599；</li>
<li>连接服务器的日志（C:\ProgramData\VMware\VDM\log\xxx.log），显示 MEMORY-ALARM:physical memory use &#x3D; 97% ,[ws_perfmon]High memory use….</li>
</ol>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>直接原因：服务器内存已经用满，出现内存泄漏的情况；<br>根本原因：出现补丁更新，未重启；</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>重启服务器。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/04/01/Powershell%E5%AE%9E%E4%BE%8B-%E8%BF%9C%E7%A8%8B%E5%AE%89%E8%A3%85%E8%A1%A5%E4%B8%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/01/Powershell%E5%AE%9E%E4%BE%8B-%E8%BF%9C%E7%A8%8B%E5%AE%89%E8%A3%85%E8%A1%A5%E4%B8%81/" class="post-title-link" itemprop="url">Powershell实例-远程安装补丁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 00:49:57" itemprop="dateCreated datePublished" datetime="2024-04-01T00:49:57+00:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-31 16:53:58" itemprop="dateModified" datetime="2024-03-31T16:53:58+00:00">2024-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h1><ol>
<li>给远端的服务器安装补丁；</li>
<li>检查是否需要重启；</li>
</ol>
<h1 id="实例脚本"><a href="#实例脚本" class="headerlink" title="实例脚本"></a>实例脚本</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Date:2024-03-31</span></span><br><span class="line"><span class="comment"># Version : v2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global Veriable</span></span><br><span class="line"><span class="variable">$WINRM_PORT</span>=<span class="number">5985</span>;</span><br><span class="line"><span class="comment"># Target Windows Update  inneed;</span></span><br><span class="line"><span class="variable">$TARGET_WUKB_ARRARY</span>=<span class="string">&quot;KB5035849&quot;</span>,<span class="string">&quot;KB5035849&quot;</span>;</span><br><span class="line"><span class="variable">$TARGETSERVER_List</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$PSCREDENTIAL</span>)&#123;<span class="variable">$PSCREDENTIAL</span>=<span class="built_in">Get-Credential</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Get-Log</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TYPE</span>,<span class="variable">$CONTENT</span>);</span><br><span class="line">    <span class="variable">$TIMESPAN1</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="variable">$TIMESPAN2</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line">    <span class="built_in">Write-Host</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> <span class="string">&quot;<span class="variable">$TYPE</span>.log&quot;</span> <span class="string">&quot;[<span class="variable">$TIMESPAN1</span>][<span class="variable">$TIMESPAN2</span>][<span class="variable">$TYPE</span>]<span class="variable">$CONTENT</span>;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check windows updates is installed</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-WindowsUpdate</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB_ARRARY</span>,<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="variable">$WU_CHECK_BLOCK</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$TARGET_WUKB</span>);</span><br><span class="line">        <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$TRUE</span>;</span><br><span class="line">        <span class="variable">$INSTALL_KB_CHECK</span>=<span class="built_in">Get-HotFix</span> | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.HotFixID <span class="operator">-match</span> <span class="variable">$TARGET_WUKB</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$INSTALL_KB_CHECK</span>)&#123;</span><br><span class="line">            <span class="variable">$INSTALL_FLAG</span>=<span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$INSTALL_FLAG</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TARGET_WUKB_ARRARY</span>.Length;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$WU_PRE_CHECK_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ArgumentList</span> <span class="variable">$TARGET_WUKB_ARRARY</span>[<span class="variable">$i</span>] <span class="literal">-ScriptBlock</span> <span class="variable">$WU_CHECK_BLOCK</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;#注意 ArgumentList 无法传递数组；2024-03-31，废案；</span></span><br><span class="line"><span class="comment">    $WU_CHECK=&#123;</span></span><br><span class="line"><span class="comment">        param($TARGET_WUKB_ARRARY);</span></span><br><span class="line"><span class="comment">        $INSTALL_FLAG=$FALSE;</span></span><br><span class="line"><span class="comment">        for($i = 0; $i -lt $TARGET_WUKB_ARRARY.Length;$i++)&#123;</span></span><br><span class="line"><span class="comment">            $ISINSTALLED=Get-HotFix | Where-Object &#123;$_.HotFixID -match $TARGET_WUKB_ARRARY[$i]&#125;;</span></span><br><span class="line"><span class="comment">            if($null -eq $ISINSTALLED)&#123;</span></span><br><span class="line"><span class="comment">                $INSTALL_FLAG=$TRUE;</span></span><br><span class="line"><span class="comment">                Write-Host &quot;$(hostname) need install $($TARGET_WUKB_ARRARY[$i]);&quot;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return $INSTALL_FLAG;</span></span><br><span class="line"><span class="comment">    &#125;    </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    $READY_FLAG=Invoke-Command -Session $PSSESSION -ScriptBlock $WU_CHECK -ArgumentList $TARGET_WUKB_ARRARY;</span></span><br><span class="line"><span class="comment">    #&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$WU_PRE_CHECK_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to install windows update &quot;</span></span><br><span class="line">        <span class="built_in">Invoke-WuJob</span> <span class="literal">-ComputerName</span> <span class="variable">$PSSESSION</span>.ComputerName <span class="literal">-Script</span> &#123;<span class="built_in">Install-WindowsUpdate</span> <span class="literal">-AcceptAll</span> <span class="literal">-IgnoreReboot</span> | <span class="built_in">Out-File</span> C:\InstallWindows.log&#125; <span class="literal">-RunNow</span> <span class="literal">-Confirm</span>:<span class="variable">$FALSE</span> <span class="literal">-ErrorAction</span> Ignore;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INSTALL-WU&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) don&#x27;t need to intall <span class="variable">$TARGET_WUKB_ARRARY</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check target windows server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Check-RebootStatus</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$CHECK_REBOOT_BLOCK</span>=&#123;</span><br><span class="line">        <span class="comment">#$ISNEED_REBOOT=$FALSE;</span></span><br><span class="line">        <span class="variable">$ISNEED_REBOOT</span>=<span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISNEED_REBOOT</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$FALSE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$TRUE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$REBOOT_FLAG</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$PSSESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$CHECK_REBOOT_BLOCK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$REBOOT_FLAG</span>)&#123;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName) need to reboot&quot;</span>;</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;REBOOT&quot;</span> <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$PSSESSION</span>.ComputerName)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start check target server;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-CheckTargetServer</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGETSERVER_LIST_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Get-Content</span> <span class="variable">$TARGETSERVER_LIST_FILE</span> | <span class="built_in">ForEach-Object</span>&#123;</span><br><span class="line">        <span class="variable">$SERVERNAME</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">        <span class="built_in">Get-Log</span> <span class="string">&quot;INFO&quot;</span> <span class="string">&quot;Start connect to <span class="variable">$SERVERNAME</span> &quot;</span>;</span><br><span class="line">        <span class="variable">$SESSION</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$SERVERNAME</span> <span class="literal">-Port</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$PSCREDENTIAL</span>;</span><br><span class="line"></span><br><span class="line">        Check<span class="literal">-WindowsUpdate</span> <span class="variable">$TARGET_WUKB_ARRARY</span> <span class="variable">$SESSION</span>;</span><br><span class="line">        Check<span class="literal">-RebootStatus</span> <span class="variable">$SESSION</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-CheckTargetServer</span> <span class="variable">$TARGETSERVER_List</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>Invoke-Command 传参：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/talentzemin/p/16976197.html">https://www.cnblogs.com/talentzemin/p/16976197.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/03/31/Powershell%E8%84%9A%E6%9C%AC%E5%AE%9E%E4%BE%8B-%E6%A3%80%E6%9F%A5%E5%9F%9F%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E5%B9%B6%E5%88%A0%E9%99%A4%E7%A6%81%E7%94%A8%E8%B4%A6%E6%88%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/31/Powershell%E8%84%9A%E6%9C%AC%E5%AE%9E%E4%BE%8B-%E6%A3%80%E6%9F%A5%E5%9F%9F%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E5%B9%B6%E5%88%A0%E9%99%A4%E7%A6%81%E7%94%A8%E8%B4%A6%E6%88%B7/" class="post-title-link" itemprop="url">Powershell脚本实例-检查域账户状态并删除禁用账户</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-31 01:00:28" itemprop="dateCreated datePublished" datetime="2024-03-31T01:00:28+00:00">2024-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-30 18:17:34" itemprop="dateModified" datetime="2024-03-30T18:17:34+00:00">2024-03-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Server/" itemprop="url" rel="index"><span itemprop="name">Windows Server</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>目标： 通过WMRM将指令下发至远端服务器，删除该服务器内无效的用户配置（AD账户已被禁用），以释放空间；</p>
<ol>
<li>获取远端服务器的用户配置信息列表，路径为 C:\Users\；检查目标账户是否为停用状态；</li>
<li>若为停用状态的账户，则下发指令删除配置文件；</li>
</ol>
<h1 id="脚本思路"><a href="#脚本思路" class="headerlink" title="脚本思路"></a>脚本思路</h1><ol>
<li>向远端获取该服务器的用户列表 : Get-ChildItem -Path “C:\Users”;</li>
<li>判断账户是否停用: $USER_INFOS&#x3D;net user $TARGET_USERNAME &#x2F;domain;$USER_INFOS[7] - match “No”;</li>
<li>删除用户配置；</li>
</ol>
<h1 id="脚本实例"><a href="#脚本实例" class="headerlink" title="脚本实例"></a>脚本实例</h1><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Date : 2024-3-30</span></span><br><span class="line"><span class="comment"># Version : v1</span></span><br><span class="line"><span class="comment">#requires -RunAsAdministrator</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global veriable</span></span><br><span class="line"><span class="variable">$DOMAIN</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$TARGETSERVER_LIST</span>=<span class="variable">$args</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$WINRM_PORT</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$PSCREDENTIAL</span>)&#123;<span class="variable">$PSCREDENTIAL</span>=<span class="built_in">Get-Credential</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function Delete user profile</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-DelUserProfile</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$TARGET_SERVER_PSSESSION</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$DELUSERPROFILE_BLOCK</span>=&#123;</span><br><span class="line">        <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$DOMAIN</span>);</span><br><span class="line">        <span class="comment"># get user SID</span></span><br><span class="line">        <span class="variable">$USER_SID</span> = (<span class="built_in">New-Object</span> Security.Principal.NTAccount(<span class="variable">$DOMAIN</span>, <span class="variable">$TARGET_USERNAME</span>)).Translate([<span class="type">Security.Principal.SecurityIdentifier</span>]).Value;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Get-WmiObject</span> <span class="literal">-ClassName</span> Win32_UserProfile <span class="literal">-Filter</span> <span class="string">&quot;SID=&#x27;<span class="variable">$USER_SID</span>&#x27;&quot;</span> |</span><br><span class="line">        <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">            <span class="variable">$_</span>.Delete();</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span> &#x27;s profile dir has been deleted.&quot;</span></span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$TARGET_SERVER_PSSESSION</span> <span class="literal">-ScriptBlock</span> <span class="variable">$DELUSERPROFILE_BLOCK</span> <span class="literal">-ArgumentList</span> <span class="variable">$TARGET_USERNAME</span>,<span class="variable">$DOMAIN</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check target user status;</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-CheckUserStatus</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGET_USERNAME</span>,<span class="variable">$TARGET_SERVER_PSSESSION</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Check on localfile</span></span><br><span class="line">    <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;NULL&quot;</span>;</span><br><span class="line">    <span class="comment">## Disabled user file check.</span></span><br><span class="line">    <span class="variable">$ISVALID</span>=<span class="built_in">Get-Content</span> disabled<span class="literal">-user</span>.list | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span>&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISVALID</span>)&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , cannot be found on disbaled-user.list.&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , was been found on disbaled-user.list.&quot;</span>;</span><br><span class="line">        <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;DISABLED&quot;</span>;</span><br><span class="line">        <span class="built_in">Start-DelUserProfile</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ISVALID</span>=<span class="built_in">Get-Content</span> enabled<span class="literal">-user</span>.list | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span> <span class="operator">-like</span> <span class="string">&quot;<span class="variable">$TARGET_USERNAME</span>&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$null</span> <span class="operator">-eq</span> <span class="variable">$ISVALID</span>)&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , cannot be found on enabled-user.list.&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> , was been found on enabled-user.list.&quot;</span>;</span><br><span class="line">        <span class="variable">$LOCAL_STATUS</span>=<span class="string">&quot;ENABLED&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;NULL&quot;</span> <span class="operator">-match</span> <span class="variable">$LOCAL_STATUS</span>)&#123;</span><br><span class="line">        <span class="variable">$TARGET_USER_STATUS</span>=<span class="variable">$</span>(net user <span class="variable">$TARGET_USERNAME</span> /domain);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$TARGET_USER_STATUS</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;Yes&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Add-Content</span> enabled<span class="literal">-user</span>.list <span class="variable">$TARGET_USERNAME</span>;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> was enabled , add to enabled-user.list.&quot;</span></span><br><span class="line">        &#125;<span class="keyword">elseif</span>(<span class="variable">$TARGET_USER_STATUS</span>[<span class="number">7</span>] <span class="operator">-match</span> <span class="string">&quot;No&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Add-Content</span> disbaled<span class="literal">-user</span>.list <span class="variable">$TARGET_USERNAME</span>;</span><br><span class="line">            <span class="built_in">Write-Host</span> <span class="string">&quot;Target user : <span class="variable">$TARGET_USERNAME</span> was disabled , add to disabled-user.list.&quot;</span></span><br><span class="line">            <span class="built_in">Start-DelUserProfile</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start current mission</span></span><br><span class="line"><span class="function"><span class="keyword">Function</span> <span class="title">Start-InvokeDelUserProfil</span></span>&#123;</span><br><span class="line">    <span class="keyword">param</span>(<span class="variable">$TARGETSERVER_LIST_FILE</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Init local file</span></span><br><span class="line">    <span class="built_in">Add-Content</span> enabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">Add-Content</span> disabled<span class="literal">-user</span>.list <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Clear-Content</span> enabled<span class="literal">-user</span>.list;</span><br><span class="line">    <span class="built_in">Clear-Content</span> disbaled<span class="literal">-user</span>.list;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start handle</span></span><br><span class="line">    <span class="built_in">Get-Content</span> <span class="variable">$TARGETSERVER_LIST_FILE</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">        <span class="variable">$TARGET_SERVERNAME</span>=<span class="variable">$_</span>.Trim();</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Start handle target server : <span class="variable">$TARGET_SERVERNAME</span> . &quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$TARGET_SERVER_PSSESSION</span>=<span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> <span class="variable">$TARGET_SERVERNAME</span> <span class="literal">-Port</span> <span class="variable">$WINRM_PORT</span> <span class="literal">-Credential</span> <span class="variable">$PSCREDENTIAL</span>;</span><br><span class="line">        <span class="variable">$TARGET_USER_SET</span>=<span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$TARGET_SERVER_PSSESSION</span> <span class="literal">-ScriptBlock</span> &#123;<span class="built_in">Get-ChildItem</span> <span class="string">&quot;C:\Users&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span> ;<span class="variable">$i</span> <span class="operator">-lt</span> <span class="variable">$TARGET_USER_SET</span>.Length ; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$TARGET_USERNAME</span>=<span class="variable">$TARGET_USER_SET</span>[<span class="variable">$i</span>].Name;</span><br><span class="line">            <span class="built_in">Start-CheckUserStatus</span> <span class="variable">$TARGET_USERNAME</span> <span class="variable">$TARGET_SERVER_PSSESSION</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Archive user list;</span></span><br><span class="line">    <span class="variable">$TIMESPAN</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;yyyyMMdd-HHmm&quot;</span>;</span><br><span class="line">    <span class="built_in">Rename-Item</span> enabled<span class="literal">-user</span>.list enabeld<span class="literal">-user-</span><span class="variable">$TIMESPAN</span>.list;</span><br><span class="line">    <span class="built_in">Rename-Item</span> disbaled<span class="literal">-user</span>.list disabled<span class="literal">-user-</span><span class="variable">$TIMESPAN</span>.list;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="built_in">Start-InvokeDelUserProfil</span> <span class="variable">$TARGETSERVER_LIST</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>删除配置文件：<a target="_blank" rel="noopener" href="https://blog.vichamp.com/2017/12/27/deleting-user-profiles/#:~:text=%E4%BB%A5%E4%B8%8B%E6%98%AF%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A%20%E9%A6%96%E5%85%88%EF%BC%8C%E8%B0%83%E6%95%B4%20%24domain%20%E5%92%8C%20%24username,%E5%8F%98%E9%87%8F%E6%8C%87%E5%90%91%E6%82%A8%E6%83%B3%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82%20%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8%20PowerShell%20%E4%B8%AD%E4%BB%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%89%B9%E6%9D%83%E8%BF%90%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%20123456789101112">https://blog.vichamp.com/2017/12/27/deleting-user-profiles/#:~:text=%E4%BB%A5%E4%B8%8B%E6%98%AF%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A%20%E9%A6%96%E5%85%88%EF%BC%8C%E8%B0%83%E6%95%B4%20%24domain%20%E5%92%8C%20%24username,%E5%8F%98%E9%87%8F%E6%8C%87%E5%90%91%E6%82%A8%E6%83%B3%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82%20%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8%20PowerShell%20%E4%B8%AD%E4%BB%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%89%B9%E6%9D%83%E8%BF%90%E8%A1%8C%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%20123456789101112</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/03/22/VPN%E9%85%8D%E7%BD%AE-WireGuard%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/22/VPN%E9%85%8D%E7%BD%AE-WireGuard%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B/" class="post-title-link" itemprop="url">VPN配置-WireGuard配置实例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-22 23:16:31" itemprop="dateCreated datePublished" datetime="2024-03-22T23:16:31+00:00">2024-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-24 15:35:46" itemprop="dateModified" datetime="2024-03-24T15:35:46+00:00">2024-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求1–需求说明"><a href="#需求1–需求说明" class="headerlink" title="需求1–需求说明"></a>需求1–需求说明</h1><p>通过云服务器、VPN 隧道将内网的服务器打通，实现互联。</p>
<p>拓扑： 内网服务器 &lt;–VPN IPSec–&gt; 云服务器</p>
<h2 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装WireGuard</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu\Debian</span></span><br><span class="line">$ <span class="built_in">sudo</span> apt install wireguard</span><br><span class="line"></span><br><span class="line"><span class="comment"># RedHat 8</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line"><span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm</span><br><span class="line"><span class="built_in">sudo</span> yum install kmod-wireguard wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line"><span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm</span><br><span class="line"><span class="built_in">sudo</span> subscription-manager repos --<span class="built_in">enable</span> codeready-builder-for-rhel-8-$(<span class="built_in">arch</span>)-rpms</span><br><span class="line"><span class="built_in">sudo</span> yum copr <span class="built_in">enable</span> jdoss/wireguard</span><br><span class="line"><span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS8</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-utils epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=<span class="string">&quot;kernel-plus, kernel-plus-*&quot;</span> --<span class="built_in">setopt</span>=centosplus.enabled=1 --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel-core$/DEFAULTKERNEL=kernel-plus-core/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kernel-plus wireguard-tools</span><br><span class="line">$ <span class="built_in">sudo</span> reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=<span class="string">&quot;kernel-plus, kernel-plus-*&quot;</span> --<span class="built_in">setopt</span>=centosplus.enabled=1 --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel-core$/DEFAULTKERNEL=kernel-plus-core/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 3</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum config-manager --set-enabled PowerTools</span><br><span class="line">$ <span class="built_in">sudo</span> yum copr <span class="built_in">enable</span> jdoss/wireguard</span><br><span class="line">$ <span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS7</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-utils epel-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum-config-manager --<span class="built_in">setopt</span>=centosplus.includepkgs=kernel-plus --enablerepo=centosplus --save</span><br><span class="line">$ <span class="built_in">sudo</span> sed -e <span class="string">&#x27;s/^DEFAULTKERNEL=kernel$/DEFAULTKERNEL=kernel-plus/&#x27;</span> -i /etc/sysconfig/kernel</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kernel-plus wireguard-tools</span><br><span class="line">$ <span class="built_in">sudo</span> reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install epel-release elrepo-release</span><br><span class="line">$ <span class="built_in">sudo</span> yum install yum-plugin-elrepo</span><br><span class="line">$ <span class="built_in">sudo</span> yum install kmod-wireguard wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment">## Method 3</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">$ <span class="built_in">sudo</span> curl -o /etc/yum.repos.d/jdoss-wireguard-epel-7.repo https://copr.fedorainfracloud.org/coprs/jdoss/wireguard/repo/epel-7/jdoss-wireguard-epel-7.repo</span><br><span class="line">$ <span class="built_in">sudo</span> yum install wireguard-dkms wireguard-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># MacOS</span></span><br><span class="line"><span class="comment">## Method 1</span></span><br><span class="line"> brew install wireguard-tools</span><br><span class="line"><span class="comment">## Method 2</span></span><br><span class="line">$ port install wireguard-tools</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="服务器节点说明"><a href="#服务器节点说明" class="headerlink" title="服务器节点说明"></a>服务器节点说明</h3><table>
<thead>
<tr>
<th align="center">角色</th>
<th align="center">公网IP</th>
<th align="center">VPN IP</th>
<th align="center">内网IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">公网服务器</td>
<td align="center">1.1.1.1</td>
<td align="center">192.168.1.1</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">内网服务器节点1</td>
<td align="center">-</td>
<td align="center">192.168.1.11</td>
<td align="center">192.168.2.11</td>
</tr>
<tr>
<td align="center">内网服务器节点2</td>
<td align="center">-</td>
<td align="center">192.168.1.12</td>
<td align="center">192.168.2.12</td>
</tr>
</tbody></table>
<blockquote>
<p>WireGuard TCP 端口 65535</p>
</blockquote>
<h3 id="服务器节点安装与配置"><a href="#服务器节点安装与配置" class="headerlink" title="服务器节点安装与配置"></a>服务器节点安装与配置</h3><h4 id="生成密钥对"><a href="#生成密钥对" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件"><a href="#配置-WireGuard-的配置文件" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>WireGuard 的配置文件一般情况下放在 &#x2F;etc&#x2F;wireguard 中，且为了安全考虑，需要将这个目录的所有者设置为 root，权限设置为 700。<br>一般情况下，配置文件可依次命名为 wgX.conf，其中 X 为任意的编号，wgX 最终也是创建出来的网络接口的名称。<br>此处，在服务端与客户端中，都将命名为 wg0.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line"><span class="comment"># 会自动添加至路由策略表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端节点安装与配置"><a href="#客户端节点安装与配置" class="headerlink" title="客户端节点安装与配置"></a>客户端节点安装与配置</h3><h4 id="生成密钥对-1"><a href="#生成密钥对-1" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-1"><a href="#配置-WireGuard-的配置文件-1" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>客户端与服务端不同的地方在于：</p>
<ul>
<li>Interface 配置中没有 ListenPort</li>
<li>Peer 即为服务端，与服务端不同的地方在于多了一个 Endpoint</li>
</ul>
<p>一般情况下，只有主动发起连接的端需要在 Peer 中指定 Endpoint，此处为服务器的公网 IP 和监听的端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端配置 ，Interface属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的 私钥；</span></span><br><span class="line">PrivateKey = Client private key</span><br><span class="line"><span class="comment"># 配置本端的内网IP；</span></span><br><span class="line">Address = 192.168.1.2/32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端，即服务器端，Peer属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 服务端的公钥；</span></span><br><span class="line">PublicKey = Server public key</span><br><span class="line"><span class="comment"># 允许对端的IP流量</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"><span class="comment"># 服务端的IP与端口；</span></span><br><span class="line">Endpoint = 1.1.1.1:28385</span><br><span class="line"><span class="comment"># 每10秒发送keepalive心跳；</span></span><br><span class="line">PersistentKeepalive = 10</span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<h1 id="需求2–需求说明"><a href="#需求2–需求说明" class="headerlink" title="需求2–需求说明"></a>需求2–需求说明</h1><p>通过云服务器、VPN 隧道将内网DMZ区的服务器打通，通过DMZ服务器转发流量包至内网，实现互联。</p>
<p>拓扑： 内网服务器&lt;–双网卡–&gt;内网DMZ服务器 &lt;–VPN IPSec–&gt; 云服务器</p>
<h2 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h2><h3 id="服务器节点说明-1"><a href="#服务器节点说明-1" class="headerlink" title="服务器节点说明"></a>服务器节点说明</h3><table>
<thead>
<tr>
<th align="center">角色</th>
<th align="center">公网IP</th>
<th align="center">VPN IP</th>
<th align="center">内网IP</th>
</tr>
</thead>
<tbody><tr>
<td align="center">公网服务器</td>
<td align="center">1.1.1.1</td>
<td align="center">192.168.1.1</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">内网DMZ服务器节点1</td>
<td align="center">-</td>
<td align="center">192.168.1.11</td>
<td align="center">192.168.2.11</td>
</tr>
<tr>
<td align="center">内网服务器节点2</td>
<td align="center">-</td>
<td align="center">192.168.1.12</td>
<td align="center">192.168.2.12</td>
</tr>
</tbody></table>
<blockquote>
<p>WireGuard TCP 端口 65535</p>
</blockquote>
<blockquote>
<p>公网服务器：因为作为VPN服务端，需开启流量转发，且需配置防火墙转发策略（集群内的节点若无通讯需求，可不用配置）；<br>内网DMZ服务器节点1：双网卡，因承担流量转发的角色，需要开启流量转发，且需要配置 SNAT 策略；</p>
</blockquote>
<h3 id="服务器节点安装与配置-1"><a href="#服务器节点安装与配置-1" class="headerlink" title="服务器节点安装与配置"></a>服务器节点安装与配置</h3><h4 id="生成密钥对-2"><a href="#生成密钥对-2" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-2"><a href="#配置-WireGuard-的配置文件-2" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>WireGuard 的配置文件一般情况下放在 &#x2F;etc&#x2F;wireguard 中，且为了安全考虑，需要将这个目录的所有者设置为 root，权限设置为 700。<br>一般情况下，配置文件可依次命名为 wgX.conf，其中 X 为任意的编号，wgX 最终也是创建出来的网络接口的名称。<br>此处，在服务端与客户端中，都将命名为 wg0.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line"><span class="comment"># 会自动添加至路由策略表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br></pre></td></tr></table></figure>

<p>需要补充端口转发流量，以及iptable进行放行；</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放行wg0端口的VPN网段</span></span><br><span class="line">iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT </span><br><span class="line"><span class="comment"># 放行 VPN 转发到内网的流量</span></span><br><span class="line">iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT </span><br><span class="line"><span class="comment"># 放行内网 转发到 VPN 的流量</span></span><br><span class="line">iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT </span><br></pre></td></tr></table></figure>

<p>所以最终配置文件应该为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端的配置， Interface 属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的VPN内网IP地址</span></span><br><span class="line">Address = 192.168.1.1/32</span><br><span class="line"><span class="comment"># 作为服务端开放的端口</span></span><br><span class="line"><span class="comment"># 为UDP端口</span></span><br><span class="line">ListenPort = 65535</span><br><span class="line"><span class="comment"># 放置刚才生成的私钥，即priv_key内容</span></span><br><span class="line">PrivateKey = Server private key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙策略</span></span><br><span class="line">PostUp = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line">PostUp = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT</span><br><span class="line">PostUP = iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.1.0/24 -i wg0 -d 192.168.2.0/24 -j ACCEPT</span><br><span class="line">PostDown = iptables -I FORWARD -s 192.168.2.0/24 -i wg0 -d 192.168.1.0/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端的配置，Peer 属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 对端的公钥，即对端生成的pub_key内容</span></span><br><span class="line">PublicKey = Client public key</span><br><span class="line"><span class="comment"># 允许对端访问过来的IP列表；</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端节点安装与配置-1"><a href="#客户端节点安装与配置-1" class="headerlink" title="客户端节点安装与配置"></a>客户端节点安装与配置</h3><h4 id="生成密钥对-3"><a href="#生成密钥对-3" class="headerlink" title="生成密钥对"></a>生成密钥对</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">wg genkey &gt; priv_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">wg pubkey &lt; priv_key &gt; pub_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会生成两个文件 priv_key , pub_key</span></span><br></pre></td></tr></table></figure>

<p>WireGuard 的服务端与客户端是对等的。生成密钥的步骤适用于服务端，也适用于客户端。</p>
<h4 id="配置-WireGuard-的配置文件-3"><a href="#配置-WireGuard-的配置文件-3" class="headerlink" title="配置 WireGuard 的配置文件"></a>配置 WireGuard 的配置文件</h4><p>客户端与服务端不同的地方在于：</p>
<ul>
<li>Interface 配置中没有 ListenPort</li>
<li>Peer 即为服务端，与服务端不同的地方在于多了一个 Endpoint</li>
</ul>
<p>一般情况下，只有主动发起连接的端需要在 Peer 中指定 Endpoint，此处为服务器的公网 IP 和监听的端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本端配置 ，Interface属性</span></span><br><span class="line">[Interface]</span><br><span class="line"><span class="comment"># 本端的 私钥；</span></span><br><span class="line">PrivateKey = Client private key</span><br><span class="line"><span class="comment"># 配置本端的内网IP；</span></span><br><span class="line">Address = 192.168.1.2/32</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 iptables 作为 SNAT</span></span><br><span class="line"><span class="comment"># --to-source 的IP作为内网中的IP地址；</span></span><br><span class="line">PostUp = iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 192.168.2.11</span><br><span class="line">PostUp = iptables -t nat -D POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 192.168.2.11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对端，即服务器端，Peer属性</span></span><br><span class="line">[Peer]</span><br><span class="line"><span class="comment"># 服务端的公钥；</span></span><br><span class="line">PublicKey = Server public key</span><br><span class="line"><span class="comment"># 允许对端的IP流量</span></span><br><span class="line">AllowedIPs = IP Range</span><br><span class="line"><span class="comment"># 服务端的IP与端口；</span></span><br><span class="line">Endpoint = 1.1.1.1:28385</span><br><span class="line"><span class="comment"># 每10秒发送keepalive心跳；</span></span><br><span class="line">PersistentKeepalive = 10</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完毕后，启动WireGuard服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wg-quick up wg0</span><br></pre></td></tr></table></figure>

<p>开启内核IP包转发</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/sysctl.conf， </span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 将 net.ipv4.ip_forward = 0 中的 0 改为 1。</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"><span class="comment"># sysctl -p 使其生效。</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h1 id="WireGuard-的缺陷"><a href="#WireGuard-的缺陷" class="headerlink" title="WireGuard 的缺陷"></a>WireGuard 的缺陷</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ryanyangcs/p/14339053.html">https://www.cnblogs.com/ryanyangcs/p/14339053.html</a></p>
<h2 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h2><p>作为终端用户，其实无需考虑协议的复杂度。</p>
<p>如果复杂度真的影响很大，我们肯定早就摆脱 SIP、 H.323 和 FTP 等不能很好地应对NAT的协议了，然而并没有。讲道理，IPsec 比 WireGuard 更复杂是有原因的：它能做的事情太多了。<br>比如，使用用户名&#x2F;密码或带有 EAP 的 SIM 卡进行用户认证；也可以扩展新的加密方式。</p>
<p>而 WireGuard 呢？这些功能都没有。这就意味着当某一天它的固定的那些加密方式被破解或削弱了之后，就彻底崩盘了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WireGuard 在加密方式上比较偏执，故意砍掉了加密协议的敏捷性，不支持扩展加密协议，因为这么做会大大降低软件的复杂度。如果底层的加密协议出现了漏洞，只能更新所有端点来修复漏洞。</span><br></pre></td></tr></table></figure>

<h2 id="更新密钥"><a href="#更新密钥" class="headerlink" title="更新密钥"></a>更新密钥</h2><p>当 WireGuard 密钥更新后，每一个客户端需要更新配置文件中的 服务端的公钥；</p>
<h2 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h2><p>WireGuard 使用以下加密技术来保障数据的安全：</p>
<ul>
<li>使用 ChaCha20 进行对称加密，使用 Poly1305 进行数据验证。</li>
<li>利用 Curve25519 进行密钥交换。</li>
<li>使用 BLAKE2 作为哈希函数。</li>
<li>使用 HKDF 进行解密。</li>
</ul>
<p>而 IPSec 和 OpenVPN 使用的都是标准的 ChaCha20-Poly1305 加密算法。</p>
<p>BLAKE2算法是 BLAKE 算法的升级版，而 BLAKE 是 SHA-3 的入围者，与 SHA-2 非常相似，所以没有获奖。如果哪天 SHA-2 被破解了，BLAKE 也很有可能被破解。</p>
<p>IPSec 和 OpenVPN 使用的加密方式和 WireGuard 是类似的，比如对称加密使用的是标准的 ChaCha20-Poly1305 算法。唯一没有用到的就是 BLAKE2，因为它目前没有列入标准。即使不用 BLAKE2，也没什么大不了的，因为 VPN 是使用 HMACs 来保障数据的完整性，即使使用 MD5 也仍然没问题。</p>
<p>我的结论是：实际上所有的 VPN 都可以使用相同的加密技术，WireGuard 在加密或数据完整性方面并没有比其他的 VPN 更安全或更不安全。</p>
<p>然而白皮书上说了，加密不是重点，速度才是。</p>
<h1 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h1><h2 id="AllowedIPs-进行ACL-设置"><a href="#AllowedIPs-进行ACL-设置" class="headerlink" title="AllowedIPs 进行ACL 设置"></a>AllowedIPs 进行ACL 设置</h2><p>AllowedIPs控制了哪些流量允许使用该vpn，未匹配的流量会直连。个人翻墙时会使用全局VPN，但服务器之间连接时，基本不会把wiregaurd当做全局VPN使用。设置这里就非常方便。</p>
<p>AllowedIPs &#x3D; 0.0.0.0&#x2F;0,::&#x2F;0 表示所有ipv4及ipv6的流量都要走vpn，适合个人用户。<br>AllowedIPs &#x3D; 10.10.0.0&#x2F;24,192.168.1.0&#x2F;24 表示只有目的IP是这两个网段时走wireguard,其余流量走服务器默认的路由。</p>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>wireguard的客户端都会有连接的日志，查看wireguard服务器端日志只能通过查看内核日志的方方式，内核要支持Dynamic Debugging,正常情况下需编译内核开启CONFIG_DYNAMIC_DEBUG，有些发型版已经默认开启。可以执行以下命令进行查看：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mount | grep debug</span><br><span class="line">debugfs on /sys/kernel/debug <span class="built_in">type</span> debugfs (rw,relatime)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置开启调试日志</span></span><br><span class="line">modprobe wireguard </span><br><span class="line"><span class="built_in">echo</span> module wireguard +p &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line"> dmesg -wH</span><br><span class="line"> journalctl -kf</span><br></pre></td></tr></table></figure>

<h2 id="报错1-linux做为客户端时启动wireguard报错：-RTNETLINK-answers-Operation-not-supported"><a href="#报错1-linux做为客户端时启动wireguard报错：-RTNETLINK-answers-Operation-not-supported" class="headerlink" title="报错1: linux做为客户端时启动wireguard报错： RTNETLINK answers: Operation not supported"></a>报错1: linux做为客户端时启动wireguard报错： RTNETLINK answers: Operation not supported</h2><p>该报错需重启服务器或客户端</p>
<h2 id="报错2-vpn服务器ping客户端时报错：-ping-sendmsg-Required-key-not-available"><a href="#报错2-vpn服务器ping客户端时报错：-ping-sendmsg-Required-key-not-available" class="headerlink" title="报错2: vpn服务器ping客户端时报错： ping: sendmsg: Required key not available"></a>报错2: vpn服务器ping客户端时报错： ping: sendmsg: Required key not available</h2><p>该错最有可能是服务器端的peer部分AllowedIPs配置不对，网上一些教程使用SaveConfig&#x3D;true，该配置是在关闭或重启wireguard时才添加配置，导致如果客户端连接后如果服务器端未重启，就会出现该错误，不建议使用saveConfig&#x3D;true。</p>
<h2 id="报错3-服务器端ping客户端时提示：-ping-sendmsg-Destination-address-required"><a href="#报错3-服务器端ping客户端时提示：-ping-sendmsg-Destination-address-required" class="headerlink" title="报错3: 服务器端ping客户端时提示： ping: sendmsg: Destination address required"></a>报错3: 服务器端ping客户端时提示： ping: sendmsg: Destination address required</h2><p>一般是服务器端更改配置后，客户端未重新连接，客户端重新连接即可</p>
<h2 id="报错4-启动wireguard时报错：-Error-Unknown-device-type-Unable-to-access-interface-Protocol-not-supported-或执行-modprobe-wireguard-命令报错：-modprobe-FATAL-Module-wireguard-not-found-in-directory"><a href="#报错4-启动wireguard时报错：-Error-Unknown-device-type-Unable-to-access-interface-Protocol-not-supported-或执行-modprobe-wireguard-命令报错：-modprobe-FATAL-Module-wireguard-not-found-in-directory" class="headerlink" title="报错4: 启动wireguard时报错： Error: Unknown device type. Unable to access interface: Protocol not supported 或执行 modprobe wireguard 命令报错： modprobe: FATAL: Module wireguard not found in directory"></a>报错4: 启动wireguard时报错： Error: Unknown device type. Unable to access interface: Protocol not supported 或执行 modprobe wireguard 命令报错： modprobe: FATAL: Module wireguard not found in directory</h2><p>这个错误通常是因为升级内核导致的，wireguard的内核模块安装在旧版内核上，新内核没有wireguard模块，解决方法是卸载旧版内核、旧版kernel-header、旧版kernel-devel等,重新安装wireguard即可。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>WireGuard 安装说明： <a target="_blank" rel="noopener" href="https://www.wireguard.com/install/">https://www.wireguard.com/install/</a><br>使用 WireGuard 无缝接入内网: <a target="_blank" rel="noopener" href="https://devld.me/2020/07/27/wireguard-setup/">https://devld.me/2020/07/27/wireguard-setup/</a><br><a target="_blank" rel="noopener" href="https://blog.d0zingcat.dev/p/vpn-connect-work-home/">https://blog.d0zingcat.dev/p/vpn-connect-work-home/</a><br><a target="_blank" rel="noopener" href="https://opswill.com/articles/wireguard-howtos.html">https://opswill.com/articles/wireguard-howtos.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://github.com/rohman-zhu/2024/03/19/vRops%E6%8C%87%E6%A0%87-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%8D%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rohman.Zhu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诺曼实验室">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 诺曼实验室">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/19/vRops%E6%8C%87%E6%A0%87-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%8D%B7/" class="post-title-link" itemprop="url">vRops指标-数据存储卷</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-03-19 23:14:41 / Modified: 15:17:46" itemprop="dateCreated datePublished" datetime="2024-03-19T23:14:41+00:00">2024-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/default/" itemprop="url" rel="index"><span itemprop="name">default</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h1><p>数据存储卷：设备：所有实例的汇总：</p>
<ol>
<li>物理设备延迟(ms)</li>
<li>总延迟(ms)</li>
<li>内核延迟(ms)</li>
</ol>
<h1 id="数据存储卷的仪表盘"><a href="#数据存储卷的仪表盘" class="headerlink" title="数据存储卷的仪表盘"></a>数据存储卷的仪表盘</h1><p>仪表板–主页–性能–数据存储性能</p>
<blockquote>
<p>可以查看各个存储卷的性能以及虚拟机性能详情。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
